<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capability Checks & Permissions - WordPress Security</title>
    <meta name="description" content="Learn WordPress capability system and implement proper permission checks in plugins for secure access control.">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/sidebar-enhanced.css">
    <style>
        .capability-header {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            padding: 3rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }
        .capability-section {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }
        .code-example {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header class="site-header">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
            </div>
        </header>
        
        <nav class="breadcrumb container">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item"><a href="/">Home</a> /</li>
                <li class="breadcrumb-item"><a href="/module6.html">Module 6</a> /</li>
                <li class="breadcrumb-item">Capability Checks & Permissions</li>
            </ol>
        </nav>
        
        <main class="main-content">
            <div class="container">
                <div class="content-with-sidebar">
                    <aside class="sidebar">
                        <div class="sidebar-nav">
                            <h3 class="sidebar-title">Session 9: Security & Performance</h3>
                            <ul class="sidebar-menu">
                                <li><a href="/09module/security_principles.html">Security Principles</a></li>
                                <li><a href="/09module/input_validation.html">Input Validation & Sanitization</a></li>
                                <li class="active"><a href="/09module/capability_checks.html">Capability Checks & Permissions</a></li>
                                <li><a href="/09module/data_encryption.html">Data Encryption</a></li>
                                <li><a href="/09module/preventing_attacks.html">Preventing Common Attacks</a></li>
                                <li><a href="/09module/performance_optimization.html">Performance Optimization</a></li>
                                <li><a href="/09module/caching_strategies.html">Caching Strategies</a></li>
                                <li><a href="/09module/homework_security_audit.html">Homework: Security Audit</a></li>
                            </ul>
                        </div>
                    </aside>
                    
                    <article class="lesson-content">
                        <div class="capability-header">
                            <h1>üîê Capability Checks & Permissions</h1>
                            <p class="lead">Implement proper access control in WordPress plugins</p>
                        </div>

                        <div class="lesson-objectives">
                            <h2>Learning Objectives</h2>
                            <ul>
                                <li>Understand WordPress roles and capabilities</li>
                                <li>Implement capability checks</li>
                                <li>Create custom capabilities</li>
                                <li>Manage user permissions</li>
                                <li>Secure admin functions</li>
                            </ul>
                        </div>
                        
                        <div class="lesson-body">
                            <section>
                                <h2>WordPress Roles & Capabilities</h2>
                                <div class="capability-section">
                                    <h3>Default WordPress Roles</h3>
                                    <ul>
                                        <li><strong>Super Admin:</strong> Multisite network administrator</li>
                                        <li><strong>Administrator:</strong> Full site access</li>
                                        <li><strong>Editor:</strong> Publish and manage all posts</li>
                                        <li><strong>Author:</strong> Publish and manage own posts</li>
                                        <li><strong>Contributor:</strong> Write and manage own posts (no publish)</li>
                                        <li><strong>Subscriber:</strong> Read content only</li>
                                    </ul>
                                    
                                    <div class="code-example">
                                        <pre><code>// Check user role
$user = wp_get_current_user();
if (in_array('administrator', $user->roles)) {
    // User is an admin
}

// Better: Check capability instead
if (current_user_can('manage_options')) {
    // User can manage options
}</code></pre>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h2>Capability Checking Functions</h2>
                                <div class="capability-section">
                                    <h3>Common Capability Checks</h3>
                                    <div class="code-example">
                                        <pre><code>// Check current user capability
if (current_user_can('edit_posts')) {
    // User can edit posts
}

// Check specific post capability
if (current_user_can('edit_post', $post_id)) {
    // User can edit this specific post
}

// Check user capability
if (user_can($user_id, 'publish_posts')) {
    // Specific user can publish
}

// Check multiple capabilities
if (current_user_can('edit_posts') && current_user_can('upload_files')) {
    // User has both capabilities
}

// Admin-only function
function admin_only_function() {
    if (!current_user_can('manage_options')) {
        wp_die(__('You do not have sufficient permissions'));
    }
    // Admin code here
}</code></pre>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h2>Custom Capabilities</h2>
                                <div class="capability-section">
                                    <h3>Adding Custom Capabilities</h3>
                                    <div class="code-example">
                                        <pre><code>// Add custom capability to role
function add_custom_capabilities() {
    $role = get_role('administrator');
    $role->add_cap('manage_custom_plugin');
    $role->add_cap('edit_custom_items');
    $role->add_cap('delete_custom_items');
}
register_activation_hook(__FILE__, 'add_custom_capabilities');

// Remove on deactivation
function remove_custom_capabilities() {
    $role = get_role('administrator');
    $role->remove_cap('manage_custom_plugin');
}
register_deactivation_hook(__FILE__, 'remove_custom_capabilities');

// Create custom role
function create_custom_role() {
    add_role('plugin_manager', 'Plugin Manager', array(
        'read' => true,
        'edit_posts' => true,
        'manage_custom_plugin' => true,
    ));
}</code></pre>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h2>Securing Admin Pages</h2>
                                <div class="capability-section">
                                    <h3>Admin Menu with Capabilities</h3>
                                    <div class="code-example">
                                        <pre><code>// Add admin menu with capability check
add_action('admin_menu', function() {
    add_menu_page(
        'Plugin Settings',
        'My Plugin',
        'manage_options', // Required capability
        'my-plugin',
        'render_admin_page'
    );
    
    add_submenu_page(
        'my-plugin',
        'Advanced Settings',
        'Advanced',
        'manage_network', // Higher capability
        'my-plugin-advanced',
        'render_advanced_page'
    );
});

// Page callback with additional check
function render_admin_page() {
    if (!current_user_can('manage_options')) {
        return;
    }
    // Render page
}</code></pre>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h2>AJAX Security with Capabilities</h2>
                                <div class="capability-section">
                                    <h3>Secure AJAX Handlers</h3>
                                    <div class="code-example">
                                        <pre><code>// AJAX handler with capability check
add_action('wp_ajax_delete_item', function() {
    // Check nonce
    if (!wp_verify_nonce($_POST['nonce'], 'delete_nonce')) {
        wp_die('Security check failed');
    }
    
    // Check capability
    if (!current_user_can('delete_posts')) {
        wp_send_json_error('Insufficient permissions');
    }
    
    // Check specific item permission
    $item_id = intval($_POST['item_id']);
    if (!current_user_can('delete_post', $item_id)) {
        wp_send_json_error('Cannot delete this item');
    }
    
    // Perform deletion
    wp_delete_post($item_id);
    wp_send_json_success('Item deleted');
});</code></pre>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h2>Dynamic Capability Checks</h2>
                                <div class="capability-section">
                                    <h3>Meta Capabilities</h3>
                                    <div class="code-example">
                                        <pre><code>// Map meta capabilities
add_filter('map_meta_cap', function($caps, $cap, $user_id, $args) {
    switch ($cap) {
        case 'edit_custom_item':
            $post = get_post($args[0]);
            if ($post->post_author == $user_id) {
                $caps = array('edit_posts');
            } else {
                $caps = array('edit_others_posts');
            }
            break;
            
        case 'delete_custom_item':
            $post = get_post($args[0]);
            if ($post->post_status == 'publish') {
                $caps = array('delete_published_posts');
            } else {
                $caps = array('delete_posts');
            }
            break;
    }
    return $caps;
}, 10, 4);</code></pre>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h2>Best Practices</h2>
                                <ul>
                                    <li>Always check capabilities, not roles</li>
                                    <li>Use most specific capability possible</li>
                                    <li>Check capabilities before sensitive operations</li>
                                    <li>Combine with nonce verification</li>
                                    <li>Don't hardcode role names</li>
                                    <li>Clean up custom capabilities on uninstall</li>
                                    <li>Document required capabilities</li>
                                </ul>
                            </section>

                            <section class="resources">
                                <h2>Resources</h2>
                                <ul>
                                    <li><a href="https://wordpress.org/support/article/roles-and-capabilities/">Roles and Capabilities</a></li>
                                    <li><a href="https://developer.wordpress.org/plugins/users/roles-and-capabilities/">Plugin Handbook: Roles</a></li>
                                </ul>
                            </section>
                        </div>

                        <div class="lesson-navigation">
                            <a href="/09module/input_validation.html" class="lesson-nav-button prev">Previous: Input Validation</a>
                            <button class="complete-lesson-btn">Mark as Complete</button>
                            <a href="/09module/data_encryption.html" class="lesson-nav-button next">Next: Data Encryption</a>
                        </div>
                    </article>
                </div>
            </div>
        </main>

        <footer class="site-footer">
            <div class="footer-container">
                <p>&copy; 2024 PHP WordPress Course. All rights reserved.</p>
            </div>
        </footer>
    </div>
    
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/progress-tracker.js"></script>
</body>
</html>