<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>Executing SQL Queries through PHP - Query Execution Guide - PHP WordPress Course</title>
    <meta name="description" content="Master SQL query execution in PHP, query building, batch operations, transactions, and optimization techniques">
    <meta name="keywords" content="PHP, MySQL, SQL queries, query execution, batch queries, transactions, query optimization">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Mermaid for diagrams -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item active">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module3.html">Module 3</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Executing Queries</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <div class="content-with-sidebar">
                    <!-- Sidebar -->
                    <aside class="sidebar">
                        <div class="sidebar-nav">
                            <h3 class="sidebar-title">Module 3: Session 5</h3>
                            <div class="sidebar-section">
                                <h4 class="sidebar-section-title">PHP MySQL Integration</h4>
                                <a href="/module3.html" class="sidebar-link">Module Overview</a>
                                <a href="/03module/connecting_mysql.html" class="sidebar-link">1. Connecting to MySQL</a>
                                <a href="/03module/pdo_vs_mysqli.html" class="sidebar-link">2. PDO vs MySQLi</a>
                                <a href="/03module/executing_queries.html" class="sidebar-link active">3. Executing Queries</a>
                                <a href="/03module/prepared_statements.html" class="sidebar-link">4. Prepared Statements</a>
                                <a href="/03module/crud_operations.html" class="sidebar-link">5. CRUD Operations</a>
                                <a href="/03module/result_sets.html" class="sidebar-link">6. Result Sets</a>
                                <a href="/03module/error_debugging.html" class="sidebar-link">7. Error Handling</a>
                                <a href="/03module/final_project.html" class="sidebar-link">8. Final Project</a>
                            </div>
                        </div>
                    </aside>
                    
                    <!-- Main Lesson Content -->
                    <article class="lesson-content">
                        <header class="lesson-header">
                            <h1>Executing SQL Queries through PHP</h1>
                            <div class="lesson-meta">
                                <div class="lesson-meta-item">
                                    <svg width="20" height="20" fill="currentColor">
                                        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span>Duration: 85 minutes</span>
                                </div>
                                <div class="lesson-meta-item">
                                    <svg width="20" height="20" fill="currentColor">
                                        <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                                    </svg>
                                    <span>Lesson 3 of 8</span>
                                </div>
                            </div>
                        </header>

                        <!-- Learning Objectives -->
                        <div class="lesson-objectives">
                            <h2>Learning Objectives</h2>
                            <ul>
                                <li>Execute different types of SQL queries (SELECT, INSERT, UPDATE, DELETE)</li>
                                <li>Build dynamic queries safely</li>
                                <li>Implement batch query operations</li>
                                <li>Execute multiple queries efficiently</li>
                                <li>Handle query results properly</li>
                                <li>Optimize query performance</li>
                                <li>Execute stored procedures and functions</li>
                                <li>Manage database transactions</li>
                            </ul>
                        </div>
                        
                        <!-- Lesson Body -->
                        <div class="lesson-body">
                            <section>
                                <h2>Query Execution Overview</h2>
                                <p class="lead">Understanding how to execute SQL queries efficiently and safely is crucial for building robust PHP applications! âš¡</p>
                                
                                <canvas id="queryCanvas" width="600" height="500"></canvas>
                                <script>
                                    const ctx = document.getElementById('queryCanvas').getContext('2d');
                                    
                                    // Title
                                    ctx.font = 'bold 18px Arial';
                                    ctx.fillStyle = '#1f2937';
                                    ctx.fillText('SQL Query Execution Flow', 180, 30);
                                    
                                    // Query Types
                                    ctx.fillStyle = '#f3f4f6';
                                    ctx.fillRect(50, 60, 500, 80);
                                    ctx.strokeStyle = '#6b7280';
                                    ctx.lineWidth = 2;
                                    ctx.strokeRect(50, 60, 500, 80);
                                    
                                    ctx.fillStyle = '#1f2937';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('Query Types', 270, 80);
                                    
                                    const queryTypes = [
                                        { type: 'SELECT', color: '#dbeafe', x: 70 },
                                        { type: 'INSERT', color: '#dcfce7', x: 170 },
                                        { type: 'UPDATE', color: '#fef3c7', x: 270 },
                                        { type: 'DELETE', color: '#fee2e2', x: 370 },
                                        { type: 'DDL', color: '#e9d5ff', x: 470 }
                                    ];
                                    
                                    queryTypes.forEach(q => {
                                        ctx.fillStyle = q.color;
                                        ctx.fillRect(q.x, 95, 70, 30);
                                        ctx.strokeStyle = '#6b7280';
                                        ctx.lineWidth = 1;
                                        ctx.strokeRect(q.x, 95, 70, 30);
                                        
                                        ctx.fillStyle = '#1f2937';
                                        ctx.font = '10px Arial';
                                        ctx.fillText(q.type, q.x + 15, 113);
                                    });
                                    
                                    // Execution Methods
                                    ctx.fillStyle = '#e0f2fe';
                                    ctx.fillRect(50, 160, 240, 120);
                                    ctx.strokeStyle = '#0891b2';
                                    ctx.strokeRect(50, 160, 240, 120);
                                    
                                    ctx.fillStyle = '#0c4a6e';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('PDO Methods', 140, 180);
                                    
                                    ctx.font = '10px Arial';
                                    ctx.fillStyle = '#374151';
                                    ctx.fillText('â€¢ query() - Direct execution', 60, 200);
                                    ctx.fillText('â€¢ exec() - Non-SELECT queries', 60, 215);
                                    ctx.fillText('â€¢ prepare() - Prepared statements', 60, 230);
                                    ctx.fillText('â€¢ beginTransaction() - Transactions', 60, 245);
                                    ctx.fillText('â€¢ lastInsertId() - Get insert ID', 60, 260);
                                    
                                    ctx.fillStyle = '#fef3c7';
                                    ctx.fillRect(310, 160, 240, 120);
                                    ctx.strokeStyle = '#ca8a04';
                                    ctx.strokeRect(310, 160, 240, 120);
                                    
                                    ctx.fillStyle = '#92400e';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('MySQLi Methods', 390, 180);
                                    
                                    ctx.font = '10px Arial';
                                    ctx.fillStyle = '#374151';
                                    ctx.fillText('â€¢ query() - Execute query', 320, 200);
                                    ctx.fillText('â€¢ real_query() - Binary-safe query', 320, 215);
                                    ctx.fillText('â€¢ multi_query() - Multiple queries', 320, 230);
                                    ctx.fillText('â€¢ prepare() - Prepared statements', 320, 245);
                                    ctx.fillText('â€¢ begin_transaction() - Transactions', 320, 260);
                                    
                                    // Execution Process
                                    ctx.fillStyle = '#dcfce7';
                                    ctx.fillRect(50, 300, 500, 100);
                                    ctx.strokeStyle = '#16a34a';
                                    ctx.strokeRect(50, 300, 500, 100);
                                    
                                    ctx.fillStyle = '#166534';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('Execution Process', 250, 320);
                                    
                                    // Process steps
                                    const steps = [
                                        { text: 'Parse', x: 70, y: 350 },
                                        { text: 'Validate', x: 150, y: 350 },
                                        { text: 'Optimize', x: 240, y: 350 },
                                        { text: 'Execute', x: 330, y: 350 },
                                        { text: 'Return', x: 420, y: 350 }
                                    ];
                                    
                                    steps.forEach((step, i) => {
                                        // Circle
                                        ctx.beginPath();
                                        ctx.arc(step.x + 20, step.y, 15, 0, 2 * Math.PI);
                                        ctx.fillStyle = '#f0fdf4';
                                        ctx.fill();
                                        ctx.strokeStyle = '#16a34a';
                                        ctx.stroke();
                                        
                                        // Number
                                        ctx.fillStyle = '#166534';
                                        ctx.font = 'bold 10px Arial';
                                        ctx.fillText(i + 1, step.x + 17, step.y + 3);
                                        
                                        // Label
                                        ctx.font = '9px Arial';
                                        ctx.fillText(step.text, step.x, step.y + 25);
                                        
                                        // Arrow
                                        if (i < steps.length - 1) {
                                            ctx.strokeStyle = '#6b7280';
                                            ctx.beginPath();
                                            ctx.moveTo(step.x + 35, step.y);
                                            ctx.lineTo(steps[i + 1].x + 5, step.y);
                                            ctx.stroke();
                                        }
                                    });
                                    
                                    // Performance note
                                    ctx.fillStyle = '#fee2e2';
                                    ctx.fillRect(50, 420, 500, 40);
                                    ctx.strokeStyle = '#dc2626';
                                    ctx.strokeRect(50, 420, 500, 40);
                                    
                                    ctx.fillStyle = '#991b1b';
                                    ctx.font = '10px Arial';
                                    ctx.fillText('âš ï¸ Performance Tip: Use prepared statements for repeated queries, batch operations for bulk data', 60, 445);
                                </script>
                                
                                <div class="alert alert-info">
                                    <div class="alert-icon">ðŸ’¡</div>
                                    <div class="alert-content">
                                        <div class="alert-title">Query Execution Best Practices</div>
                                        <div class="alert-message">
                                            <ul>
                                                <li><strong>Use appropriate method:</strong> query() for SELECT, exec() for INSERT/UPDATE/DELETE in PDO</li>
                                                <li><strong>Handle errors:</strong> Always check for query execution errors</li>
                                                <li><strong>Optimize queries:</strong> Use EXPLAIN to analyze query performance</li>
                                                <li><strong>Batch operations:</strong> Group multiple operations when possible</li>
                                                <li><strong>Transaction control:</strong> Use transactions for related operations</li>
                                                <li><strong>Resource management:</strong> Free results when done</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h2>Basic Query Execution</h2>
                                
                                <div class="mermaid">
                                    graph TB
                                        QUERY[SQL Query] --> PREPARE{Prepared?}
                                        
                                        PREPARE -->|No| DIRECT[Direct Execution]
                                        PREPARE -->|Yes| STMT[Prepare Statement]
                                        
                                        DIRECT --> EXEC1[Execute Query]
                                        STMT --> BIND[Bind Parameters]
                                        BIND --> EXEC2[Execute Statement]
                                        
                                        EXEC1 --> RESULT[Process Result]
                                        EXEC2 --> RESULT
                                        
                                        RESULT --> CHECK{Success?}
                                        CHECK -->|Yes| FETCH[Fetch Data]
                                        CHECK -->|No| ERROR[Handle Error]
                                        
                                        style QUERY fill:#dbeafe
                                        style STMT fill:#dcfce7
                                        style RESULT fill:#fef3c7
                                        style ERROR fill:#fee2e2
                                </div>
                                
                                <div class="real_world_example">
                                    <h3>Query Execution Methods</h3>
                                    
                                    <pre><code class="language-php">&lt;?php
// ========================================
// PDO QUERY EXECUTION
// ========================================

class PDOQueryExecutor {
    private $pdo;
    private $queryLog = [];
    private $performanceLog = [];
    
    public function __construct(PDO $pdo) {
        $this->pdo = $pdo;
    }
    
    /**
     * Execute SELECT query
     */
    public function select($sql, $params = []) {
        $startTime = microtime(true);
        
        try {
            if (empty($params)) {
                // Direct query for simple SELECT
                $stmt = $this->pdo->query($sql);
            } else {
                // Prepared statement for parameterized query
                $stmt = $this->pdo->prepare($sql);
                $stmt->execute($params);
            }
            
            $result = $stmt->fetchAll();
            
            $this->logQuery($sql, $params, microtime(true) - $startTime);
            
            return [
                'success' => true,
                'data' => $result,
                'rowCount' => count($result)
            ];
            
        } catch (PDOException $e) {
            return $this->handleError($e, $sql, $params);
        }
    }
    
    /**
     * Execute INSERT query
     */
    public function insert($table, $data) {
        $startTime = microtime(true);
        
        try {
            // Build INSERT query
            $columns = array_keys($data);
            $placeholders = array_map(function($col) { return ":$col"; }, $columns);
            
            $sql = "INSERT INTO $table (" . implode(', ', $columns) . ") 
                    VALUES (" . implode(', ', $placeholders) . ")";
            
            $stmt = $this->pdo->prepare($sql);
            
            // Bind parameters
            foreach ($data as $key => $value) {
                $stmt->bindValue(":$key", $value);
            }
            
            $result = $stmt->execute();
            
            $this->logQuery($sql, $data, microtime(true) - $startTime);
            
            return [
                'success' => $result,
                'id' => $this->pdo->lastInsertId(),
                'affected' => $stmt->rowCount()
            ];
            
        } catch (PDOException $e) {
            return $this->handleError($e, $sql, $data);
        }
    }
    
    /**
     * Execute UPDATE query
     */
    public function update($table, $data, $where = []) {
        $startTime = microtime(true);
        
        try {
            // Build SET clause
            $setClauses = [];
            foreach ($data as $key => $value) {
                $setClauses[] = "$key = :set_$key";
            }
            
            // Build WHERE clause
            $whereClauses = [];
            foreach ($where as $key => $value) {
                $whereClauses[] = "$key = :where_$key";
            }
            
            $sql = "UPDATE $table SET " . implode(', ', $setClauses);
            if (!empty($whereClauses)) {
                $sql .= " WHERE " . implode(' AND ', $whereClauses);
            }
            
            $stmt = $this->pdo->prepare($sql);
            
            // Bind SET parameters
            foreach ($data as $key => $value) {
                $stmt->bindValue(":set_$key", $value);
            }
            
            // Bind WHERE parameters
            foreach ($where as $key => $value) {
                $stmt->bindValue(":where_$key", $value);
            }
            
            $result = $stmt->execute();
            
            $this->logQuery($sql, array_merge($data, $where), microtime(true) - $startTime);
            
            return [
                'success' => $result,
                'affected' => $stmt->rowCount()
            ];
            
        } catch (PDOException $e) {
            return $this->handleError($e, $sql, array_merge($data, $where));
        }
    }
    
    /**
     * Execute DELETE query
     */
    public function delete($table, $where = []) {
        $startTime = microtime(true);
        
        try {
            $sql = "DELETE FROM $table";
            
            if (!empty($where)) {
                $whereClauses = [];
                foreach ($where as $key => $value) {
                    $whereClauses[] = "$key = :$key";
                }
                $sql .= " WHERE " . implode(' AND ', $whereClauses);
            }
            
            $stmt = $this->pdo->prepare($sql);
            
            foreach ($where as $key => $value) {
                $stmt->bindValue(":$key", $value);
            }
            
            $result = $stmt->execute();
            
            $this->logQuery($sql, $where, microtime(true) - $startTime);
            
            return [
                'success' => $result,
                'affected' => $stmt->rowCount()
            ];
            
        } catch (PDOException $e) {
            return $this->handleError($e, $sql, $where);
        }
    }
    
    /**
     * Execute raw query
     */
    public function raw($sql, $params = []) {
        $startTime = microtime(true);
        
        try {
            if (empty($params)) {
                // Use exec for non-SELECT queries without params
                if (preg_match('/^(INSERT|UPDATE|DELETE|CREATE|DROP|ALTER)/i', $sql)) {
                    $affected = $this->pdo->exec($sql);
                    
                    $this->logQuery($sql, [], microtime(true) - $startTime);
                    
                    return [
                        'success' => true,
                        'affected' => $affected
                    ];
                } else {
                    // Use query for SELECT
                    $stmt = $this->pdo->query($sql);
                    $result = $stmt->fetchAll();
                    
                    $this->logQuery($sql, [], microtime(true) - $startTime);
                    
                    return [
                        'success' => true,
                        'data' => $result
                    ];
                }
            } else {
                // Use prepared statement
                $stmt = $this->pdo->prepare($sql);
                $stmt->execute($params);
                
                if (preg_match('/^SELECT/i', $sql)) {
                    $result = $stmt->fetchAll();
                    
                    $this->logQuery($sql, $params, microtime(true) - $startTime);
                    
                    return [
                        'success' => true,
                        'data' => $result
                    ];
                } else {
                    $this->logQuery($sql, $params, microtime(true) - $startTime);
                    
                    return [
                        'success' => true,
                        'affected' => $stmt->rowCount()
                    ];
                }
            }
            
        } catch (PDOException $e) {
            return $this->handleError($e, $sql, $params);
        }
    }
    
    /**
     * Log query for debugging
     */
    private function logQuery($sql, $params, $executionTime) {
        $this->queryLog[] = [
            'sql' => $sql,
            'params' => $params,
            'execution_time' => round($executionTime * 1000, 2) . ' ms',
            'timestamp' => date('Y-m-d H:i:s')
        ];
        
        // Log slow queries
        if ($executionTime > 1) { // More than 1 second
            $this->performanceLog[] = [
                'sql' => $sql,
                'time' => $executionTime,
                'timestamp' => date('Y-m-d H:i:s')
            ];
        }
    }
    
    /**
     * Handle query errors
     */
    private function handleError($e, $sql, $params) {
        $error = [
            'success' => false,
            'error' => $e->getMessage(),
            'code' => $e->getCode(),
            'sql' => $sql,
            'params' => $params
        ];
        
        // Log error
        error_log("Query Error: " . json_encode($error));
        
        return $error;
    }
    
    /**
     * Get query log
     */
    public function getQueryLog() {
        return $this->queryLog;
    }
    
    /**
     * Get slow queries
     */
    public function getSlowQueries() {
        return $this->performanceLog;
    }
}

// ========================================
// MYSQLI QUERY EXECUTION
// ========================================

class MySQLiQueryExecutor {
    private $mysqli;
    private $queryLog = [];
    
    public function __construct(mysqli $mysqli) {
        $this->mysqli = $mysqli;
    }
    
    /**
     * Execute query with result
     */
    public function query($sql, $params = []) {
        $startTime = microtime(true);
        
        try {
            if (empty($params)) {
                // Direct query
                $result = $this->mysqli->query($sql);
                
                if ($result === false) {
                    throw new Exception($this->mysqli->error);
                }
                
                // Process result based on query type
                if ($result instanceof mysqli_result) {
                    $data = [];
                    while ($row = $result->fetch_assoc()) {
                        $data[] = $row;
                    }
                    $result->free();
                    
                    $this->logQuery($sql, [], microtime(true) - $startTime);
                    
                    return [
                        'success' => true,
                        'data' => $data,
                        'num_rows' => count($data)
                    ];
                } else {
                    // Non-SELECT query
                    $this->logQuery($sql, [], microtime(true) - $startTime);
                    
                    return [
                        'success' => true,
                        'affected_rows' => $this->mysqli->affected_rows,
                        'insert_id' => $this->mysqli->insert_id
                    ];
                }
            } else {
                // Prepared statement
                return $this->executeWithParams($sql, $params);
            }
            
        } catch (Exception $e) {
            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }
    
    /**
     * Execute with parameters (prepared statement)
     */
    private function executeWithParams($sql, $params) {
        $stmt = $this->mysqli->prepare($sql);
        
        if (!$stmt) {
            throw new Exception($this->mysqli->error);
        }
        
        // Determine types
        $types = '';
        foreach ($params as $param) {
            if (is_int($param)) {
                $types .= 'i';
            } elseif (is_float($param)) {
                $types .= 'd';
            } else {
                $types .= 's';
            }
        }
        
        // Bind parameters
        if (!empty($params)) {
            $stmt->bind_param($types, ...$params);
        }
        
        // Execute
        if (!$stmt->execute()) {
            throw new Exception($stmt->error);
        }
        
        // Get result
        $result = $stmt->get_result();
        
        if ($result) {
            // SELECT query
            $data = [];
            while ($row = $result->fetch_assoc()) {
                $data[] = $row;
            }
            
            return [
                'success' => true,
                'data' => $data,
                'num_rows' => $result->num_rows
            ];
        } else {
            // Non-SELECT query
            return [
                'success' => true,
                'affected_rows' => $stmt->affected_rows,
                'insert_id' => $this->mysqli->insert_id
            ];
        }
    }
    
    /**
     * Execute multiple queries
     */
    public function multiQuery($sql) {
        $results = [];
        
        if ($this->mysqli->multi_query($sql)) {
            do {
                // Store result
                if ($result = $this->mysqli->store_result()) {
                    $data = [];
                    while ($row = $result->fetch_assoc()) {
                        $data[] = $row;
                    }
                    $results[] = $data;
                    $result->free();
                } else {
                    // Non-SELECT query
                    $results[] = [
                        'affected_rows' => $this->mysqli->affected_rows
                    ];
                }
                
                // Check for more results
                $moreResults = $this->mysqli->more_results();
                
                if ($moreResults) {
                    $this->mysqli->next_result();
                }
                
            } while ($moreResults);
        }
        
        return $results;
    }
    
    /**
     * Call stored procedure
     */
    public function callProcedure($procedure, $params = []) {
        $placeholders = array_fill(0, count($params), '?');
        $sql = "CALL $procedure(" . implode(',', $placeholders) . ")";
        
        return $this->query($sql, $params);
    }
    
    /**
     * Log query
     */
    private function logQuery($sql, $params, $executionTime) {
        $this->queryLog[] = [
            'sql' => $sql,
            'params' => $params,
            'execution_time' => round($executionTime * 1000, 2) . ' ms',
            'timestamp' => date('Y-m-d H:i:s')
        ];
    }
}

// ========================================
// BATCH OPERATIONS
// ========================================

class BatchQueryExecutor {
    private $pdo;
    private $batchSize = 1000;
    
    public function __construct(PDO $pdo) {
        $this->pdo = $pdo;
    }
    
    /**
     * Batch insert
     */
    public function batchInsert($table, $data, $columns = null) {
        if (empty($data)) {
            return ['success' => false, 'error' => 'No data provided'];
        }
        
        // Get columns from first row if not provided
        if ($columns === null) {
            $columns = array_keys($data[0]);
        }
        
        $totalInserted = 0;
        $chunks = array_chunk($data, $this->batchSize);
        
        try {
            $this->pdo->beginTransaction();
            
            foreach ($chunks as $chunk) {
                $sql = $this->buildBatchInsertQuery($table, $columns, count($chunk));
                $stmt = $this->pdo->prepare($sql);
                
                // Flatten data for binding
                $values = [];
                foreach ($chunk as $row) {
                    foreach ($columns as $col) {
                        $values[] = $row[$col] ?? null;
                    }
                }
                
                $stmt->execute($values);
                $totalInserted += $stmt->rowCount();
            }
            
            $this->pdo->commit();
            
            return [
                'success' => true,
                'inserted' => $totalInserted
            ];
            
        } catch (PDOException $e) {
            $this->pdo->rollBack();
            
            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }
    
    /**
     * Build batch insert query
     */
    private function buildBatchInsertQuery($table, $columns, $rowCount) {
        $columnList = implode(', ', $columns);
        $placeholders = '(' . implode(', ', array_fill(0, count($columns), '?')) . ')';
        $values = implode(', ', array_fill(0, $rowCount, $placeholders));
        
        return "INSERT INTO $table ($columnList) VALUES $values";
    }
    
    /**
     * Batch update
     */
    public function batchUpdate($table, $data, $keyColumn) {
        if (empty($data)) {
            return ['success' => false, 'error' => 'No data provided'];
        }
        
        $totalUpdated = 0;
        
        try {
            $this->pdo->beginTransaction();
            
            foreach ($data as $row) {
                if (!isset($row[$keyColumn])) {
                    continue;
                }
                
                $keyValue = $row[$keyColumn];
                unset($row[$keyColumn]);
                
                $setClauses = [];
                foreach ($row as $col => $value) {
                    $setClauses[] = "$col = ?";
                }
                
                $sql = "UPDATE $table SET " . implode(', ', $setClauses) . 
                       " WHERE $keyColumn = ?";
                
                $stmt = $this->pdo->prepare($sql);
                
                $values = array_values($row);
                $values[] = $keyValue;
                
                $stmt->execute($values);
                $totalUpdated += $stmt->rowCount();
            }
            
            $this->pdo->commit();
            
            return [
                'success' => true,
                'updated' => $totalUpdated
            ];
            
        } catch (PDOException $e) {
            $this->pdo->rollBack();
            
            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }
    
    /**
     * Batch delete
     */
    public function batchDelete($table, $column, $values) {
        if (empty($values)) {
            return ['success' => false, 'error' => 'No values provided'];
        }
        
        try {
            $placeholders = str_repeat('?,', count($values) - 1) . '?';
            $sql = "DELETE FROM $table WHERE $column IN ($placeholders)";
            
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute($values);
            
            return [
                'success' => true,
                'deleted' => $stmt->rowCount()
            ];
            
        } catch (PDOException $e) {
            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }
}

// ========================================
// USAGE EXAMPLES
// ========================================

// PDO Examples
$pdo = new PDO('mysql:host=localhost;dbname=test', 'user', 'pass');
$executor = new PDOQueryExecutor($pdo);

// SELECT
$result = $executor->select("SELECT * FROM users WHERE status = ?", ['active']);
print_r($result);

// INSERT
$result = $executor->insert('users', [
    'name' => 'John Doe',
    'email' => 'john@example.com',
    'status' => 'active'
]);
echo "Inserted ID: " . $result['id'];

// UPDATE
$result = $executor->update('users', 
    ['status' => 'inactive'],
    ['id' => 123]
);
echo "Updated rows: " . $result['affected'];

// DELETE
$result = $executor->delete('users', ['id' => 123]);
echo "Deleted rows: " . $result['affected'];

// Batch operations
$batch = new BatchQueryExecutor($pdo);

// Batch insert
$data = [
    ['name' => 'User 1', 'email' => 'user1@example.com'],
    ['name' => 'User 2', 'email' => 'user2@example.com'],
    // ... more data
];
$result = $batch->batchInsert('users', $data);

// View query log
print_r($executor->getQueryLog());
print_r($executor->getSlowQueries());</code></pre>
                                </div>
                            </section>

                            <section>
                                <h2>Advanced Query Execution</h2>
                                
                                <div class="best_practice">
                                    <h3>Transaction Management and Optimization</h3>
                                    
                                    <pre><code class="language-php">&lt;?php
// ========================================
// TRANSACTION MANAGER
// ========================================

class TransactionManager {
    private $pdo;
    private $transactionLevel = 0;
    private $rollbackOnly = false;
    
    public function __construct(PDO $pdo) {
        $this->pdo = $pdo;
    }
    
    /**
     * Begin transaction with nesting support
     */
    public function beginTransaction() {
        if ($this->transactionLevel == 0) {
            $this->pdo->beginTransaction();
        } else {
            $this->pdo->exec("SAVEPOINT LEVEL{$this->transactionLevel}");
        }
        
        $this->transactionLevel++;
        
        return $this->transactionLevel;
    }
    
    /**
     * Commit transaction
     */
    public function commit() {
        if ($this->transactionLevel == 0) {
            throw new Exception("No active transaction");
        }
        
        $this->transactionLevel--;
        
        if ($this->transactionLevel == 0) {
            if ($this->rollbackOnly) {
                $this->pdo->rollBack();
                $this->rollbackOnly = false;
                throw new Exception("Transaction marked for rollback only");
            } else {
                $this->pdo->commit();
            }
        } else {
            if (!$this->rollbackOnly) {
                $this->pdo->exec("RELEASE SAVEPOINT LEVEL{$this->transactionLevel}");
            }
        }
    }
    
    /**
     * Rollback transaction
     */
    public function rollback() {
        if ($this->transactionLevel == 0) {
            throw new Exception("No active transaction");
        }
        
        $this->transactionLevel--;
        
        if ($this->transactionLevel == 0) {
            $this->pdo->rollBack();
            $this->rollbackOnly = false;
        } else {
            $this->pdo->exec("ROLLBACK TO SAVEPOINT LEVEL{$this->transactionLevel}");
            $this->rollbackOnly = true;
        }
    }
    
    /**
     * Execute in transaction
     */
    public function transactional(callable $callback) {
        $this->beginTransaction();
        
        try {
            $result = $callback($this->pdo);
            $this->commit();
            
            return $result;
            
        } catch (Exception $e) {
            $this->rollback();
            throw $e;
        }
    }
}

// ========================================
// QUERY BUILDER
// ========================================

class QueryBuilder {
    private $type;
    private $table;
    private $columns = ['*'];
    private $where = [];
    private $joins = [];
    private $groupBy = [];
    private $having = [];
    private $orderBy = [];
    private $limit;
    private $offset;
    private $bindings = [];
    
    /**
     * SELECT query
     */
    public function select($columns = ['*']) {
        $this->type = 'SELECT';
        $this->columns = is_array($columns) ? $columns : [$columns];
        return $this;
    }
    
    /**
     * FROM table
     */
    public function from($table) {
        $this->table = $table;
        return $this;
    }
    
    /**
     * JOIN clause
     */
    public function join($table, $first, $operator, $second, $type = 'INNER') {
        $this->joins[] = [
            'type' => $type,
            'table' => $table,
            'first' => $first,
            'operator' => $operator,
            'second' => $second
        ];
        return $this;
    }
    
    /**
     * WHERE clause
     */
    public function where($column, $operator, $value = null) {
        if ($value === null) {
            $value = $operator;
            $operator = '=';
        }
        
        $this->where[] = [
            'type' => 'AND',
            'column' => $column,
            'operator' => $operator,
            'value' => $value
        ];
        
        return $this;
    }
    
    /**
     * OR WHERE clause
     */
    public function orWhere($column, $operator, $value = null) {
        if ($value === null) {
            $value = $operator;
            $operator = '=';
        }
        
        $this->where[] = [
            'type' => 'OR',
            'column' => $column,
            'operator' => $operator,
            'value' => $value
        ];
        
        return $this;
    }
    
    /**
     * WHERE IN clause
     */
    public function whereIn($column, array $values) {
        $this->where[] = [
            'type' => 'AND',
            'column' => $column,
            'operator' => 'IN',
            'value' => $values
        ];
        
        return $this;
    }
    
    /**
     * GROUP BY clause
     */
    public function groupBy($columns) {
        $this->groupBy = is_array($columns) ? $columns : [$columns];
        return $this;
    }
    
    /**
     * HAVING clause
     */
    public function having($column, $operator, $value = null) {
        if ($value === null) {
            $value = $operator;
            $operator = '=';
        }
        
        $this->having[] = [
            'column' => $column,
            'operator' => $operator,
            'value' => $value
        ];
        
        return $this;
    }
    
    /**
     * ORDER BY clause
     */
    public function orderBy($column, $direction = 'ASC') {
        $this->orderBy[] = [
            'column' => $column,
            'direction' => strtoupper($direction)
        ];
        
        return $this;
    }
    
    /**
     * LIMIT clause
     */
    public function limit($limit, $offset = null) {
        $this->limit = $limit;
        if ($offset !== null) {
            $this->offset = $offset;
        }
        return $this;
    }
    
    /**
     * Build SQL query
     */
    public function toSql() {
        $sql = $this->type . ' ';
        
        // SELECT columns
        $sql .= implode(', ', $this->columns);
        
        // FROM
        $sql .= " FROM {$this->table}";
        
        // JOINs
        foreach ($this->joins as $join) {
            $sql .= " {$join['type']} JOIN {$join['table']} ON ";
            $sql .= "{$join['first']} {$join['operator']} {$join['second']}";
        }
        
        // WHERE
        if (!empty($this->where)) {
            $sql .= " WHERE ";
            $whereClauses = [];
            
            foreach ($this->where as $i => $condition) {
                $clause = '';
                
                if ($i > 0) {
                    $clause .= " {$condition['type']} ";
                }
                
                if ($condition['operator'] === 'IN') {
                    $placeholders = array_fill(0, count($condition['value']), '?');
                    $clause .= "{$condition['column']} IN (" . implode(', ', $placeholders) . ")";
                    $this->bindings = array_merge($this->bindings, $condition['value']);
                } else {
                    $clause .= "{$condition['column']} {$condition['operator']} ?";
                    $this->bindings[] = $condition['value'];
                }
                
                $whereClauses[] = $clause;
            }
            
            $sql .= implode('', $whereClauses);
        }
        
        // GROUP BY
        if (!empty($this->groupBy)) {
            $sql .= " GROUP BY " . implode(', ', $this->groupBy);
        }
        
        // HAVING
        if (!empty($this->having)) {
            $sql .= " HAVING ";
            $havingClauses = [];
            
            foreach ($this->having as $condition) {
                $havingClauses[] = "{$condition['column']} {$condition['operator']} ?";
                $this->bindings[] = $condition['value'];
            }
            
            $sql .= implode(' AND ', $havingClauses);
        }
        
        // ORDER BY
        if (!empty($this->orderBy)) {
            $sql .= " ORDER BY ";
            $orderClauses = [];
            
            foreach ($this->orderBy as $order) {
                $orderClauses[] = "{$order['column']} {$order['direction']}";
            }
            
            $sql .= implode(', ', $orderClauses);
        }
        
        // LIMIT
        if ($this->limit) {
            $sql .= " LIMIT {$this->limit}";
            
            if ($this->offset) {
                $sql .= " OFFSET {$this->offset}";
            }
        }
        
        return $sql;
    }
    
    /**
     * Get bindings
     */
    public function getBindings() {
        return $this->bindings;
    }
    
    /**
     * Execute query
     */
    public function execute(PDO $pdo) {
        $sql = $this->toSql();
        $stmt = $pdo->prepare($sql);
        $stmt->execute($this->bindings);
        
        return $stmt->fetchAll();
    }
}

// ========================================
// QUERY OPTIMIZATION
// ========================================

class QueryOptimizer {
    private $pdo;
    
    public function __construct(PDO $pdo) {
        $this->pdo = $pdo;
    }
    
    /**
     * Analyze query performance
     */
    public function explain($sql) {
        $stmt = $this->pdo->query("EXPLAIN $sql");
        return $stmt->fetchAll();
    }
    
    /**
     * Analyze query with extended information
     */
    public function explainAnalyze($sql) {
        $stmt = $this->pdo->query("EXPLAIN ANALYZE $sql");
        return $stmt->fetchAll();
    }
    
    /**
     * Get query execution plan
     */
    public function getExecutionPlan($sql) {
        $explain = $this->explain($sql);
        
        $plan = [];
        foreach ($explain as $row) {
            $plan[] = [
                'table' => $row['table'],
                'type' => $row['type'],
                'possible_keys' => $row['possible_keys'],
                'key' => $row['key'],
                'rows' => $row['rows'],
                'extra' => $row['Extra']
            ];
        }
        
        return $plan;
    }
    
    /**
     * Suggest optimizations
     */
    public function suggestOptimizations($sql) {
        $plan = $this->getExecutionPlan($sql);
        $suggestions = [];
        
        foreach ($plan as $step) {
            // Check for full table scan
            if ($step['type'] === 'ALL') {
                $suggestions[] = "Consider adding index on {$step['table']} for WHERE/JOIN conditions";
            }
            
            // Check for filesort
            if (strpos($step['extra'], 'filesort') !== false) {
                $suggestions[] = "Query uses filesort on {$step['table']}, consider adding index for ORDER BY";
            }
            
            // Check for temporary table
            if (strpos($step['extra'], 'temporary') !== false) {
                $suggestions[] = "Query creates temporary table for {$step['table']}, review GROUP BY/ORDER BY";
            }
            
            // Check for no index used
            if (empty($step['key']) && !empty($step['possible_keys'])) {
                $suggestions[] = "Index exists but not used for {$step['table']}, consider FORCE INDEX";
            }
        }
        
        return $suggestions;
    }
}

// ========================================
// USAGE EXAMPLES
// ========================================

$pdo = new PDO('mysql:host=localhost;dbname=test', 'user', 'pass');

// Transaction example
$tm = new TransactionManager($pdo);
$result = $tm->transactional(function($pdo) {
    $pdo->exec("INSERT INTO users (name) VALUES ('John')");
    $pdo->exec("INSERT INTO logs (action) VALUES ('User created')");
    return true;
});

// Query builder example
$query = new QueryBuilder();
$sql = $query->select(['id', 'name', 'email'])
    ->from('users')
    ->join('profiles', 'users.id', '=', 'profiles.user_id')
    ->where('status', 'active')
    ->whereIn('role', ['admin', 'moderator'])
    ->orderBy('created_at', 'DESC')
    ->limit(10)
    ->toSql();

echo $sql;
$results = $query->execute($pdo);

// Query optimization
$optimizer = new QueryOptimizer($pdo);
$plan = $optimizer->explain("SELECT * FROM large_table WHERE status = 'active'");
$suggestions = $optimizer->suggestOptimizations("SELECT * FROM large_table WHERE status = 'active'");
print_r($suggestions);</code></pre>
                                </div>
                            </section>
                            
                            <!-- Practice Exercise -->
                            <section>
                                <h2>Practice Exercise</h2>
                                
                                <div class="alert alert-success">
                                    <div class="alert-icon">ðŸ’»</div>
                                    <div class="alert-content">
                                        <div class="alert-title">Query Execution Challenges</div>
                                        <div class="alert-message">
                                            Complete these query execution tasks:
                                            <ol>
                                                <li>Execute a complex SELECT with JOINs</li>
                                                <li>Implement batch insert of 1000 records</li>
                                                <li>Create a transaction with multiple operations</li>
                                                <li>Build and execute dynamic queries safely</li>
                                                <li>Execute stored procedures with parameters</li>
                                                <li>Implement query result caching</li>
                                                <li>Create a query performance monitor</li>
                                                <li>Build a query builder with method chaining</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            
                            <!-- Resources -->
                            <section class="resources">
                                <h2>Additional Resources</h2>
                                <ul>
                                    <li><a href="https://www.php.net/manual/en/pdo.query.php" target="_blank">PDO::query Documentation</a></li>
                                    <li><a href="https://www.php.net/manual/en/mysqli.query.php" target="_blank">mysqli::query Documentation</a></li>
                                    <li><a href="https://dev.mysql.com/doc/refman/8.0/en/execution-plan-information.html" target="_blank">MySQL EXPLAIN</a></li>
                                    <li><a href="https://use-the-index-luke.com/" target="_blank">SQL Performance Explained</a></li>
                                </ul>
                            </section>
                        </div>

                        <!-- Lesson Navigation -->
                        <div class="lesson-navigation">
                            <a href="/03module/pdo_vs_mysqli.html" class="lesson-nav-button prev">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                                </svg>
                                <span>
                                    <small>Previous</small><br>
                                    PDO vs MySQLi
                                </span>
                            </a>
                            
                            <button class="complete-lesson-btn">
                                Mark as Complete
                            </button>
                            
                            <a href="/03module/prepared_statements.html" class="lesson-nav-button next">
                                <span>
                                    <small>Next</small><br>
                                    Prepared Statements
                                </span>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                                </svg>
                            </a>
                        </div>
                    </article>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module3.html">Module 3</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Support</h4>
                        <ul class="footer-links">
                            <li><a href="/help.html">Help Center</a></li>
                            <li><a href="/faq.html">FAQ</a></li>
                            <li><a href="/contact.html">Contact</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <div class="footer-bottom-content">
                        <p class="copyright">&copy; 2025 PHP WordPress Development Course</p>
                        <nav class="footer-bottom-links">
                            <a href="/privacy.html">Privacy</a>
                            <span class="separator">|</span>
                            <a href="/terms.html">Terms</a>
                        </nav>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Back to Top -->
    <button id="back-to-top" class="back-to-top" aria-label="Back to top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 19V5M12 5l-7 7M12 5l7 7"/>
        </svg>
    </button>

    <!-- JavaScript -->
    <script src="/assets/js/navigation.js"></script>
    <script src="/assets/js/site-config.js"></script>
</body>
</html>