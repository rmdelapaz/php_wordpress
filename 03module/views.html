<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>SQL Views - Virtual Tables and Data Abstraction - PHP WordPress Course</title>
    <meta name="description" content="Master SQL Views - create virtual tables, materialized views, updatable views, and security implementation">
    <meta name="keywords" content="PHP, WordPress, MySQL, SQL Views, virtual tables, materialized views, database security">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Mermaid for diagrams -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item active">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module3.html">Module 3</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">SQL Views</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <div class="content-with-sidebar">
                    <!-- Sidebar -->
                    <aside class="sidebar">
                        <div class="sidebar-nav">
                            <h3 class="sidebar-title">Module 3: Session 5</h3>
                            <div class="sidebar-section">
                                <h4 class="sidebar-section-title">Database Objects</h4>
                                <a href="/module3.html" class="sidebar-link">Module Overview</a>
                                <a href="/03module/views.html" class="sidebar-link active">Views</a>
                                <a href="/03module/stored_procedures.html" class="sidebar-link">Stored Procedures</a>
                                <a href="/03module/triggers.html" class="sidebar-link">Triggers</a>
                                <a href="/03module/indexes_optimization.html" class="sidebar-link">Indexes & Optimization</a>
                                <a href="/03module/transactions.html" class="sidebar-link">Transactions</a>
                                <a href="/03module/security.html" class="sidebar-link">Security</a>
                                <a href="/03module/homework_advanced_sql.html" class="sidebar-link">Homework</a>
                            </div>
                        </div>
                    </aside>
                    
                    <!-- Main Lesson Content -->
                    <article class="lesson-content">
                        <header class="lesson-header">
                            <h1>SQL Views - Virtual Tables</h1>
                            <div class="lesson-meta">
                                <div class="lesson-meta-item">
                                    <svg width="20" height="20" fill="currentColor">
                                        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span>Duration: 85 minutes</span>
                                </div>
                                <div class="lesson-meta-item">
                                    <svg width="20" height="20" fill="currentColor">
                                        <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                                    </svg>
                                    <span>Module 3: Database Objects</span>
                                </div>
                            </div>
                        </header>

                        <!-- Learning Objectives -->
                        <div class="lesson-objectives">
                            <h2>Learning Objectives</h2>
                            <ul>
                                <li>Understand views as virtual tables</li>
                                <li>Create and manage simple and complex views</li>
                                <li>Implement updatable views with restrictions</li>
                                <li>Use views for security and access control</li>
                                <li>Apply views for data abstraction</li>
                                <li>Understand materialized views concepts</li>
                                <li>Optimize view performance</li>
                                <li>Handle view dependencies and maintenance</li>
                            </ul>
                        </div>
                        
                        <!-- Lesson Body -->
                        <div class="lesson-body">
                            <section>
                                <h2>Understanding Database Views</h2>
                                <p class="lead">Views are virtual tables that present data from one or more tables through a predefined query. They simplify complex queries and enhance security! üîç</p>
                                
                                <canvas id="viewConceptCanvas" width="600" height="450"></canvas>
                                <script>
                                    const ctx = document.getElementById('viewConceptCanvas').getContext('2d');
                                    
                                    // Title
                                    ctx.font = 'bold 18px Arial';
                                    ctx.fillStyle = '#1f2937';
                                    ctx.fillText('Database Views Architecture', 180, 30);
                                    
                                    // Base tables
                                    ctx.fillStyle = '#dbeafe';
                                    ctx.fillRect(50, 70, 120, 80);
                                    ctx.strokeStyle = '#2563eb';
                                    ctx.lineWidth = 2;
                                    ctx.strokeRect(50, 70, 120, 80);
                                    ctx.fillStyle = '#1e40af';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('customers', 80, 90);
                                    ctx.font = '10px Arial';
                                    ctx.fillStyle = '#374151';
                                    ctx.fillText('customer_id', 60, 110);
                                    ctx.fillText('name', 60, 125);
                                    ctx.fillText('email', 60, 140);
                                    
                                    ctx.fillStyle = '#dcfce7';
                                    ctx.fillRect(190, 70, 120, 80);
                                    ctx.strokeStyle = '#16a34a';
                                    ctx.strokeRect(190, 70, 120, 80);
                                    ctx.fillStyle = '#166534';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('orders', 230, 90);
                                    ctx.font = '10px Arial';
                                    ctx.fillStyle = '#374151';
                                    ctx.fillText('order_id', 200, 110);
                                    ctx.fillText('customer_id', 200, 125);
                                    ctx.fillText('amount', 200, 140);
                                    
                                    ctx.fillStyle = '#fef3c7';
                                    ctx.fillRect(330, 70, 120, 80);
                                    ctx.strokeStyle = '#ca8a04';
                                    ctx.strokeRect(330, 70, 120, 80);
                                    ctx.fillStyle = '#92400e';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('products', 365, 90);
                                    ctx.font = '10px Arial';
                                    ctx.fillStyle = '#374151';
                                    ctx.fillText('product_id', 340, 110);
                                    ctx.fillText('name', 340, 125);
                                    ctx.fillText('price', 340, 140);
                                    
                                    // View layer
                                    ctx.fillStyle = '#e9d5ff';
                                    ctx.fillRect(100, 200, 400, 100);
                                    ctx.strokeStyle = '#7c3aed';
                                    ctx.lineWidth = 3;
                                    ctx.strokeRect(100, 200, 400, 100);
                                    
                                    ctx.fillStyle = '#6b21a8';
                                    ctx.font = 'bold 14px Arial';
                                    ctx.fillText('VIEW: customer_orders_summary', 210, 225);
                                    
                                    ctx.fillStyle = '#374151';
                                    ctx.font = '10px Courier';
                                    ctx.fillText('SELECT c.name, COUNT(o.order_id), SUM(o.amount)', 110, 250);
                                    ctx.fillText('FROM customers c JOIN orders o ON ...', 110, 265);
                                    ctx.fillText('GROUP BY c.customer_id', 110, 280);
                                    
                                    // Arrows from tables to view
                                    ctx.strokeStyle = '#6b7280';
                                    ctx.lineWidth = 2;
                                    ctx.setLineDash([5, 5]);
                                    
                                    ctx.beginPath();
                                    ctx.moveTo(110, 150);
                                    ctx.lineTo(200, 200);
                                    ctx.stroke();
                                    
                                    ctx.beginPath();
                                    ctx.moveTo(250, 150);
                                    ctx.lineTo(300, 200);
                                    ctx.stroke();
                                    
                                    ctx.setLineDash([]);
                                    
                                    // Users/Applications
                                    ctx.fillStyle = '#e0f2fe';
                                    ctx.fillRect(50, 330, 220, 80);
                                    ctx.strokeStyle = '#0891b2';
                                    ctx.strokeRect(50, 330, 220, 80);
                                    
                                    ctx.fillStyle = '#0c4a6e';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('Application/Users', 120, 350);
                                    ctx.font = '10px Arial';
                                    ctx.fillStyle = '#374151';
                                    ctx.fillText('SELECT * FROM', 60, 370);
                                    ctx.fillText('customer_orders_summary', 60, 385);
                                    ctx.fillText('WHERE total > 1000', 60, 400);
                                    
                                    // Benefits box
                                    ctx.fillStyle = '#fee2e2';
                                    ctx.fillRect(330, 330, 220, 80);
                                    ctx.strokeStyle = '#dc2626';
                                    ctx.strokeRect(330, 330, 220, 80);
                                    
                                    ctx.fillStyle = '#991b1b';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('Benefits', 410, 350);
                                    ctx.font = '10px Arial';
                                    ctx.fillStyle = '#374151';
                                    ctx.fillText('‚úì Simplifies complex queries', 340, 370);
                                    ctx.fillText('‚úì Security (hide columns)', 340, 385);
                                    ctx.fillText('‚úì Data abstraction', 340, 400);
                                    
                                    // Arrow from view to users
                                    ctx.strokeStyle = '#7c3aed';
                                    ctx.lineWidth = 2;
                                    ctx.beginPath();
                                    ctx.moveTo(200, 300);
                                    ctx.lineTo(160, 330);
                                    ctx.stroke();
                                </script>
                                
                                <div class="alert alert-info">
                                    <div class="alert-icon">üí°</div>
                                    <div class="alert-content">
                                        <div class="alert-title">View Key Concepts</div>
                                        <div class="alert-message">
                                            <ul>
                                                <li><strong>Virtual Table:</strong> View doesn't store data, executes query on access</li>
                                                <li><strong>Abstraction:</strong> Hides complex JOINs and calculations</li>
                                                <li><strong>Security:</strong> Restrict access to specific columns/rows</li>
                                                <li><strong>Consistency:</strong> Centralizes business logic</li>
                                                <li><strong>Updateable:</strong> Some views allow INSERT/UPDATE/DELETE</li>
                                                <li><strong>Performance:</strong> Can be slower than direct queries</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h2>Creating and Managing Views</h2>
                                
                                <div class="mermaid">
                                    graph TB
                                        VIEW[Database Views] --> SIMPLE[Simple Views]
                                        VIEW --> COMPLEX[Complex Views]
                                        VIEW --> UPDATE[Updatable Views]
                                        VIEW --> MAT[Materialized Views]
                                        
                                        SIMPLE --> S1[Single table]
                                        SIMPLE --> S2[No aggregates]
                                        
                                        COMPLEX --> C1[Multiple tables]
                                        COMPLEX --> C2[Aggregates/Groups]
                                        
                                        UPDATE --> U1[Restrictions apply]
                                        UPDATE --> U2[WITH CHECK OPTION]
                                        
                                        MAT --> M1[Stored results]
                                        MAT --> M2[Refresh needed]
                                        
                                        style VIEW fill:#dcfce7
                                        style SIMPLE fill:#dbeafe
                                        style COMPLEX fill:#fef3c7
                                        style UPDATE fill:#fee2e2
                                </div>
                                
                                <div class="real_world_example">
                                    <h3>View Creation Examples</h3>
                                    
                                    <pre><code class="language-sql">-- ========================================
-- SIMPLE VIEWS
-- ========================================

-- Basic view creation
CREATE VIEW active_customers AS
SELECT 
    customer_id,
    customer_name,
    email,
    registration_date
FROM customers
WHERE is_active = TRUE;

-- Using the view
SELECT * FROM active_customers;
SELECT * FROM active_customers WHERE registration_date >= '2024-01-01';

-- View with column aliases
CREATE VIEW product_inventory AS
SELECT 
    p.product_id AS id,
    p.product_name AS name,
    p.price AS unit_price,
    i.quantity_available AS stock,
    p.price * i.quantity_available AS inventory_value
FROM products p
JOIN inventory i ON p.product_id = i.product_id;

-- ========================================
-- COMPLEX VIEWS
-- ========================================

-- View with aggregations
CREATE VIEW customer_statistics AS
SELECT 
    c.customer_id,
    c.customer_name,
    c.customer_segment,
    COUNT(DISTINCT o.order_id) AS total_orders,
    SUM(o.amount) AS lifetime_value,
    AVG(o.amount) AS avg_order_value,
    MAX(o.order_date) AS last_order_date,
    DATEDIFF(CURDATE(), MAX(o.order_date)) AS days_since_last_order
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id;

-- Multi-table complex view
CREATE VIEW order_details_view AS
SELECT 
    o.order_id,
    o.order_date,
    c.customer_name,
    c.email AS customer_email,
    p.product_name,
    oi.quantity,
    oi.unit_price,
    oi.quantity * oi.unit_price AS line_total,
    o.status AS order_status
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id;

-- ========================================
-- REPLACE/ALTER VIEWS
-- ========================================

-- Replace existing view
CREATE OR REPLACE VIEW active_customers AS
SELECT 
    customer_id,
    customer_name,
    email,
    phone,  -- Added phone
    registration_date,
    last_login
FROM customers
WHERE is_active = TRUE
    AND last_login >= DATE_SUB(CURDATE(), INTERVAL 90 DAY);

-- ALTER VIEW (MySQL 5.0.1+)
ALTER VIEW product_inventory AS
SELECT 
    p.product_id,
    p.product_name,
    p.category,  -- Added category
    p.price,
    i.quantity_available,
    i.reorder_level  -- Added reorder level
FROM products p
JOIN inventory i ON p.product_id = i.product_id
WHERE p.is_discontinued = FALSE;

-- ========================================
-- VIEW METADATA
-- ========================================

-- Show all views in database
SHOW FULL TABLES WHERE Table_type = 'VIEW';

-- Show view definition
SHOW CREATE VIEW customer_statistics;

-- View information from information_schema
SELECT 
    TABLE_NAME,
    VIEW_DEFINITION,
    CHECK_OPTION,
    IS_UPDATABLE,
    DEFINER,
    SECURITY_TYPE
FROM information_schema.VIEWS
WHERE TABLE_SCHEMA = DATABASE();

-- Check view columns
DESCRIBE customer_statistics;

-- ========================================
-- DROP VIEWS
-- ========================================

-- Drop single view
DROP VIEW IF EXISTS customer_statistics;

-- Drop multiple views
DROP VIEW IF EXISTS view1, view2, view3;</code></pre>
                                </div>
                            </section>

                            <section>
                                <h2>Updatable Views</h2>
                                
                                <canvas id="updatableCanvas" width="600" height="400"></canvas>
                                <script>
                                    const uCtx = document.getElementById('updatableCanvas').getContext('2d');
                                    
                                    // Title
                                    uCtx.font = 'bold 16px Arial';
                                    uCtx.fillStyle = '#1f2937';
                                    uCtx.fillText('Updatable View Requirements', 180, 30);
                                    
                                    // Can update box
                                    uCtx.fillStyle = '#dcfce7';
                                    uCtx.fillRect(50, 60, 250, 150);
                                    uCtx.strokeStyle = '#16a34a';
                                    uCtx.lineWidth = 2;
                                    uCtx.strokeRect(50, 60, 250, 150);
                                    
                                    uCtx.fillStyle = '#166534';
                                    uCtx.font = 'bold 12px Arial';
                                    uCtx.fillText('‚úÖ Can Update', 130, 80);
                                    
                                    uCtx.fillStyle = '#374151';
                                    uCtx.font = '10px Arial';
                                    uCtx.fillText('‚Ä¢ Single table', 60, 100);
                                    uCtx.fillText('‚Ä¢ No DISTINCT', 60, 115);
                                    uCtx.fillText('‚Ä¢ No GROUP BY', 60, 130);
                                    uCtx.fillText('‚Ä¢ No aggregates', 60, 145);
                                    uCtx.fillText('‚Ä¢ No UNION', 60, 160);
                                    uCtx.fillText('‚Ä¢ No subqueries in SELECT', 60, 175);
                                    uCtx.fillText('‚Ä¢ All NOT NULL cols included', 60, 190);
                                    
                                    // Cannot update box
                                    uCtx.fillStyle = '#fee2e2';
                                    uCtx.fillRect(320, 60, 250, 150);
                                    uCtx.strokeStyle = '#dc2626';
                                    uCtx.strokeRect(320, 60, 250, 150);
                                    
                                    uCtx.fillStyle = '#991b1b';
                                    uCtx.font = 'bold 12px Arial';
                                    uCtx.fillText('‚ùå Cannot Update', 385, 80);
                                    
                                    uCtx.fillStyle = '#374151';
                                    uCtx.font = '10px Arial';
                                    uCtx.fillText('‚Ä¢ Multiple tables (JOINs)', 330, 100);
                                    uCtx.fillText('‚Ä¢ DISTINCT keyword', 330, 115);
                                    uCtx.fillText('‚Ä¢ GROUP BY clause', 330, 130);
                                    uCtx.fillText('‚Ä¢ Aggregate functions', 330, 145);
                                    uCtx.fillText('‚Ä¢ UNION operations', 330, 160);
                                    uCtx.fillText('‚Ä¢ Complex expressions', 330, 175);
                                    uCtx.fillText('‚Ä¢ Calculated columns', 330, 190);
                                    
                                    // WITH CHECK OPTION
                                    uCtx.fillStyle = '#fef3c7';
                                    uCtx.fillRect(50, 230, 520, 150);
                                    uCtx.strokeStyle = '#ca8a04';
                                    uCtx.strokeRect(50, 230, 520, 150);
                                    
                                    uCtx.fillStyle = '#92400e';
                                    uCtx.font = 'bold 12px Arial';
                                    uCtx.fillText('WITH CHECK OPTION', 250, 250);
                                    
                                    uCtx.fillStyle = '#374151';
                                    uCtx.font = '10px Arial';
                                    uCtx.fillText('Ensures INSERTs and UPDATEs satisfy the view\'s WHERE clause', 60, 270);
                                    
                                    uCtx.font = '9px Courier';
                                    uCtx.fillText('CREATE VIEW active_products AS', 60, 295);
                                    uCtx.fillText('SELECT * FROM products WHERE is_active = TRUE', 60, 310);
                                    uCtx.fillText('WITH CHECK OPTION;', 60, 325);
                                    
                                    uCtx.font = '10px Arial';
                                    uCtx.fillStyle = '#059669';
                                    uCtx.fillText('‚úì INSERT with is_active=TRUE works', 60, 350);
                                    uCtx.fillStyle = '#dc2626';
                                    uCtx.fillText('‚úó INSERT with is_active=FALSE fails', 60, 365);
                                </script>
                                
                                <div class="best_practice">
                                    <h3>Working with Updatable Views</h3>
                                    
                                    <pre><code class="language-sql">-- ========================================
-- UPDATABLE VIEW EXAMPLES
-- ========================================

-- Simple updatable view
CREATE VIEW editable_products AS
SELECT 
    product_id,
    product_name,
    price,
    category,
    is_active
FROM products
WHERE category = 'Electronics';

-- INSERT through view
INSERT INTO editable_products (product_name, price, category, is_active)
VALUES ('New Laptop', 999.99, 'Electronics', TRUE);

-- UPDATE through view
UPDATE editable_products
SET price = price * 1.1
WHERE product_id = 123;

-- DELETE through view
DELETE FROM editable_products
WHERE product_id = 456;

-- ========================================
-- WITH CHECK OPTION
-- ========================================

-- LOCAL check (only this view's WHERE)
CREATE VIEW premium_products AS
SELECT * FROM products
WHERE price > 1000
WITH LOCAL CHECK OPTION;

-- Cascaded check (all underlying views)
CREATE VIEW electronics_premium AS
SELECT * FROM premium_products
WHERE category = 'Electronics'
WITH CASCADED CHECK OPTION;

-- This INSERT will fail (price <= 1000)
-- INSERT INTO premium_products (product_name, price)
-- VALUES ('Cheap Item', 50.00);  -- Error!

-- ========================================
-- VIEW WITH DEFAULT VALUES
-- ========================================

CREATE VIEW customer_orders AS
SELECT 
    o.order_id,
    o.customer_id,
    COALESCE(o.status, 'pending') AS status,
    COALESCE(o.amount, 0) AS amount,
    o.order_date
FROM orders o;

-- ========================================
-- INSTEAD OF TRIGGERS (Not in MySQL)
-- ========================================

-- MySQL doesn't support INSTEAD OF triggers
-- Alternative: Use stored procedures for complex updates

DELIMITER $$

CREATE PROCEDURE update_complex_view(
    IN p_customer_id INT,
    IN p_new_email VARCHAR(255),
    IN p_new_phone VARCHAR(20)
)
BEGIN
    -- Update customer table
    UPDATE customers
    SET email = p_new_email,
        phone = p_new_phone
    WHERE customer_id = p_customer_id;
    
    -- Log the change
    INSERT INTO audit_log (table_name, action, user, timestamp)
    VALUES ('customers', 'UPDATE', USER(), NOW());
END$$

DELIMITER ;

-- ========================================
-- CHECK VIEW UPDATABILITY
-- ========================================

-- Check if view is updatable
SELECT 
    TABLE_NAME,
    IS_UPDATABLE,
    CHECK_OPTION
FROM information_schema.VIEWS
WHERE TABLE_SCHEMA = DATABASE()
    AND TABLE_NAME = 'editable_products';

-- Test updatability
-- Try to update and check for errors
BEGIN;
    UPDATE editable_products SET price = 100 WHERE product_id = 1;
    -- If no error, view is updatable
ROLLBACK;</code></pre>
                                </div>
                            </section>

                            <section>
                                <h2>Views for Security and Access Control</h2>
                                
                                <div class="alert alert-success">
                                    <div class="alert-icon">üîí</div>
                                    <div class="alert-content">
                                        <div class="alert-title">Security Through Views</div>
                                        <div class="alert-message">
                                            Views provide row-level and column-level security by exposing only necessary data to users.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="homework">
                                    <h3>Security Implementation with Views</h3>
                                    
                                    <pre><code class="language-sql">-- ========================================
-- COLUMN-LEVEL SECURITY
-- ========================================

-- Hide sensitive columns
CREATE VIEW employee_public AS
SELECT 
    employee_id,
    first_name,
    last_name,
    department,
    job_title
    -- Excludes: salary, ssn, birth_date, personal info
FROM employees;

-- Grant access to view, not table
GRANT SELECT ON employee_public TO 'app_user'@'localhost';
-- Don't grant on employees table

-- ========================================
-- ROW-LEVEL SECURITY
-- ========================================

-- Department-specific views
CREATE VIEW sales_team_view AS
SELECT * FROM employees
WHERE department = 'Sales';

CREATE VIEW hr_employee_view AS
SELECT * FROM employees
WHERE department = 'HR' 
   OR employee_id = SUBSTRING_INDEX(USER(), '@', 1);

-- Regional data access
CREATE VIEW regional_sales_west AS
SELECT * FROM sales
WHERE region = 'West';

-- ========================================
-- DATA MASKING
-- ========================================

CREATE VIEW customer_masked AS
SELECT 
    customer_id,
    CONCAT(LEFT(customer_name, 1), REPEAT('*', LENGTH(customer_name) - 2), 
           RIGHT(customer_name, 1)) AS customer_name,
    CONCAT(LEFT(email, 3), '***@***', 
           SUBSTRING_INDEX(email, '.', -1)) AS email,
    CONCAT('***-***-', RIGHT(phone, 4)) AS phone,
    registration_date
FROM customers;

-- ========================================
-- MULTI-TENANT SECURITY
-- ========================================

-- Create tenant-specific views
CREATE VIEW tenant_1_data AS
SELECT * FROM multi_tenant_table
WHERE tenant_id = 1;

CREATE VIEW tenant_2_data AS
SELECT * FROM multi_tenant_table
WHERE tenant_id = 2;

-- User can only see their tenant's data
GRANT SELECT ON tenant_1_data TO 'tenant1_user'@'localhost';

-- ========================================
-- AUDIT VIEWS
-- ========================================

CREATE VIEW user_activity_summary AS
SELECT 
    user_id,
    COUNT(*) AS total_actions,
    MAX(action_timestamp) AS last_activity,
    COUNT(CASE WHEN action_type = 'LOGIN' THEN 1 END) AS login_count,
    COUNT(CASE WHEN action_type = 'ERROR' THEN 1 END) AS error_count
FROM audit_log
GROUP BY user_id;

-- ========================================
-- DEFINER vs INVOKER Security
-- ========================================

-- DEFINER security (default) - runs with creator's privileges
CREATE DEFINER = 'admin'@'localhost'
SQL SECURITY DEFINER
VIEW sensitive_data AS
SELECT * FROM confidential_table;

-- INVOKER security - runs with caller's privileges
CREATE SQL SECURITY INVOKER
VIEW public_data AS
SELECT * FROM public_table;

-- ========================================
-- ROLE-BASED ACCESS VIEWS
-- ========================================

-- Manager view - sees team data
CREATE VIEW manager_dashboard AS
SELECT 
    e.employee_id,
    e.employee_name,
    e.performance_score,
    d.department_budget,
    d.department_goals
FROM employees e
JOIN departments d ON e.department_id = d.department_id
WHERE e.manager_id = (
    SELECT employee_id 
    FROM employees 
    WHERE user_account = CURRENT_USER()
);

-- Executive view - sees aggregate data
CREATE VIEW executive_summary AS
SELECT 
    department,
    COUNT(*) AS employee_count,
    AVG(salary) AS avg_salary,
    SUM(budget) AS total_budget
FROM departments d
JOIN employees e ON d.department_id = e.department_id
GROUP BY department;</code></pre>
                                </div>
                            </section>

                            <section>
                                <h2>Advanced View Patterns</h2>
                                
                                <div class="real_world_example">
                                    <h3>Complex View Patterns and Optimization</h3>
                                    
                                    <pre><code class="language-sql">-- ========================================
-- MATERIALIZED VIEW SIMULATION IN MySQL
-- ========================================

-- MySQL doesn't have native materialized views
-- Simulate with tables and triggers

-- Create materialized view table
CREATE TABLE mv_daily_sales_summary (
    sale_date DATE PRIMARY KEY,
    total_orders INT,
    total_revenue DECIMAL(10,2),
    unique_customers INT,
    avg_order_value DECIMAL(10,2),
    last_refreshed TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_revenue (total_revenue)
);

-- Refresh procedure
DELIMITER $$

CREATE PROCEDURE refresh_daily_sales_summary()
BEGIN
    TRUNCATE TABLE mv_daily_sales_summary;
    
    INSERT INTO mv_daily_sales_summary (
        sale_date,
        total_orders,
        total_revenue,
        unique_customers,
        avg_order_value
    )
    SELECT 
        DATE(order_date) AS sale_date,
        COUNT(*) AS total_orders,
        SUM(amount) AS total_revenue,
        COUNT(DISTINCT customer_id) AS unique_customers,
        AVG(amount) AS avg_order_value
    FROM orders
    WHERE status = 'completed'
    GROUP BY DATE(order_date);
END$$

DELIMITER ;

-- Schedule refresh (using events)
CREATE EVENT refresh_sales_summary
ON SCHEDULE EVERY 1 HOUR
DO CALL refresh_daily_sales_summary();

-- ========================================
-- NESTED VIEWS
-- ========================================

-- Base view
CREATE VIEW order_basics AS
SELECT 
    order_id,
    customer_id,
    order_date,
    amount,
    status
FROM orders;

-- View built on another view
CREATE VIEW recent_orders AS
SELECT * FROM order_basics
WHERE order_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY);

-- Another level of nesting
CREATE VIEW recent_large_orders AS
SELECT * FROM recent_orders
WHERE amount > 1000;

-- ========================================
-- UNION VIEWS
-- ========================================

CREATE VIEW all_transactions AS
SELECT 
    'Order' AS transaction_type,
    order_id AS transaction_id,
    customer_id,
    amount,
    order_date AS transaction_date
FROM orders
WHERE status = 'completed'

UNION ALL

SELECT 
    'Refund' AS transaction_type,
    refund_id AS transaction_id,
    customer_id,
    -amount AS amount,
    refund_date AS transaction_date
FROM refunds

UNION ALL

SELECT 
    'Credit' AS transaction_type,
    credit_id AS transaction_id,
    customer_id,
    amount,
    credit_date AS transaction_date
FROM customer_credits;

-- ========================================
-- PARAMETERIZED VIEW WORKAROUND
-- ========================================

-- MySQL views don't support parameters
-- Use session variables as workaround

SET @customer_id = 123;
SET @start_date = '2024-01-01';
SET @end_date = '2024-12-31';

CREATE VIEW parameterized_orders AS
SELECT *
FROM orders
WHERE customer_id = @customer_id
    AND order_date BETWEEN @start_date AND @end_date;

-- Better approach: Use stored procedure
DELIMITER $$

CREATE PROCEDURE get_customer_orders(
    IN p_customer_id INT,
    IN p_start_date DATE,
    IN p_end_date DATE
)
BEGIN
    SELECT *
    FROM orders
    WHERE customer_id = p_customer_id
        AND order_date BETWEEN p_start_date AND p_end_date;
END$$

DELIMITER ;

-- ========================================
-- VIEW DEPENDENCIES
-- ========================================

-- Find all views that depend on a table
SELECT 
    TABLE_NAME AS view_name,
    VIEW_DEFINITION
FROM information_schema.VIEWS
WHERE TABLE_SCHEMA = DATABASE()
    AND VIEW_DEFINITION LIKE '%products%';

-- Find view hierarchy
WITH RECURSIVE view_deps AS (
    SELECT 
        TABLE_NAME AS view_name,
        VIEW_DEFINITION,
        1 AS level
    FROM information_schema.VIEWS
    WHERE TABLE_SCHEMA = DATABASE()
        AND VIEW_DEFINITION NOT LIKE '%information_schema.VIEWS%'
    
    UNION ALL
    
    SELECT 
        v.TABLE_NAME,
        v.VIEW_DEFINITION,
        vd.level + 1
    FROM information_schema.VIEWS v
    JOIN view_deps vd ON v.VIEW_DEFINITION LIKE CONCAT('%', vd.view_name, '%')
    WHERE v.TABLE_SCHEMA = DATABASE()
        AND vd.level < 5
)
SELECT DISTINCT view_name, level
FROM view_deps
ORDER BY level, view_name;</code></pre>
                                </div>
                            </section>

                            <section>
                                <h2>View Performance Optimization</h2>
                                
                                <div class="alert alert-warning">
                                    <div class="alert-icon">‚ö†Ô∏è</div>
                                    <div class="alert-content">
                                        <div class="alert-title">Performance Considerations</div>
                                        <div class="alert-message">
                                            Views execute their underlying query each time they're accessed. Complex views can impact performance significantly.
                                        </div>
                                    </div>
                                </div>
                                
                                <pre><code class="language-sql">-- ========================================
-- VIEW PERFORMANCE OPTIMIZATION
-- ========================================

-- Analyze view performance
EXPLAIN SELECT * FROM customer_statistics;

-- Create indexes for view performance
-- Identify columns used in view's WHERE/JOIN
CREATE INDEX idx_view_support 
ON orders(customer_id, order_date, status);

-- ========================================
-- OPTIMIZE COMPLEX VIEWS
-- ========================================

-- Instead of complex view with many JOINs
-- CREATE VIEW complex_report AS
-- SELECT ... FROM t1 JOIN t2 JOIN t3 JOIN t4 ...

-- Use summary tables updated periodically
CREATE TABLE report_summary (
    report_date DATE,
    metric1 DECIMAL(10,2),
    metric2 INT,
    -- ... other columns
    PRIMARY KEY (report_date)
);

-- Update via stored procedure or triggers
DELIMITER $$

CREATE TRIGGER update_report_summary
AFTER INSERT ON orders
FOR EACH ROW
BEGIN
    INSERT INTO report_summary (report_date, metric1, metric2)
    VALUES (DATE(NEW.order_date), NEW.amount, 1)
    ON DUPLICATE KEY UPDATE
        metric1 = metric1 + NEW.amount,
        metric2 = metric2 + 1;
END$$

DELIMITER ;

-- ========================================
-- VIEW CACHING STRATEGIES
-- ========================================

-- Use query cache (deprecated in MySQL 8.0)
-- For older versions:
SET GLOBAL query_cache_type = 1;
SET GLOBAL query_cache_size = 67108864; -- 64MB

-- Application-level caching
-- Cache view results in Redis/Memcached

-- ========================================
-- MONITOR VIEW USAGE
-- ========================================

-- Track slow queries involving views
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- Check view execution frequency
SELECT 
    SUBSTRING_INDEX(
        SUBSTRING_INDEX(argument, 'FROM', -1), 
        ' ', 2
    ) AS view_name,
    COUNT(*) AS execution_count,
    AVG(query_time) AS avg_time,
    MAX(query_time) AS max_time
FROM mysql.general_log
WHERE argument LIKE '%FROM%VIEW%'
GROUP BY view_name;</code></pre>
                            </section>

                            <!-- Practice Exercise -->
                            <section>
                                <h2>Practice Exercise</h2>
                                
                                <div class="alert alert-success">
                                    <div class="alert-icon">üíª</div>
                                    <div class="alert-content">
                                        <div class="alert-title">View Challenges</div>
                                        <div class="alert-message">
                                            Create views for these scenarios:
                                            <ol>
                                                <li>Create a view showing top customers by revenue with data masking</li>
                                                <li>Build an updatable view for product management with CHECK OPTION</li>
                                                <li>Design role-based views for different user types</li>
                                                <li>Create a reporting view with multiple aggregations</li>
                                                <li>Implement a view simulating materialized view behavior</li>
                                                <li>Build nested views for hierarchical data</li>
                                                <li>Create a security view hiding sensitive information</li>
                                                <li>Design a performance-optimized view for dashboards</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                                
                                <details>
                                    <summary>üí° Click for Solutions</summary>
                                    <pre><code class="language-sql">-- 1. Top customers with data masking
CREATE VIEW top_customers_masked AS
SELECT 
    customer_id,
    CONCAT(LEFT(customer_name, 2), REPEAT('*', LENGTH(customer_name) - 4), 
           RIGHT(customer_name, 2)) AS customer_name,
    CONCAT(LEFT(email, 3), '****@****.***') AS email,
    total_orders,
    total_revenue,
    CASE 
        WHEN total_revenue > 10000 THEN 'Platinum'
        WHEN total_revenue > 5000 THEN 'Gold'
        WHEN total_revenue > 1000 THEN 'Silver'
        ELSE 'Bronze'
    END AS tier
FROM (
    SELECT 
        c.customer_id,
        c.customer_name,
        c.email,
        COUNT(o.order_id) AS total_orders,
        SUM(o.amount) AS total_revenue
    FROM customers c
    JOIN orders o ON c.customer_id = o.customer_id
    WHERE o.status = 'completed'
    GROUP BY c.customer_id
    ORDER BY total_revenue DESC
    LIMIT 100
) AS customer_summary;

-- 2. Updatable product management view
CREATE VIEW product_management AS
SELECT 
    product_id,
    sku,
    product_name,
    category,
    price,
    is_active,
    last_updated
FROM products
WHERE is_active = TRUE
    AND price > 0
WITH CHECK OPTION;

-- Test updates
UPDATE product_management 
SET price = 99.99 
WHERE product_id = 1;

-- 3. Role-based views
-- Admin view
CREATE VIEW admin_dashboard AS
SELECT 
    DATE(order_date) AS date,
    COUNT(*) AS orders,
    SUM(amount) AS revenue,
    AVG(amount) AS avg_order,
    COUNT(DISTINCT customer_id) AS unique_customers
FROM orders
GROUP BY DATE(order_date);

-- Sales view
CREATE VIEW sales_dashboard AS
SELECT 
    product_name,
    category,
    SUM(quantity) AS units_sold,
    SUM(quantity * unit_price) AS revenue
FROM order_items oi
JOIN products p ON oi.product_id = p.product_id
GROUP BY p.product_id;

-- Customer service view
CREATE VIEW customer_service_view AS
SELECT 
    c.customer_id,
    c.customer_name,
    c.email,
    COUNT(o.order_id) AS total_orders,
    MAX(o.order_date) AS last_order,
    COUNT(r.review_id) AS reviews_written
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
LEFT JOIN reviews r ON c.customer_id = r.user_id
GROUP BY c.customer_id;

-- 4. Complex reporting view
CREATE VIEW sales_report AS
SELECT 
    YEAR(o.order_date) AS year,
    QUARTER(o.order_date) AS quarter,
    MONTH(o.order_date) AS month,
    p.category,
    COUNT(DISTINCT o.order_id) AS order_count,
    COUNT(DISTINCT o.customer_id) AS unique_customers,
    SUM(oi.quantity) AS units_sold,
    SUM(oi.quantity * oi.unit_price) AS gross_revenue,
    SUM(oi.quantity * (oi.unit_price - p.cost)) AS gross_profit,
    AVG(oi.unit_price) AS avg_selling_price
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
WHERE o.status = 'completed'
GROUP BY 
    YEAR(o.order_date),
    QUARTER(o.order_date),
    MONTH(o.order_date),
    p.category;

-- 5. Materialized view simulation
-- Create table to store view results
CREATE TABLE mv_product_performance (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(200),
    total_quantity_sold INT,
    total_revenue DECIMAL(10,2),
    avg_rating DECIMAL(3,2),
    review_count INT,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Procedure to refresh
DELIMITER $$
CREATE PROCEDURE refresh_product_performance()
BEGIN
    TRUNCATE TABLE mv_product_performance;
    
    INSERT INTO mv_product_performance
    SELECT 
        p.product_id,
        p.product_name,
        COALESCE(SUM(oi.quantity), 0),
        COALESCE(SUM(oi.quantity * oi.unit_price), 0),
        COALESCE(AVG(r.rating), 0),
        COUNT(DISTINCT r.review_id),
        NOW()
    FROM products p
    LEFT JOIN order_items oi ON p.product_id = oi.product_id
    LEFT JOIN reviews r ON p.product_id = r.product_id
    GROUP BY p.product_id;
END$$
DELIMITER ;

-- 6. Nested views for hierarchy
CREATE VIEW category_base AS
SELECT 
    category_id,
    category_name,
    parent_category_id
FROM categories;

CREATE VIEW category_with_products AS
SELECT 
    c.*,
    COUNT(p.product_id) AS product_count
FROM category_base c
LEFT JOIN products p ON c.category_id = p.category_id
GROUP BY c.category_id;

CREATE VIEW category_hierarchy AS
SELECT 
    c1.category_name AS main_category,
    c2.category_name AS sub_category,
    c2.product_count
FROM category_with_products c1
JOIN category_with_products c2 ON c1.category_id = c2.parent_category_id;

-- 7. Security view
CREATE VIEW employee_safe_view AS
SELECT 
    employee_id,
    first_name,
    last_name,
    department,
    hire_date,
    CASE 
        WHEN USER() LIKE '%hr%' THEN salary
        ELSE 'RESTRICTED'
    END AS salary_info,
    CASE 
        WHEN USER() LIKE '%hr%' THEN ssn
        ELSE 'XXX-XX-' || RIGHT(ssn, 4)
    END AS ssn_masked
FROM employees;

-- 8. Performance-optimized dashboard view
CREATE VIEW dashboard_metrics AS
SELECT 
    (SELECT COUNT(*) FROM orders WHERE DATE(order_date) = CURDATE()) AS orders_today,
    (SELECT SUM(amount) FROM orders WHERE DATE(order_date) = CURDATE()) AS revenue_today,
    (SELECT COUNT(*) FROM customers WHERE DATE(registration_date) = CURDATE()) AS new_customers_today,
    (SELECT COUNT(*) FROM products WHERE is_active = TRUE) AS active_products,
    (SELECT AVG(rating) FROM reviews WHERE DATE(created_at) = CURDATE()) AS avg_rating_today;</code></pre>
                                </details>
                            </section>
                            
                            <!-- Resources -->
                            <section class="resources">
                                <h2>Additional Resources</h2>
                                <ul>
                                    <li><a href="https://dev.mysql.com/doc/refman/8.0/en/views.html" target="_blank">MySQL Views Documentation</a></li>
                                    <li><a href="https://dev.mysql.com/doc/refman/8.0/en/view-updatability.html" target="_blank">View Updatability</a></li>
                                    <li><a href="https://dev.mysql.com/doc/refman/8.0/en/view-restrictions.html" target="_blank">View Restrictions</a></li>
                                    <li><a href="https://www.mysqltutorial.org/mysql-views-tutorial.aspx" target="_blank">MySQL Views Tutorial</a></li>
                                    <li><a href="https://www.percona.com/blog/2007/08/12/mysql-view-as-a-performance-troublemaker/" target="_blank">View Performance Considerations</a></li>
                                </ul>
                            </section>
                        </div>

                        <!-- Lesson Navigation -->
                        <div class="lesson-navigation">
                            <a href="/03module/subqueries.html" class="lesson-nav-button prev">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                                </svg>
                                <span>
                                    <small>Previous</small><br>
                                    Subqueries
                                </span>
                            </a>
                            
                            <button class="complete-lesson-btn">
                                Mark as Complete
                            </button>
                            
                            <a href="/03module/stored_procedures.html" class="lesson-nav-button next">
                                <span>
                                    <small>Next</small><br>
                                    Stored Procedures
                                </span>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                                </svg>
                            </a>
                        </div>
                    </article>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module3.html">Module 3</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Support</h4>
                        <ul class="footer-links">
                            <li><a href="/help.html">Help Center</a></li>
                            <li><a href="/faq.html">FAQ</a></li>
                            <li><a href="/contact.html">Contact</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <div class="footer-bottom-content">
                        <p class="copyright">&copy; 2025 PHP WordPress Development Course</p>
                        <nav class="footer-bottom-links">
                            <a href="/privacy.html">Privacy</a>
                            <span class="separator">|</span>
                            <a href="/terms.html">Terms</a>
                        </nav>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Back to Top -->
    <button id="back-to-top" class="back-to-top" aria-label="Back to top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 19V5M12 5l-7 7M12 5l7 7"/>
        </svg>
    </button>

    <!-- JavaScript -->
    <script src="/assets/js/navigation.js"></script>
    <script src="/assets/js/site-config.js"></script>
</body>
</html>