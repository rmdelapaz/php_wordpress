<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="ie=edge" http-equiv="X-UA-Compatible"/>
  <!-- SEO Meta Tags -->
  <title>Prepared Statements and Security - SQL Injection Prevention - PHP WordPress Course</title>
  <meta content="Master prepared statements in PHP, prevent SQL injection attacks, implement security best practices, and build secure database applications" name="description"/>
  <meta content="PHP, MySQL, prepared statements, SQL injection, security, parameterized queries, database security" name="keywords"/>
  <meta content="PHP WordPress Course" name="author"/>
  <link href="/assets/css/main.css" rel="stylesheet"/>
  <link href="/assets/css/sidebar-enhanced.css" rel="stylesheet"/>
  <link href="/assets/css/sidebar-toggle.css" rel="stylesheet"/>
  <!-- Favicon -->
  <link href="/favicon.png" rel="icon" type="image/png"/>
  <link href="/favicon.png" rel="apple-touch-icon"/>
  <!-- CSS -->
  <link href="/assets/css/sidebar-enhanced.css" rel="stylesheet"/>
  <link href="/assets/css/sidebar-toggle.css" rel="stylesheet"/>
 </head>
 <body>
  <!-- Skip to main content -->
  <a class="sr-only" href="#main-content">Skip to main content</a>
  <div class="page-wrapper">
   <!-- Header -->
   <header class="site-header" role="banner">
    <div class="header-container">
     <div class="site-branding">
      <a class="site-logo" href="/">
       <h1 class="site-title">PHP WordPress Development</h1>
      </a>
     </div>
     <nav aria-label="Main navigation" class="main-navigation" role="navigation">
      <button aria-expanded="false" aria-label="Toggle navigation" class="mobile-menu-btn">
       <span>
       </span>
       <span>
       </span>
       <span>
       </span>
      </button>
      <div class="nav-menu">
       <ul class="nav-list">
        <li class="nav-item">
         <a class="nav-link" href="/">Home</a>
        </li>
        <li class="nav-item dropdown">
         <button aria-haspopup="true" class="nav-link dropdown-toggle active">Modules</button>
         <div class="dropdown-menu">
          <a class="dropdown-item" href="/module1.html">Module 1: Web Fundamentals</a>
          <a class="dropdown-item" href="/module2.html">Module 2: PHP Fundamentals</a>
          <a class="dropdown-item active" href="/module3.html">Module 3: MySQL Database</a>
          <a class="dropdown-item" href="/module4.html">Module 4: WordPress &amp; Docker</a>
          <a class="dropdown-item" href="/module5.html">Module 5: Theme Development</a>
          <a class="dropdown-item" href="/module6.html">Module 6: Plugin Development</a>
          <a class="dropdown-item" href="/module7.html">Module 7: Advanced WordPress</a>
          <a class="dropdown-item" href="/module8.html">Module 8: Deployment</a>
          <a class="dropdown-item" href="/module9.html">Module 9: Final Project</a>
         </div>
        </li>
        <li class="nav-item">
         <a class="nav-link" href="/resources.html">Resources</a>
        </li>
        <li class="nav-item">
         <a class="nav-link" href="/about.html">About</a>
        </li>
       </ul>
      </div>
     </nav>
     <div class="search-container">
      <div class="search-input-wrapper">
       <svg class="search-icon" fill="currentColor" height="20" viewbox="0 0 20 20" width="20">
        <path clip-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" fill-rule="evenodd">
        </path>
       </svg>
       <input aria-label="Search" class="search-input" placeholder="Search lessons..." type="search"/>
      </div>
      <div class="search-results">
      </div>
     </div>
    </div>
   </header>
   <!-- Progress Bar -->
   <div class="progress-container">
    <div class="progress-header">
     <h2 class="progress-title">Course Progress</h2>
     <span class="progress-text">Loading...</span>
    </div>
    <div class="progress-bar">
     <div class="progress-bar-fill">
      <span class="progress-bar-text">
      </span>
     </div>
    </div>
   </div>
   <!-- Breadcrumb -->
   <nav aria-label="Breadcrumb" class="breadcrumb container">
    <ol class="breadcrumb-list">
     <li class="breadcrumb-item">
      <a href="/">Home</a>
      <span class="breadcrumb-separator">/</span>
     </li>
     <li class="breadcrumb-item">
      <a href="/module3.html">Module 3</a>
      <span class="breadcrumb-separator">/</span>
     </li>
     <li class="breadcrumb-item">
      <span aria-current="page">Prepared Statements</span>
     </li>
    </ol>
   </nav>
   <!-- Main Content -->
   <main class="main-content" id="main-content" role="main">
    <div class="container">
     <div class="content-with-sidebar">
      <!-- Sidebar -->
      <aside class="sidebar">
    <div class="sidebar-nav">
        <h3 class="sidebar-title">Module 3: MySQL Database</h3>
        <div class="sidebar-section">
            <h4 class="sidebar-section-title">Session 5: PHP and MySQL Integration</h4>
            <ul class="sidebar-menu">
                <li><a class="sidebar-link" href="/03module/connecting_mysql.html">Connecting to MySQL with PHP</a></li>
                <li><a class="sidebar-link" href="/03module/executing_queries.html">Executing SQL queries through PHP</a></li>
                <li class="active"><a class="sidebar-link active" href="/03module/prepared_statements.html">Prepared statements and security concerns</a></li>
                <li><a class="sidebar-link" href="/03module/crud_operations.html">CRUD operations in PHP applications</a></li>
                <li><a class="sidebar-link" href="/03module/result_sets.html">Handling results sets</a></li>
                <li><a class="sidebar-link" href="/03module/error_debugging.html">Error handling and debugging</a></li>
                <li><a class="sidebar-link" href="/03module/php_mysql_integration.html">Final Project: Build a complete data-driven PHP application with MySQL backend</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <h4 class="sidebar-section-title">Quick Links</h4>
            <ul class="sidebar-menu">
                <li><a class="sidebar-link" href="/module3.html">Module Overview</a></li>
                <li><a class="sidebar-link prev-session" href="/03module/sql_joins.html">‚Üê Prev: Advanced SQL</a></li>
                <li><a class="sidebar-link" href="/">‚Üê Course Home</a></li>
                <li><a class="sidebar-link" href="/module4.html">Next Module ‚Üí</a></li>
                <li><a class="sidebar-link" href="/resources.html">Resources</a></li>
            </ul>
        </div>
    </div>
</aside>
      <!-- Main Lesson Content -->
      <article class="lesson-content">
       <header class="lesson-header">
        <h1>Prepared Statements and Security Concerns</h1>
        <div class="lesson-meta">
         <div class="lesson-meta-item">
          <svg fill="currentColor" height="20" width="20">
           <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z">
           </path>
          </svg>
          <span>Duration: 90 minutes</span>
         </div>
         <div class="lesson-meta-item">
          <svg fill="currentColor" height="20" width="20">
           <path d="M12 14l9-5-9-5-9 5 9 5z">
           </path>
          </svg>
          <span>Lesson 4 of 8</span>
         </div>
        </div>
       </header>
       <!-- Learning Objectives -->
       <div class="lesson-objectives">
        <h2>Learning Objectives</h2>
        <ul>
         <li>Understand SQL injection attacks and their impact</li>
         <li>Master prepared statements in both PDO and MySQLi</li>
         <li>Implement parameter binding correctly</li>
         <li>Apply input validation and sanitization</li>
         <li>Use whitelisting for dynamic queries</li>
         <li>Implement defense-in-depth security strategies</li>
         <li>Handle different data types securely</li>
         <li>Audit and test for security vulnerabilities</li>
        </ul>
       </div>
       <!-- Lesson Body -->
       <div class="lesson-body">
        <section>
         <h2>Understanding SQL Injection</h2>
         <p class="lead">SQL injection is one of the most dangerous web vulnerabilities. Let's understand how it works and how to prevent it completely! üõ°Ô∏è</p>
         <canvas height="550" id="injectionCanvas" width="600">
         </canvas>
         <script>const ctx = document.getElementById('injectionCanvas').getContext('2d');
                                    
                                    // Title
                                    ctx.font = 'bold 18px Arial';
                                    ctx.fillStyle = '#1f2937';
                                    ctx.fillText('SQL Injection Attack Vectors', 175, 30);
                                    
                                    // Vulnerable Code Section
                                    ctx.fillStyle = '#fee2e2';
                                    ctx.fillRect(50, 60, 500, 140);
                                    ctx.strokeStyle = '#dc2626';
                                    ctx.lineWidth = 2;
                                    ctx.strokeRect(50, 60, 500, 140);
                                    
                                    ctx.fillStyle = '#991b1b';
                                    ctx.font = 'bold 14px Arial';
                                    ctx.fillText('‚ùå VULNERABLE CODE', 60, 85);
                                    
                                    ctx.font = '11px monospace';
                                    ctx.fillStyle = '#374151';
                                    ctx.fillText('$id = $_GET["id"];', 60, 110);
                                    ctx.fillText('$sql = "SELECT * FROM users WHERE id = " . $id;', 60, 130);
                                    ctx.fillText('// Input: 1 OR 1=1', 60, 155);
                                    ctx.fillText('// Result: SELECT * FROM users WHERE id = 1 OR 1=1', 60, 175);
                                    ctx.fillStyle = '#dc2626';
                                    ctx.fillText('// Returns ALL users! üö®', 60, 190);
                                    
                                    // Attack Types
                                    ctx.fillStyle = '#fef3c7';
                                    ctx.fillRect(50, 220, 500, 100);
                                    ctx.strokeStyle = '#ca8a04';
                                    ctx.strokeRect(50, 220, 500, 100);
                                    
                                    ctx.fillStyle = '#92400e';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.fillText('Common Attack Patterns', 230, 240);
                                    
                                    const attacks = [
                                        '‚Ä¢ Union-based: 1 UNION SELECT * FROM passwords',
                                        '‚Ä¢ Boolean-based: 1 AND 1=1 (true) vs 1 AND 1=2 (false)',
                                        '‚Ä¢ Time-based: 1; SELECT SLEEP(5)--',
                                        '‚Ä¢ Error-based: 1\' (triggers database error)',
                                        '‚Ä¢ Second-order: Stored payloads executed later'
                                    ];
                                    
                                    ctx.font = '10px Arial';
                                    ctx.fillStyle = '#374151';
                                    attacks.forEach((attack, i) =>{
                                        ctx.fillText(attack, 60, 265 + (i * 15));
                                    });
                                    
                                    // Secure Code Section
                                    ctx.fillStyle = '#dcfce7';
                                    ctx.fillRect(50, 340, 500, 140);
                                    ctx.strokeStyle = '#16a34a';
                                    ctx.strokeRect(50, 340, 500, 140);
                                    
                                    ctx.fillStyle = '#166534';
                                    ctx.font = 'bold 14px Arial';
                                    ctx.fillText('‚úÖ SECURE CODE', 60, 365);
                                    
                                    ctx.font = '11px monospace';
                                    ctx.fillStyle = '#374151';
                                    ctx.fillText('$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");', 60, 390);
                                    ctx.fillText('$stmt->execute([$_GET["id"]]);', 60, 410);
                                    ctx.fillText('// Input: 1 OR 1=1', 60, 435);
                                    ctx.fillText('// Treated as: "1 OR 1=1" (string literal)', 60, 455);
                                    ctx.fillStyle = '#16a34a';
                                    ctx.fillText('// Safe! Query looks for id = "1 OR 1=1" ‚úÖ', 60, 470);
                                    
                                    // Impact Box
                                    ctx.fillStyle = '#e0f2fe';
                                    ctx.fillRect(50, 500, 500, 40);
                                    ctx.strokeStyle = '#0891b2';
                                    ctx.strokeRect(50, 500, 500, 40);
                                    
                                    ctx.fillStyle = '#0c4a6e';
                                    ctx.font = '10px Arial';
                                    ctx.fillText('‚ö†Ô∏è Impact: Data breach, data loss, unauthorized access, complete system compromise', 60, 525);</script>
         <div class="alert alert-danger">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div class="alert-content">
           <div class="alert-title">SQL Injection Risks</div>
           <div class="alert-message">SQL injection can lead to:<ul>
             <li>
              <strong>Data Breach:</strong>Attackers can extract sensitive information</li>
             <li>
              <strong>Data Manipulation:</strong>Modify or delete database records</li>
             <li>
              <strong>Authentication Bypass:</strong>Login without credentials</li>
             <li>
              <strong>Remote Code Execution:</strong>Execute system commands</li>
             <li>
              <strong>Complete Takeover:</strong>Gain administrative access</li>
            </ul>
           </div>
          </div>
         </div>
        </section>
        <section>
         <h2>Prepared Statements Deep Dive</h2>
         <div class="mermaid">graph TB
                                        INPUT[User Input] --&gt; PREPARE[Prepare Statement]
                                        
                                        PREPARE --&gt; COMPILE[SQL Compiled]
                                        COMPILE --&gt; PLAN[Execution Plan Created]
                                        
                                        INPUT --&gt; BIND[Bind Parameters]
                                        BIND --&gt; EXECUTE[Execute Statement]
                                        
                                        PLAN --&gt; EXECUTE
                                        
                                        EXECUTE --&gt; SAFE[Safe Execution]
                                        
                                        subgraph "Protection Layer"
                                            BIND --&gt; |"Data separated from code"| SAFE
                                        end
                                        
                                        style INPUT fill:#fee2e2
                                        style PREPARE fill:#dcfce7
                                        style SAFE fill:#dbeafe</div>
         <div class="real_world_example">
          <h3>Complete Prepared Statements Implementation</h3>
          <pre><code class="language-php">&lt;?php
// ========================================
// PDO PREPARED STATEMENTS
// ========================================

class SecurePDODatabase {
    private $pdo;
    private $allowedTables = ['users', 'products', 'orders'];
    private $allowedColumns = [];
    
    public function __construct(PDO $pdo) {
        $this-&gt;pdo = $pdo;
        $this-&gt;initializeAllowedColumns();
    }
    
    /**
     * Initialize allowed columns for each table
     */
    private function initializeAllowedColumns() {
        $this-&gt;allowedColumns = [
            'users' =&gt; ['id', 'username', 'email', 'status', 'created_at'],
            'products' =&gt; ['id', 'name', 'price', 'category', 'stock'],
            'orders' =&gt; ['id', 'user_id', 'total', 'status', 'created_at']
        ];
    }
    
    /**
     * Secure SELECT with prepared statements
     */
    public function secureSelect($table, $conditions = [], $columns = ['*']) {
        // Validate table name (whitelist)
        if (!in_array($table, $this-&gt;allowedTables)) {
            throw new Exception("Invalid table name");
        }
        
        // Validate columns (whitelist)
        $safeColumns = $this-&gt;validateColumns($table, $columns);
        
        // Build query
        $sql = "SELECT " . implode(', ', $safeColumns) . " FROM $table";
        
        // Add WHERE conditions
        if (!empty($conditions)) {
            $whereClauses = [];
            $params = [];
            
            foreach ($conditions as $column =&gt; $value) {
                // Validate column name
                if (!in_array($column, $this-&gt;allowedColumns[$table])) {
                    throw new Exception("Invalid column: $column");
                }
                
                if (is_array($value)) {
                    // Handle IN clause
                    $placeholders = array_fill(0, count($value), '?');
                    $whereClauses[] = "$column IN (" . implode(', ', $placeholders) . ")";
                    $params = array_merge($params, $value);
                } elseif ($value === null) {
                    // Handle NULL
                    $whereClauses[] = "$column IS NULL";
                } else {
                    // Regular condition
                    $whereClauses[] = "$column = ?";
                    $params[] = $value;
                }
            }
            
            $sql .= " WHERE " . implode(' AND ', $whereClauses);
        }
        
        // Prepare and execute
        try {
            $stmt = $this-&gt;pdo-&gt;prepare($sql);
            $stmt-&gt;execute($params);
            
            return $stmt-&gt;fetchAll();
            
        } catch (PDOException $e) {
            $this-&gt;logSecurityEvent('Query failed', [
                'sql' =&gt; $sql,
                'error' =&gt; $e-&gt;getMessage()
            ]);
            throw new Exception("Database query failed");
        }
    }
    
    /**
     * Secure INSERT with type checking
     */
    public function secureInsert($table, array $data) {
        // Validate table
        if (!in_array($table, $this-&gt;allowedTables)) {
            throw new Exception("Invalid table name");
        }
        
        // Validate columns
        $columns = array_keys($data);
        foreach ($columns as $column) {
            if (!in_array($column, $this-&gt;allowedColumns[$table])) {
                throw new Exception("Invalid column: $column");
            }
        }
        
        // Build query
        $placeholders = array_fill(0, count($data), '?');
        
        $sql = "INSERT INTO $table (" . implode(', ', $columns) . ") 
                VALUES (" . implode(', ', $placeholders) . ")";
        
        try {
            $stmt = $this-&gt;pdo-&gt;prepare($sql);
            
            // Bind parameters with type detection
            $i = 1;
            foreach ($data as $value) {
                $type = $this-&gt;getPDOType($value);
                $stmt-&gt;bindValue($i++, $value, $type);
            }
            
            $stmt-&gt;execute();
            
            return [
                'success' =&gt; true,
                'id' =&gt; $this-&gt;pdo-&gt;lastInsertId()
            ];
            
        } catch (PDOException $e) {
            $this-&gt;logSecurityEvent('Insert failed', [
                'table' =&gt; $table,
                'error' =&gt; $e-&gt;getMessage()
            ]);
            throw new Exception("Insert operation failed");
        }
    }
    
    /**
     * Secure UPDATE with strict validation
     */
    public function secureUpdate($table, array $data, array $where) {
        // Validate table
        if (!in_array($table, $this-&gt;allowedTables)) {
            throw new Exception("Invalid table name");
        }
        
        // Validate all columns
        $allColumns = array_merge(array_keys($data), array_keys($where));
        foreach ($allColumns as $column) {
            if (!in_array($column, $this-&gt;allowedColumns[$table])) {
                throw new Exception("Invalid column: $column");
            }
        }
        
        // Build SET clause
        $setClauses = [];
        $params = [];
        
        foreach ($data as $column =&gt; $value) {
            $setClauses[] = "$column = ?";
            $params[] = $value;
        }
        
        // Build WHERE clause
        $whereClauses = [];
        foreach ($where as $column =&gt; $value) {
            $whereClauses[] = "$column = ?";
            $params[] = $value;
        }
        
        $sql = "UPDATE $table SET " . implode(', ', $setClauses) . 
               " WHERE " . implode(' AND ', $whereClauses);
        
        try {
            $stmt = $this-&gt;pdo-&gt;prepare($sql);
            $stmt-&gt;execute($params);
            
            return [
                'success' =&gt; true,
                'affected' =&gt; $stmt-&gt;rowCount()
            ];
            
        } catch (PDOException $e) {
            $this-&gt;logSecurityEvent('Update failed', [
                'table' =&gt; $table,
                'error' =&gt; $e-&gt;getMessage()
            ]);
            throw new Exception("Update operation failed");
        }
    }
    
    /**
     * Secure DELETE with confirmation
     */
    public function secureDelete($table, array $where, $requireConfirmation = true) {
        // Validate table
        if (!in_array($table, $this-&gt;allowedTables)) {
            throw new Exception("Invalid table name");
        }
        
        // Prevent accidental mass deletion
        if (empty($where) &amp;&amp; $requireConfirmation) {
            throw new Exception("Cannot delete without WHERE clause");
        }
        
        // Validate columns
        foreach (array_keys($where) as $column) {
            if (!in_array($column, $this-&gt;allowedColumns[$table])) {
                throw new Exception("Invalid column: $column");
            }
        }
        
        // Build WHERE clause
        $whereClauses = [];
        $params = [];
        
        foreach ($where as $column =&gt; $value) {
            $whereClauses[] = "$column = ?";
            $params[] = $value;
        }
        
        $sql = "DELETE FROM $table WHERE " . implode(' AND ', $whereClauses);
        
        try {
            $stmt = $this-&gt;pdo-&gt;prepare($sql);
            $stmt-&gt;execute($params);
            
            $affected = $stmt-&gt;rowCount();
            
            // Log deletion for audit
            $this-&gt;logSecurityEvent('Data deleted', [
                'table' =&gt; $table,
                'conditions' =&gt; $where,
                'affected' =&gt; $affected
            ]);
            
            return [
                'success' =&gt; true,
                'deleted' =&gt; $affected
            ];
            
        } catch (PDOException $e) {
            $this-&gt;logSecurityEvent('Delete failed', [
                'table' =&gt; $table,
                'error' =&gt; $e-&gt;getMessage()
            ]);
            throw new Exception("Delete operation failed");
        }
    }
    
    /**
     * Execute stored procedure securely
     */
    public function callProcedure($procedure, array $params = []) {
        // Whitelist procedures
        $allowedProcedures = ['GetUserById', 'UpdateInventory', 'ProcessOrder'];
        
        if (!in_array($procedure, $allowedProcedures)) {
            throw new Exception("Invalid procedure");
        }
        
        $placeholders = array_fill(0, count($params), '?');
        $sql = "CALL $procedure(" . implode(', ', $placeholders) . ")";
        
        try {
            $stmt = $this-&gt;pdo-&gt;prepare($sql);
            $stmt-&gt;execute($params);
            
            return $stmt-&gt;fetchAll();
            
        } catch (PDOException $e) {
            $this-&gt;logSecurityEvent('Procedure failed', [
                'procedure' =&gt; $procedure,
                'error' =&gt; $e-&gt;getMessage()
            ]);
            throw new Exception("Procedure execution failed");
        }
    }
    
    /**
     * Validate columns against whitelist
     */
    private function validateColumns($table, $columns) {
        if ($columns === ['*']) {
            return $columns;
        }
        
        $validColumns = [];
        foreach ($columns as $column) {
            if (!in_array($column, $this-&gt;allowedColumns[$table])) {
                throw new Exception("Invalid column: $column");
            }
            $validColumns[] = $column;
        }
        
        return $validColumns;
    }
    
    /**
     * Get PDO parameter type
     */
    private function getPDOType($value) {
        if (is_null($value)) {
            return PDO::PARAM_NULL;
        } elseif (is_bool($value)) {
            return PDO::PARAM_BOOL;
        } elseif (is_int($value)) {
            return PDO::PARAM_INT;
        } else {
            return PDO::PARAM_STR;
        }
    }
    
    /**
     * Log security events
     */
    private function logSecurityEvent($event, $data) {
        $logEntry = [
            'timestamp' =&gt; date('Y-m-d H:i:s'),
            'event' =&gt; $event,
            'data' =&gt; $data,
            'ip' =&gt; $_SERVER['REMOTE_ADDR'] ?? 'CLI',
            'user' =&gt; $_SESSION['user_id'] ?? 'anonymous'
        ];
        
        error_log(json_encode($logEntry), 3, '/var/log/security.log');
    }
}

// ========================================
// MYSQLI PREPARED STATEMENTS
// ========================================

class SecureMySQLiDatabase {
    private $mysqli;
    private $typeMap = [];
    
    public function __construct(mysqli $mysqli) {
        $this-&gt;mysqli = $mysqli;
    }
    
    /**
     * Secure query with automatic type detection
     */
    public function secureQuery($sql, array $params = []) {
        // Check for dangerous patterns
        if ($this-&gt;containsDangerousSQL($sql)) {
            throw new Exception("Potentially dangerous SQL detected");
        }
        
        $stmt = $this-&gt;mysqli-&gt;prepare($sql);
        
        if (!$stmt) {
            throw new Exception("Prepare failed: " . $this-&gt;mysqli-&gt;error);
        }
        
        if (!empty($params)) {
            // Build type string
            $types = $this-&gt;buildTypeString($params);
            
            // Bind parameters
            $stmt-&gt;bind_param($types, ...$params);
        }
        
        if (!$stmt-&gt;execute()) {
            throw new Exception("Execute failed: " . $stmt-&gt;error);
        }
        
        // Get result if SELECT query
        if (stripos($sql, 'SELECT') === 0) {
            $result = $stmt-&gt;get_result();
            $data = [];
            
            while ($row = $result-&gt;fetch_assoc()) {
                $data[] = $row;
            }
            
            $stmt-&gt;close();
            return $data;
        }
        
        // Return affected rows for other queries
        $affected = $stmt-&gt;affected_rows;
        $stmt-&gt;close();
        
        return ['affected' =&gt; $affected];
    }
    
    /**
     * Build type string for mysqli
     */
    private function buildTypeString(array $params) {
        $types = '';
        
        foreach ($params as $param) {
            if (is_int($param)) {
                $types .= 'i';
            } elseif (is_float($param)) {
                $types .= 'd';
            } elseif (is_string($param)) {
                $types .= 's';
            } else {
                $types .= 'b'; // blob
            }
        }
        
        return $types;
    }
    
    /**
     * Check for dangerous SQL patterns
     */
    private function containsDangerousSQL($sql) {
        $dangerous = [
            '/DROP\s+TABLE/i',
            '/DROP\s+DATABASE/i',
            '/TRUNCATE/i',
            '/DELETE\s+FROM\s+\w+\s*$/i', // DELETE without WHERE
            '/UPDATE\s+\w+\s+SET\s+[^W]+$/i', // UPDATE without WHERE
            '/;.*--;?/i', // Multiple statements
            '/UNION.*SELECT/i', // UNION without proper context
            '/INTO\s+OUTFILE/i', // File operations
            '/LOAD_FILE/i'
        ];
        
        foreach ($dangerous as $pattern) {
            if (preg_match($pattern, $sql)) {
                return true;
            }
        }
        
        return false;
    }
}

// ========================================
// INPUT VALIDATION &amp; SANITIZATION
// ========================================

class InputValidator {
    
    /**
     * Validate and sanitize input
     */
    public static function validate($input, $type, $options = []) {
        switch ($type) {
            case 'int':
                return self::validateInt($input, $options);
                
            case 'float':
                return self::validateFloat($input, $options);
                
            case 'email':
                return self::validateEmail($input);
                
            case 'url':
                return self::validateUrl($input);
                
            case 'alphanumeric':
                return self::validateAlphanumeric($input, $options);
                
            case 'date':
                return self::validateDate($input, $options);
                
            case 'phone':
                return self::validatePhone($input);
                
            case 'uuid':
                return self::validateUuid($input);
                
            default:
                return self::validateString($input, $options);
        }
    }
    
    /**
     * Validate integer
     */
    private static function validateInt($input, $options = []) {
        $filtered = filter_var($input, FILTER_VALIDATE_INT);
        
        if ($filtered === false) {
            throw new ValidationException("Invalid integer");
        }
        
        // Check range
        if (isset($options['min']) &amp;&amp; $filtered &lt; $options['min']) {
            throw new ValidationException("Value below minimum");
        }
        
        if (isset($options['max']) &amp;&amp; $filtered &gt; $options['max']) {
            throw new ValidationException("Value above maximum");
        }
        
        return $filtered;
    }
    
    /**
     * Validate float
     */
    private static function validateFloat($input, $options = []) {
        $filtered = filter_var($input, FILTER_VALIDATE_FLOAT);
        
        if ($filtered === false) {
            throw new ValidationException("Invalid float");
        }
        
        return $filtered;
    }
    
    /**
     * Validate email
     */
    private static function validateEmail($input) {
        $filtered = filter_var($input, FILTER_VALIDATE_EMAIL);
        
        if ($filtered === false) {
            throw new ValidationException("Invalid email address");
        }
        
        // Additional checks
        if (!checkdnsrr(substr(strrchr($filtered, "@"), 1), 'MX')) {
            throw new ValidationException("Email domain does not exist");
        }
        
        return $filtered;
    }
    
    /**
     * Validate URL
     */
    private static function validateUrl($input) {
        $filtered = filter_var($input, FILTER_VALIDATE_URL);
        
        if ($filtered === false) {
            throw new ValidationException("Invalid URL");
        }
        
        // Check allowed protocols
        $allowedProtocols = ['http', 'https'];
        $protocol = parse_url($filtered, PHP_URL_SCHEME);
        
        if (!in_array($protocol, $allowedProtocols)) {
            throw new ValidationException("Invalid URL protocol");
        }
        
        return $filtered;
    }
    
    /**
     * Validate alphanumeric
     */
    private static function validateAlphanumeric($input, $options = []) {
        $allowSpaces = $options['allow_spaces'] ?? false;
        $pattern = $allowSpaces ? '/^[a-zA-Z0-9\s]+$/' : '/^[a-zA-Z0-9]+$/';
        
        if (!preg_match($pattern, $input)) {
            throw new ValidationException("Invalid alphanumeric value");
        }
        
        return $input;
    }
    
    /**
     * Validate date
     */
    private static function validateDate($input, $options = []) {
        $format = $options['format'] ?? 'Y-m-d';
        $date = DateTime::createFromFormat($format, $input);
        
        if (!$date || $date-&gt;format($format) !== $input) {
            throw new ValidationException("Invalid date format");
        }
        
        return $input;
    }
    
    /**
     * Validate phone number
     */
    private static function validatePhone($input) {
        // Remove non-numeric characters
        $phone = preg_replace('/[^0-9]/', '', $input);
        
        // Check length (adjust for your country)
        if (strlen($phone) &lt; 10 || strlen($phone) &gt; 15) {
            throw new ValidationException("Invalid phone number");
        }
        
        return $phone;
    }
    
    /**
     * Validate UUID
     */
    private static function validateUuid($input) {
        $pattern = '/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i';
        
        if (!preg_match($pattern, $input)) {
            throw new ValidationException("Invalid UUID");
        }
        
        return $input;
    }
    
    /**
     * Validate string with sanitization
     */
    private static function validateString($input, $options = []) {
        $minLength = $options['min_length'] ?? 0;
        $maxLength = $options['max_length'] ?? PHP_INT_MAX;
        $allowHtml = $options['allow_html'] ?? false;
        
        // Remove null bytes
        $input = str_replace(chr(0), '', $input);
        
        // Trim whitespace
        $input = trim($input);
        
        // Check length
        if (strlen($input) &lt; $minLength) {
            throw new ValidationException("String too short");
        }
        
        if (strlen($input) &gt; $maxLength) {
            throw new ValidationException("String too long");
        }
        
        // Sanitize HTML
        if (!$allowHtml) {
            $input = htmlspecialchars($input, ENT_QUOTES, 'UTF-8');
        } else {
            // Allow only safe HTML tags
            $allowedTags = '<p><br/><strong><em><u><a><ul><ol><li>';
            $input = strip_tags($input, $allowedTags);
        }
        
        return $input;
    }
}

class ValidationException extends Exception {}

// ========================================
// USAGE EXAMPLES
// ========================================

// PDO Example
$pdo = new PDO('mysql:host=localhost;dbname=test', 'user', 'pass');
$db = new SecurePDODatabase($pdo);

// Secure SELECT
try {
    $users = $db-&gt;secureSelect('users', [
        'status' =&gt; 'active',
        'role' =&gt; ['admin', 'moderator']
    ], ['id', 'username', 'email']);
    
} catch (Exception $e) {
    echo "Query failed: " . $e-&gt;getMessage();
}

// Secure INSERT with validation
try {
    $email = InputValidator::validate($_POST['email'], 'email');
    $age = InputValidator::validate($_POST['age'], 'int', ['min' =&gt; 18, 'max' =&gt; 120]);
    
    $result = $db-&gt;secureInsert('users', [
        'email' =&gt; $email,
        'age' =&gt; $age,
        'created_at' =&gt; date('Y-m-d H:i:s')
    ]);
    
    echo "User created with ID: " . $result['id'];
    
} catch (ValidationException $e) {
    echo "Validation error: " . $e-&gt;getMessage();
} catch (Exception $e) {
    echo "Database error: " . $e-&gt;getMessage();
}

// MySQLi Example
$mysqli = new mysqli('localhost', 'user', 'pass', 'test');
$db = new SecureMySQLiDatabase($mysqli);

// Secure query
$result = $db-&gt;secureQuery(
    "SELECT * FROM products WHERE price &gt; ? AND category = ?",
    [29.99, 'electronics']
);

print_r($result);</li></ol></ul></a></u></em></strong></p></code></pre>
         </div>
        </section>
        <section>
         <h2>Security Testing and Auditing</h2>
         <div class="best_practice">
          <h3>Security Testing Framework</h3>
          <pre><code class="language-php">&lt;?php
// ========================================
// SECURITY TESTING SUITE
// ========================================

class SQLInjectionTester {
    private $testPayloads = [
        // Basic injection attempts
        "' OR '1'='1",
        "1' OR '1' = '1",
        "' OR 1=1--",
        "' OR 'a'='a",
        "' OR ''='",
        
        // Union-based
        "' UNION SELECT * FROM users--",
        "1 UNION SELECT null, version()--",
        
        // Boolean-based
        "1' AND '1'='1",
        "1' AND '1'='2",
        
        // Time-based
        "1' AND SLEEP(5)--",
        "1'; WAITFOR DELAY '0:0:5'--",
        
        // Error-based
        "1'",
        "\\",
        "'\"",
        
        // Stacked queries
        "1'; DROP TABLE users--",
        "1'; DELETE FROM users--",
        
        // Out-of-band
        "1' AND LOAD_FILE('/etc/passwd')--",
        
        // Second-order
        "admin'--",
        
        // NoSQL injection (for MongoDB)
        '{"$ne": ""}',
        '{"$gt": ""}',
        
        // XML injection
        "' or count(//user[userid=$userid])&gt;0 or 'a'='b"
    ];
    
    /**
     * Test function for SQL injection vulnerabilities
     */
    public function testFunction(callable $function, $paramName = 'input') {
        $results = [];
        
        foreach ($this-&gt;testPayloads as $payload) {
            try {
                // Test the function with payload
                $result = $function([$paramName =&gt; $payload]);
                
                // Analyze result
                $analysis = $this-&gt;analyzeResult($result, $payload);
                
                $results[] = [
                    'payload' =&gt; $payload,
                    'vulnerable' =&gt; $analysis['vulnerable'],
                    'reason' =&gt; $analysis['reason']
                ];
                
            } catch (Exception $e) {
                // Error might indicate protection
                $results[] = [
                    'payload' =&gt; $payload,
                    'vulnerable' =&gt; false,
                    'reason' =&gt; 'Exception thrown (likely protected)'
                ];
            }
        }
        
        return $results;
    }
    
    /**
     * Analyze result for signs of injection
     */
    private function analyzeResult($result, $payload) {
        // Check for unexpected data volume
        if (is_array($result) &amp;&amp; count($result) &gt; 100) {
            return [
                'vulnerable' =&gt; true,
                'reason' =&gt; 'Returned excessive data'
            ];
        }
        
        // Check for database errors in result
        if (is_string($result)) {
            $errorPatterns = [
                '/SQL syntax/',
                '/mysql_fetch/',
                '/Warning.*mysql/',
                '/mysqli::/',
                '/PDO::/',
                '/PostgreSQL/',
                '/valid MySQL result/',
                '/mssql_/',
                '/Microsoft.*ODBC.*SQL/',
                '/Oracle.*error/',
                '/SQLite.*error/'
            ];
            
            foreach ($errorPatterns as $pattern) {
                if (preg_match($pattern, $result)) {
                    return [
                        'vulnerable' =&gt; true,
                        'reason' =&gt; 'Database error exposed'
                    ];
                }
            }
        }
        
        // Check for successful bypass indicators
        if (strpos($payload, 'OR') !== false &amp;&amp; !empty($result)) {
            return [
                'vulnerable' =&gt; 'possible',
                'reason' =&gt; 'OR condition might have bypassed filter'
            ];
        }
        
        return [
            'vulnerable' =&gt; false,
            'reason' =&gt; 'No injection detected'
        ];
    }
    
    /**
     * Generate security report
     */
    public function generateReport($results) {
        $vulnerable = 0;
        $protected = 0;
        $warnings = [];
        
        foreach ($results as $result) {
            if ($result['vulnerable'] === true) {
                $vulnerable++;
                $warnings[] = "CRITICAL: Vulnerable to: {$result['payload']}";
            } elseif ($result['vulnerable'] === 'possible') {
                $warnings[] = "WARNING: Possible vulnerability: {$result['payload']}";
            } else {
                $protected++;
            }
        }
        
        return [
            'total_tests' =&gt; count($results),
            'vulnerabilities' =&gt; $vulnerable,
            'protected' =&gt; $protected,
            'security_score' =&gt; round(($protected / count($results)) * 100, 2),
            'warnings' =&gt; $warnings,
            'recommendation' =&gt; $vulnerable &gt; 0 ? 
                'URGENT: Fix SQL injection vulnerabilities immediately!' : 
                'Good protection detected, continue monitoring'
        ];
    }
}

// ========================================
// SECURITY AUDIT LOGGER
// ========================================

class SecurityAuditLogger {
    private $logFile;
    
    public function __construct($logFile = '/var/log/security_audit.log') {
        $this-&gt;logFile = $logFile;
    }
    
    /**
     * Log query execution
     */
    public function logQuery($sql, $params, $user, $result) {
        $entry = [
            'timestamp' =&gt; date('Y-m-d H:i:s'),
            'user' =&gt; $user,
            'ip' =&gt; $_SERVER['REMOTE_ADDR'] ?? 'unknown',
            'sql' =&gt; $sql,
            'params' =&gt; $params,
            'result' =&gt; $result ? 'success' : 'failed',
            'checksum' =&gt; $this-&gt;generateChecksum($sql, $params)
        ];
        
        $this-&gt;writeLog($entry);
    }
    
    /**
     * Log suspicious activity
     */
    public function logSuspiciousActivity($activity, $details) {
        $entry = [
            'timestamp' =&gt; date('Y-m-d H:i:s'),
            'type' =&gt; 'SUSPICIOUS',
            'activity' =&gt; $activity,
            'details' =&gt; $details,
            'ip' =&gt; $_SERVER['REMOTE_ADDR'] ?? 'unknown',
            'user_agent' =&gt; $_SERVER['HTTP_USER_AGENT'] ?? 'unknown',
            'alert_level' =&gt; $this-&gt;determineAlertLevel($activity)
        ];
        
        $this-&gt;writeLog($entry);
        
        // Send immediate alert for critical issues
        if ($entry['alert_level'] === 'CRITICAL') {
            $this-&gt;sendAlert($entry);
        }
    }
    
    /**
     * Determine alert level
     */
    private function determineAlertLevel($activity) {
        $criticalPatterns = [
            'SQL injection attempt',
            'Mass deletion attempt',
            'Privilege escalation',
            'Data exfiltration'
        ];
        
        foreach ($criticalPatterns as $pattern) {
            if (stripos($activity, $pattern) !== false) {
                return 'CRITICAL';
            }
        }
        
        return 'WARNING';
    }
    
    /**
     * Generate checksum for integrity
     */
    private function generateChecksum($sql, $params) {
        return hash('sha256', $sql . serialize($params));
    }
    
    /**
     * Write to log file
     */
    private function writeLog($entry) {
        $json = json_encode($entry) . PHP_EOL;
        file_put_contents($this-&gt;logFile, $json, FILE_APPEND | LOCK_EX);
    }
    
    /**
     * Send security alert
     */
    private function sendAlert($entry) {
        // Email alert
        $to = 'security@example.com';
        $subject = 'CRITICAL Security Alert';
        $message = "Critical security event detected:\n\n" . print_r($entry, true);
        
        mail($to, $subject, $message);
        
        // You could also send to:
        // - Slack webhook
        // - SMS via Twilio
        // - PagerDuty
        // - Security Information and Event Management (SIEM) system
    }
    
    /**
     * Analyze logs for patterns
     */
    public function analyzeLogs($hours = 24) {
        $logs = file($this-&gt;logFile, FILE_IGNORE_NEW_LINES);
        $cutoff = time() - ($hours * 3600);
        
        $analysis = [
            'failed_queries' =&gt; 0,
            'suspicious_activities' =&gt; 0,
            'unique_ips' =&gt; [],
            'attack_patterns' =&gt; []
        ];
        
        foreach ($logs as $log) {
            $entry = json_decode($log, true);
            
            if (strtotime($entry['timestamp']) &lt; $cutoff) {
                continue;
            }
            
            if (isset($entry['result']) &amp;&amp; $entry['result'] === 'failed') {
                $analysis['failed_queries']++;
            }
            
            if (isset($entry['type']) &amp;&amp; $entry['type'] === 'SUSPICIOUS') {
                $analysis['suspicious_activities']++;
                $analysis['attack_patterns'][] = $entry['activity'];
            }
            
            if (isset($entry['ip'])) {
                $analysis['unique_ips'][$entry['ip']] = 
                    ($analysis['unique_ips'][$entry['ip']] ?? 0) + 1;
            }
        }
        
        return $analysis;
    }
}

// ========================================
// USAGE EXAMPLES
// ========================================

// Test a function for SQL injection
$tester = new SQLInjectionTester();

// Example vulnerable function (DO NOT USE IN PRODUCTION)
$vulnerableFunction = function($params) use ($pdo) {
    $id = $params['input'];
    $sql = "SELECT * FROM users WHERE id = $id"; // VULNERABLE!
    return $pdo-&gt;query($sql)-&gt;fetchAll();
};

// Example secure function
$secureFunction = function($params) use ($pdo) {
    $stmt = $pdo-&gt;prepare("SELECT * FROM users WHERE id = ?");
    $stmt-&gt;execute([$params['input']]);
    return $stmt-&gt;fetchAll();
};

// Test and compare
echo "Testing vulnerable function:\n";
$results = $tester-&gt;testFunction($vulnerableFunction);
$report = $tester-&gt;generateReport($results);
print_r($report);

echo "\nTesting secure function:\n";
$results = $tester-&gt;testFunction($secureFunction);
$report = $tester-&gt;generateReport($results);
print_r($report);

// Security audit logging
$auditLogger = new SecurityAuditLogger();

// Log queries
$auditLogger-&gt;logQuery(
    "SELECT * FROM users WHERE id = ?",
    [123],
    $_SESSION['username'] ?? 'anonymous',
    true
);

// Log suspicious activity
$auditLogger-&gt;logSuspiciousActivity(
    "SQL injection attempt detected",
    [
        'query' =&gt; $_GET['search'] ?? '',
        'pattern_matched' =&gt; "' OR '1'='1"
    ]
);

// Analyze logs
$analysis = $auditLogger-&gt;analyzeLogs(24);
echo "Security analysis for last 24 hours:\n";
print_r($analysis);</code></pre>
         </div>
        </section>
        <!-- Practice Exercise -->
        <section>
         <h2>Practice Exercise</h2>
         <div class="alert alert-success">
          <div class="alert-icon">üíª</div>
          <div class="alert-content">
           <div class="alert-title">Security Implementation Challenges</div>
           <div class="alert-message">Complete these security tasks:<ol>
             <li>Convert vulnerable code to use prepared statements</li>
             <li>Implement input validation for a user registration form</li>
             <li>Create a whitelist system for dynamic table/column names</li>
             <li>Build a SQL injection testing suite</li>
             <li>Implement query logging and auditing</li>
             <li>Create a security monitoring dashboard</li>
             <li>Build rate limiting for database queries</li>
             <li>Implement database firewall rules</li>
            </ol>
           </div>
          </div>
         </div>
        </section>
        <!-- Resources -->
        <section class="resources">
         <h2>Additional Resources</h2>
         <ul>
          <li>
           <a href="https://owasp.org/www-community/attacks/SQL_Injection" target="_blank">OWASP SQL Injection Guide</a>
          </li>
          <li>
           <a href="https://www.php.net/manual/en/pdo.prepared-statements.php" target="_blank">PDO Prepared Statements</a>
          </li>
          <li>
           <a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html" target="_blank">SQL Injection Prevention Cheat Sheet</a>
          </li>
          <li>
           <a href="https://portswigger.net/web-security/sql-injection" target="_blank">PortSwigger SQL Injection Tutorial</a>
          </li>
          <li>
           <a href="https://www.php.net/manual/en/security.database.sql-injection.php" target="_blank">PHP SQL Injection Prevention</a>
          </li>
         </ul>
        </section>
       </div>
       <!-- Lesson Navigation -->
       <div class="lesson-navigation">
        <a class="lesson-nav-button prev" href="/03module/executing_queries.html">
         <svg fill="currentColor" height="20" viewbox="0 0 20 20" width="20">
          <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z">
          </path>
         </svg>
         <span>
          <small>Previous</small>
          <br/>Executing Queries</span>
        </a>
        <button class="complete-lesson-btn">Mark as Complete</button>
        <a class="lesson-nav-button next" href="/03module/crud_operations.html">
         <span>
          <small>Next</small>
          <br/>CRUD Operations</span>
         <svg fill="currentColor" height="20" viewbox="0 0 20 20" width="20">
          <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z">
          </path>
         </svg>
        </a>
       </div>
      </article>
     </div>
    </div>
   </main>
   <!-- Footer -->
   <footer class="site-footer" role="contentinfo">
    <div class="footer-container">
     <div class="footer-content">
      <div class="footer-section footer-about">
       <h3>PHP WordPress Development</h3>
       <p>Complete Web Development Course</p>
      </div>
      <div class="footer-section">
       <h4>Quick Links</h4>
       <ul class="footer-links">
        <li>
         <a href="/">Home</a>
        </li>
        <li>
         <a class="active" href="/module3.html">Module 3</a>
        </li>
        <li>
         <a href="/resources.html">Resources</a>
        </li>
       </ul>
      </div>
      <div class="footer-section">
       <h4>Support</h4>
       <ul class="footer-links">
        <li>
         <a href="/help.html">Help Center</a>
        </li>
        <li>
         <a href="/faq.html">FAQ</a>
        </li>
        <li>
         <a href="/contact.html">Contact</a>
        </li>
       </ul>
      </div>
     </div>
     <div class="footer-bottom">
      <div class="footer-bottom-content">
       <p class="copyright">¬© 2025 PHP WordPress Development Course</p>
       <nav class="footer-bottom-links">
        <a href="/privacy.html">Privacy</a>
        <span class="separator">|</span>
        <a href="/terms.html">Terms</a>
       </nav>
      </div>
     </div>
    </div>
   </footer>
  </div>
  <!-- Back to Top -->
  <button aria-label="Back to top" class="back-to-top" id="back-to-top">
   <svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
    <path d="M12 19V5M12 5l-7 7M12 5l7 7">
    </path>
   </svg>
  </button>
  <!-- JavaScript -->
  <script src="/assets/js/navigation.js">
  </script>
  <script src="/assets/js/site-config.js">
  </script>
  <script src="/assets/js/sidebar-toggle.js">
  </script>
  <!-- Universal Mermaid Fix (Enhanced) -->
  <!-- Universal Mermaid Fix -->
  <script src="/assets/js/mermaid-universal-fix.js">
  </script>
 </body>
</html>
