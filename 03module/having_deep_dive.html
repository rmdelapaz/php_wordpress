<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>HAVING Clause Deep Dive - Advanced Group Filtering - PHP WordPress Course</title>
    <meta name="description" content="Master the HAVING clause for filtering grouped data, complex conditions, and advanced SQL patterns">
    <meta name="keywords" content="PHP, WordPress, MySQL, HAVING clause, GROUP BY, aggregate filtering, SQL">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Mermaid for diagrams -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item active">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module3.html">Module 3</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">HAVING Clause Deep Dive</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <div class="content-with-sidebar">
                    <!-- Sidebar -->
                    <aside class="sidebar">
                        <div class="sidebar-nav">
                            <h3 class="sidebar-title">Module 3: Session 4</h3>
                            <div class="sidebar-section">
                                <h4 class="sidebar-section-title">Advanced SQL</h4>
                                <a href="/module3.html" class="sidebar-link">Module Overview</a>
                                <a href="/03module/sql_joins.html" class="sidebar-link">SQL JOINs</a>
                                <a href="/03module/aggregate_functions.html" class="sidebar-link">Aggregate Functions</a>
                                <a href="/03module/group_by_having.html" class="sidebar-link">GROUP BY & HAVING</a>
                                <a href="/03module/having_deep_dive.html" class="sidebar-link active">HAVING Deep Dive</a>
                                <a href="/03module/subqueries.html" class="sidebar-link">Subqueries</a>
                                <a href="/03module/window_functions.html" class="sidebar-link">Window Functions</a>
                                <a href="/03module/homework_advanced_sql.html" class="sidebar-link">Homework</a>
                            </div>
                        </div>
                    </aside>
                    
                    <!-- Main Lesson Content -->
                    <article class="lesson-content">
                        <header class="lesson-header">
                            <h1>HAVING Clause Deep Dive</h1>
                            <div class="lesson-meta">
                                <div class="lesson-meta-item">
                                    <svg width="20" height="20" fill="currentColor">
                                        <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span>Duration: 75 minutes</span>
                                </div>
                                <div class="lesson-meta-item">
                                    <svg width="20" height="20" fill="currentColor">
                                        <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                                    </svg>
                                    <span>Module 3: Advanced Topic</span>
                                </div>
                            </div>
                        </header>

                        <!-- Learning Objectives -->
                        <div class="lesson-objectives">
                            <h2>Learning Objectives</h2>
                            <ul>
                                <li>Master HAVING clause mechanics and execution timing</li>
                                <li>Understand HAVING vs WHERE in depth</li>
                                <li>Use complex aggregate conditions in HAVING</li>
                                <li>Implement subqueries within HAVING</li>
                                <li>Apply HAVING with window functions</li>
                                <li>Optimize HAVING clause performance</li>
                                <li>Handle edge cases and common pitfalls</li>
                                <li>Build complex analytical queries with HAVING</li>
                            </ul>
                        </div>
                        
                        <!-- Lesson Body -->
                        <div class="lesson-body">
                            <section>
                                <h2>HAVING Clause Mechanics</h2>
                                <p class="lead">HAVING is SQL's post-grouping filter, allowing you to filter aggregated results after GROUP BY has created groups! üéØ</p>
                                
                                <canvas id="havingFlowCanvas" width="600" height="500"></canvas>
                                <script>
                                    const ctx = document.getElementById('havingFlowCanvas').getContext('2d');
                                    
                                    // Title
                                    ctx.font = 'bold 18px Arial';
                                    ctx.fillStyle = '#1f2937';
                                    ctx.fillText('Complete Query Execution Pipeline', 180, 30);
                                    
                                    // Draw pipeline boxes
                                    const pipeline = [
                                        { step: '1. FROM/JOIN', desc: 'Get base data', y: 60, color: '#f3f4f6', rows: '1000 rows' },
                                        { step: '2. WHERE', desc: 'Filter rows', y: 120, color: '#dbeafe', rows: '500 rows' },
                                        { step: '3. GROUP BY', desc: 'Create groups', y: 180, color: '#dcfce7', rows: '50 groups' },
                                        { step: '4. HAVING', desc: 'Filter groups', y: 240, color: '#fef3c7', rows: '20 groups' },
                                        { step: '5. SELECT', desc: 'Choose columns', y: 300, color: '#fee2e2', rows: '20 rows' },
                                        { step: '6. ORDER BY', desc: 'Sort results', y: 360, color: '#e9d5ff', rows: '20 rows' },
                                        { step: '7. LIMIT', desc: 'Limit rows', y: 420, color: '#e0f2fe', rows: '10 rows' }
                                    ];
                                    
                                    pipeline.forEach((item, index) => {
                                        // Box
                                        ctx.fillStyle = item.color;
                                        ctx.fillRect(150, item.y, 300, 50);
                                        ctx.strokeStyle = '#6b7280';
                                        ctx.lineWidth = 1;
                                        ctx.strokeRect(150, item.y, 300, 50);
                                        
                                        // Highlight HAVING
                                        if (index === 3) {
                                            ctx.strokeStyle = '#ca8a04';
                                            ctx.lineWidth = 3;
                                            ctx.strokeRect(150, item.y, 300, 50);
                                        }
                                        
                                        // Step text
                                        ctx.fillStyle = index === 3 ? '#92400e' : '#1f2937';
                                        ctx.font = index === 3 ? 'bold 12px Arial' : '12px Arial';
                                        ctx.fillText(item.step, 160, item.y + 20);
                                        
                                        // Description
                                        ctx.fillStyle = '#6b7280';
                                        ctx.font = '10px Arial';
                                        ctx.fillText(item.desc, 160, item.y + 35);
                                        
                                        // Row count
                                        ctx.fillStyle = '#16a34a';
                                        ctx.font = 'bold 10px Arial';
                                        ctx.fillText(item.rows, 360, item.y + 28);
                                        
                                        // Arrow
                                        if (index < pipeline.length - 1) {
                                            ctx.strokeStyle = '#9ca3af';
                                            ctx.lineWidth = 2;
                                            ctx.beginPath();
                                            ctx.moveTo(300, item.y + 50);
                                            ctx.lineTo(300, item.y + 60);
                                            ctx.stroke();
                                            
                                            // Arrow head
                                            ctx.beginPath();
                                            ctx.moveTo(295, item.y + 57);
                                            ctx.lineTo(300, item.y + 60);
                                            ctx.lineTo(305, item.y + 57);
                                            ctx.stroke();
                                        }
                                    });
                                    
                                    // Key insight
                                    ctx.fillStyle = '#dc2626';
                                    ctx.font = 'bold 11px Arial';
                                    ctx.fillText('‚ö° HAVING can only reference grouped columns or aggregates!', 100, 470);
                                </script>
                                
                                <div class="alert alert-info">
                                    <div class="alert-icon">üí°</div>
                                    <div class="alert-content">
                                        <div class="alert-title">HAVING Key Concepts</div>
                                        <div class="alert-message">
                                            <ul>
                                                <li>HAVING filters AFTER grouping is complete</li>
                                                <li>Can reference aggregate functions (COUNT, SUM, AVG, etc.)</li>
                                                <li>Can reference columns in GROUP BY clause</li>
                                                <li>Cannot reference ungrouped, non-aggregate columns</li>
                                                <li>Executes before SELECT column aliases are available</li>
                                                <li>More expensive than WHERE (processes grouped data)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h2>HAVING vs WHERE: Deep Comparison</h2>
                                
                                <div class="mermaid">
                                    graph TB
                                        FILTER[Filtering Data] --> WHERE[WHERE Clause]
                                        FILTER --> HAVING[HAVING Clause]
                                        
                                        WHERE --> W1[Pre-aggregation]
                                        WHERE --> W2[Row-level]
                                        WHERE --> W3[No aggregates]
                                        WHERE --> W4[More efficient]
                                        
                                        HAVING --> H1[Post-aggregation]
                                        HAVING --> H2[Group-level]
                                        HAVING --> H3[Uses aggregates]
                                        HAVING --> H4[Processes less data]
                                        
                                        style FILTER fill:#dcfce7
                                        style WHERE fill:#dbeafe
                                        style HAVING fill:#fef3c7
                                </div>
                                
                                <div class="real_world_example">
                                    <h3>WHERE vs HAVING Examples</h3>
                                    
                                    <pre><code class="language-sql">-- ========================================
-- COMPARING WHERE AND HAVING
-- ========================================

-- Wrong: Cannot use aggregate in WHERE
-- This will cause an error:
-- SELECT category, COUNT(*)
-- FROM products
-- WHERE COUNT(*) > 10  -- ERROR!
-- GROUP BY category;

-- Correct: Use HAVING for aggregate conditions
SELECT category, COUNT(*)
FROM products
GROUP BY category
HAVING COUNT(*) > 10;

-- ========================================
-- OPTIMAL FILTERING STRATEGY
-- ========================================

-- Inefficient: Filtering after grouping
SELECT 
    customer_id,
    COUNT(*) as order_count,
    SUM(amount) as total_spent
FROM orders
GROUP BY customer_id
HAVING customer_id IN (
    SELECT customer_id 
    FROM customers 
    WHERE country = 'USA'
);

-- Efficient: Filter before grouping
SELECT 
    o.customer_id,
    COUNT(*) as order_count,
    SUM(o.amount) as total_spent
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE c.country = 'USA'  -- Filter early!
GROUP BY o.customer_id;

-- ========================================
-- COMBINED WHERE AND HAVING
-- ========================================

-- Complex filtering at both levels
SELECT 
    DATE_FORMAT(o.order_date, '%Y-%m') as month,
    c.customer_segment,
    COUNT(DISTINCT o.customer_id) as unique_customers,
    COUNT(o.order_id) as total_orders,
    SUM(o.amount) as revenue,
    AVG(o.amount) as avg_order_value
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
WHERE 
    -- Row-level filters (WHERE)
    o.status = 'completed'
    AND o.order_date >= '2024-01-01'
    AND c.is_active = TRUE
GROUP BY 
    DATE_FORMAT(o.order_date, '%Y-%m'),
    c.customer_segment
HAVING 
    -- Group-level filters (HAVING)
    COUNT(DISTINCT o.customer_id) >= 10  -- At least 10 customers
    AND SUM(o.amount) > 5000             -- Revenue threshold
    AND AVG(o.amount) > 100              -- Average order threshold
ORDER BY month DESC, revenue DESC;

-- ========================================
-- EDGE CASE: Column in both WHERE and HAVING
-- ========================================

-- You can reference grouped columns in HAVING
SELECT 
    category,
    brand,
    COUNT(*) as product_count,
    AVG(price) as avg_price
FROM products
WHERE 
    category IN ('Electronics', 'Computers')  -- Pre-filter categories
GROUP BY category, brand
HAVING 
    category = 'Electronics'  -- Valid! category is in GROUP BY
    AND COUNT(*) > 5
    AND AVG(price) > 500;</code></pre>
                                </div>
                            </section>

                            <section>
                                <h2>Complex HAVING Conditions</h2>
                                
                                <canvas id="complexHavingCanvas" width="600" height="400"></canvas>
                                <script>
                                    const chCtx = document.getElementById('complexHavingCanvas').getContext('2d');
                                    
                                    // Title
                                    chCtx.font = 'bold 16px Arial';
                                    chCtx.fillStyle = '#1f2937';
                                    chCtx.fillText('Complex HAVING Patterns', 200, 30);
                                    
                                    // Pattern boxes
                                    const patterns = [
                                        { 
                                            title: 'Multiple Aggregates',
                                            example: 'HAVING COUNT(*) > 10\n  AND SUM(amount) > 1000\n  AND AVG(rating) >= 4.0',
                                            x: 50, y: 60, width: 250, color: '#dbeafe'
                                        },
                                        { 
                                            title: 'Calculated Conditions',
                                            example: 'HAVING MAX(price) - MIN(price) > 100\n  AND SUM(quantity) / COUNT(*) > 5',
                                            x: 320, y: 60, width: 250, color: '#dcfce7'
                                        },
                                        { 
                                            title: 'Subquery Comparisons',
                                            example: 'HAVING AVG(salary) > (\n  SELECT AVG(salary) * 1.2\n  FROM employees\n)',
                                            x: 50, y: 180, width: 250, color: '#fef3c7'
                                        },
                                        { 
                                            title: 'Statistical Filters',
                                            example: 'HAVING STD(amount) < AVG(amount) * 0.3\n  AND VARIANCE(score) < 100',
                                            x: 320, y: 180, width: 250, color: '#fee2e2'
                                        }
                                    ];
                                    
                                    patterns.forEach(pattern => {
                                        // Box
                                        chCtx.fillStyle = pattern.color;
                                        chCtx.fillRect(pattern.x, pattern.y, pattern.width, 100);
                                        chCtx.strokeStyle = '#6b7280';
                                        chCtx.strokeRect(pattern.x, pattern.y, pattern.width, 100);
                                        
                                        // Title
                                        chCtx.fillStyle = '#1f2937';
                                        chCtx.font = 'bold 12px Arial';
                                        chCtx.fillText(pattern.title, pattern.x + 10, pattern.y + 20);
                                        
                                        // Example
                                        chCtx.fillStyle = '#374151';
                                        chCtx.font = '9px Courier';
                                        const lines = pattern.example.split('\n');
                                        lines.forEach((line, i) => {
                                            chCtx.fillText(line, pattern.x + 10, pattern.y + 40 + (i * 12));
                                        });
                                    });
                                    
                                    // Important note
                                    chCtx.fillStyle = '#e0f2fe';
                                    chCtx.fillRect(50, 300, 520, 80);
                                    chCtx.strokeStyle = '#0891b2';
                                    chCtx.strokeRect(50, 300, 520, 80);
                                    
                                    chCtx.fillStyle = '#0c4a6e';
                                    chCtx.font = 'bold 11px Arial';
                                    chCtx.fillText('üí° Pro Tip: Complex HAVING Strategies', 60, 320);
                                    
                                    chCtx.fillStyle = '#374151';
                                    chCtx.font = '10px Arial';
                                    chCtx.fillText('‚Ä¢ Use CASE in aggregates for conditional filtering', 60, 340);
                                    chCtx.fillText('‚Ä¢ Combine statistical functions for outlier detection', 60, 355);
                                    chCtx.fillText('‚Ä¢ Reference CTEs or derived tables for baseline comparisons', 60, 370);
                                </script>
                                
                                <div class="best_practice">
                                    <h3>Advanced HAVING Patterns</h3>
                                    
                                    <pre><code class="language-sql">-- ========================================
-- HAVING WITH COMPLEX AGGREGATES
-- ========================================

-- Multiple aggregate conditions with calculations
SELECT 
    product_category,
    supplier_id,
    COUNT(*) as product_count,
    AVG(price) as avg_price,
    MIN(price) as min_price,
    MAX(price) as max_price,
    MAX(price) - MIN(price) as price_range,
    STD(price) as price_std_dev
FROM products
GROUP BY product_category, supplier_id
HAVING 
    COUNT(*) >= 5  -- Minimum products
    AND MAX(price) - MIN(price) > AVG(price) * 0.5  -- Significant range
    AND STD(price) > 10  -- Price variation
    AND AVG(price) BETWEEN 50 AND 500;  -- Price band

-- ========================================
-- HAVING WITH CONDITIONAL AGGREGATES
-- ========================================

-- Using CASE within aggregates in HAVING
SELECT 
    customer_id,
    COUNT(*) as total_orders,
    SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed_orders,
    SUM(CASE WHEN status = 'cancelled' THEN 1 ELSE 0 END) as cancelled_orders,
    SUM(amount) as total_amount
FROM orders
GROUP BY customer_id
HAVING 
    -- More than 20% cancellation rate
    SUM(CASE WHEN status = 'cancelled' THEN 1 ELSE 0 END) / COUNT(*) > 0.2
    -- And significant order volume
    AND COUNT(*) >= 10
    -- But still profitable
    AND SUM(CASE WHEN status = 'completed' THEN amount ELSE 0 END) > 1000;

-- ========================================
-- HAVING WITH SUBQUERIES
-- ========================================

-- Compare groups to overall statistics
SELECT 
    department,
    COUNT(*) as employee_count,
    AVG(salary) as avg_salary,
    SUM(salary) as total_payroll
FROM employees
GROUP BY department
HAVING 
    -- Department average above company average
    AVG(salary) > (SELECT AVG(salary) FROM employees)
    -- And represents significant portion of payroll
    AND SUM(salary) > (SELECT SUM(salary) * 0.1 FROM employees);

-- Dynamic thresholds with subqueries
SELECT 
    product_id,
    COUNT(*) as review_count,
    AVG(rating) as avg_rating
FROM reviews
GROUP BY product_id
HAVING 
    -- Above median review count
    COUNT(*) > (
        SELECT AVG(review_count)
        FROM (
            SELECT COUNT(*) as review_count
            FROM reviews
            GROUP BY product_id
        ) as counts
    )
    -- And rating in top quartile
    AND AVG(rating) > (
        SELECT DISTINCT rating
        FROM reviews
        ORDER BY rating DESC
        LIMIT 1 OFFSET (SELECT COUNT(DISTINCT rating) * 0.25 FROM reviews)
    );

-- ========================================
-- HAVING WITH CORRELATED SUBQUERIES
-- ========================================

-- Find categories performing better than their historical average
SELECT 
    category,
    YEAR(order_date) as year,
    MONTH(order_date) as month,
    SUM(amount) as monthly_revenue
FROM orders o
JOIN products p ON o.product_id = p.product_id
GROUP BY category, YEAR(order_date), MONTH(order_date)
HAVING 
    SUM(amount) > (
        -- Historical average for this category
        SELECT AVG(monthly_rev)
        FROM (
            SELECT SUM(amount) as monthly_rev
            FROM orders o2
            JOIN products p2 ON o2.product_id = p2.product_id
            WHERE p2.category = p.category
            AND o2.order_date < DATE_SUB(LAST_DAY(CONCAT(year, '-', month, '-01')), INTERVAL 0 DAY)
            GROUP BY YEAR(o2.order_date), MONTH(o2.order_date)
        ) as historical
    ) * 1.1;  -- 10% above historical average</code></pre>
                                </div>
                            </section>

                            <section>
                                <h2>HAVING Performance Optimization</h2>
                                
                                <div class="alert alert-warning">
                                    <div class="alert-icon">‚ö†Ô∏è</div>
                                    <div class="alert-content">
                                        <div class="alert-title">Performance Considerations</div>
                                        <div class="alert-message">
                                            HAVING operates on aggregated data, so optimization focuses on reducing the groups processed and efficient aggregate calculations.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="homework">
                                    <h3>Optimizing HAVING Queries</h3>
                                    
                                    <pre><code class="language-sql">-- ========================================
-- OPTIMIZATION STRATEGIES
-- ========================================

-- Strategy 1: Filter early with WHERE
-- Bad: HAVING does unnecessary grouping
SELECT 
    customer_id,
    COUNT(*),
    SUM(amount)
FROM orders
GROUP BY customer_id
HAVING customer_id IN (1, 2, 3, 4, 5);  -- Should be WHERE

-- Good: WHERE filters before grouping
SELECT 
    customer_id,
    COUNT(*),
    SUM(amount)
FROM orders
WHERE customer_id IN (1, 2, 3, 4, 5)  -- Filter first
GROUP BY customer_id;

-- ========================================
-- Strategy 2: Use indexes for GROUP BY
-- ========================================

-- Create covering index for GROUP BY + aggregates
CREATE INDEX idx_orders_customer_amount 
ON orders(customer_id, status, amount);

-- This query can use index only
SELECT 
    customer_id,
    COUNT(*) as order_count,
    SUM(amount) as total
FROM orders
WHERE status = 'completed'
GROUP BY customer_id
HAVING COUNT(*) > 10;

-- ========================================
-- Strategy 3: Materialized aggregates
-- ========================================

-- Create summary table for frequent HAVING queries
CREATE TABLE customer_summary (
    customer_id INT PRIMARY KEY,
    total_orders INT,
    total_amount DECIMAL(10,2),
    avg_order_value DECIMAL(10,2),
    last_order_date DATE,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_metrics (total_orders, total_amount)
);

-- Populate summary (run periodically)
INSERT INTO customer_summary
SELECT 
    customer_id,
    COUNT(*),
    SUM(amount),
    AVG(amount),
    MAX(order_date),
    NOW()
FROM orders
WHERE status = 'completed'
GROUP BY customer_id
ON DUPLICATE KEY UPDATE
    total_orders = VALUES(total_orders),
    total_amount = VALUES(total_amount),
    avg_order_value = VALUES(avg_order_value),
    last_order_date = VALUES(last_order_date);

-- Now HAVING queries are instant
SELECT *
FROM customer_summary
WHERE total_orders > 10  -- No HAVING needed!
    AND total_amount > 1000;

-- ========================================
-- Strategy 4: Optimize complex HAVING
-- ========================================

-- Inefficient: Multiple passes for statistics
SELECT 
    category,
    COUNT(*) as cnt,
    AVG(price) as avg_price,
    STD(price) as std_price
FROM products
GROUP BY category
HAVING 
    STD(price) / AVG(price) > 0.5  -- Coefficient of variation
    AND COUNT(*) > 10;

-- Efficient: Calculate once, filter once
SELECT *
FROM (
    SELECT 
        category,
        COUNT(*) as cnt,
        AVG(price) as avg_price,
        STD(price) as std_price,
        STD(price) / AVG(price) as coeff_variation
    FROM products
    GROUP BY category
) as stats
WHERE coeff_variation > 0.5
    AND cnt > 10;

-- ========================================
-- Strategy 5: Partition elimination
-- ========================================

-- If table is partitioned by date
ALTER TABLE orders
PARTITION BY RANGE (YEAR(order_date)) (
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026)
);

-- This query only scans relevant partitions
SELECT 
    customer_id,
    COUNT(*) as orders_2024
FROM orders
WHERE order_date >= '2024-01-01' 
    AND order_date < '2025-01-01'
GROUP BY customer_id
HAVING COUNT(*) > 50;</code></pre>
                                </div>
                            </section>

                            <section>
                                <h2>Common HAVING Pitfalls and Solutions</h2>
                                
                                <div class="real_world_example">
                                    <h3>Avoiding HAVING Mistakes</h3>
                                    
                                    <pre><code class="language-sql">-- ========================================
-- PITFALL 1: Column Aliases in HAVING
-- ========================================

-- MySQL allows this (non-standard):
SELECT 
    customer_id,
    COUNT(*) as order_count
FROM orders
GROUP BY customer_id
HAVING order_count > 10;  -- Works in MySQL

-- Standard SQL requires:
SELECT 
    customer_id,
    COUNT(*) as order_count
FROM orders
GROUP BY customer_id
HAVING COUNT(*) > 10;  -- Portable

-- ========================================
-- PITFALL 2: NULL Handling in HAVING
-- ========================================

-- NULLs can cause unexpected results
SELECT 
    category,
    AVG(discount) as avg_discount
FROM products
GROUP BY category
HAVING AVG(discount) > 10;  -- Excludes NULL discount groups

-- Handle NULLs explicitly
SELECT 
    category,
    AVG(COALESCE(discount, 0)) as avg_discount,
    COUNT(discount) as products_with_discount
FROM products
GROUP BY category
HAVING AVG(COALESCE(discount, 0)) > 10
    OR COUNT(discount) = 0;  -- Include all-NULL groups

-- ========================================
-- PITFALL 3: HAVING Without GROUP BY
-- ========================================

-- Valid but treats entire result as one group
SELECT 
    COUNT(*) as total,
    AVG(price) as avg_price
FROM products
HAVING AVG(price) > 100;  -- Filters the single group

-- ========================================
-- PITFALL 4: Mixing WHERE and HAVING Logic
-- ========================================

-- Confusing: Mixes row and group logic
SELECT 
    category,
    COUNT(*) as product_count
FROM products
GROUP BY category
HAVING COUNT(*) > 5 
    AND category != 'Discontinued';  -- Should be WHERE

-- Clear: Separate row and group filters
SELECT 
    category,
    COUNT(*) as product_count
FROM products
WHERE category != 'Discontinued'  -- Row filter
GROUP BY category
HAVING COUNT(*) > 5;  -- Group filter

-- ========================================
-- PITFALL 5: Incorrect Aggregate Scope
-- ========================================

-- Wrong: Trying to filter individual rows in HAVING
SELECT 
    customer_id,
    order_id,  -- Not in GROUP BY!
    SUM(amount)
FROM orders
GROUP BY customer_id
HAVING amount > 100;  -- Error: amount not aggregated

-- Correct: Aggregate or include in GROUP BY
SELECT 
    customer_id,
    COUNT(*) as order_count,
    SUM(amount) as total
FROM orders
WHERE amount > 100  -- Filter individual orders
GROUP BY customer_id
HAVING SUM(amount) > 1000;  -- Filter grouped totals</code></pre>
                                </div>
                            </section>

                            <!-- Practice Exercise -->
                            <section>
                                <h2>Practice Exercise</h2>
                                
                                <div class="alert alert-success">
                                    <div class="alert-icon">üíª</div>
                                    <div class="alert-content">
                                        <div class="alert-title">Advanced HAVING Challenges</div>
                                        <div class="alert-message">
                                            Solve these complex HAVING scenarios:
                                            <ol>
                                                <li>Find customer segments where average order value exceeds median</li>
                                                <li>Identify products with abnormal return rates (statistical outliers)</li>
                                                <li>Find months where sales exceeded both previous month and year-ago month</li>
                                                <li>Detect categories with high price variance but stable sales</li>
                                                <li>Find suppliers whose product ratings improved consistently</li>
                                                <li>Identify customers with irregular purchase patterns</li>
                                                <li>Find product combinations frequently bought together (>50% of orders)</li>
                                                <li>Detect seasonal categories using coefficient of variation</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                                
                                <details>
                                    <summary>üí° Click for Solutions</summary>
                                    <pre><code class="language-sql">-- 1. Customer segments where average exceeds median
WITH segment_stats AS (
    SELECT 
        customer_segment,
        AVG(order_value) as avg_value,
        COUNT(*) as order_count
    FROM orders o
    JOIN customers c ON o.customer_id = c.customer_id
    GROUP BY customer_segment
),
median_calc AS (
    SELECT 
        customer_segment,
        order_value,
        ROW_NUMBER() OVER (PARTITION BY customer_segment ORDER BY order_value) as rn,
        COUNT(*) OVER (PARTITION BY customer_segment) as cnt
    FROM orders o
    JOIN customers c ON o.customer_id = c.customer_id
)
SELECT 
    s.customer_segment,
    s.avg_value,
    m.median_value,
    s.order_count
FROM segment_stats s
JOIN (
    SELECT 
        customer_segment,
        AVG(order_value) as median_value
    FROM median_calc
    WHERE rn IN (FLOOR((cnt + 1) / 2), CEIL((cnt + 1) / 2))
    GROUP BY customer_segment
) m ON s.customer_segment = m.customer_segment
WHERE s.avg_value > m.median_value * 1.2;

-- 2. Products with abnormal return rates
SELECT 
    product_id,
    product_name,
    COUNT(*) as total_sales,
    SUM(CASE WHEN returned = TRUE THEN 1 ELSE 0 END) as returns,
    AVG(CASE WHEN returned = TRUE THEN 1 ELSE 0 END) as return_rate,
    STD(CASE WHEN returned = TRUE THEN 1 ELSE 0 END) as return_std
FROM order_items oi
JOIN products p ON oi.product_id = p.product_id
GROUP BY product_id
HAVING 
    COUNT(*) >= 20  -- Minimum sample size
    AND AVG(CASE WHEN returned = TRUE THEN 1 ELSE 0 END) > (
        SELECT AVG(return_rate) + 2 * STD(return_rate)
        FROM (
            SELECT AVG(CASE WHEN returned = TRUE THEN 1 ELSE 0 END) as return_rate
            FROM order_items
            GROUP BY product_id
        ) as rates
    );

-- 3. Months exceeding both previous and year-ago
WITH monthly_sales AS (
    SELECT 
        DATE_FORMAT(order_date, '%Y-%m') as month,
        SUM(amount) as revenue
    FROM orders
    WHERE status = 'completed'
    GROUP BY DATE_FORMAT(order_date, '%Y-%m')
)
SELECT 
    month,
    revenue,
    LAG(revenue, 1) OVER (ORDER BY month) as prev_month,
    LAG(revenue, 12) OVER (ORDER BY month) as year_ago
FROM monthly_sales
HAVING 
    revenue > LAG(revenue, 1) OVER (ORDER BY month) * 1.05
    AND revenue > LAG(revenue, 12) OVER (ORDER BY month) * 1.10;

-- 4. High price variance but stable sales
SELECT 
    category,
    COUNT(DISTINCT product_id) as products,
    STD(price) as price_std,
    AVG(price) as price_avg,
    STD(monthly_sales) as sales_std,
    AVG(monthly_sales) as sales_avg,
    STD(price) / AVG(price) as price_cv,
    STD(monthly_sales) / AVG(monthly_sales) as sales_cv
FROM (
    SELECT 
        p.category,
        p.product_id,
        p.price,
        DATE_FORMAT(o.order_date, '%Y-%m') as month,
        SUM(oi.quantity) as monthly_sales
    FROM products p
    JOIN order_items oi ON p.product_id = oi.product_id
    JOIN orders o ON oi.order_id = o.order_id
    GROUP BY p.category, p.product_id, month
) as product_sales
GROUP BY category
HAVING 
    STD(price) / AVG(price) > 0.5  -- High price variance
    AND STD(monthly_sales) / AVG(monthly_sales) < 0.2;  -- Low sales variance

-- 5. Suppliers with consistent rating improvement
WITH supplier_ratings AS (
    SELECT 
        s.supplier_id,
        s.supplier_name,
        QUARTER(r.review_date) as quarter,
        YEAR(r.review_date) as year,
        AVG(r.rating) as avg_rating,
        ROW_NUMBER() OVER (PARTITION BY s.supplier_id ORDER BY YEAR(r.review_date), QUARTER(r.review_date)) as quarter_num
    FROM suppliers s
    JOIN products p ON s.supplier_id = p.supplier_id
    JOIN reviews r ON p.product_id = r.product_id
    GROUP BY s.supplier_id, year, quarter
)
SELECT 
    supplier_id,
    supplier_name,
    COUNT(*) as quarters_tracked,
    MIN(avg_rating) as min_rating,
    MAX(avg_rating) as max_rating
FROM supplier_ratings
GROUP BY supplier_id
HAVING 
    COUNT(*) >= 4  -- At least 4 quarters
    AND MIN(CASE WHEN quarter_num > 1 THEN avg_rating END) > 
        MIN(CASE WHEN quarter_num = 1 THEN avg_rating END);

-- 6. Customers with irregular patterns
SELECT 
    customer_id,
    COUNT(*) as order_count,
    AVG(DATEDIFF(order_date, LAG(order_date) OVER (PARTITION BY customer_id ORDER BY order_date))) as avg_days_between,
    STD(DATEDIFF(order_date, LAG(order_date) OVER (PARTITION BY customer_id ORDER BY order_date))) as std_days_between,
    MIN(amount) as min_order,
    MAX(amount) as max_order,
    STD(amount) as std_amount
FROM orders
GROUP BY customer_id
HAVING 
    COUNT(*) >= 10
    AND STD(amount) > AVG(amount) * 0.8  -- High amount variance
    AND STD(DATEDIFF(order_date, LAG(order_date) OVER (PARTITION BY customer_id ORDER BY order_date))) > 
        AVG(DATEDIFF(order_date, LAG(order_date) OVER (PARTITION BY customer_id ORDER BY order_date))) * 0.5;

-- 7. Product combinations (association rules)
SELECT 
    oi1.product_id as product_a,
    oi2.product_id as product_b,
    COUNT(DISTINCT oi1.order_id) as orders_together,
    COUNT(DISTINCT oi1.order_id) * 100.0 / (
        SELECT COUNT(DISTINCT order_id)
        FROM order_items
        WHERE product_id = oi1.product_id
    ) as support_percentage
FROM order_items oi1
JOIN order_items oi2 ON oi1.order_id = oi2.order_id
    AND oi1.product_id < oi2.product_id
GROUP BY oi1.product_id, oi2.product_id
HAVING 
    COUNT(DISTINCT oi1.order_id) >= 10
    AND COUNT(DISTINCT oi1.order_id) * 100.0 / (
        SELECT COUNT(DISTINCT order_id)
        FROM order_items
        WHERE product_id = oi1.product_id
    ) > 50;

-- 8. Seasonal categories using CV
SELECT 
    category,
    COUNT(DISTINCT MONTH(order_date)) as months_active,
    AVG(monthly_revenue) as avg_monthly_revenue,
    STD(monthly_revenue) as std_monthly_revenue,
    STD(monthly_revenue) / AVG(monthly_revenue) as coefficient_of_variation,
    CASE 
        WHEN STD(monthly_revenue) / AVG(monthly_revenue) > 0.5 THEN 'Highly Seasonal'
        WHEN STD(monthly_revenue) / AVG(monthly_revenue) > 0.3 THEN 'Moderately Seasonal'
        ELSE 'Stable'
    END as seasonality
FROM (
    SELECT 
        p.category,
        MONTH(o.order_date) as month,
        SUM(oi.quantity * oi.unit_price) as monthly_revenue
    FROM products p
    JOIN order_items oi ON p.product_id = oi.product_id
    JOIN orders o ON oi.order_id = o.order_id
    WHERE o.status = 'completed'
    GROUP BY p.category, MONTH(o.order_date)
) as monthly_data
GROUP BY category
HAVING STD(monthly_revenue) / AVG(monthly_revenue) > 0.3;</code></pre>
                                </details>
                            </section>
                            
                            <!-- Resources -->
                            <section class="resources">
                                <h2>Additional Resources</h2>
                                <ul>
                                    <li><a href="https://dev.mysql.com/doc/refman/8.0/en/group-by-handling.html" target="_blank">MySQL GROUP BY and HAVING</a></li>
                                    <li><a href="https://www.mysqltutorial.org/mysql-having.aspx" target="_blank">MySQL HAVING Tutorial</a></li>
                                    <li><a href="https://modern-sql.com/feature/filter" target="_blank">SQL Filtering: WHERE vs HAVING</a></li>
                                    <li><a href="https://use-the-index-luke.com/sql/where-clause/searching-for-ranges" target="_blank">Optimizing Filter Conditions</a></li>
                                </ul>
                            </section>
                        </div>

                        <!-- Lesson Navigation -->
                        <div class="lesson-navigation">
                            <a href="/03module/group_by_having.html" class="lesson-nav-button prev">
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                                </svg>
                                <span>
                                    <small>Previous</small><br>
                                    GROUP BY & HAVING
                                </span>
                            </a>
                            
                            <button class="complete-lesson-btn">
                                Mark as Complete
                            </button>
                            
                            <a href="/03module/subqueries.html" class="lesson-nav-button next">
                                <span>
                                    <small>Next</small><br>
                                    Subqueries
                                </span>
                                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                                </svg>
                            </a>
                        </div>
                    </article>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module3.html">Module 3</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                        </ul>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Support</h4>
                        <ul class="footer-links">
                            <li><a href="/help.html">Help Center</a></li>
                            <li><a href="/faq.html">FAQ</a></li>
                            <li><a href="/contact.html">Contact</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <div class="footer-bottom-content">
                        <p class="copyright">&copy; 2025 PHP WordPress Development Course</p>
                        <nav class="footer-bottom-links">
                            <a href="/privacy.html">Privacy</a>
                            <span class="separator">|</span>
                            <a href="/terms.html">Terms</a>
                        </nav>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Back to Top -->
    <button id="back-to-top" class="back-to-top" aria-label="Back to top">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 19V5M12 5l-7 7M12 5l7 7"/>
        </svg>
    </button>

    <!-- JavaScript -->
    <script src="/assets/js/navigation.js"></script>
    <script src="/assets/js/site-config.js"></script>
</body>
</html>