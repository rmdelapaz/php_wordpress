<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="ie=edge" http-equiv="X-UA-Compatible"/>
<!-- SEO Meta Tags -->
<title>Database Transactions - ACID Properties and Isolation - PHP WordPress Course</title>
<meta content="Master database transactions, ACID properties, isolation levels, deadlocks, and transaction management in MySQL" name="description"/>
<meta content="PHP, WordPress, MySQL, transactions, ACID, isolation levels, COMMIT, ROLLBACK" name="keywords"/>
<meta content="PHP WordPress Course" name="author"/>
<!-- Favicon -->
<link href="/favicon.png" rel="icon" type="image/png"/>
<link href="/favicon.png" rel="apple-touch-icon"/>
<!-- CSS -->
<link href="/assets/css/main.css" rel="stylesheet"/><link href="/assets/css/sidebar-enhanced.css" rel="stylesheet"/><link href="/assets/css/sidebar-toggle.css" rel="stylesheet"/>
</head>
<body>
<!-- Skip to main content -->
<a class="sr-only" href="#main-content">Skip to main content</a>
<div class="page-wrapper">
<!-- Header -->
<header class="site-header" role="banner">
<div class="header-container">
<div class="site-branding">
<a class="site-logo" href="/">
<h1 class="site-title">PHP WordPress Development</h1>
</a>
</div>
<nav aria-label="Main navigation" class="main-navigation" role="navigation">
<button aria-expanded="false" aria-label="Toggle navigation" class="mobile-menu-btn">
<span></span>
<span></span>
<span></span>
</button>
<div class="nav-menu">
<ul class="nav-list">
<li class="nav-item"><a class="nav-link" href="/">Home</a></li>
<li class="nav-item dropdown">
<button aria-haspopup="true" class="nav-link dropdown-toggle active">Modules</button>
<div class="dropdown-menu">
<a class="dropdown-item" href="/module1.html">Module 1: Web Fundamentals</a>
<a class="dropdown-item" href="/module2.html">Module 2: PHP Fundamentals</a>
<a class="dropdown-item active" href="/module3.html">Module 3: MySQL Database</a>
<a class="dropdown-item" href="/module4.html">Module 4: WordPress &amp; Docker</a>
<a class="dropdown-item" href="/module5.html">Module 5: Theme Development</a>
<a class="dropdown-item" href="/module6.html">Module 6: Plugin Development</a>
<a class="dropdown-item" href="/module7.html">Module 7: Advanced WordPress</a>
<a class="dropdown-item" href="/module8.html">Module 8: Deployment</a>
<a class="dropdown-item" href="/module9.html">Module 9: Final Project</a>
</div>
</li>
<li class="nav-item"><a class="nav-link" href="/resources.html">Resources</a></li>
<li class="nav-item"><a class="nav-link" href="/about.html">About</a></li>
</ul>
</div>
</nav>
<div class="search-container">
<div class="search-input-wrapper">
<svg class="search-icon" fill="currentColor" height="20" viewbox="0 0 20 20" width="20">
<path clip-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" fill-rule="evenodd"></path>
</svg>
<input aria-label="Search" class="search-input" placeholder="Search lessons..." type="search"/>
</div>
<div class="search-results"></div>
</div>
</div>
</header>
<!-- Progress Bar -->
<div class="progress-container">
<div class="progress-header">
<h2 class="progress-title">Course Progress</h2>
<span class="progress-text">Loading...</span>
</div>
<div class="progress-bar">
<div class="progress-bar-fill">
<span class="progress-bar-text"></span>
</div>
</div>
</div>
<!-- Breadcrumb -->
<nav aria-label="Breadcrumb" class="breadcrumb container">
<ol class="breadcrumb-list">
<li class="breadcrumb-item">
<a href="/">Home</a>
<span class="breadcrumb-separator">/</span>
</li>
<li class="breadcrumb-item">
<a href="/module3.html">Module 3</a>
<span class="breadcrumb-separator">/</span>
</li>
<li class="breadcrumb-item">
<span aria-current="page">Transactions</span>
</li>
</ol>
</nav>
<!-- Main Content -->
<main class="main-content" id="main-content" role="main">
<div class="container">
<div class="content-with-sidebar">
<!-- Sidebar -->
<aside class="sidebar">

<div class="sidebar-nav">
<h3 class="sidebar-title">Module 3: MySQL Database</h3>
<div class="sidebar-section">
<h4 class="sidebar-section-title">Session 4</h4>
<ul class="sidebar-menu">
<li><a class="sidebar-link" href="/03module/sql_joins.html">SQL Joins</a></li>
<li><a class="sidebar-link" href="/03module/aggregate_functions.html">Aggregate Functions</a></li>
<li><a class="sidebar-link" href="/03module/group_by_having.html">GROUP BY</a></li>
<li><a class="sidebar-link" href="/03module/having_deep_dive.html">HAVING Clause</a></li>
<li><a class="sidebar-link" href="/03module/subqueries.html">Subqueries</a></li>
<li><a class="sidebar-link" href="/03module/views.html">Views</a></li>
<li class="active"><a class="sidebar-link active" href="/03module/transactions.html">Transactions</a></li>
<li><a class="sidebar-link" href="/03module/stored_procedures.html">Stored Procedures</a></li>
<li><a class="sidebar-link" href="/03module/homework_advanced_sql.html">Homework: Advanced SQL</a></li>
</ul>
</div>
<div class="sidebar-section">
<h4 class="sidebar-section-title">Quick Links</h4>
<ul class="sidebar-menu">
<li><a class="sidebar-link" href="/module3.html">Module Overview</a></li>
<li><a class="sidebar-link prev-session" href="/03module/sql_syntax_conventions.html">‚Üê Prev: Session 3: SQL Basics</a></li>
<li><a class="sidebar-link next-session" href="/03module/connecting_mysql.html">Next: Session 5: PHP-MySQL ‚Üí</a></li>
<li><a class="sidebar-link" href="/module2.html">‚Üê Previous Module</a></li>
<li><a class="sidebar-link" href="/module4.html">Next Module ‚Üí</a></li>
<li><a class="sidebar-link" href="/resources.html">Resources</a></li>
</ul>
</div>
</div></aside>
<!-- Main Lesson Content -->
<article class="lesson-content">
<header class="lesson-header">
<h1>Database Transactions</h1>
<div class="lesson-meta">
<div class="lesson-meta-item">
<svg fill="currentColor" height="20" width="20">
<path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg>
<span>Duration: 80 minutes</span>
</div>
<div class="lesson-meta-item">
<svg fill="currentColor" height="20" width="20">
<path d="M12 14l9-5-9-5-9 5 9 5z"></path>
</svg>
<span>Module 3: Database Objects</span>
</div>
</div>
</header>
<!-- Learning Objectives -->
<div class="lesson-objectives">
<h2>Learning Objectives</h2>
<ul>
<li>Understand ACID properties of transactions</li>
<li>Master transaction control statements (BEGIN, COMMIT, ROLLBACK)</li>
<li>Implement savepoints for partial rollbacks</li>
<li>Configure isolation levels and understand their impact</li>
<li>Handle deadlocks and lock timeouts</li>
<li>Use transactions in stored procedures</li>
<li>Apply transactions in PHP applications</li>
<li>Optimize transaction performance</li>
</ul>
</div>
<!-- Lesson Body -->
<div class="lesson-body">
<section>
<h2>Understanding Database Transactions</h2>
<p class="lead">Transactions ensure data integrity by treating multiple operations as a single unit of work - either all succeed or all fail! üîí</p>
<canvas height="500" id="transactionCanvas" width="600"></canvas>
<script>
                                    const ctx = document.getElementById('transactionCanvas').getContext('2d');
                                    
                                    // Title
                                    ctx.font = 'bold 18px Arial';
                                    ctx.fillStyle = '#1f2937';
                                    ctx.fillText('ACID Properties of Transactions', 180, 30);
                                    
                                    // ACID boxes
                                    const acidProps = [
                                        {
                                            letter: 'A',
                                            name: 'Atomicity',
                                            desc: 'All or nothing',
                                            details: ['Operations complete', 'entirely or fail', 'No partial state'],
                                            x: 50, y: 60, color: '#dbeafe', border: '#2563eb'
                                        },
                                        {
                                            letter: 'C',
                                            name: 'Consistency',
                                            desc: 'Valid state to valid state',
                                            details: ['Maintains integrity', 'Rules enforced', 'Constraints met'],
                                            x: 320, y: 60, color: '#dcfce7', border: '#16a34a'
                                        },
                                        {
                                            letter: 'I',
                                            name: 'Isolation',
                                            desc: 'Concurrent independence',
                                            details: ['Transactions isolated', 'No interference', 'Serializable'],
                                            x: 50, y: 180, color: '#fef3c7', border: '#ca8a04'
                                        },
                                        {
                                            letter: 'D',
                                            name: 'Durability',
                                            desc: 'Permanent changes',
                                            details: ['Survives failures', 'Written to disk', 'Recoverable'],
                                            x: 320, y: 180, color: '#fee2e2', border: '#dc2626'
                                        }
                                    ];
                                    
                                    acidProps.forEach(prop => {
                                        // Box
                                        ctx.fillStyle = prop.color;
                                        ctx.fillRect(prop.x, prop.y, 230, 100);
                                        ctx.strokeStyle = prop.border;
                                        ctx.lineWidth = 2;
                                        ctx.strokeRect(prop.x, prop.y, 230, 100);
                                        
                                        // Letter
                                        ctx.fillStyle = prop.border;
                                        ctx.font = 'bold 24px Arial';
                                        ctx.fillText(prop.letter, prop.x + 10, prop.y + 30);
                                        
                                        // Name
                                        ctx.font = 'bold 14px Arial';
                                        ctx.fillText(prop.name, prop.x + 40, prop.y + 25);
                                        
                                        // Description
                                        ctx.fillStyle = '#4b5563';
                                        ctx.font = 'italic 11px Arial';
                                        ctx.fillText(prop.desc, prop.x + 40, prop.y + 40);
                                        
                                        // Details
                                        ctx.fillStyle = '#374151';
                                        ctx.font = '10px Arial';
                                        prop.details.forEach((detail, i) => {
                                            ctx.fillText(`‚Ä¢ ${detail}`, prop.x + 10, prop.y + 60 + (i * 12));
                                        });
                                    });
                                    
                                    // Transaction flow
                                    ctx.fillStyle = '#e9d5ff';
                                    ctx.fillRect(50, 300, 500, 180);
                                    ctx.strokeStyle = '#7c3aed';
                                    ctx.strokeRect(50, 300, 500, 180);
                                    
                                    ctx.fillStyle = '#6b21a8';
                                    ctx.font = 'bold 14px Arial';
                                    ctx.fillText('Transaction Lifecycle', 230, 320);
                                    
                                    // Flow stages
                                    const stages = [
                                        { text: 'BEGIN TRANSACTION', x: 70, y: 350 },
                                        { text: '‚Üì Execute Operations', x: 70, y: 380 },
                                        { text: '‚Üì Check for Errors', x: 70, y: 410 },
                                        { text: 'Success ‚Üí COMMIT', x: 200, y: 440, color: '#059669' },
                                        { text: 'Failure ‚Üí ROLLBACK', x: 350, y: 440, color: '#dc2626' }
                                    ];
                                    
                                    stages.forEach(stage => {
                                        ctx.fillStyle = stage.color || '#374151';
                                        ctx.font = stage.text.startsWith('‚Üì') ? '12px Arial' : 'bold 12px Arial';
                                        ctx.fillText(stage.text, stage.x, stage.y);
                                    });
                                </script>
<div class="alert alert-info">
<div class="alert-icon">üí°</div>
<div class="alert-content">
<div class="alert-title">Transaction Key Concepts</div>
<div class="alert-message">
<ul>
<li><strong>Atomicity:</strong> All operations succeed or all fail</li>
<li><strong>Consistency:</strong> Database remains in valid state</li>
<li><strong>Isolation:</strong> Concurrent transactions don't interfere</li>
<li><strong>Durability:</strong> Committed changes persist</li>
<li>Transactions prevent partial updates and maintain data integrity</li>
<li>Essential for financial operations and critical data</li>
</ul>
</div>
</div>
</div>
</section>
<section>
<h2>Transaction Control Statements</h2>
<div class="mermaid">
                                    graph TB
                                        START[Start] --&gt; AUTO[Autocommit ON]
                                        START --&gt; MANUAL[Autocommit OFF]
                                        
                                        AUTO --&gt; SINGLE[Each statement<br/>auto-commits]
                                        
                                        MANUAL --&gt; BEGIN[BEGIN/START TRANSACTION]
                                        BEGIN --&gt; OPS[Operations]
                                        OPS --&gt; DECISION{Success?}
                                        DECISION --&gt;|Yes| COMMIT[COMMIT]
                                        DECISION --&gt;|No| ROLLBACK[ROLLBACK]
                                        
                                        OPS --&gt; SAVE[SAVEPOINT]
                                        SAVE --&gt; MORE[More Operations]
                                        MORE --&gt; PARTIAL[ROLLBACK TO SAVEPOINT]
                                        
                                        style BEGIN fill:#dcfce7
                                        style COMMIT fill:#dbeafe
                                        style ROLLBACK fill:#fee2e2
                                        style SAVE fill:#fef3c7
                                </div>
<div class="real_world_example">
<h3>Transaction Examples</h3>
<pre><code class="language-sql">-- ========================================
-- BASIC TRANSACTION CONTROL
-- ========================================

-- Check autocommit status
SHOW VARIABLES LIKE 'autocommit';

-- Disable autocommit
SET autocommit = 0;

-- Simple transaction
START TRANSACTION;  -- or BEGIN

-- Operations
INSERT INTO accounts (account_id, balance) VALUES (1, 1000);
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1;
UPDATE accounts SET balance = balance + 100 WHERE account_id = 2;

-- Commit changes
COMMIT;

-- Or rollback if error
ROLLBACK;

-- ========================================
-- TRANSACTION WITH ERROR HANDLING
-- ========================================

-- Bank transfer example
START TRANSACTION;

-- Debit from account
UPDATE accounts 
SET balance = balance - 500 
WHERE account_id = 1;

-- Check if balance went negative
SELECT balance INTO @balance 
FROM accounts 
WHERE account_id = 1;

IF @balance &lt; 0 THEN
    ROLLBACK;
    SELECT 'Insufficient funds' AS error_message;
ELSE
    -- Credit to account
    UPDATE accounts 
    SET balance = balance + 500 
    WHERE account_id = 2;
    
    COMMIT;
    SELECT 'Transfer successful' AS message;
END IF;

-- ========================================
-- SAVEPOINTS
-- ========================================

START TRANSACTION;

-- First operation
INSERT INTO orders (customer_id, order_date) 
VALUES (123, NOW());
SET @order_id = LAST_INSERT_ID();

SAVEPOINT order_created;

-- Add order items
INSERT INTO order_items (order_id, product_id, quantity) 
VALUES (@order_id, 1, 5);

SAVEPOINT item1_added;

INSERT INTO order_items (order_id, product_id, quantity) 
VALUES (@order_id, 2, 3);

-- Check inventory
SELECT quantity_available INTO @stock 
FROM inventory 
WHERE product_id = 2;

IF @stock &lt; 3 THEN
    -- Rollback only the second item
    ROLLBACK TO SAVEPOINT item1_added;
    SELECT 'Product 2 out of stock, removed from order' AS message;
END IF;

-- Commit the transaction
COMMIT;

-- ========================================
-- READ-ONLY TRANSACTIONS
-- ========================================

-- Optimize read-only operations
START TRANSACTION READ ONLY;

SELECT * FROM large_table WHERE conditions;
-- Multiple SELECT statements
-- No locks for writes

COMMIT;  -- or ROLLBACK (same effect for read-only)

-- ========================================
-- TRANSACTION WITH LOCKS
-- ========================================

START TRANSACTION;

-- Lock rows for update
SELECT * FROM inventory 
WHERE product_id = 123 
FOR UPDATE;

-- Check and update
UPDATE inventory 
SET quantity = quantity - 10 
WHERE product_id = 123;

COMMIT;

-- Share mode lock (allows reads)
START TRANSACTION;

SELECT * FROM products 
WHERE category = 'Electronics' 
LOCK IN SHARE MODE;

-- Other transactions can read but not write
COMMIT;</code></pre>
</div>
</section>
<section>
<h2>Isolation Levels</h2>
<canvas height="400" id="isolationCanvas" width="600"></canvas>
<script>
                                    const iCtx = document.getElementById('isolationCanvas').getContext('2d');
                                    
                                    // Title
                                    iCtx.font = 'bold 16px Arial';
                                    iCtx.fillStyle = '#1f2937';
                                    iCtx.fillText('MySQL Isolation Levels', 220, 30);
                                    
                                    // Header
                                    iCtx.fillStyle = '#f3f4f6';
                                    iCtx.fillRect(50, 50, 500, 30);
                                    iCtx.strokeStyle = '#6b7280';
                                    iCtx.strokeRect(50, 50, 500, 30);
                                    
                                    iCtx.fillStyle = '#1f2937';
                                    iCtx.font = 'bold 11px Arial';
                                    iCtx.fillText('Level', 60, 70);
                                    iCtx.fillText('Dirty Read', 200, 70);
                                    iCtx.fillText('Non-Repeat', 280, 70);
                                    iCtx.fillText('Phantom', 360, 70);
                                    iCtx.fillText('Performance', 440, 70);
                                    
                                    // Isolation levels
                                    const levels = [
                                        {
                                            name: 'READ UNCOMMITTED',
                                            dirty: '‚úó',
                                            nonrepeat: '‚úó',
                                            phantom: '‚úó',
                                            perf: 'Fastest',
                                            y: 90,
                                            color: '#fee2e2'
                                        },
                                        {
                                            name: 'READ COMMITTED',
                                            dirty: '‚úì',
                                            nonrepeat: '‚úó',
                                            phantom: '‚úó',
                                            perf: 'Fast',
                                            y: 140,
                                            color: '#fef3c7'
                                        },
                                        {
                                            name: 'REPEATABLE READ',
                                            dirty: '‚úì',
                                            nonrepeat: '‚úì',
                                            phantom: '‚úó',
                                            perf: 'Moderate',
                                            y: 190,
                                            color: '#dcfce7'
                                        },
                                        {
                                            name: 'SERIALIZABLE',
                                            dirty: '‚úì',
                                            nonrepeat: '‚úì',
                                            phantom: '‚úì',
                                            perf: 'Slowest',
                                            y: 240,
                                            color: '#dbeafe'
                                        }
                                    ];
                                    
                                    levels.forEach(level => {
                                        // Row background
                                        iCtx.fillStyle = level.color;
                                        iCtx.fillRect(50, level.y, 500, 40);
                                        iCtx.strokeStyle = '#6b7280';
                                        iCtx.strokeRect(50, level.y, 500, 40);
                                        
                                        // Level name
                                        iCtx.fillStyle = '#1f2937';
                                        iCtx.font = 'bold 10px Arial';
                                        iCtx.fillText(level.name, 60, level.y + 25);
                                        
                                        // Properties
                                        iCtx.font = '12px Arial';
                                        iCtx.fillStyle = level.dirty === '‚úì' ? '#059669' : '#dc2626';
                                        iCtx.fillText(level.dirty, 220, level.y + 25);
                                        
                                        iCtx.fillStyle = level.nonrepeat === '‚úì' ? '#059669' : '#dc2626';
                                        iCtx.fillText(level.nonrepeat, 300, level.y + 25);
                                        
                                        iCtx.fillStyle = level.phantom === '‚úì' ? '#059669' : '#dc2626';
                                        iCtx.fillText(level.phantom, 370, level.y + 25);
                                        
                                        iCtx.fillStyle = '#374151';
                                        iCtx.font = '10px Arial';
                                        iCtx.fillText(level.perf, 440, level.y + 25);
                                    });
                                    
                                    // Legend
                                    iCtx.fillStyle = '#e0f2fe';
                                    iCtx.fillRect(50, 300, 500, 80);
                                    iCtx.strokeStyle = '#0891b2';
                                    iCtx.strokeRect(50, 300, 500, 80);
                                    
                                    iCtx.fillStyle = '#0c4a6e';
                                    iCtx.font = 'bold 11px Arial';
                                    iCtx.fillText('Problem Definitions:', 60, 320);
                                    
                                    iCtx.fillStyle = '#374151';
                                    iCtx.font = '10px Arial';
                                    iCtx.fillText('‚Ä¢ Dirty Read: Reading uncommitted changes from other transactions', 60, 340);
                                    iCtx.fillText('‚Ä¢ Non-Repeatable Read: Same query returns different results', 60, 355);
                                    iCtx.fillText('‚Ä¢ Phantom Read: New rows appear between reads', 60, 370);
                                </script>
<div class="best_practice">
<h3>Working with Isolation Levels</h3>
<pre><code class="language-sql">-- ========================================
-- ISOLATION LEVEL CONFIGURATION
-- ========================================

-- Check current isolation level
SELECT @@GLOBAL.transaction_isolation;
SELECT @@SESSION.transaction_isolation;

-- Set session isolation level
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;

-- Set for next transaction only
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

-- ========================================
-- DEMONSTRATING ISOLATION PROBLEMS
-- ========================================

-- DIRTY READ (READ UNCOMMITTED)
-- Session 1:
START TRANSACTION;
UPDATE products SET price = 999 WHERE product_id = 1;
-- Don't commit yet

-- Session 2:
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
START TRANSACTION;
SELECT price FROM products WHERE product_id = 1;  -- Sees 999 (dirty)
COMMIT;

-- Session 1:
ROLLBACK;  -- Price reverts, but Session 2 saw wrong value

-- ========================================
-- NON-REPEATABLE READ
-- ========================================

-- Session 1:
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
START TRANSACTION;
SELECT price FROM products WHERE product_id = 1;  -- Returns 100

-- Session 2:
UPDATE products SET price = 150 WHERE product_id = 1;
COMMIT;

-- Session 1 (same transaction):
SELECT price FROM products WHERE product_id = 1;  -- Returns 150 (changed!)
COMMIT;

-- ========================================
-- PHANTOM READ
-- ========================================

-- Session 1:
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION;
SELECT COUNT(*) FROM products WHERE price &gt; 100;  -- Returns 5

-- Session 2:
INSERT INTO products (name, price) VALUES ('New', 200);
COMMIT;

-- Session 1 (same transaction):
SELECT COUNT(*) FROM products WHERE price &gt; 100;  -- Still 5 (no phantom)
-- But in READ COMMITTED, would see 6

-- ========================================
-- DEADLOCK HANDLING
-- ========================================

-- Session 1:
START TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
-- Wait
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

-- Session 2:
START TRANSACTION;
UPDATE accounts SET balance = balance - 50 WHERE id = 2;
-- Wait
UPDATE accounts SET balance = balance + 50 WHERE id = 1;
-- DEADLOCK! One transaction will be rolled back

-- Handling in application:
START TRANSACTION;

-- Set lock timeout
SET innodb_lock_wait_timeout = 5;

-- Attempt operation
UPDATE accounts SET balance = balance - 100 WHERE id = 1;

-- Check for lock timeout error
GET DIAGNOSTICS CONDITION 1
    @errno = MYSQL_ERRNO;

IF @errno = 1205 THEN  -- Lock timeout
    ROLLBACK;
    -- Retry or handle error
ELSE
    COMMIT;
END IF;</code></pre>
</div>
</section>
<section>
<h2>Transactions in Stored Procedures</h2>
<div class="homework">
<h3>Advanced Transaction Patterns</h3>
<pre><code class="language-sql">-- ========================================
-- STORED PROCEDURE WITH TRANSACTIONS
-- ========================================

DELIMITER $$

CREATE PROCEDURE transfer_funds(
    IN from_account INT,
    IN to_account INT,
    IN amount DECIMAL(10,2),
    OUT result VARCHAR(100)
)
BEGIN
    DECLARE exit handler FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SET result = 'Transaction failed - rolled back';
    END;
    
    DECLARE exit handler FOR SQLWARNING
    BEGIN
        ROLLBACK;
        SET result = 'Transaction warning - rolled back';
    END;
    
    START TRANSACTION;
    
    -- Check source account balance
    SELECT balance INTO @current_balance
    FROM accounts
    WHERE account_id = from_account
    FOR UPDATE;  -- Lock the row
    
    IF @current_balance &lt; amount THEN
        ROLLBACK;
        SET result = 'Insufficient funds';
    ELSE
        -- Debit source account
        UPDATE accounts
        SET balance = balance - amount,
            last_transaction = NOW()
        WHERE account_id = from_account;
        
        -- Credit destination account
        UPDATE accounts
        SET balance = balance + amount,
            last_transaction = NOW()
        WHERE account_id = to_account;
        
        -- Log transaction
        INSERT INTO transaction_log (
            from_account, to_account, amount, 
            transaction_date, status
        ) VALUES (
            from_account, to_account, amount,
            NOW(), 'completed'
        );
        
        COMMIT;
        SET result = 'Transfer successful';
    END IF;
END$$

DELIMITER ;

-- ========================================
-- NESTED TRANSACTIONS (Emulated)
-- ========================================

DELIMITER $$

CREATE PROCEDURE process_order(
    IN p_customer_id INT,
    IN p_items JSON,
    OUT p_order_id INT
)
BEGIN
    DECLARE v_done INT DEFAULT 0;
    DECLARE v_product_id INT;
    DECLARE v_quantity INT;
    DECLARE v_idx INT DEFAULT 0;
    
    DECLARE exit handler FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SIGNAL SQLSTATE '45000' 
            SET MESSAGE_TEXT = 'Order processing failed';
    END;
    
    START TRANSACTION;
    
    -- Create order
    INSERT INTO orders (customer_id, order_date, status)
    VALUES (p_customer_id, NOW(), 'pending');
    
    SET p_order_id = LAST_INSERT_ID();
    
    -- Create savepoint for items
    SAVEPOINT before_items;
    
    -- Process each item
    WHILE v_idx &lt; JSON_LENGTH(p_items) DO
        SET v_product_id = JSON_EXTRACT(p_items, CONCAT('$[', v_idx, '].product_id'));
        SET v_quantity = JSON_EXTRACT(p_items, CONCAT('$[', v_idx, '].quantity'));
        
        -- Check inventory
        SELECT quantity_available INTO @stock
        FROM inventory
        WHERE product_id = v_product_id
        FOR UPDATE;
        
        IF @stock &lt; v_quantity THEN
            -- Rollback to savepoint if item unavailable
            ROLLBACK TO SAVEPOINT before_items;
            UPDATE orders 
            SET status = 'partial', 
                notes = CONCAT('Product ', v_product_id, ' insufficient stock')
            WHERE order_id = p_order_id;
        ELSE
            -- Add order item
            INSERT INTO order_items (order_id, product_id, quantity)
            VALUES (p_order_id, v_product_id, v_quantity);
            
            -- Update inventory
            UPDATE inventory
            SET quantity_available = quantity_available - v_quantity
            WHERE product_id = v_product_id;
        END IF;
        
        SET v_idx = v_idx + 1;
    END WHILE;
    
    COMMIT;
END$$

DELIMITER ;

-- ========================================
-- DISTRIBUTED TRANSACTION EXAMPLE
-- ========================================

-- XA transactions for distributed systems
XA START 'xatest';

INSERT INTO local_table VALUES (1, 'data');

XA END 'xatest';
XA PREPARE 'xatest';
XA COMMIT 'xatest';

-- Or rollback
XA ROLLBACK 'xatest';

-- Recovery after crash
XA RECOVER;</code></pre>
</div>
</section>
<!-- Practice Exercise -->
<section>
<h2>Practice Exercise</h2>
<div class="alert alert-success">
<div class="alert-icon">üíª</div>
<div class="alert-content">
<div class="alert-title">Transaction Challenges</div>
<div class="alert-message">
                                            Implement these transaction scenarios:
                                            <ol>
<li>Create a banking system with atomic transfers</li>
<li>Implement an order processing system with inventory checks</li>
<li>Build a booking system preventing double-bookings</li>
<li>Design a points/rewards system with transaction history</li>
<li>Create a batch processing system with savepoints</li>
<li>Implement deadlock detection and retry logic</li>
<li>Build an audit system tracking all changes</li>
<li>Design a two-phase commit simulation</li>
</ol>
</div>
</div>
</div>
</section>
</div>
<!-- Lesson Navigation -->
<div class="lesson-navigation">
<a class="lesson-nav-button prev" href="/03module/views.html">
<svg fill="currentColor" height="20" viewbox="0 0 20 20" width="20">
<path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"></path>
</svg>
<span>
<small>Previous</small><br/>
                                    Views
                                </span>
</a>
<button class="complete-lesson-btn">
                                Mark as Complete
                            </button>
<a class="lesson-nav-button next" href="/03module/stored_procedures.html">
<span>
<small>Next</small><br/>
                                    Stored Procedures
                                </span>
<svg fill="currentColor" height="20" viewbox="0 0 20 20" width="20">
<path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"></path>
</svg>
</a>
</div>
</article>
</div>
</div>
</main>
<!-- Footer -->
<footer class="site-footer" role="contentinfo">
<div class="footer-container">
<div class="footer-content">
<div class="footer-section footer-about">
<h3>PHP WordPress Development</h3>
<p>Complete Web Development Course</p>
</div>
<div class="footer-section">
<h4>Quick Links</h4>
<ul class="footer-links">
<li><a href="/">Home</a></li>
<li><a href="/module3.html">Module 3</a></li>
<li><a href="/resources.html">Resources</a></li>
</ul>
</div>
<div class="footer-section">
<h4>Support</h4>
<ul class="footer-links">
<li><a href="/help.html">Help Center</a></li>
<li><a href="/faq.html">FAQ</a></li>
<li><a href="/contact.html">Contact</a></li>
</ul>
</div>
</div>
<div class="footer-bottom">
<div class="footer-bottom-content">
<p class="copyright">¬© 2025 PHP WordPress Development Course</p>
<nav class="footer-bottom-links">
<a href="/privacy.html">Privacy</a>
<span class="separator">|</span>
<a href="/terms.html">Terms</a>
</nav>
</div>
</div>
</div>
</footer>
</div>
<!-- Back to Top -->
<button aria-label="Back to top" class="back-to-top" id="back-to-top">
<svg fill="none" height="24" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="24">
<path d="M12 19V5M12 5l-7 7M12 5l7 7"></path>
</svg>
</button>
<!-- JavaScript -->
<script src="/assets/js/navigation.js"></script>
<script src="/assets/js/site-config.js"></script>
<script src="/assets/js/sidebar-toggle.js"></script>
<!-- Universal Mermaid Fix (Enhanced) -->

<!-- Universal Mermaid Fix -->
<script src="/assets/js/mermaid-universal-fix.js"></script>
</body>
</html>