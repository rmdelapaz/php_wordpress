<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>Separating Business Logic from Presentation - PHP WordPress Course</title>
    <meta name="description" content="Learn how to separate business logic from presentation in WordPress. Master clean architecture principles for maintainable WordPress applications.">
    <meta name="keywords" content="WordPress, business logic, presentation layer, separation of concerns, clean architecture">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Separating Business Logic from Presentation">
    <meta property="og:description" content="Implement clean separation of concerns in WordPress applications">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Separating Business Logic</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">Separating Business Logic from Presentation</h1>
                    <p class="lesson-subtitle">Build maintainable WordPress applications with clean architecture</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Understand the importance of separation of concerns</li>
                        <li>Implement service layer patterns</li>
                        <li>Create repository patterns for data access</li>
                        <li>Build view models and presenters</li>
                        <li>Apply dependency injection</li>
                        <li>Design testable business logic</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Understanding Separation of Concerns -->
                    <section>
                        <h2>Understanding Separation of Concerns</h2>
                        
                        <p>Separation of concerns is a design principle that divides a program into distinct sections, each addressing a specific concern. In WordPress applications, this means:</p>
                        
                        <div class="info-box">
                            <h3>Why Separate Business Logic from Presentation?</h3>
                            <ul>
                                <li><strong>Maintainability:</strong> Changes to business rules don't affect presentation</li>
                                <li><strong>Testability:</strong> Business logic can be tested without UI</li>
                                <li><strong>Reusability:</strong> Same logic can serve multiple interfaces</li>
                                <li><strong>Team Collaboration:</strong> Frontend and backend teams work independently</li>
                                <li><strong>Flexibility:</strong> Easy to change presentation layer or add new interfaces</li>
                            </ul>
                        </div>
                        
                        <h3>The Problem with Mixed Concerns</h3>
                        <pre><code class="language-php">
// ❌ Bad: Mixed business logic and presentation
&lt;?php
// In a template file
$user_id = get_current_user_id();
$orders = $wpdb->get_results($wpdb->prepare(
    "SELECT * FROM {$wpdb->prefix}orders WHERE user_id = %d AND status = 'completed'",
    $user_id
));

$total = 0;
foreach ($orders as $order) {
    $total += $order->amount;
    if ($order->amount > 100) {
        $order->discount = $order->amount * 0.1;
    }
}

if ($total > 1000) {
    $loyalty_status = 'Gold';
} elseif ($total > 500) {
    $loyalty_status = 'Silver';
} else {
    $loyalty_status = 'Bronze';
}
?&gt;

&lt;div class="user-dashboard"&gt;
    &lt;h2&gt;Your Orders (<?php echo $loyalty_status; ?> Member)&lt;/h2&gt;
    &lt;?php foreach ($orders as $order): ?&gt;
        &lt;div&gt;Order #&lt;?php echo $order->id; ?&gt; - $&lt;?php echo $order->amount; ?&gt;&lt;/div&gt;
    &lt;?php endforeach; ?&gt;
&lt;/div&gt;
                        </code></pre>
                    </section>
                    
                    <!-- Service Layer Pattern -->
                    <section>
                        <h2>Service Layer Pattern</h2>
                        
                        <p>The service layer encapsulates business logic and coordinates between different parts of the application.</p>
                        
                        <h3>Basic Service Implementation</h3>
                        <pre><code class="language-php">
// src/Services/OrderService.php
namespace App\Services;

use App\Repositories\OrderRepository;
use App\Repositories\UserRepository;
use App\Models\Order;
use App\Events\OrderPlaced;

class OrderService {
    private $orderRepository;
    private $userRepository;
    private $emailService;
    private $inventoryService;
    
    public function __construct(
        OrderRepository $orderRepository,
        UserRepository $userRepository,
        EmailService $emailService,
        InventoryService $inventoryService
    ) {
        $this->orderRepository = $orderRepository;
        $this->userRepository = $userRepository;
        $this->emailService = $emailService;
        $this->inventoryService = $inventoryService;
    }
    
    /**
     * Place a new order
     */
    public function placeOrder(array $orderData): Order {
        // Begin transaction
        global $wpdb;
        $wpdb->query('START TRANSACTION');
        
        try {
            // Validate order data
            $this->validateOrderData($orderData);
            
            // Check inventory
            foreach ($orderData['items'] as $item) {
                if (!$this->inventoryService->checkAvailability($item['product_id'], $item['quantity'])) {
                    throw new \Exception("Product {$item['product_id']} is out of stock");
                }
            }
            
            // Calculate totals
            $orderData['subtotal'] = $this->calculateSubtotal($orderData['items']);
            $orderData['tax'] = $this->calculateTax($orderData['subtotal'], $orderData['shipping_address']);
            $orderData['shipping'] = $this->calculateShipping($orderData['items'], $orderData['shipping_address']);
            $orderData['total'] = $orderData['subtotal'] + $orderData['tax'] + $orderData['shipping'];
            
            // Apply discounts
            $orderData['discount'] = $this->calculateDiscounts($orderData);
            $orderData['total'] -= $orderData['discount'];
            
            // Create order
            $order = $this->orderRepository->create($orderData);
            
            // Update inventory
            foreach ($orderData['items'] as $item) {
                $this->inventoryService->decrementStock($item['product_id'], $item['quantity']);
            }
            
            // Update user statistics
            $this->updateUserStatistics($order->user_id, $order->total);
            
            // Send confirmation email
            $this->emailService->sendOrderConfirmation($order);
            
            // Trigger event
            do_action('order_placed', new OrderPlaced($order));
            
            // Commit transaction
            $wpdb->query('COMMIT');
            
            return $order;
            
        } catch (\Exception $e) {
            // Rollback transaction
            $wpdb->query('ROLLBACK');
            
            // Log error
            error_log('Order placement failed: ' . $e->getMessage());
            
            throw $e;
        }
    }
    
    /**
     * Get user order statistics
     */
    public function getUserOrderStatistics($userId): array {
        $orders = $this->orderRepository->findByUser($userId);
        
        return [
            'total_orders' => count($orders),
            'total_spent' => array_sum(array_column($orders, 'total')),
            'average_order_value' => count($orders) > 0 
                ? array_sum(array_column($orders, 'total')) / count($orders) 
                : 0,
            'loyalty_status' => $this->calculateLoyaltyStatus($orders),
            'recent_orders' => array_slice($orders, 0, 5)
        ];
    }
    
    private function calculateLoyaltyStatus(array $orders): string {
        $total = array_sum(array_column($orders, 'total'));
        
        if ($total > 10000) return 'Platinum';
        if ($total > 5000) return 'Gold';
        if ($total > 1000) return 'Silver';
        return 'Bronze';
    }
    
    private function calculateDiscounts(array $orderData): float {
        $discount = 0;
        
        // Volume discount
        if ($orderData['subtotal'] > 500) {
            $discount += $orderData['subtotal'] * 0.1;
        }
        
        // Loyalty discount
        $user = $this->userRepository->find($orderData['user_id']);
        if ($user->loyalty_status === 'Gold') {
            $discount += $orderData['subtotal'] * 0.05;
        }
        
        // Coupon discount
        if (!empty($orderData['coupon_code'])) {
            $couponDiscount = $this->applyCoupon($orderData['coupon_code'], $orderData['subtotal']);
            $discount += $couponDiscount;
        }
        
        return $discount;
    }
    
    private function validateOrderData(array $data): void {
        $required = ['user_id', 'items', 'shipping_address', 'billing_address'];
        
        foreach ($required as $field) {
            if (empty($data[$field])) {
                throw new \InvalidArgumentException("Field {$field} is required");
            }
        }
        
        if (empty($data['items'])) {
            throw new \InvalidArgumentException("Order must contain at least one item");
        }
    }
}
                        </code></pre>
                        
                        <h3>Service Provider Pattern</h3>
                        <pre><code class="language-php">
// src/Providers/ServiceProvider.php
namespace App\Providers;

use App\Container;

abstract class ServiceProvider {
    protected $container;
    
    public function __construct(Container $container) {
        $this->container = $container;
    }
    
    abstract public function register(): void;
    abstract public function boot(): void;
}

// src/Providers/OrderServiceProvider.php
namespace App\Providers;

use App\Services\OrderService;
use App\Repositories\OrderRepository;
use App\Repositories\UserRepository;
use App\Services\EmailService;
use App\Services\InventoryService;

class OrderServiceProvider extends ServiceProvider {
    public function register(): void {
        $this->container->singleton(OrderService::class, function($container) {
            return new OrderService(
                $container->get(OrderRepository::class),
                $container->get(UserRepository::class),
                $container->get(EmailService::class),
                $container->get(InventoryService::class)
            );
        });
    }
    
    public function boot(): void {
        // Register hooks
        add_action('init', [$this, 'registerOrderPostType']);
        add_action('rest_api_init', [$this, 'registerOrderEndpoints']);
    }
    
    public function registerOrderPostType() {
        register_post_type('shop_order', [
            'public' => false,
            'show_ui' => true,
            'supports' => ['title', 'custom-fields'],
            'labels' => [
                'name' => 'Orders',
                'singular_name' => 'Order'
            ]
        ]);
    }
    
    public function registerOrderEndpoints() {
        register_rest_route('app/v1', '/orders', [
            'methods' => 'POST',
            'callback' => [$this->container->get(OrderService::class), 'placeOrder'],
            'permission_callback' => 'is_user_logged_in'
        ]);
    }
}
                        </code></pre>
                    </section>
                    
                    <!-- Repository Pattern -->
                    <section>
                        <h2>Repository Pattern for Data Access</h2>
                        
                        <h3>Repository Interface</h3>
                        <pre><code class="language-php">
// src/Repositories/Contracts/RepositoryInterface.php
namespace App\Repositories\Contracts;

interface RepositoryInterface {
    public function all(array $columns = ['*']);
    public function paginate(int $perPage = 15, array $columns = ['*']);
    public function find($id, array $columns = ['*']);
    public function findBy(string $field, $value, array $columns = ['*']);
    public function findWhere(array $where, array $columns = ['*']);
    public function create(array $data);
    public function update($id, array $data);
    public function delete($id);
    public function count(array $where = []): int;
    public function exists($id): bool;
}
                        </code></pre>
                        
                        <h3>WordPress Repository Implementation</h3>
                        <pre><code class="language-php">
// src/Repositories/WordPressRepository.php
namespace App\Repositories;

use App\Repositories\Contracts\RepositoryInterface;

abstract class WordPressRepository implements RepositoryInterface {
    protected $postType;
    protected $metaKeys = [];
    
    public function all(array $columns = ['*']) {
        $args = [
            'post_type' => $this->postType,
            'posts_per_page' => -1,
            'post_status' => 'publish'
        ];
        
        if ($columns !== ['*']) {
            $args['fields'] = $columns;
        }
        
        $posts = get_posts($args);
        return $this->hydrateMany($posts);
    }
    
    public function paginate(int $perPage = 15, array $columns = ['*']) {
        $paged = get_query_var('paged') ?: 1;
        
        $query = new \WP_Query([
            'post_type' => $this->postType,
            'posts_per_page' => $perPage,
            'paged' => $paged,
            'post_status' => 'publish'
        ]);
        
        return [
            'data' => $this->hydrateMany($query->posts),
            'total' => $query->found_posts,
            'per_page' => $perPage,
            'current_page' => $paged,
            'last_page' => $query->max_num_pages
        ];
    }
    
    public function find($id, array $columns = ['*']) {
        $post = get_post($id);
        
        if (!$post || $post->post_type !== $this->postType) {
            return null;
        }
        
        return $this->hydrate($post);
    }
    
    public function findBy(string $field, $value, array $columns = ['*']) {
        if ($field === 'slug') {
            $post = get_page_by_path($value, OBJECT, $this->postType);
            return $post ? $this->hydrate($post) : null;
        }
        
        $args = [
            'post_type' => $this->postType,
            'meta_key' => $field,
            'meta_value' => $value,
            'posts_per_page' => 1,
            'post_status' => 'publish'
        ];
        
        $posts = get_posts($args);
        return !empty($posts) ? $this->hydrate($posts[0]) : null;
    }
    
    public function findWhere(array $where, array $columns = ['*']) {
        $args = [
            'post_type' => $this->postType,
            'post_status' => 'publish',
            'meta_query' => []
        ];
        
        foreach ($where as $key => $value) {
            if (in_array($key, ['title', 'content', 'status'])) {
                $args['post_' . $key] = $value;
            } else {
                $args['meta_query'][] = [
                    'key' => $key,
                    'value' => $value,
                    'compare' => is_array($value) ? 'IN' : '='
                ];
            }
        }
        
        $posts = get_posts($args);
        return $this->hydrateMany($posts);
    }
    
    public function create(array $data) {
        $postData = [
            'post_type' => $this->postType,
            'post_status' => $data['status'] ?? 'publish',
            'post_title' => $data['title'] ?? '',
            'post_content' => $data['content'] ?? ''
        ];
        
        $postId = wp_insert_post($postData);
        
        if (is_wp_error($postId)) {
            throw new \Exception($postId->get_error_message());
        }
        
        // Save meta data
        foreach ($data as $key => $value) {
            if (in_array($key, $this->metaKeys)) {
                update_post_meta($postId, $key, $value);
            }
        }
        
        return $this->find($postId);
    }
    
    public function update($id, array $data) {
        $postData = ['ID' => $id];
        
        if (isset($data['title'])) {
            $postData['post_title'] = $data['title'];
        }
        
        if (isset($data['content'])) {
            $postData['post_content'] = $data['content'];
        }
        
        if (isset($data['status'])) {
            $postData['post_status'] = $data['status'];
        }
        
        $result = wp_update_post($postData);
        
        if (is_wp_error($result)) {
            throw new \Exception($result->get_error_message());
        }
        
        // Update meta data
        foreach ($data as $key => $value) {
            if (in_array($key, $this->metaKeys)) {
                update_post_meta($id, $key, $value);
            }
        }
        
        return $this->find($id);
    }
    
    public function delete($id) {
        return wp_delete_post($id, true);
    }
    
    public function count(array $where = []): int {
        $args = [
            'post_type' => $this->postType,
            'post_status' => 'publish',
            'fields' => 'ids'
        ];
        
        if (!empty($where)) {
            $args['meta_query'] = [];
            foreach ($where as $key => $value) {
                $args['meta_query'][] = [
                    'key' => $key,
                    'value' => $value
                ];
            }
        }
        
        $query = new \WP_Query($args);
        return $query->found_posts;
    }
    
    public function exists($id): bool {
        return $this->find($id) !== null;
    }
    
    protected function hydrate($post) {
        if (!$post) return null;
        
        $data = [
            'id' => $post->ID,
            'title' => $post->post_title,
            'content' => $post->post_content,
            'status' => $post->post_status,
            'created_at' => $post->post_date,
            'updated_at' => $post->post_modified
        ];
        
        // Add meta data
        foreach ($this->metaKeys as $key) {
            $data[$key] = get_post_meta($post->ID, $key, true);
        }
        
        return $this->createModel($data);
    }
    
    protected function hydrateMany($posts) {
        return array_map([$this, 'hydrate'], $posts);
    }
    
    abstract protected function createModel(array $data);
}

// src/Repositories/ProductRepository.php
namespace App\Repositories;

use App\Models\Product;

class ProductRepository extends WordPressRepository {
    protected $postType = 'product';
    protected $metaKeys = ['price', 'sku', 'stock', 'featured'];
    
    protected function createModel(array $data) {
        return new Product($data);
    }
    
    public function getFeatured($limit = 4) {
        return $this->findWhere(['featured' => 'yes']);
    }
    
    public function getInStock() {
        $args = [
            'post_type' => $this->postType,
            'meta_query' => [
                [
                    'key' => 'stock',
                    'value' => 0,
                    'compare' => '>',
                    'type' => 'NUMERIC'
                ]
            ]
        ];
        
        $posts = get_posts($args);
        return $this->hydrateMany($posts);
    }
}
                        </code></pre>
                    </section>
                    
                    <!-- View Models and Presenters -->
                    <section>
                        <h2>View Models and Presenters</h2>
                        
                        <p>View models and presenters prepare data for presentation, keeping display logic out of templates.</p>
                        
                        <h3>View Model Implementation</h3>
                        <pre><code class="language-php">
// src/ViewModels/ViewModel.php
namespace App\ViewModels;

abstract class ViewModel {
    protected $data = [];
    
    public function __get($key) {
        return $this->data[$key] ?? null;
    }
    
    public function __set($key, $value) {
        $this->data[$key] = $value;
    }
    
    public function toArray(): array {
        return $this->data;
    }
    
    public function toJson(): string {
        return json_encode($this->data);
    }
}

// src/ViewModels/ProductViewModel.php
namespace App\ViewModels;

use App\Models\Product;

class ProductViewModel extends ViewModel {
    private $product;
    
    public function __construct(Product $product) {
        $this->product = $product;
        $this->prepareData();
    }
    
    protected function prepareData() {
        $this->data = [
            'id' => $this->product->id,
            'name' => $this->product->name,
            'price' => $this->formatPrice($this->product->price),
            'original_price' => $this->product->original_price 
                ? $this->formatPrice($this->product->original_price) 
                : null,
            'discount_percentage' => $this->calculateDiscountPercentage(),
            'in_stock' => $this->product->stock > 0,
            'stock_status' => $this->getStockStatus(),
            'stock_class' => $this->getStockClass(),
            'image_url' => $this->getImageUrl(),
            'thumbnail_url' => $this->getThumbnailUrl(),
            'gallery' => $this->getGalleryImages(),
            'rating' => $this->formatRating(),
            'review_count' => $this->product->review_count,
            'add_to_cart_url' => $this->getAddToCartUrl(),
            'permalink' => get_permalink($this->product->id),
            'is_featured' => $this->product->featured,
            'is_on_sale' => $this->product->original_price > $this->product->price,
            'badges' => $this->getBadges()
        ];
    }
    
    private function formatPrice($price) {
        return get_woocommerce_currency_symbol() . number_format($price, 2);
    }
    
    private function calculateDiscountPercentage() {
        if (!$this->product->original_price || $this->product->original_price <= $this->product->price) {
            return 0;
        }
        
        return round((($this->product->original_price - $this->product->price) / $this->product->original_price) * 100);
    }
    
    private function getStockStatus() {
        if ($this->product->stock <= 0) {
            return 'Out of Stock';
        } elseif ($this->product->stock <= 5) {
            return "Only {$this->product->stock} left in stock";
        } else {
            return 'In Stock';
        }
    }
    
    private function getStockClass() {
        if ($this->product->stock <= 0) {
            return 'out-of-stock';
        } elseif ($this->product->stock <= 5) {
            return 'low-stock';
        } else {
            return 'in-stock';
        }
    }
    
    private function getImageUrl() {
        return get_the_post_thumbnail_url($this->product->id, 'large') 
            ?: '/assets/images/placeholder.png';
    }
    
    private function getThumbnailUrl() {
        return get_the_post_thumbnail_url($this->product->id, 'thumbnail') 
            ?: '/assets/images/placeholder-thumb.png';
    }
    
    private function getGalleryImages() {
        $gallery = [];
        $attachment_ids = $this->product->gallery_image_ids ?? [];
        
        foreach ($attachment_ids as $attachment_id) {
            $gallery[] = [
                'thumbnail' => wp_get_attachment_image_url($attachment_id, 'thumbnail'),
                'full' => wp_get_attachment_image_url($attachment_id, 'full')
            ];
        }
        
        return $gallery;
    }
    
    private function formatRating() {
        return [
            'average' => round($this->product->average_rating, 1),
            'stars' => $this->renderStars($this->product->average_rating),
            'count' => $this->product->review_count
        ];
    }
    
    private function renderStars($rating) {
        $fullStars = floor($rating);
        $halfStar = ($rating - $fullStars) >= 0.5 ? 1 : 0;
        $emptyStars = 5 - $fullStars - $halfStar;
        
        return str_repeat('★', $fullStars) . 
               str_repeat('☆', $halfStar) . 
               str_repeat('☆', $emptyStars);
    }
    
    private function getAddToCartUrl() {
        return add_query_arg([
            'add-to-cart' => $this->product->id,
            'quantity' => 1
        ], wc_get_cart_url());
    }
    
    private function getBadges() {
        $badges = [];
        
        if ($this->product->featured) {
            $badges[] = ['text' => 'Featured', 'class' => 'badge-featured'];
        }
        
        if ($this->product->is_new) {
            $badges[] = ['text' => 'New', 'class' => 'badge-new'];
        }
        
        if ($this->calculateDiscountPercentage() > 0) {
            $badges[] = [
                'text' => "-{$this->calculateDiscountPercentage()}%", 
                'class' => 'badge-sale'
            ];
        }
        
        return $badges;
    }
}
                        </code></pre>
                        
                        <h3>Presenter Pattern</h3>
                        <pre><code class="language-php">
// src/Presenters/Presenter.php
namespace App\Presenters;

abstract class Presenter {
    protected $entity;
    
    public function __construct($entity) {
        $this->entity = $entity;
    }
    
    public function __get($property) {
        if (method_exists($this, $property)) {
            return $this->{$property}();
        }
        
        return $this->entity->{$property};
    }
    
    public function __call($method, $args) {
        return call_user_func_array([$this->entity, $method], $args);
    }
}

// src/Presenters/OrderPresenter.php
namespace App\Presenters;

use App\Models\Order;

class OrderPresenter extends Presenter {
    public function status() {
        $statuses = [
            'pending' => ['label' => 'Pending', 'class' => 'status-pending'],
            'processing' => ['label' => 'Processing', 'class' => 'status-processing'],
            'completed' => ['label' => 'Completed', 'class' => 'status-completed'],
            'cancelled' => ['label' => 'Cancelled', 'class' => 'status-cancelled']
        ];
        
        return $statuses[$this->entity->status] ?? ['label' => 'Unknown', 'class' => ''];
    }
    
    public function date() {
        return date_i18n(get_option('date_format'), strtotime($this->entity->created_at));
    }
    
    public function time() {
        return date_i18n(get_option('time_format'), strtotime($this->entity->created_at));
    }
    
    public function total() {
        return wc_price($this->entity->total);
    }
    
    public function customer() {
        $user = get_userdata($this->entity->user_id);
        
        return [
            'name' => $user->display_name,
            'email' => $user->user_email,
            'avatar' => get_avatar_url($user->ID)
        ];
    }
    
    public function itemCount() {
        $count = count($this->entity->items);
        return sprintf(_n('%d item', '%d items', $count), $count);
    }
    
    public function canBeCancelled() {
        return in_array($this->entity->status, ['pending', 'processing']);
    }
    
    public function actions() {
        $actions = [];
        
        if ($this->canBeCancelled()) {
            $actions[] = [
                'label' => 'Cancel',
                'url' => wp_nonce_url(
                    add_query_arg('action', 'cancel', get_permalink($this->entity->id)),
                    'cancel-order-' . $this->entity->id
                ),
                'class' => 'button-cancel'
            ];
        }
        
        $actions[] = [
            'label' => 'View',
            'url' => get_permalink($this->entity->id),
            'class' => 'button-view'
        ];
        
        if ($this->entity->status === 'completed') {
            $actions[] = [
                'label' => 'Download Invoice',
                'url' => add_query_arg('download-invoice', $this->entity->id),
                'class' => 'button-download'
            ];
        }
        
        return $actions;
    }
}
                        </code></pre>
                    </section>
                    
                    <!-- Dependency Injection -->
                    <section>
                        <h2>Dependency Injection</h2>
                        
                        <h3>Container Implementation</h3>
                        <pre><code class="language-php">
// src/Container.php
namespace App;

class Container {
    private static $instance;
    private $bindings = [];
    private $singletons = [];
    private $instances = [];
    
    public static function getInstance() {
        if (!self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    public function bind($abstract, $concrete = null) {
        if ($concrete === null) {
            $concrete = $abstract;
        }
        
        $this->bindings[$abstract] = $concrete;
    }
    
    public function singleton($abstract, $concrete = null) {
        $this->bind($abstract, $concrete);
        $this->singletons[] = $abstract;
    }
    
    public function get($abstract, $parameters = []) {
        // Return existing singleton instance
        if (isset($this->instances[$abstract])) {
            return $this->instances[$abstract];
        }
        
        $concrete = $this->bindings[$abstract] ?? $abstract;
        
        // Build the instance
        if ($concrete instanceof \Closure) {
            $object = $concrete($this, $parameters);
        } else {
            $object = $this->build($concrete, $parameters);
        }
        
        // Store singleton instance
        if (in_array($abstract, $this->singletons)) {
            $this->instances[$abstract] = $object;
        }
        
        return $object;
    }
    
    private function build($concrete, $parameters = []) {
        $reflector = new \ReflectionClass($concrete);
        
        if (!$reflector->isInstantiable()) {
            throw new \Exception("Class {$concrete} is not instantiable");
        }
        
        $constructor = $reflector->getConstructor();
        
        if (is_null($constructor)) {
            return new $concrete;
        }
        
        $dependencies = $constructor->getParameters();
        $instances = $this->resolveDependencies($dependencies, $parameters);
        
        return $reflector->newInstanceArgs($instances);
    }
    
    private function resolveDependencies($dependencies, $parameters) {
        $results = [];
        
        foreach ($dependencies as $dependency) {
            // Use provided parameter
            if (isset($parameters[$dependency->getName()])) {
                $results[] = $parameters[$dependency->getName()];
                continue;
            }
            
            // Resolve type-hinted class
            $type = $dependency->getType();
            
            if ($type && !$type->isBuiltin()) {
                $results[] = $this->get($type->getName());
                continue;
            }
            
            // Use default value if available
            if ($dependency->isDefaultValueAvailable()) {
                $results[] = $dependency->getDefaultValue();
                continue;
            }
            
            throw new \Exception("Unable to resolve dependency {$dependency->getName()}");
        }
        
        return $results;
    }
}

// Usage
$container = Container::getInstance();

// Bind interfaces to implementations
$container->bind(
    'App\Repositories\Contracts\OrderRepositoryInterface',
    'App\Repositories\OrderRepository'
);

// Register singletons
$container->singleton('App\Services\OrderService');

// Resolve dependencies automatically
$orderService = $container->get('App\Services\OrderService');
                        </code></pre>
                    </section>
                    
                    <!-- Clean Template Implementation -->
                    <section>
                        <h2>Clean Template Implementation</h2>
                        
                        <p>With business logic separated, templates become clean and focused on presentation:</p>
                        
                        <pre><code class="language-php">
// ✅ Good: Clean template with separated concerns
&lt;?php
// templates/user-dashboard.php

// Get data from service layer
$orderService = app()->get(OrderService::class);
$statistics = $orderService->getUserOrderStatistics(get_current_user_id());

// Create view model
$viewModel = new UserDashboardViewModel($statistics);
?&gt;

&lt;div class="user-dashboard"&gt;
    &lt;h2&gt;Your Dashboard (&lt;?php echo esc_html($viewModel->loyaltyBadge); ?&gt;)&lt;/h2&gt;
    
    &lt;div class="dashboard-stats"&gt;
        &lt;div class="stat-card"&gt;
            &lt;span class="stat-value"&gt;&lt;?php echo esc_html($viewModel->totalOrders); ?&gt;&lt;/span&gt;
            &lt;span class="stat-label"&gt;Total Orders&lt;/span&gt;
        &lt;/div&gt;
        &lt;div class="stat-card"&gt;
            &lt;span class="stat-value"&gt;&lt;?php echo esc_html($viewModel->totalSpent); ?&gt;&lt;/span&gt;
            &lt;span class="stat-label"&gt;Total Spent&lt;/span&gt;
        &lt;/div&gt;
        &lt;div class="stat-card"&gt;
            &lt;span class="stat-value"&gt;&lt;?php echo esc_html($viewModel->averageOrderValue); ?&gt;&lt;/span&gt;
            &lt;span class="stat-label"&gt;Average Order&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;div class="recent-orders"&gt;
        &lt;h3&gt;Recent Orders&lt;/h3&gt;
        &lt;?php foreach ($viewModel->recentOrders as $order): ?&gt;
            &lt;div class="order-card"&gt;
                &lt;div class="order-header"&gt;
                    &lt;span class="order-number"&gt;#&lt;?php echo esc_html($order->number); ?&gt;&lt;/span&gt;
                    &lt;span class="order-date"&gt;&lt;?php echo esc_html($order->date); ?&gt;&lt;/span&gt;
                &lt;/div&gt;
                &lt;div class="order-body"&gt;
                    &lt;span class="order-items"&gt;&lt;?php echo esc_html($order->itemCount); ?&gt;&lt;/span&gt;
                    &lt;span class="order-total"&gt;&lt;?php echo esc_html($order->total); ?&gt;&lt;/span&gt;
                &lt;/div&gt;
                &lt;div class="order-footer"&gt;
                    &lt;span class="order-status &lt;?php echo esc_attr($order->statusClass); ?&gt;"&gt;
                        &lt;?php echo esc_html($order->statusLabel); ?&gt;
                    &lt;/span&gt;
                    &lt;?php foreach ($order->actions as $action): ?&gt;
                        &lt;a href="&lt;?php echo esc_url($action['url']); ?&gt;" 
                           class="&lt;?php echo esc_attr($action['class']); ?&gt;"&gt;
                            &lt;?php echo esc_html($action['label']); ?&gt;
                        &lt;/a&gt;
                    &lt;?php endforeach; ?&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;?php endforeach; ?&gt;
    &lt;/div&gt;
&lt;/div&gt;
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>Separation of concerns improves maintainability and testability</li>
                                <li>Service layer encapsulates business logic</li>
                                <li>Repository pattern abstracts data access</li>
                                <li>View models prepare data for presentation</li>
                                <li>Presenters format entity data for display</li>
                                <li>Dependency injection enables loose coupling</li>
                                <li>Clean templates focus on presentation only</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Best Practices</h3>
                            <ul>
                                <li>Keep business logic in service classes</li>
                                <li>Use repositories for all data access</li>
                                <li>Create view models for complex views</li>
                                <li>Implement dependency injection consistently</li>
                                <li>Write unit tests for business logic</li>
                                <li>Keep templates simple and logic-free</li>
                                <li>Use type hints and return types</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://martinfowler.com/eaaCatalog/serviceLayer.html" target="_blank">Service Layer Pattern - Martin Fowler</a></li>
                            <li><a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/ddd-oriented-microservice" target="_blank">Domain-Driven Design</a></li>
                            <li><a href="https://symfony.com/doc/current/service_container.html" target="_blank">Symfony Service Container</a></li>
                            <li><a href="https://refactoring.guru/design-patterns/repository" target="_blank">Repository Pattern</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/project_structure.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            Project Structure
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/building_reusable_components.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            Building Reusable Components
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>