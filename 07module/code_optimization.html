<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>WordPress Code Optimization - PHP WordPress Course</title>
    <meta name="description" content="Learn advanced code optimization techniques for WordPress including asset optimization, lazy loading, and performance improvements.">
    <meta name="keywords" content="WordPress, code optimization, performance, minification, lazy loading">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="WordPress Code Optimization">
    <meta property="og:description" content="Optimize WordPress code for maximum performance">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Code Optimization</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">WordPress Code Optimization</h1>
                    <p class="lesson-subtitle">Advanced techniques for optimizing WordPress code and assets</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Optimize and minify CSS and JavaScript</li>
                        <li>Implement lazy loading for images and iframes</li>
                        <li>Optimize database queries</li>
                        <li>Implement code splitting and async loading</li>
                        <li>Optimize autoloading and dependencies</li>
                        <li>Apply PHP optimization techniques</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Asset Optimization System -->
                    <section>
                        <h2>Advanced Asset Optimization</h2>
                        
                        <h3>Complete Asset Manager</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * WordPress Asset Optimization Manager
 */
class WP_Asset_Optimizer {
    
    private $critical_css = '';
    private $deferred_scripts = [];
    private $async_scripts = [];
    private $inline_scripts = [];
    private $combined_assets = [];
    
    public function __construct() {
        // Asset optimization
        add_action('wp_enqueue_scripts', [$this, 'analyze_assets'], 999);
        add_filter('script_loader_tag', [$this, 'optimize_script_loading'], 10, 3);
        add_filter('style_loader_tag', [$this, 'optimize_style_loading'], 10, 4);
        
        // Minification
        add_filter('wp_loaded', [$this, 'start_buffer']);
        add_action('shutdown', [$this, 'end_buffer'], 0);
        
        // Critical CSS
        add_action('wp_head', [$this, 'inject_critical_css'], 1);
        
        // Preloading
        add_action('wp_head', [$this, 'add_resource_hints'], 2);
        
        // Lazy loading
        add_filter('the_content', [$this, 'lazy_load_content']);
        add_filter('post_thumbnail_html', [$this, 'lazy_load_thumbnail']);
        add_filter('get_avatar', [$this, 'lazy_load_avatar']);
        
        // Remove unnecessary assets
        $this->remove_unnecessary_assets();
    }
    
    /**
     * Analyze and optimize enqueued assets
     */
    public function analyze_assets() {
        global $wp_scripts, $wp_styles;
        
        // Analyze scripts
        foreach ($wp_scripts->queue as $handle) {
            if (isset($wp_scripts->registered[$handle])) {
                $script = $wp_scripts->registered[$handle];
                
                // Determine loading strategy
                if ($this->should_defer_script($handle, $script)) {
                    $this->deferred_scripts[] = $handle;
                } elseif ($this->should_async_script($handle, $script)) {
                    $this->async_scripts[] = $handle;
                }
                
                // Check if can be inlined
                if ($this->should_inline_script($handle, $script)) {
                    $this->inline_script($handle, $script);
                }
            }
        }
        
        // Analyze styles
        foreach ($wp_styles->queue as $handle) {
            if (isset($wp_styles->registered[$handle])) {
                $style = $wp_styles->registered[$handle];
                
                // Extract critical CSS
                if ($this->is_critical_style($handle, $style)) {
                    $this->extract_critical_css($style);
                }
                
                // Check if can be inlined
                if ($this->should_inline_style($handle, $style)) {
                    $this->inline_style($handle, $style);
                }
            }
        }
        
        // Combine assets if beneficial
        $this->combine_assets();
    }
    
    /**
     * Optimize script loading
     */
    public function optimize_script_loading($tag, $handle, $src) {
        // Add defer attribute
        if (in_array($handle, $this->deferred_scripts)) {
            return str_replace(' src', ' defer src', $tag);
        }
        
        // Add async attribute
        if (in_array($handle, $this->async_scripts)) {
            return str_replace(' src', ' async src', $tag);
        }
        
        // Add module type for ES6 modules
        if (strpos($src, '.mjs') !== false || $this->is_module($handle)) {
            return str_replace('<script', '<script type="module"', $tag);
        }
        
        // Add preload for critical scripts
        if ($this->is_critical_script($handle)) {
            $preload = sprintf(
                '<link rel="preload" href="%s" as="script">',
                esc_url($src)
            );
            return $preload . $tag;
        }
        
        return $tag;
    }
    
    /**
     * Optimize style loading
     */
    public function optimize_style_loading($tag, $handle, $href, $media) {
        // Load non-critical CSS asynchronously
        if (!$this->is_critical_style($handle)) {
            $async_css = sprintf(
                '<link rel="preload" href="%s" as="style" onload="this.onload=null;this.rel=\'stylesheet\'" media="%s">',
                esc_url($href),
                esc_attr($media)
            );
            
            // Add noscript fallback
            $noscript = sprintf(
                '<noscript>%s</noscript>',
                $tag
            );
            
            return $async_css . $noscript;
        }
        
        return $tag;
    }
    
    /**
     * Start output buffering for minification
     */
    public function start_buffer() {
        if (!is_admin() && !is_user_logged_in()) {
            ob_start([$this, 'minify_html']);
        }
    }
    
    /**
     * End output buffering
     */
    public function end_buffer() {
        if (ob_get_level() > 0) {
            ob_end_flush();
        }
    }
    
    /**
     * Minify HTML output
     */
    public function minify_html($html) {
        // Skip if contains <pre> or <textarea>
        if (preg_match('/<(pre|textarea)/', $html)) {
            return $html;
        }
        
        // Remove HTML comments (keep IE conditionals)
        $html = preg_replace('/<!--(?!\[if)(?!wp:).*?-->/s', '', $html);
        
        // Minify inline CSS
        $html = preg_replace_callback('/<style[^>]*>(.*?)<\/style>/is', function($matches) {
            return '<style>' . $this->minify_css($matches[1]) . '</style>';
        }, $html);
        
        // Minify inline JavaScript
        $html = preg_replace_callback('/<script[^>]*>(.*?)<\/script>/is', function($matches) {
            // Skip if external script
            if (strpos($matches[0], 'src=') !== false) {
                return $matches[0];
            }
            
            // Skip if contains certain patterns that break with minification
            if (preg_match('/document\.write|innerHTML/i', $matches[1])) {
                return $matches[0];
            }
            
            return '<script>' . $this->minify_js($matches[1]) . '</script>';
        }, $html);
        
        // Remove whitespace between tags
        $html = preg_replace('/>\s+</', '><', $html);
        
        // Remove multiple spaces
        $html = preg_replace('/\s+/', ' ', $html);
        
        return trim($html);
    }
    
    /**
     * Minify CSS
     */
    private function minify_css($css) {
        // Remove comments
        $css = preg_replace('/\/\*.*?\*\//s', '', $css);
        
        // Remove unnecessary whitespace
        $css = preg_replace('/\s+/', ' ', $css);
        
        // Remove whitespace around specific characters
        $css = preg_replace('/\s*([{}:;,])\s*/', '$1', $css);
        
        // Remove trailing semicolon before closing brace
        $css = str_replace(';}', '}', $css);
        
        // Remove unnecessary zeros
        $css = preg_replace('/(:| )0\.(\d+)/', '$1.$2', $css);
        $css = preg_replace('/(:| )0px/', '$1 0', $css);
        
        // Shorten hex colors
        $css = preg_replace('/#([a-f0-9])\1([a-f0-9])\2([a-f0-9])\3/i', '#$1$2$3', $css);
        
        return trim($css);
    }
    
    /**
     * Minify JavaScript
     */
    private function minify_js($js) {
        // Very basic JS minification (use with caution)
        // For production, use a proper JS minifier
        
        // Remove single-line comments
        $js = preg_replace('/\/\/(?!["\']).*$/m', '', $js);
        
        // Remove multi-line comments
        $js = preg_replace('/\/\*.*?\*\//s', '', $js);
        
        // Remove unnecessary whitespace
        $js = preg_replace('/\s+/', ' ', $js);
        
        // Remove whitespace around operators
        $js = preg_replace('/\s*([=+\-*\/%&|^!~<>?:,;{}()\[\]])\s*/', '$1', $js);
        
        return trim($js);
    }
    
    /**
     * Inject critical CSS
     */
    public function inject_critical_css() {
        if (!empty($this->critical_css)) {
            echo '<style id="critical-css">' . $this->critical_css . '</style>';
        }
    }
    
    /**
     * Add resource hints
     */
    public function add_resource_hints() {
        global $wp_scripts, $wp_styles;
        
        $dns_prefetch = [];
        $preconnect = [];
        $preload = [];
        
        // Analyze external resources
        foreach ($wp_scripts->queue as $handle) {
            if (isset($wp_scripts->registered[$handle])) {
                $src = $wp_scripts->registered[$handle]->src;
                
                if ($this->is_external_url($src)) {
                    $domain = parse_url($src, PHP_URL_HOST);
                    $dns_prefetch[] = $domain;
                    
                    if ($this->is_critical_script($handle)) {
                        $preconnect[] = $domain;
                    }
                }
            }
        }
        
        // Output DNS prefetch
        foreach (array_unique($dns_prefetch) as $domain) {
            echo '<link rel="dns-prefetch" href="//' . esc_attr($domain) . '">' . "\n";
        }
        
        // Output preconnect
        foreach (array_unique($preconnect) as $domain) {
            echo '<link rel="preconnect" href="//' . esc_attr($domain) . '" crossorigin>' . "\n";
        }
        
        // Preload fonts
        $this->preload_fonts();
    }
    
    /**
     * Preload fonts
     */
    private function preload_fonts() {
        $fonts = [
            '/wp-content/themes/mytheme/fonts/font.woff2',
            // Add your font paths
        ];
        
        foreach ($fonts as $font) {
            printf(
                '<link rel="preload" href="%s" as="font" type="font/woff2" crossorigin="anonymous">' . "\n",
                esc_url($font)
            );
        }
    }
    
    /**
     * Lazy load content
     */
    public function lazy_load_content($content) {
        // Skip if AMP
        if (function_exists('is_amp_endpoint') && is_amp_endpoint()) {
            return $content;
        }
        
        // Lazy load images
        $content = preg_replace_callback('/<img([^>]+)>/i', function($matches) {
            $img_tag = $matches[0];
            
            // Skip if already has loading attribute
            if (strpos($img_tag, 'loading=') !== false) {
                return $img_tag;
            }
            
            // Skip if is eager loading candidate
            if ($this->is_eager_loading_candidate($img_tag)) {
                return str_replace('<img', '<img loading="eager"', $img_tag);
            }
            
            // Add lazy loading
            return str_replace('<img', '<img loading="lazy"', $img_tag);
        }, $content);
        
        // Lazy load iframes
        $content = preg_replace_callback('/<iframe([^>]+)>/i', function($matches) {
            $iframe_tag = $matches[0];
            
            // Skip if already has loading attribute
            if (strpos($iframe_tag, 'loading=') !== false) {
                return $iframe_tag;
            }
            
            // Add lazy loading
            return str_replace('<iframe', '<iframe loading="lazy"', $iframe_tag);
        }, $content);
        
        return $content;
    }
    
    /**
     * Remove unnecessary assets
     */
    private function remove_unnecessary_assets() {
        // Remove emoji scripts
        remove_action('wp_head', 'print_emoji_detection_script', 7);
        remove_action('wp_print_styles', 'print_emoji_styles');
        remove_action('admin_print_scripts', 'print_emoji_detection_script');
        remove_action('admin_print_styles', 'print_emoji_styles');
        
        // Remove oEmbed
        remove_action('wp_head', 'wp_oembed_add_discovery_links');
        remove_action('wp_head', 'wp_oembed_add_host_js');
        
        // Remove RSD link
        remove_action('wp_head', 'rsd_link');
        
        // Remove WLW manifest
        remove_action('wp_head', 'wlwmanifest_link');
        
        // Remove shortlink
        remove_action('wp_head', 'wp_shortlink_wp_head');
        
        // Remove RSS feeds
        remove_action('wp_head', 'feed_links', 2);
        remove_action('wp_head', 'feed_links_extra', 3);
        
        // Remove REST API link
        remove_action('wp_head', 'rest_output_link_wp_head');
        
        // Disable Gutenberg block styles if not using blocks
        if (!has_blocks()) {
            wp_dequeue_style('wp-block-library');
            wp_dequeue_style('wp-block-library-theme');
        }
    }
    
    /**
     * Combine and optimize assets
     */
    private function combine_assets() {
        // This would combine multiple CSS/JS files into single files
        // Implementation depends on specific needs
    }
}

// Initialize asset optimizer
new WP_Asset_Optimizer();

/**
 * Advanced Image Optimization
 */
class WP_Image_Optimizer {
    
    public function __construct() {
        // Image optimization
        add_filter('wp_handle_upload', [$this, 'optimize_uploaded_image']);
        add_filter('wp_generate_attachment_metadata', [$this, 'optimize_image_sizes'], 10, 2);
        
        // Responsive images
        add_filter('wp_calculate_image_srcset', [$this, 'optimize_srcset'], 10, 5);
        add_filter('max_srcset_image_width', [$this, 'max_srcset_width']);
        
        // WebP support
        add_filter('wp_handle_upload_prefilter', [$this, 'convert_to_webp']);
        add_filter('image_make_intermediate_size', [$this, 'create_webp_subsizes']);
        
        // Lazy loading with intersection observer
        add_action('wp_footer', [$this, 'add_lazy_load_script']);
    }
    
    /**
     * Optimize uploaded image
     */
    public function optimize_uploaded_image($upload) {
        if (!$upload['type'] || strpos($upload['type'], 'image') === false) {
            return $upload;
        }
        
        $file_path = $upload['file'];
        
        // Get image type
        $image_type = exif_imagetype($file_path);
        
        switch ($image_type) {
            case IMAGETYPE_JPEG:
                $this->optimize_jpeg($file_path);
                break;
            
            case IMAGETYPE_PNG:
                $this->optimize_png($file_path);
                break;
            
            case IMAGETYPE_GIF:
                $this->optimize_gif($file_path);
                break;
        }
        
        return $upload;
    }
    
    /**
     * Optimize JPEG
     */
    private function optimize_jpeg($file_path) {
        $image = imagecreatefromjpeg($file_path);
        
        if ($image) {
            // Remove EXIF data
            $this->strip_exif($file_path);
            
            // Save with optimal quality
            imagejpeg($image, $file_path, 85);
            imagedestroy($image);
            
            // Use jpegoptim if available
            if ($this->command_exists('jpegoptim')) {
                exec("jpegoptim --strip-all --max=85 " . escapeshellarg($file_path));
            }
        }
    }
    
    /**
     * Optimize PNG
     */
    private function optimize_png($file_path) {
        // Use optipng if available
        if ($this->command_exists('optipng')) {
            exec("optipng -o2 -strip all " . escapeshellarg($file_path));
        } else {
            // Fallback to PHP compression
            $image = imagecreatefrompng($file_path);
            if ($image) {
                imagepng($image, $file_path, 9);
                imagedestroy($image);
            }
        }
    }
    
    /**
     * Convert to WebP
     */
    public function convert_to_webp($file) {
        // Check if image
        if (!isset($file['type']) || strpos($file['type'], 'image') === false) {
            return $file;
        }
        
        // Skip if already WebP
        if ($file['type'] === 'image/webp') {
            return $file;
        }
        
        // Check if WebP is supported
        if (!function_exists('imagewebp')) {
            return $file;
        }
        
        $file_path = $file['tmp_name'];
        $webp_path = $file_path . '.webp';
        
        // Create WebP version
        $image = null;
        switch ($file['type']) {
            case 'image/jpeg':
                $image = imagecreatefromjpeg($file_path);
                break;
            case 'image/png':
                $image = imagecreatefrompng($file_path);
                break;
            case 'image/gif':
                $image = imagecreatefromgif($file_path);
                break;
        }
        
        if ($image) {
            imagewebp($image, $webp_path, 85);
            imagedestroy($image);
            
            // Compare file sizes
            if (filesize($webp_path) < filesize($file_path)) {
                // Use WebP if smaller
                unlink($file_path);
                rename($webp_path, $file_path);
                $file['type'] = 'image/webp';
            } else {
                // Keep original if smaller
                unlink($webp_path);
            }
        }
        
        return $file;
    }
    
    /**
     * Add lazy loading script
     */
    public function add_lazy_load_script() {
        ?>
        <script>
        (function() {
            // Intersection Observer for lazy loading
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver(function(entries, observer) {
                    entries.forEach(function(entry) {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            
                            // Load image
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                delete img.dataset.src;
                            }
                            
                            // Load srcset
                            if (img.dataset.srcset) {
                                img.srcset = img.dataset.srcset;
                                delete img.dataset.srcset;
                            }
                            
                            // Stop observing
                            observer.unobserve(img);
                            
                            // Add loaded class
                            img.classList.add('lazy-loaded');
                        }
                    });
                }, {
                    rootMargin: '50px 0px',
                    threshold: 0.01
                });
                
                // Observe all lazy images
                document.querySelectorAll('img[data-src], img[data-srcset]').forEach(function(img) {
                    imageObserver.observe(img);
                });
                
                // Progressive image loading
                const progressiveImages = document.querySelectorAll('img.progressive');
                progressiveImages.forEach(function(img) {
                    if (img.dataset.fullsrc) {
                        const fullImage = new Image();
                        fullImage.onload = function() {
                            img.src = fullImage.src;
                            img.classList.add('loaded');
                        };
                        fullImage.src = img.dataset.fullsrc;
                    }
                });
            } else {
                // Fallback for older browsers
                const images = document.querySelectorAll('img[data-src]');
                images.forEach(function(img) {
                    img.src = img.dataset.src;
                });
            }
        })();
        </script>
        <?php
    }
}

// Initialize image optimizer
new WP_Image_Optimizer();
                        </code></pre>
                    </section>
                    
                    <!-- Database Query Optimization -->
                    <section>
                        <h2>Database Query Optimization</h2>
                        
                        <h3>Query Performance Manager</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * WordPress Query Optimization
 */
class WP_Query_Optimizer {
    
    private $query_cache = [];
    private $slow_query_threshold = 0.05; // 50ms
    
    public function __construct() {
        // Query optimization
        add_filter('posts_request', [$this, 'optimize_query'], 10, 2);
        add_filter('posts_clauses', [$this, 'optimize_clauses'], 10, 2);
        add_filter('pre_get_posts', [$this, 'optimize_main_query']);
        
        // Prevent unnecessary queries
        add_action('pre_get_posts', [$this, 'limit_query_vars']);
        add_filter('posts_pre_query', [$this, 'cache_query_results'], 10, 2);
        
        // Optimize specific queries
        add_filter('get_terms_args', [$this, 'optimize_term_queries'], 10, 2);
        add_filter('get_users_args', [$this, 'optimize_user_queries']);
        
        // Batch queries
        add_action('init', [$this, 'setup_batch_queries']);
    }
    
    /**
     * Optimize SQL query
     */
    public function optimize_query($request, $query) {
        // Remove SQL_CALC_FOUND_ROWS when not needed
        if ($query->get('no_found_rows')) {
            $request = str_replace('SQL_CALC_FOUND_ROWS', '', $request);
        }
        
        // Add query hints for complex queries
        if ($this->is_complex_query($request)) {
            // Use STRAIGHT_JOIN for better join order
            $request = str_replace('SELECT', 'SELECT STRAIGHT_JOIN', $request);
            
            // Add index hints if beneficial
            $request = $this->add_index_hints($request);
        }
        
        // Optimize LIMIT without OFFSET
        if (preg_match('/LIMIT (\d+), (\d+)/', $request, $matches)) {
            $offset = intval($matches[1]);
            $limit = intval($matches[2]);
            
            // Use cursor-based pagination for large offsets
            if ($offset > 1000) {
                $request = $this->convert_to_cursor_pagination($request, $query);
            }
        }
        
        return $request;
    }
    
    /**
     * Optimize query clauses
     */
    public function optimize_clauses($clauses, $query) {
        global $wpdb;
        
        // Optimize JOIN clauses
        if (!empty($clauses['join'])) {
            // Ensure proper join order
            $clauses['join'] = $this->optimize_join_order($clauses['join']);
        }
        
        // Optimize WHERE clauses
        if (!empty($clauses['where'])) {
            // Use EXISTS instead of IN for large datasets
            $clauses['where'] = $this->optimize_where_clause($clauses['where']);
        }
        
        // Add covering index fields to SELECT when possible
        if ($this->can_use_covering_index($query)) {
            $clauses['fields'] = $this->add_covering_index_fields($clauses['fields']);
        }
        
        // Optimize GROUP BY
        if (!empty($clauses['groupby'])) {
            // Remove unnecessary GROUP BY
            if (!$this->needs_groupby($query)) {
                $clauses['groupby'] = '';
            }
        }
        
        return $clauses;
    }
    
    /**
     * Optimize main query
     */
    public function optimize_main_query($query) {
        if (!$query->is_main_query()) {
            return;
        }
        
        // Optimize homepage query
        if ($query->is_home()) {
            // Limit fields for archive pages
            $query->set('fields', 'ids');
            
            // Disable term and meta queries if not needed
            $query->set('update_post_term_cache', false);
            $query->set('update_post_meta_cache', false);
        }
        
        // Optimize search queries
        if ($query->is_search()) {
            // Limit post types
            $query->set('post_type', ['post', 'page']);
            
            // Limit fields
            $query->set('fields', 'ids');
            
            // Add relevance sorting
            add_filter('posts_orderby', [$this, 'orderby_search_relevance']);
        }
        
        // Optimize archive queries
        if ($query->is_archive()) {
            // Reduce posts per page on mobile
            if (wp_is_mobile()) {
                $query->set('posts_per_page', 10);
            }
            
            // Cache term queries
            $query->set('update_post_term_cache', true);
            $query->set('cache_results', true);
        }
    }
    
    /**
     * Prevent unnecessary queries
     */
    public function limit_query_vars($query) {
        // Skip if admin or not main query
        if (is_admin() || !$query->is_main_query()) {
            return;
        }
        
        // Remove unnecessary meta queries
        $meta_query = $query->get('meta_query');
        if (!empty($meta_query)) {
            $meta_query = $this->optimize_meta_query($meta_query);
            $query->set('meta_query', $meta_query);
        }
        
        // Limit taxonomy queries
        $tax_query = $query->get('tax_query');
        if (!empty($tax_query)) {
            $tax_query = $this->optimize_tax_query($tax_query);
            $query->set('tax_query', $tax_query);
        }
    }
    
    /**
     * Cache query results
     */
    public function cache_query_results($posts, $query) {
        // Generate cache key
        $cache_key = $this->generate_query_cache_key($query);
        
        // Check cache
        if (isset($this->query_cache[$cache_key])) {
            return $this->query_cache[$cache_key];
        }
        
        // Check persistent cache
        $cached = wp_cache_get($cache_key, 'query_cache');
        if ($cached !== false) {
            $this->query_cache[$cache_key] = $cached;
            return $cached;
        }
        
        return $posts;
    }
    
    /**
     * Batch multiple queries
     */
    public function setup_batch_queries() {
        // Batch user queries
        add_filter('get_users', [$this, 'batch_user_queries'], 10, 2);
        
        // Batch term queries
        add_filter('get_terms', [$this, 'batch_term_queries'], 10, 3);
        
        // Batch meta queries
        add_filter('get_post_metadata', [$this, 'batch_meta_queries'], 10, 4);
    }
    
    /**
     * Batch user queries
     */
    public function batch_user_queries($users, $args) {
        static $user_batch = [];
        
        // Collect user IDs
        if (!empty($args['include'])) {
            $user_batch = array_merge($user_batch, (array)$args['include']);
        }
        
        // Execute batch query when threshold reached
        if (count($user_batch) >= 10) {
            $this->execute_user_batch($user_batch);
            $user_batch = [];
        }
        
        return $users;
    }
    
    /**
     * Execute batched user query
     */
    private function execute_user_batch($user_ids) {
        global $wpdb;
        
        $user_ids = array_unique(array_map('intval', $user_ids));
        $placeholders = implode(',', array_fill(0, count($user_ids), '%d'));
        
        // Get all user data in one query
        $users = $wpdb->get_results($wpdb->prepare(
            "SELECT * FROM {$wpdb->users} WHERE ID IN ($placeholders)",
            $user_ids
        ));
        
        // Get all user meta in one query
        $user_meta = $wpdb->get_results($wpdb->prepare(
            "SELECT user_id, meta_key, meta_value 
             FROM {$wpdb->usermeta} 
             WHERE user_id IN ($placeholders)",
            $user_ids
        ));
        
        // Cache results
        foreach ($users as $user) {
            wp_cache_set($user->ID, $user, 'users');
        }
        
        // Organize and cache meta
        $meta_by_user = [];
        foreach ($user_meta as $meta) {
            if (!isset($meta_by_user[$meta->user_id])) {
                $meta_by_user[$meta->user_id] = [];
            }
            $meta_by_user[$meta->user_id][$meta->meta_key] = $meta->meta_value;
        }
        
        foreach ($meta_by_user as $user_id => $meta) {
            wp_cache_set($user_id, $meta, 'user_meta');
        }
    }
    
    /**
     * Optimize meta queries
     */
    private function optimize_meta_query($meta_query) {
        // Convert EXISTS queries to more efficient form
        foreach ($meta_query as &$clause) {
            if (is_array($clause)) {
                if (isset($clause['compare']) && $clause['compare'] === 'EXISTS') {
                    // Use NOT NULL instead of EXISTS
                    $clause['compare'] = '!=';
                    $clause['value'] = '';
                }
                
                // Optimize IN queries with many values
                if (isset($clause['compare']) && $clause['compare'] === 'IN') {
                    if (is_array($clause['value']) && count($clause['value']) > 10) {
                        // Consider using temporary table for large IN clauses
                        $clause = $this->optimize_large_in_clause($clause);
                    }
                }
            }
        }
        
        return $meta_query;
    }
    
    /**
     * Generate query cache key
     */
    private function generate_query_cache_key($query) {
        $vars = $query->query_vars;
        
        // Remove non-deterministic values
        unset($vars['cache_results']);
        unset($vars['suppress_filters']);
        unset($vars['fields']);
        
        return 'query_' . md5(serialize($vars));
    }
}

// Initialize query optimizer
new WP_Query_Optimizer();
                        </code></pre>
                    </section>
                    
                    <!-- PHP Code Optimization -->
                    <section>
                        <h2>PHP Code Optimization</h2>
                        
                        <h3>PHP Performance Optimizations</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * PHP Performance Optimization Techniques
 */
class PHP_Performance_Optimizer {
    
    /**
     * Optimize autoloading
     */
    public static function optimize_autoloading() {
        // Use Composer's optimized autoloader
        if (file_exists(ABSPATH . 'vendor/autoload.php')) {
            require_once ABSPATH . 'vendor/autoload.php';
        }
        
        // Register optimized PSR-4 autoloader
        spl_autoload_register(function ($class) {
            // Project-specific namespace prefix
            $prefix = 'MyProject\\';
            
            // Base directory for namespace prefix
            $base_dir = __DIR__ . '/src/';
            
            // Check if class uses the namespace prefix
            $len = strlen($prefix);
            if (strncmp($prefix, $class, $len) !== 0) {
                return;
            }
            
            // Get relative class name
            $relative_class = substr($class, $len);
            
            // Replace namespace separators with directory separators
            $file = $base_dir . str_replace('\\', '/', $relative_class) . '.php';
            
            // Require file if it exists
            if (file_exists($file)) {
                require $file;
            }
        });
    }
    
    /**
     * Optimize string operations
     */
    public static function optimize_strings() {
        // Use single quotes for simple strings (faster)
        $simple = 'This is faster';
        
        // Use sprintf for complex formatting
        $formatted = sprintf('%s: %d items', 'Total', 100);
        
        // Use implode instead of concatenation in loops
        $parts = ['part1', 'part2', 'part3'];
        $result = implode('', $parts); // Faster than loop concatenation
        
        // Use strpos for simple substring checks
        if (strpos($haystack, $needle) !== false) {
            // Found (faster than strstr or preg_match for simple cases)
        }
        
        // Use str_replace for simple replacements
        $result = str_replace($search, $replace, $subject); // Faster than preg_replace
    }
    
    /**
     * Optimize arrays
     */
    public static function optimize_arrays() {
        // Use isset() instead of in_array() when possible
        $lookup = array_flip($array); // Convert to hash table
        if (isset($lookup[$value])) {
            // Found (much faster than in_array)
        }
        
        // Use array_key_exists for nullable values
        if (array_key_exists($key, $array)) {
            // Key exists (even if value is null)
        }
        
        // Pre-calculate array counts
        $count = count($array);
        for ($i = 0; $i < $count; $i++) {
            // Use cached count
        }
        
        // Use array_map for transformations
        $result = array_map('trim', $array); // Faster than foreach for simple ops
        
        // Use array_filter efficiently
        $filtered = array_filter($array, function($item) {
            return $item > 10;
        });
    }
    
    /**
     * Optimize loops
     */
    public static function optimize_loops() {
        // Use foreach for arrays (fastest)
        foreach ($array as $key => $value) {
            // Process
        }
        
        // Pre-calculate loop conditions
        $count = count($array);
        for ($i = 0; $i < $count; $i++) {
            // Avoid calling count() on each iteration
        }
        
        // Use while for simple iterations
        $i = 0;
        while ($i < $limit) {
            // Process
            $i++;
        }
        
        // Break early when possible
        foreach ($array as $item) {
            if ($found) {
                break; // Stop unnecessary iterations
            }
        }
        
        // Use generators for large datasets
        function large_dataset_generator() {
            for ($i = 0; $i < 1000000; $i++) {
                yield $i; // Memory efficient
            }
        }
    }
    
    /**
     * Optimize function calls
     */
    public static function optimize_functions() {
        // Cache function results
        static $cache = [];
        
        $key = md5(serialize($params));
        if (!isset($cache[$key])) {
            $cache[$key] = expensive_function($params);
        }
        return $cache[$key];
        
        // Use static variables for persistence
        function counter() {
            static $count = 0;
            return ++$count;
        }
        
        // Avoid function calls in loops
        $callback = 'trim';
        foreach ($array as &$value) {
            $value = $callback($value); // Store function reference
        }
        
        // Use built-in functions
        $max = max($array); // Faster than custom implementation
    }
    
    /**
     * Optimize object creation
     */
    public static function optimize_objects() {
        // Use singleton pattern for shared objects
        class Singleton {
            private static $instance;
            
            public static function getInstance() {
                if (self::$instance === null) {
                    self::$instance = new self();
                }
                return self::$instance;
            }
        }
        
        // Use object pooling for reusable objects
        class ObjectPool {
            private $available = [];
            private $in_use = [];
            
            public function get() {
                if (count($this->available) > 0) {
                    $object = array_pop($this->available);
                } else {
                    $object = new PooledObject();
                }
                $this->in_use[] = $object;
                return $object;
            }
            
            public function release($object) {
                $key = array_search($object, $this->in_use);
                if ($key !== false) {
                    unset($this->in_use[$key]);
                    $this->available[] = $object;
                }
            }
        }
        
        // Use lazy loading for expensive properties
        class LazyLoader {
            private $data;
            
            public function getData() {
                if ($this->data === null) {
                    $this->data = $this->loadExpensiveData();
                }
                return $this->data;
            }
        }
    }
    
    /**
     * Optimize file operations
     */
    public static function optimize_file_operations() {
        // Use file_get_contents for reading entire files
        $content = file_get_contents($file); // Faster than fopen/fread/fclose
        
        // Use file_put_contents for writing
        file_put_contents($file, $content, LOCK_EX); // Atomic write with lock
        
        // Cache file checks
        static $file_exists_cache = [];
        
        if (!isset($file_exists_cache[$file])) {
            $file_exists_cache[$file] = file_exists($file);
        }
        
        if ($file_exists_cache[$file]) {
            // File exists (cached)
        }
        
        // Use SplFileObject for large files
        $file = new SplFileObject('large_file.txt');
        foreach ($file as $line) {
            // Process line by line (memory efficient)
        }
    }
    
    /**
     * Use opcache effectively
     */
    public static function optimize_opcache() {
        // Check if OPcache is enabled
        if (!function_exists('opcache_get_status')) {
            return false;
        }
        
        $status = opcache_get_status();
        
        // Preload important files
        if (function_exists('opcache_compile_file')) {
            $files = [
                '/path/to/important/file1.php',
                '/path/to/important/file2.php',
            ];
            
            foreach ($files as $file) {
                if (file_exists($file)) {
                    opcache_compile_file($file);
                }
            }
        }
        
        // Monitor OPcache usage
        $memory_usage = $status['memory_usage'];
        $cache_full = $memory_usage['used_memory'] + $memory_usage['wasted_memory'] 
                     > $memory_usage['free_memory'];
        
        if ($cache_full) {
            // Consider increasing opcache.memory_consumption
            error_log('OPcache memory is nearly full');
        }
        
        return true;
    }
}

// Initialize PHP optimizations
PHP_Performance_Optimizer::optimize_autoloading();
PHP_Performance_Optimizer::optimize_opcache();
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>Asset optimization reduces page load times</li>
                                <li>Lazy loading improves initial page performance</li>
                                <li>Query optimization reduces database load</li>
                                <li>Minification reduces file sizes</li>
                                <li>Code splitting improves resource loading</li>
                                <li>PHP optimizations improve server performance</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Code Optimization Best Practices</h3>
                            <ul>
                                <li>Measure performance before optimizing</li>
                                <li>Optimize critical rendering path</li>
                                <li>Use async/defer for non-critical scripts</li>
                                <li>Implement resource hints (preload, prefetch)</li>
                                <li>Optimize images and use modern formats</li>
                                <li>Cache expensive operations</li>
                                <li>Profile and optimize database queries</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://web.dev/fast/" target="_blank">Web.dev Performance Guide</a></li>
                            <li><a href="https://developers.google.com/web/fundamentals/performance" target="_blank">Google Performance Fundamentals</a></li>
                            <li><a href="https://www.php.net/manual/en/book.opcache.php" target="_blank">PHP OPcache Documentation</a></li>
                            <li><a href="https://kinsta.com/learn/speed-up-wordpress/" target="_blank">WordPress Speed Optimization</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/security_best_practices.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            Security Best Practices
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/debugging_tools.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            Debugging Tools
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>