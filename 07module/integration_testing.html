<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>Integration Testing WordPress - PHP WordPress Course</title>
    <meta name="description" content="Learn integration testing for WordPress including database testing, API testing, and full stack testing.">
    <meta name="keywords" content="WordPress, integration testing, database testing, API testing, E2E">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Integration Testing WordPress">
    <meta property="og:description" content="Master integration testing for WordPress applications">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Integration Testing</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">Integration Testing WordPress</h1>
                    <p class="lesson-subtitle">Test complete workflows and system interactions</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Write integration tests for WordPress</li>
                        <li>Test database transactions</li>
                        <li>Test plugin and theme interactions</li>
                        <li>Implement API integration testing</li>
                        <li>Test user workflows</li>
                        <li>Use Selenium for browser testing</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Integration Testing Setup -->
                    <section>
                        <h2>Integration Testing Setup</h2>
                        
                        <h3>Integration Test Environment</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * Integration Test Base Class
 */
abstract class WP_Integration_Test_Case extends WP_UnitTestCase {
    
    /**
     * Test database transaction
     */
    protected $use_transaction = true;
    
    /**
     * Plugins to load
     */
    protected $active_plugins = [];
    
    /**
     * Theme to activate
     */
    protected $active_theme = 'twentytwentyone';
    
    /**
     * Set up integration test environment
     */
    public function setUp(): void {
        parent::setUp();
        
        // Start transaction if enabled
        if ($this->use_transaction) {
            global $wpdb;
            $wpdb->query('START TRANSACTION');
        }
        
        // Load plugins
        $this->load_plugins();
        
        // Switch theme
        switch_theme($this->active_theme);
        
        // Set up test data
        $this->setup_test_data();
        
        // Initialize components
        $this->init_components();
    }
    
    /**
     * Tear down test environment
     */
    public function tearDown(): void {
        // Rollback transaction
        if ($this->use_transaction) {
            global $wpdb;
            $wpdb->query('ROLLBACK');
        }
        
        // Clean up
        $this->cleanup();
        
        parent::tearDown();
    }
    
    /**
     * Load required plugins
     */
    protected function load_plugins() {
        foreach ($this->active_plugins as $plugin) {
            require_once WP_PLUGIN_DIR . '/' . $plugin;
        }
        
        // Trigger plugin activation hooks
        do_action('plugins_loaded');
    }
    
    /**
     * Set up test data
     */
    protected function setup_test_data() {
        // Create test users
        $this->admin_id = $this->factory->user->create([
            'role' => 'administrator',
            'user_login' => 'admin_test'
        ]);
        
        $this->editor_id = $this->factory->user->create([
            'role' => 'editor',
            'user_login' => 'editor_test'
        ]);
        
        $this->subscriber_id = $this->factory->user->create([
            'role' => 'subscriber',
            'user_login' => 'subscriber_test'
        ]);
        
        // Create test content
        $this->create_test_content();
    }
    
    /**
     * Create test content
     */
    protected function create_test_content() {
        // Create categories
        $this->cat_ids = $this->factory->term->create_many(3, [
            'taxonomy' => 'category'
        ]);
        
        // Create posts
        $this->post_ids = $this->factory->post->create_many(10, [
            'post_author' => $this->editor_id,
            'post_status' => 'publish'
        ]);
        
        // Assign categories
        foreach ($this->post_ids as $index => $post_id) {
            wp_set_post_categories($post_id, [$this->cat_ids[$index % 3]]);
        }
        
        // Create pages
        $this->page_ids = $this->factory->post->create_many(5, [
            'post_type' => 'page',
            'post_status' => 'publish'
        ]);
    }
    
    /**
     * Initialize components for testing
     */
    protected function init_components() {
        // Override in child classes
    }
    
    /**
     * Clean up after test
     */
    protected function cleanup() {
        // Override in child classes
    }
    
    /**
     * Assert database state
     */
    protected function assertDatabaseHas($table, $data) {
        global $wpdb;
        
        $where = [];
        $values = [];
        
        foreach ($data as $column => $value) {
            $where[] = "$column = %s";
            $values[] = $value;
        }
        
        $query = "SELECT COUNT(*) FROM $table WHERE " . implode(' AND ', $where);
        $count = $wpdb->get_var($wpdb->prepare($query, $values));
        
        $this->assertGreaterThan(0, $count, "Record not found in $table");
    }
    
    /**
     * Assert database missing
     */
    protected function assertDatabaseMissing($table, $data) {
        global $wpdb;
        
        $where = [];
        $values = [];
        
        foreach ($data as $column => $value) {
            $where[] = "$column = %s";
            $values[] = $value;
        }
        
        $query = "SELECT COUNT(*) FROM $table WHERE " . implode(' AND ', $where);
        $count = $wpdb->get_var($wpdb->prepare($query, $values));
        
        $this->assertEquals(0, $count, "Record found in $table");
    }
}
                        </code></pre>
                    </section>
                    
                    <!-- Database Integration Testing -->
                    <section>
                        <h2>Database Integration Testing</h2>
                        
                        <h3>Testing Database Transactions</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * Database Integration Tests
 */
class Test_Database_Integration extends WP_Integration_Test_Case {
    
    /**
     * Test complex database transaction
     */
    public function test_order_processing_transaction() {
        global $wpdb;
        
        // Start transaction
        $wpdb->query('START TRANSACTION');
        
        try {
            // Create order
            $order_id = $wpdb->insert(
                $wpdb->prefix . 'orders',
                [
                    'user_id' => $this->admin_id,
                    'status' => 'pending',
                    'total' => 100.00,
                    'created_at' => current_time('mysql')
                ],
                ['%d', '%s', '%f', '%s']
            );
            
            $this->assertNotFalse($order_id);
            
            // Add order items
            $items = [
                ['product_id' => 1, 'quantity' => 2, 'price' => 25.00],
                ['product_id' => 2, 'quantity' => 1, 'price' => 50.00]
            ];
            
            foreach ($items as $item) {
                $result = $wpdb->insert(
                    $wpdb->prefix . 'order_items',
                    array_merge(['order_id' => $order_id], $item),
                    ['%d', '%d', '%d', '%f']
                );
                
                $this->assertNotFalse($result);
            }
            
            // Update inventory
            foreach ($items as $item) {
                $wpdb->query($wpdb->prepare(
                    "UPDATE {$wpdb->prefix}products 
                     SET stock = stock - %d 
                     WHERE id = %d",
                    $item['quantity'],
                    $item['product_id']
                ));
            }
            
            // Create payment record
            $payment_id = $wpdb->insert(
                $wpdb->prefix . 'payments',
                [
                    'order_id' => $order_id,
                    'amount' => 100.00,
                    'method' => 'credit_card',
                    'status' => 'completed'
                ],
                ['%d', '%f', '%s', '%s']
            );
            
            $this->assertNotFalse($payment_id);
            
            // Update order status
            $wpdb->update(
                $wpdb->prefix . 'orders',
                ['status' => 'completed'],
                ['id' => $order_id],
                ['%s'],
                ['%d']
            );
            
            // Commit transaction
            $wpdb->query('COMMIT');
            
            // Verify complete transaction
            $this->assertDatabaseHas($wpdb->prefix . 'orders', [
                'id' => $order_id,
                'status' => 'completed'
            ]);
            
            $this->assertDatabaseHas($wpdb->prefix . 'payments', [
                'order_id' => $order_id,
                'status' => 'completed'
            ]);
            
        } catch (Exception $e) {
            // Rollback on error
            $wpdb->query('ROLLBACK');
            throw $e;
        }
    }
    
    /**
     * Test database relationships
     */
    public function test_database_relationships() {
        global $wpdb;
        
        // Create related data
        $author_id = $this->factory->user->create();
        $post_ids = $this->factory->post->create_many(5, [
            'post_author' => $author_id
        ]);
        
        // Test one-to-many relationship
        $author_posts = $wpdb->get_results($wpdb->prepare(
            "SELECT * FROM {$wpdb->posts} WHERE post_author = %d",
            $author_id
        ));
        
        $this->assertCount(5, $author_posts);
        
        // Test many-to-many relationship
        $tag_ids = $this->factory->term->create_many(3, [
            'taxonomy' => 'post_tag'
        ]);
        
        foreach ($post_ids as $post_id) {
            wp_set_post_tags($post_id, $tag_ids);
        }
        
        // Query through relationship
        $tagged_posts = $wpdb->get_results($wpdb->prepare(
            "SELECT DISTINCT p.* 
             FROM {$wpdb->posts} p
             INNER JOIN {$wpdb->term_relationships} tr ON p.ID = tr.object_id
             INNER JOIN {$wpdb->term_taxonomy} tt ON tr.term_taxonomy_id = tt.term_taxonomy_id
             WHERE tt.term_id IN (%d, %d, %d)",
            $tag_ids[0], $tag_ids[1], $tag_ids[2]
        ));
        
        $this->assertCount(5, $tagged_posts);
    }
    
    /**
     * Test database migrations
     */
    public function test_database_migration() {
        global $wpdb;
        
        // Get current version
        $current_version = get_option('my_plugin_db_version', '0');
        
        // Run migration
        $migration = new Database_Migration();
        $migration->migrate($current_version, '2.0.0');
        
        // Check new table exists
        $table_name = $wpdb->prefix . 'new_feature_table';
        $table_exists = $wpdb->get_var(
            "SHOW TABLES LIKE '$table_name'"
        ) === $table_name;
        
        $this->assertTrue($table_exists);
        
        // Check column modifications
        $columns = $wpdb->get_results(
            "SHOW COLUMNS FROM $table_name"
        );
        
        $column_names = array_column($columns, 'Field');
        $this->assertContains('new_column', $column_names);
        
        // Check indexes
        $indexes = $wpdb->get_results(
            "SHOW INDEX FROM $table_name"
        );
        
        $index_names = array_column($indexes, 'Key_name');
        $this->assertContains('idx_new_column', $index_names);
        
        // Verify version update
        $this->assertEquals('2.0.0', get_option('my_plugin_db_version'));
    }
}

/**
 * Test Plugin Interactions
 */
class Test_Plugin_Integration extends WP_Integration_Test_Case {
    
    protected $active_plugins = [
        'woocommerce/woocommerce.php',
        'my-addon/my-addon.php'
    ];
    
    /**
     * Test plugin compatibility
     */
    public function test_woocommerce_integration() {
        // Check WooCommerce is active
        $this->assertTrue(class_exists('WooCommerce'));
        
        // Create WooCommerce product
        $product = new WC_Product_Simple();
        $product->set_name('Test Product');
        $product->set_price(19.99);
        $product->set_regular_price(19.99);
        $product->save();
        
        $this->assertGreaterThan(0, $product->get_id());
        
        // Test our addon modifies product
        $addon = new My_WooCommerce_Addon();
        $modified_price = $addon->modify_price($product->get_price(), $product);
        
        $this->assertEquals(17.99, $modified_price); // 10% discount
        
        // Test cart integration
        WC()->cart->add_to_cart($product->get_id(), 2);
        
        $cart_total = WC()->cart->get_total('');
        $this->assertEquals(35.98, $cart_total);
        
        // Test order creation
        $order = wc_create_order([
            'customer_id' => $this->admin_id,
            'status' => 'pending'
        ]);
        
        $order->add_product($product, 2);
        $order->calculate_totals();
        $order->save();
        
        $this->assertEquals('pending', $order->get_status());
        $this->assertEquals(35.98, $order->get_total());
    }
    
    /**
     * Test multiple plugin interactions
     */
    public function test_plugin_conflict_resolution() {
        // Load potentially conflicting plugins
        activate_plugin('plugin-a/plugin-a.php');
        activate_plugin('plugin-b/plugin-b.php');
        
        // Both plugins modify same filter
        $value = apply_filters('shared_filter', 'original');
        
        // Our plugin should handle conflicts
        $resolver = new Plugin_Conflict_Resolver();
        $resolved_value = $resolver->resolve_filter_conflict('shared_filter', $value);
        
        $this->assertNotEquals('original', $resolved_value);
        $this->assertStringContainsString('resolved', $resolved_value);
        
        // Test priority handling
        $priorities = $resolver->get_filter_priorities('shared_filter');
        $this->assertIsArray($priorities);
        $this->assertArrayHasKey('plugin-a', $priorities);
        $this->assertArrayHasKey('plugin-b', $priorities);
    }
}
                        </code></pre>
                    </section>
                    
                    <!-- API Integration Testing -->
                    <section>
                        <h2>API Integration Testing</h2>
                        
                        <h3>REST API Integration Tests</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * REST API Integration Tests
 */
class Test_REST_API_Integration extends WP_Integration_Test_Case {
    
    /**
     * REST Server instance
     */
    protected $server;
    
    /**
     * Set up REST API
     */
    protected function init_components() {
        global $wp_rest_server;
        
        $this->server = $wp_rest_server = new WP_REST_Server();
        do_action('rest_api_init');
    }
    
    /**
     * Test complete API workflow
     */
    public function test_api_crud_workflow() {
        // Authenticate
        wp_set_current_user($this->admin_id);
        
        // CREATE - Post new resource
        $create_request = new WP_REST_Request('POST', '/wp/v2/posts');
        $create_request->set_body_params([
            'title' => 'API Test Post',
            'content' => 'Test content',
            'status' => 'draft'
        ]);
        
        $create_response = $this->server->dispatch($create_request);
        $this->assertEquals(201, $create_response->get_status());
        
        $created_data = $create_response->get_data();
        $post_id = $created_data['id'];
        
        // READ - Get created resource
        $read_request = new WP_REST_Request('GET', '/wp/v2/posts/' . $post_id);
        $read_response = $this->server->dispatch($read_request);
        
        $this->assertEquals(200, $read_response->get_status());
        $read_data = $read_response->get_data();
        $this->assertEquals('API Test Post', $read_data['title']['raw']);
        
        // UPDATE - Modify resource
        $update_request = new WP_REST_Request('PUT', '/wp/v2/posts/' . $post_id);
        $update_request->set_body_params([
            'title' => 'Updated API Post',
            'status' => 'publish'
        ]);
        
        $update_response = $this->server->dispatch($update_request);
        $this->assertEquals(200, $update_response->get_status());
        
        // Verify update
        $verify_request = new WP_REST_Request('GET', '/wp/v2/posts/' . $post_id);
        $verify_response = $this->server->dispatch($verify_request);
        $verify_data = $verify_response->get_data();
        
        $this->assertEquals('Updated API Post', $verify_data['title']['rendered']);
        $this->assertEquals('publish', $verify_data['status']);
        
        // DELETE - Remove resource
        $delete_request = new WP_REST_Request('DELETE', '/wp/v2/posts/' . $post_id);
        $delete_request->set_param('force', true);
        
        $delete_response = $this->server->dispatch($delete_request);
        $this->assertEquals(200, $delete_response->get_status());
        
        // Verify deletion
        $check_request = new WP_REST_Request('GET', '/wp/v2/posts/' . $post_id);
        $check_response = $this->server->dispatch($check_request);
        $this->assertEquals(404, $check_response->get_status());
    }
    
    /**
     * Test API authentication and permissions
     */
    public function test_api_authentication() {
        // Test unauthenticated request
        wp_set_current_user(0);
        
        $request = new WP_REST_Request('POST', '/wp/v2/posts');
        $request->set_body_params(['title' => 'Test']);
        
        $response = $this->server->dispatch($request);
        $this->assertEquals(401, $response->get_status());
        
        // Test with subscriber (insufficient permissions)
        wp_set_current_user($this->subscriber_id);
        
        $response = $this->server->dispatch($request);
        $this->assertEquals(403, $response->get_status());
        
        // Test with editor (sufficient permissions)
        wp_set_current_user($this->editor_id);
        
        $response = $this->server->dispatch($request);
        $this->assertEquals(201, $response->get_status());
        
        // Test JWT authentication
        $jwt_token = $this->generate_jwt_token($this->admin_id);
        
        $jwt_request = new WP_REST_Request('GET', '/wp/v2/users/me');
        $jwt_request->set_header('Authorization', 'Bearer ' . $jwt_token);
        
        $jwt_response = $this->server->dispatch($jwt_request);
        $this->assertEquals(200, $jwt_response->get_status());
        
        $user_data = $jwt_response->get_data();
        $this->assertEquals($this->admin_id, $user_data['id']);
    }
    
    /**
     * Test custom API endpoints
     */
    public function test_custom_api_endpoints() {
        // Register custom endpoint
        register_rest_route('myplugin/v1', '/analytics', [
            'methods' => 'GET',
            'callback' => function($request) {
                return [
                    'views' => 1000,
                    'users' => 50,
                    'posts' => 100
                ];
            },
            'permission_callback' => '__return_true'
        ]);
        
        // Test custom endpoint
        $request = new WP_REST_Request('GET', '/myplugin/v1/analytics');
        $response = $this->server->dispatch($request);
        
        $this->assertEquals(200, $response->get_status());
        
        $data = $response->get_data();
        $this->assertArrayHasKey('views', $data);
        $this->assertArrayHasKey('users', $data);
        $this->assertArrayHasKey('posts', $data);
        
        // Test batch requests
        $batch_request = new WP_REST_Request('POST', '/batch/v1');
        $batch_request->set_body_params([
            'requests' => [
                ['path' => '/wp/v2/posts', 'method' => 'GET'],
                ['path' => '/wp/v2/users', 'method' => 'GET'],
                ['path' => '/myplugin/v1/analytics', 'method' => 'GET']
            ]
        ]);
        
        $batch_response = $this->server->dispatch($batch_request);
        $this->assertEquals(200, $batch_response->get_status());
        
        $batch_data = $batch_response->get_data();
        $this->assertCount(3, $batch_data['responses']);
    }
    
    /**
     * Generate JWT token for testing
     */
    private function generate_jwt_token($user_id) {
        // Mock JWT generation
        return base64_encode(json_encode([
            'user_id' => $user_id,
            'exp' => time() + 3600
        ]));
    }
}

/**
 * External API Integration Tests
 */
class Test_External_API_Integration extends WP_Integration_Test_Case {
    
    /**
     * Test external API integration
     */
    public function test_payment_gateway_integration() {
        // Mock external API responses
        add_filter('pre_http_request', [$this, 'mock_payment_api'], 10, 3);
        
        // Initialize payment gateway
        $gateway = new Payment_Gateway([
            'api_key' => 'test_key',
            'api_secret' => 'test_secret',
            'sandbox' => true
        ]);
        
        // Test authentication
        $auth_result = $gateway->authenticate();
        $this->assertTrue($auth_result);
        $this->assertNotEmpty($gateway->get_access_token());
        
        // Test payment processing
        $payment_data = [
            'amount' => 99.99,
            'currency' => 'USD',
            'card' => [
                'number' => '4111111111111111',
                'exp_month' => '12',
                'exp_year' => '2025',
                'cvc' => '123'
            ],
            'customer' => [
                'email' => 'test@example.com',
                'name' => 'Test User'
            ]
        ];
        
        $payment_result = $gateway->process_payment($payment_data);
        
        $this->assertTrue($payment_result['success']);
        $this->assertArrayHasKey('transaction_id', $payment_result);
        $this->assertArrayHasKey('status', $payment_result);
        $this->assertEquals('completed', $payment_result['status']);
        
        // Test refund
        $refund_result = $gateway->refund($payment_result['transaction_id'], 50.00);
        
        $this->assertTrue($refund_result['success']);
        $this->assertEquals(50.00, $refund_result['refunded_amount']);
        
        // Test webhook handling
        $webhook_payload = [
            'event' => 'payment.completed',
            'transaction_id' => 'TXN123',
            'amount' => 99.99,
            'timestamp' => time()
        ];
        
        $webhook_signature = $this->generate_webhook_signature($webhook_payload);
        
        $webhook_result = $gateway->handle_webhook($webhook_payload, $webhook_signature);
        $this->assertTrue($webhook_result);
        
        // Verify database updates
        $this->assertDatabaseHas($GLOBALS['wpdb']->prefix . 'payments', [
            'transaction_id' => 'TXN123',
            'status' => 'completed'
        ]);
    }
    
    /**
     * Mock payment API responses
     */
    public function mock_payment_api($preempt, $args, $url) {
        if (strpos($url, 'api.payment.com') === false) {
            return $preempt;
        }
        
        // Mock authentication
        if (strpos($url, '/auth') !== false) {
            return [
                'response' => ['code' => 200],
                'body' => json_encode([
                    'access_token' => 'mock_token_' . time(),
                    'expires_in' => 3600
                ])
            ];
        }
        
        // Mock payment processing
        if (strpos($url, '/payments') !== false && $args['method'] === 'POST') {
            return [
                'response' => ['code' => 200],
                'body' => json_encode([
                    'success' => true,
                    'transaction_id' => 'TXN_' . uniqid(),
                    'status' => 'completed',
                    'amount' => json_decode($args['body'])->amount
                ])
            ];
        }
        
        // Mock refund
        if (strpos($url, '/refunds') !== false) {
            return [
                'response' => ['code' => 200],
                'body' => json_encode([
                    'success' => true,
                    'refund_id' => 'REF_' . uniqid(),
                    'refunded_amount' => 50.00
                ])
            ];
        }
        
        return $preempt;
    }
    
    /**
     * Generate webhook signature
     */
    private function generate_webhook_signature($payload) {
        return hash_hmac('sha256', json_encode($payload), 'test_secret');
    }
}
                        </code></pre>
                    </section>
                    
                    <!-- User Workflow Testing -->
                    <section>
                        <h2>User Workflow Testing</h2>
                        
                        <h3>Testing Complete User Journeys</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * User Workflow Integration Tests
 */
class Test_User_Workflows extends WP_Integration_Test_Case {
    
    /**
     * Test complete user registration workflow
     */
    public function test_user_registration_workflow() {
        // Enable registration
        update_option('users_can_register', 1);
        
        // Step 1: User visits registration page
        $registration_page = get_permalink(get_option('registration_page_id'));
        $this->assertNotEmpty($registration_page);
        
        // Step 2: Submit registration form
        $user_data = [
            'user_login' => 'newuser',
            'user_email' => 'newuser@example.com',
            'user_pass' => 'SecurePassword123!',
            'first_name' => 'New',
            'last_name' => 'User'
        ];
        
        $user_id = wp_insert_user($user_data);
        $this->assertIsInt($user_id);
        $this->assertGreaterThan(0, $user_id);
        
        // Step 3: Send activation email
        $activation_key = get_user_meta($user_id, 'activation_key', true);
        $this->assertNotEmpty($activation_key);
        
        // Mock email sending
        $email_sent = $this->send_activation_email($user_id, $activation_key);
        $this->assertTrue($email_sent);
        
        // Step 4: User activates account
        $activation_result = $this->activate_user_account($user_id, $activation_key);
        $this->assertTrue($activation_result);
        
        // Step 5: User logs in
        $user = wp_signon([
            'user_login' => 'newuser',
            'user_password' => 'SecurePassword123!',
            'remember' => true
        ]);
        
        $this->assertInstanceOf(WP_User::class, $user);
        $this->assertEquals($user_id, $user->ID);
        
        // Step 6: User completes profile
        update_user_meta($user_id, 'profile_completed', true);
        update_user_meta($user_id, 'bio', 'Test bio');
        update_user_meta($user_id, 'avatar', 'avatar.jpg');
        
        // Step 7: Verify complete profile
        $profile_complete = get_user_meta($user_id, 'profile_completed', true);
        $this->assertTrue($profile_complete);
        
        // Verify user capabilities
        $user = new WP_User($user_id);
        $this->assertTrue($user->has_cap('read'));
        $this->assertTrue($user->has_cap('edit_posts'));
    }
    
    /**
     * Test e-commerce purchase workflow
     */
    public function test_purchase_workflow() {
        // Step 1: User browses products
        $products = get_posts([
            'post_type' => 'product',
            'posts_per_page' => 10
        ]);
        
        $this->assertNotEmpty($products);
        
        // Step 2: User adds to cart
        $cart = new Shopping_Cart();
        $cart->add_item($products[0]->ID, 2);
        $cart->add_item($products[1]->ID, 1);
        
        $this->assertEquals(2, $cart->get_item_count());
        
        // Step 3: Apply coupon
        $coupon = new Coupon('SAVE10');
        $discount = $cart->apply_coupon($coupon);
        
        $this->assertGreaterThan(0, $discount);
        $this->assertEquals(10, $coupon->get_discount_percent());
        
        // Step 4: Calculate shipping
        $shipping_address = [
            'country' => 'US',
            'state' => 'CA',
            'city' => 'Los Angeles',
            'zip' => '90001'
        ];
        
        $shipping_cost = $cart->calculate_shipping($shipping_address);
        $this->assertGreaterThan(0, $shipping_cost);
        
        // Step 5: Process checkout
        $checkout = new Checkout($cart);
        $checkout->set_billing_address($shipping_address);
        $checkout->set_shipping_address($shipping_address);
        $checkout->set_payment_method('credit_card');
        
        // Step 6: Process payment
        $payment_data = [
            'card_number' => '4111111111111111',
            'exp_month' => '12',
            'exp_year' => '2025',
            'cvv' => '123'
        ];
        
        $payment_result = $checkout->process_payment($payment_data);
        $this->assertTrue($payment_result['success']);
        
        // Step 7: Create order
        $order = $checkout->create_order();
        $this->assertInstanceOf(Order::class, $order);
        $this->assertEquals('processing', $order->get_status());
        
        // Step 8: Send confirmation email
        $email_sent = $order->send_confirmation_email();
        $this->assertTrue($email_sent);
        
        // Step 9: Update inventory
        foreach ($cart->get_items() as $item) {
            $product = get_post($item['product_id']);
            $stock = get_post_meta($product->ID, '_stock', true);
            $new_stock = $stock - $item['quantity'];
            update_post_meta($product->ID, '_stock', $new_stock);
            
            $this->assertEquals($new_stock, get_post_meta($product->ID, '_stock', true));
        }
        
        // Step 10: Verify order in database
        $this->assertDatabaseHas($GLOBALS['wpdb']->prefix . 'orders', [
            'id' => $order->get_id(),
            'status' => 'processing',
            'total' => $order->get_total()
        ]);
    }
    
    /**
     * Test content publishing workflow
     */
    public function test_content_publishing_workflow() {
        // Step 1: Author creates draft
        wp_set_current_user($this->editor_id);
        
        $post_data = [
            'post_title' => 'Draft Article',
            'post_content' => 'Article content...',
            'post_status' => 'draft',
            'post_author' => $this->editor_id
        ];
        
        $post_id = wp_insert_post($post_data);
        $this->assertGreaterThan(0, $post_id);
        
        // Step 2: Add media
        $attachment_id = $this->factory->attachment->create_upload_object(
            __DIR__ . '/fixtures/test-image.jpg',
            $post_id
        );
        
        set_post_thumbnail($post_id, $attachment_id);
        $this->assertEquals($attachment_id, get_post_thumbnail_id($post_id));
        
        // Step 3: Add categories and tags
        wp_set_post_categories($post_id, [$this->cat_ids[0]]);
        wp_set_post_tags($post_id, ['test', 'integration']);
        
        // Step 4: Submit for review
        wp_update_post([
            'ID' => $post_id,
            'post_status' => 'pending'
        ]);
        
        $this->assertEquals('pending', get_post_status($post_id));
        
        // Step 5: Editor reviews and approves
        wp_set_current_user($this->admin_id);
        
        // Add editorial comment
        $comment_id = wp_insert_comment([
            'comment_post_ID' => $post_id,
            'comment_content' => 'Approved with minor edits',
            'user_id' => $this->admin_id,
            'comment_type' => 'editorial'
        ]);
        
        $this->assertGreaterThan(0, $comment_id);
        
        // Step 6: Schedule publication
        $future_date = date('Y-m-d H:i:s', strtotime('+1 day'));
        
        wp_update_post([
            'ID' => $post_id,
            'post_status' => 'future',
            'post_date' => $future_date,
            'post_date_gmt' => get_gmt_from_date($future_date)
        ]);
        
        $this->assertEquals('future', get_post_status($post_id));
        
        // Step 7: Simulate cron job for publication
        $this->fast_forward_time(86400); // 1 day
        wp_publish_post($post_id);
        
        $this->assertEquals('publish', get_post_status($post_id));
        
        // Step 8: Verify SEO meta
        update_post_meta($post_id, '_yoast_wpseo_title', 'SEO Title');
        update_post_meta($post_id, '_yoast_wpseo_metadesc', 'SEO Description');
        
        $seo_title = get_post_meta($post_id, '_yoast_wpseo_title', true);
        $this->assertEquals('SEO Title', $seo_title);
        
        // Step 9: Check social sharing
        $social_shares = [
            'facebook' => 10,
            'twitter' => 5,
            'linkedin' => 3
        ];
        
        update_post_meta($post_id, 'social_shares', $social_shares);
        
        $shares = get_post_meta($post_id, 'social_shares', true);
        $this->assertEquals(18, array_sum($shares));
    }
    
    /**
     * Helper: Send activation email
     */
    private function send_activation_email($user_id, $activation_key) {
        // Mock email sending
        return true;
    }
    
    /**
     * Helper: Activate user account
     */
    private function activate_user_account($user_id, $activation_key) {
        $stored_key = get_user_meta($user_id, 'activation_key', true);
        
        if ($stored_key === $activation_key) {
            update_user_meta($user_id, 'account_activated', true);
            delete_user_meta($user_id, 'activation_key');
            return true;
        }
        
        return false;
    }
    
    /**
     * Helper: Fast forward time for testing
     */
    private function fast_forward_time($seconds) {
        // Mock time progression for testing scheduled events
        add_filter('current_time', function($type) use ($seconds) {
            return time() + $seconds;
        });
    }
}
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>Integration tests verify complete workflows</li>
                                <li>Database transactions ensure data integrity</li>
                                <li>API testing validates endpoint functionality</li>
                                <li>Plugin interactions can be tested together</li>
                                <li>User journeys validate business logic</li>
                                <li>Mock external services for reliable tests</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Integration Testing Best Practices</h3>
                            <ul>
                                <li>Use database transactions for isolation</li>
                                <li>Test complete user workflows</li>
                                <li>Mock external dependencies</li>
                                <li>Verify database state changes</li>
                                <li>Test error scenarios</li>
                                <li>Keep tests independent</li>
                                <li>Use factories for test data</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://phpunit.de/manual/current/en/database.html" target="_blank">PHPUnit Database Testing</a></li>
                            <li><a href="https://make.wordpress.org/core/handbook/testing/automated-testing/" target="_blank">WordPress Automated Testing</a></li>
                            <li><a href="https://developer.wordpress.org/rest-api/extending-the-rest-api/adding-custom-endpoints/" target="_blank">REST API Testing</a></li>
                            <li><a href="https://martinfowler.com/bliki/IntegrationTest.html" target="_blank">Integration Testing Patterns</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/unit_testing.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            Unit Testing
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/e2e_testing.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            E2E Testing
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>