<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>Data Storage and Retrieval Best Practices - PHP WordPress Course</title>
    <meta name="description" content="Learn best practices for storing and retrieving data in WordPress. Master performance optimization, caching strategies, and database efficiency.">
    <meta name="keywords" content="WordPress, data storage, database optimization, caching, performance, best practices">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Data Storage and Retrieval Best Practices">
    <meta property="og:description" content="Optimize WordPress data storage and retrieval for maximum performance">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Data Storage Best Practices</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">Data Storage and Retrieval Best Practices</h1>
                    <p class="lesson-subtitle">Optimize WordPress data operations for performance and scalability</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Choose appropriate data storage methods</li>
                        <li>Optimize database queries for performance</li>
                        <li>Implement effective caching strategies</li>
                        <li>Handle large datasets efficiently</li>
                        <li>Secure data storage and retrieval</li>
                        <li>Debug and profile database operations</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Data Storage Options -->
                    <section>
                        <h2>WordPress Data Storage Options</h2>
                        
                        <div class="info-box">
                            <h3>Storage Methods Comparison</h3>
                            <table class="comparison-table">
                                <thead>
                                    <tr>
                                        <th>Method</th>
                                        <th>Use Case</th>
                                        <th>Pros</th>
                                        <th>Cons</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Post Meta</strong></td>
                                        <td>Post-specific data</td>
                                        <td>Easy to use, built-in caching</td>
                                        <td>Can bloat postmeta table</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Options API</strong></td>
                                        <td>Site-wide settings</td>
                                        <td>Autoloaded, cached</td>
                                        <td>Not for large data</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Custom Tables</strong></td>
                                        <td>Complex, large datasets</td>
                                        <td>Optimized queries, scalable</td>
                                        <td>More complex to implement</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Transients</strong></td>
                                        <td>Temporary/cached data</td>
                                        <td>Built-in expiration</td>
                                        <td>Not permanent storage</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Object Cache</strong></td>
                                        <td>Frequently accessed data</td>
                                        <td>Very fast retrieval</td>
                                        <td>Requires setup</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                    
                    <!-- Post Meta Best Practices -->
                    <section>
                        <h2>Post Meta Best Practices</h2>
                        
                        <h3>Efficient Meta Storage</h3>
                        <pre><code class="language-php">
// BAD: Multiple meta entries
update_post_meta($post_id, 'address_street', $street);
update_post_meta($post_id, 'address_city', $city);
update_post_meta($post_id, 'address_state', $state);
update_post_meta($post_id, 'address_zip', $zip);

// GOOD: Single serialized entry
$address = [
    'street' => $street,
    'city' => $city,
    'state' => $state,
    'zip' => $zip
];
update_post_meta($post_id, '_address', $address);

// BETTER: Use a single meta key for related data
class Product_Meta {
    private $post_id;
    private $meta_key = '_product_data';
    private $data = [];
    
    public function __construct($post_id) {
        $this->post_id = $post_id;
        $this->load();
    }
    
    private function load() {
        $this->data = get_post_meta($this->post_id, $this->meta_key, true) ?: [];
    }
    
    public function get($key, $default = null) {
        return $this->data[$key] ?? $default;
    }
    
    public function set($key, $value) {
        $this->data[$key] = $value;
        return $this;
    }
    
    public function save() {
        update_post_meta($this->post_id, $this->meta_key, $this->data);
        return $this;
    }
}

// Usage
$product = new Product_Meta($post_id);
$product->set('price', 29.99)
        ->set('sku', 'PROD-123')
        ->set('stock', 100)
        ->save();
                        </code></pre>
                        
                        <h3>Querying Meta Efficiently</h3>
                        <pre><code class="language-php">
// BAD: Multiple queries in loop
$posts = get_posts(['post_type' => 'product']);
foreach ($posts as $post) {
    $price = get_post_meta($post->ID, 'price', true);
    $stock = get_post_meta($post->ID, 'stock', true);
    // Process...
}

// GOOD: Single query with meta_query
$products = new WP_Query([
    'post_type' => 'product',
    'meta_query' => [
        'relation' => 'AND',
        [
            'key' => 'price',
            'value' => 50,
            'compare' => '<=',
            'type' => 'NUMERIC'
        ],
        [
            'key' => 'stock',
            'value' => 0,
            'compare' => '>',
            'type' => 'NUMERIC'
        ]
    ],
    'fields' => 'ids' // Only get IDs if that's all you need
]);

// BETTER: Preload all meta at once
$post_ids = wp_list_pluck($posts, 'ID');
update_meta_cache('post', $post_ids);

// Now these won't hit the database
foreach ($posts as $post) {
    $meta = get_post_meta($post->ID);
    // All meta is already cached
}

// BEST: Custom SQL for complex queries
global $wpdb;
$results = $wpdb->get_results($wpdb->prepare("
    SELECT p.ID, p.post_title, 
           pm1.meta_value as price,
           pm2.meta_value as stock
    FROM {$wpdb->posts} p
    LEFT JOIN {$wpdb->postmeta} pm1 ON p.ID = pm1.post_id 
        AND pm1.meta_key = 'price'
    LEFT JOIN {$wpdb->postmeta} pm2 ON p.ID = pm2.post_id 
        AND pm2.meta_key = 'stock'
    WHERE p.post_type = 'product'
        AND p.post_status = 'publish'
        AND CAST(pm1.meta_value AS DECIMAL(10,2)) <= %d
        AND CAST(pm2.meta_value AS UNSIGNED) > 0
    ORDER BY CAST(pm1.meta_value AS DECIMAL(10,2)) ASC
    LIMIT 20
", 100));
                        </code></pre>
                    </section>
                    
                    <!-- Options API Best Practices -->
                    <section>
                        <h2>Options API Best Practices</h2>
                        
                        <h3>Autoload Management</h3>
                        <pre><code class="language-php">
// BAD: Large data with autoload
update_option('huge_data_array', $massive_array); // Autoloads by default

// GOOD: Disable autoload for large data
update_option('huge_data_array', $massive_array, false); // No autoload

// Check autoloaded options size
global $wpdb;
$autoload_size = $wpdb->get_var("
    SELECT SUM(LENGTH(option_value)) 
    FROM {$wpdb->options} 
    WHERE autoload = 'yes'
");
echo 'Autoloaded data size: ' . size_format($autoload_size);

// Find large autoloaded options
$large_options = $wpdb->get_results("
    SELECT option_name, LENGTH(option_value) as size 
    FROM {$wpdb->options} 
    WHERE autoload = 'yes' 
    ORDER BY size DESC 
    LIMIT 10
");

// Optimize options storage
class Theme_Options {
    private static $option_key = 'theme_settings';
    private static $cache = null;
    
    public static function get($key = null, $default = null) {
        if (self::$cache === null) {
            self::$cache = get_option(self::$option_key, []);
        }
        
        if ($key === null) {
            return self::$cache;
        }
        
        return self::$cache[$key] ?? $default;
    }
    
    public static function set($key, $value) {
        if (self::$cache === null) {
            self::$cache = get_option(self::$option_key, []);
        }
        
        self::$cache[$key] = $value;
        
        // Update with autoload disabled if data is large
        $autoload = strlen(serialize(self::$cache)) < 40000;
        update_option(self::$option_key, self::$cache, $autoload);
    }
    
    public static function delete($key) {
        if (self::$cache === null) {
            self::$cache = get_option(self::$option_key, []);
        }
        
        unset(self::$cache[$key]);
        update_option(self::$option_key, self::$cache);
    }
}
                        </code></pre>
                    </section>
                    
                    <!-- Custom Tables -->
                    <section>
                        <h2>Custom Database Tables</h2>
                        
                        <h3>When to Use Custom Tables</h3>
                        <div class="info-box">
                            <ul>
                                <li>Complex relational data structures</li>
                                <li>Large datasets (>10,000 records)</li>
                                <li>Need for specific indexes</li>
                                <li>Performance-critical queries</li>
                                <li>Data that doesn't fit post/meta model</li>
                            </ul>
                        </div>
                        
                        <h3>Creating Custom Tables</h3>
                        <pre><code class="language-php">
class Custom_Table_Manager {
    
    private static $table_version = '1.0';
    
    public static function create_tables() {
        global $wpdb;
        
        $table_name = $wpdb->prefix . 'custom_analytics';
        $charset_collate = $wpdb->get_charset_collate();
        
        $sql = "CREATE TABLE IF NOT EXISTS $table_name (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            post_id bigint(20) UNSIGNED NOT NULL,
            user_id bigint(20) UNSIGNED DEFAULT NULL,
            event_type varchar(50) NOT NULL,
            event_data longtext DEFAULT NULL,
            ip_address varchar(45) DEFAULT NULL,
            user_agent text DEFAULT NULL,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY post_id_idx (post_id),
            KEY user_id_idx (user_id),
            KEY event_type_idx (event_type),
            KEY created_at_idx (created_at),
            KEY compound_idx (post_id, event_type, created_at)
        ) $charset_collate;";
        
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql);
        
        update_option('custom_table_version', self::$table_version);
    }
    
    public static function insert_event($data) {
        global $wpdb;
        
        $defaults = [
            'post_id' => 0,
            'user_id' => get_current_user_id(),
            'event_type' => '',
            'event_data' => '',
            'ip_address' => $_SERVER['REMOTE_ADDR'] ?? '',
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? ''
        ];
        
        $data = wp_parse_args($data, $defaults);
        
        // Serialize event data if array
        if (is_array($data['event_data'])) {
            $data['event_data'] = json_encode($data['event_data']);
        }
        
        $result = $wpdb->insert(
            $wpdb->prefix . 'custom_analytics',
            $data,
            ['%d', '%d', '%s', '%s', '%s', '%s']
        );
        
        if ($result === false) {
            error_log('Failed to insert event: ' . $wpdb->last_error);
            return false;
        }
        
        return $wpdb->insert_id;
    }
    
    public static function get_events($args = []) {
        global $wpdb;
        
        $defaults = [
            'post_id' => null,
            'user_id' => null,
            'event_type' => null,
            'date_from' => null,
            'date_to' => null,
            'limit' => 100,
            'offset' => 0,
            'orderby' => 'created_at',
            'order' => 'DESC'
        ];
        
        $args = wp_parse_args($args, $defaults);
        $table = $wpdb->prefix . 'custom_analytics';
        
        // Build WHERE clause
        $where = ['1=1'];
        $values = [];
        
        if ($args['post_id']) {
            $where[] = 'post_id = %d';
            $values[] = $args['post_id'];
        }
        
        if ($args['user_id']) {
            $where[] = 'user_id = %d';
            $values[] = $args['user_id'];
        }
        
        if ($args['event_type']) {
            $where[] = 'event_type = %s';
            $values[] = $args['event_type'];
        }
        
        if ($args['date_from']) {
            $where[] = 'created_at >= %s';
            $values[] = $args['date_from'];
        }
        
        if ($args['date_to']) {
            $where[] = 'created_at <= %s';
            $values[] = $args['date_to'];
        }
        
        $where_clause = implode(' AND ', $where);
        
        // Add ORDER BY and LIMIT
        $values[] = $args['limit'];
        $values[] = $args['offset'];
        
        $query = "
            SELECT * FROM $table
            WHERE $where_clause
            ORDER BY {$args['orderby']} {$args['order']}
            LIMIT %d OFFSET %d
        ";
        
        $results = $wpdb->get_results(
            $wpdb->prepare($query, $values)
        );
        
        // Decode event data
        foreach ($results as &$result) {
            $result->event_data = json_decode($result->event_data, true);
        }
        
        return $results;
    }
    
    public static function cleanup_old_events($days = 90) {
        global $wpdb;
        
        $table = $wpdb->prefix . 'custom_analytics';
        $date = date('Y-m-d H:i:s', strtotime("-{$days} days"));
        
        $deleted = $wpdb->query($wpdb->prepare("
            DELETE FROM $table WHERE created_at < %s
        ", $date));
        
        return $deleted;
    }
}

// Register table creation on activation
register_activation_hook(__FILE__, ['Custom_Table_Manager', 'create_tables']);

// Schedule cleanup
if (!wp_next_scheduled('cleanup_analytics_events')) {
    wp_schedule_event(time(), 'daily', 'cleanup_analytics_events');
}
add_action('cleanup_analytics_events', ['Custom_Table_Manager', 'cleanup_old_events']);
                        </code></pre>
                    </section>
                    
                    <!-- Caching Strategies -->
                    <section>
                        <h2>Caching Strategies</h2>
                        
                        <h3>Transients API</h3>
                        <pre><code class="language-php">
// Basic transient usage
function get_expensive_data() {
    $cache_key = 'expensive_data_' . md5(serialize(func_get_args()));
    $cached = get_transient($cache_key);
    
    if ($cached !== false) {
        return $cached;
    }
    
    // Expensive operation
    $data = perform_expensive_operation();
    
    // Cache for 1 hour
    set_transient($cache_key, $data, HOUR_IN_SECONDS);
    
    return $data;
}

// Transient with soft expiration
class Smart_Cache {
    
    public static function get($key, $callback, $expiration = 3600) {
        $transient_key = 'sc_' . $key;
        $cached = get_transient($transient_key);
        
        if ($cached !== false) {
            // Check if soft expired
            if (isset($cached['soft_expire']) && 
                $cached['soft_expire'] < time()) {
                
                // Spawn background refresh
                wp_schedule_single_event(time(), 'refresh_cache', [$key, $callback, $expiration]);
            }
            
            return $cached['data'];
        }
        
        // Generate fresh data
        $data = call_user_func($callback);
        
        // Store with soft expiration
        $cache_data = [
            'data' => $data,
            'soft_expire' => time() + ($expiration * 0.8) // 80% of expiration
        ];
        
        set_transient($transient_key, $cache_data, $expiration);
        
        return $data;
    }
    
    public static function delete($key) {
        delete_transient('sc_' . $key);
    }
    
    public static function flush_group($group) {
        global $wpdb;
        
        $wpdb->query($wpdb->prepare("
            DELETE FROM {$wpdb->options}
            WHERE option_name LIKE %s
            OR option_name LIKE %s
        ", 
        '_transient_sc_' . $group . '%',
        '_transient_timeout_sc_' . $group . '%'
        ));
    }
}

// Usage
$products = Smart_Cache::get('featured_products', function() {
    return get_posts([
        'post_type' => 'product',
        'meta_key' => 'featured',
        'meta_value' => 'yes',
        'posts_per_page' => 10
    ]);
}, 3600);
                        </code></pre>
                        
                        <h3>Object Cache</h3>
                        <pre><code class="language-php">
// Object cache wrapper
class Cache_Manager {
    
    private static $group = 'theme_cache';
    
    public static function get($key) {
        return wp_cache_get($key, self::$group);
    }
    
    public static function set($key, $value, $expiration = 3600) {
        return wp_cache_set($key, $value, self::$group, $expiration);
    }
    
    public static function delete($key) {
        return wp_cache_delete($key, self::$group);
    }
    
    public static function remember($key, $callback, $expiration = 3600) {
        $cached = self::get($key);
        
        if ($cached !== false) {
            return $cached;
        }
        
        $value = call_user_func($callback);
        self::set($key, $value, $expiration);
        
        return $value;
    }
    
    public static function flush() {
        wp_cache_flush();
    }
    
    // Fragment caching
    public static function fragment($key, $callback, $expiration = 3600) {
        $output = self::get($key);
        
        if ($output !== false) {
            echo $output;
            return;
        }
        
        ob_start();
        call_user_func($callback);
        $output = ob_get_clean();
        
        self::set($key, $output, $expiration);
        echo $output;
    }
}

// Usage
Cache_Manager::fragment('header_menu_' . get_current_user_id(), function() {
    wp_nav_menu(['theme_location' => 'primary']);
}, 3600);
                        </code></pre>
                    </section>
                    
                    <!-- Query Optimization -->
                    <section>
                        <h2>Query Optimization</h2>
                        
                        <h3>Efficient Query Patterns</h3>
                        <pre><code class="language-php">
// Query optimization techniques
class Optimized_Queries {
    
    // Use fields parameter to get only what you need
    public static function get_post_ids($args = []) {
        $defaults = [
            'post_type' => 'post',
            'posts_per_page' => -1,
            'fields' => 'ids', // Only get IDs
            'no_found_rows' => true, // Skip pagination calculations
            'update_post_meta_cache' => false,
            'update_post_term_cache' => false
        ];
        
        $args = wp_parse_args($args, $defaults);
        return get_posts($args);
    }
    
    // Batch operations
    public static function batch_update_meta($post_ids, $meta_key, $meta_value) {
        global $wpdb;
        
        if (empty($post_ids)) {
            return false;
        }
        
        $post_ids = array_map('intval', $post_ids);
        $ids_string = implode(',', $post_ids);
        
        // Delete existing meta
        $wpdb->query($wpdb->prepare("
            DELETE FROM {$wpdb->postmeta}
            WHERE post_id IN ($ids_string)
            AND meta_key = %s
        ", $meta_key));
        
        // Build batch insert
        $values = [];
        foreach ($post_ids as $id) {
            $values[] = $wpdb->prepare("(%d, %s, %s)", 
                $id, $meta_key, $meta_value);
        }
        
        // Insert all at once
        $wpdb->query("
            INSERT INTO {$wpdb->postmeta} 
            (post_id, meta_key, meta_value)
            VALUES " . implode(',', $values)
        );
        
        // Clear cache
        foreach ($post_ids as $id) {
            clean_post_cache($id);
        }
        
        return true;
    }
    
    // Pagination with custom queries
    public static function paginated_query($sql, $page = 1, $per_page = 20) {
        global $wpdb;
        
        // Get total count
        $count_sql = "SELECT COUNT(*) FROM ($sql) as count_query";
        $total = $wpdb->get_var($count_sql);
        
        // Calculate pagination
        $offset = ($page - 1) * $per_page;
        
        // Get results
        $results_sql = "$sql LIMIT $per_page OFFSET $offset";
        $results = $wpdb->get_results($results_sql);
        
        return [
            'results' => $results,
            'total' => $total,
            'pages' => ceil($total / $per_page),
            'current_page' => $page,
            'per_page' => $per_page
        ];
    }
    
    // Avoid N+1 queries
    public static function get_posts_with_meta($post_type = 'post') {
        global $wpdb;
        
        $query = "
            SELECT 
                p.*,
                MAX(CASE WHEN pm.meta_key = 'price' 
                    THEN pm.meta_value END) as price,
                MAX(CASE WHEN pm.meta_key = 'sku' 
                    THEN pm.meta_value END) as sku,
                MAX(CASE WHEN pm.meta_key = 'stock' 
                    THEN pm.meta_value END) as stock
            FROM {$wpdb->posts} p
            LEFT JOIN {$wpdb->postmeta} pm ON p.ID = pm.post_id
            WHERE p.post_type = %s
                AND p.post_status = 'publish'
                AND pm.meta_key IN ('price', 'sku', 'stock')
            GROUP BY p.ID
            ORDER BY p.post_date DESC
        ";
        
        return $wpdb->get_results($wpdb->prepare($query, $post_type));
    }
}
                        </code></pre>
                        
                        <h3>Query Monitoring</h3>
                        <pre><code class="language-php">
// Query performance monitoring
class Query_Monitor {
    
    private static $queries = [];
    
    public static function init() {
        if (defined('WP_DEBUG') && WP_DEBUG) {
            add_filter('query', [__CLASS__, 'log_query']);
            add_action('shutdown', [__CLASS__, 'display_stats']);
        }
    }
    
    public static function log_query($query) {
        $start = microtime(true);
        
        // Store query info
        self::$queries[] = [
            'query' => $query,
            'time' => microtime(true) - $start,
            'backtrace' => debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 5)
        ];
        
        return $query;
    }
    
    public static function display_stats() {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $total_time = array_sum(array_column(self::$queries, 'time'));
        $slow_queries = array_filter(self::$queries, function($q) {
            return $q['time'] > 0.05; // Queries taking more than 50ms
        });
        
        echo "&lt;!-- Query Stats:\n";
        echo "Total Queries: " . count(self::$queries) . "\n";
        echo "Total Time: " . round($total_time * 1000, 2) . "ms\n";
        echo "Slow Queries: " . count($slow_queries) . "\n";
        
        if (!empty($slow_queries)) {
            echo "\nSlow Query Details:\n";
            foreach ($slow_queries as $query) {
                echo "Time: " . round($query['time'] * 1000, 2) . "ms\n";
                echo "Query: " . substr($query['query'], 0, 100) . "...\n\n";
            }
        }
        
        echo "--&gt;";
    }
}

// Initialize monitoring
add_action('init', ['Query_Monitor', 'init']);
                        </code></pre>
                    </section>
                    
                    <!-- Data Security -->
                    <section>
                        <h2>Data Security Best Practices</h2>
                        
                        <h3>Sanitization and Validation</h3>
                        <pre><code class="language-php">
// Data sanitization helper
class Data_Sanitizer {
    
    public static function sanitize($data, $type = 'text') {
        switch ($type) {
            case 'text':
                return sanitize_text_field($data);
                
            case 'textarea':
                return sanitize_textarea_field($data);
                
            case 'email':
                return sanitize_email($data);
                
            case 'url':
                return esc_url_raw($data);
                
            case 'int':
                return intval($data);
                
            case 'float':
                return floatval($data);
                
            case 'html':
                return wp_kses_post($data);
                
            case 'json':
                return json_encode(
                    json_decode($data, true), 
                    JSON_UNESCAPED_UNICODE
                );
                
            case 'array':
                return array_map('sanitize_text_field', (array) $data);
                
            default:
                return sanitize_text_field($data);
        }
    }
    
    public static function validate($data, $rules) {
        $errors = [];
        
        foreach ($rules as $field => $rule) {
            if (!isset($data[$field]) && !empty($rule['required'])) {
                $errors[$field] = $field . ' is required';
                continue;
            }
            
            $value = $data[$field] ?? '';
            
            // Type validation
            if (isset($rule['type'])) {
                switch ($rule['type']) {
                    case 'email':
                        if (!is_email($value)) {
                            $errors[$field] = 'Invalid email format';
                        }
                        break;
                        
                    case 'url':
                        if (!filter_var($value, FILTER_VALIDATE_URL)) {
                            $errors[$field] = 'Invalid URL format';
                        }
                        break;
                        
                    case 'numeric':
                        if (!is_numeric($value)) {
                            $errors[$field] = 'Must be numeric';
                        }
                        break;
                }
            }
            
            // Min/Max validation
            if (isset($rule['min']) && strlen($value) < $rule['min']) {
                $errors[$field] = "Minimum length is {$rule['min']}";
            }
            
            if (isset($rule['max']) && strlen($value) > $rule['max']) {
                $errors[$field] = "Maximum length is {$rule['max']}";
            }
            
            // Custom validation callback
            if (isset($rule['callback']) && is_callable($rule['callback'])) {
                $result = call_user_func($rule['callback'], $value);
                if ($result !== true) {
                    $errors[$field] = $result;
                }
            }
        }
        
        return empty($errors) ? true : $errors;
    }
}

// Usage
$rules = [
    'email' => [
        'required' => true,
        'type' => 'email'
    ],
    'age' => [
        'type' => 'numeric',
        'min' => 1,
        'max' => 3,
        'callback' => function($value) {
            return $value >= 18 ? true : 'Must be 18 or older';
        }
    ]
];

$validation = Data_Sanitizer::validate($_POST, $rules);
if ($validation === true) {
    // Data is valid
} else {
    // Handle errors
    foreach ($validation as $field => $error) {
        echo "$field: $error\n";
    }
}
                        </code></pre>
                        
                        <h3>Secure Data Access</h3>
                        <pre><code class="language-php">
// Secure data access layer
class Secure_Data_Access {
    
    // Check capability before accessing data
    public static function get_sensitive_data($post_id) {
        if (!current_user_can('edit_post', $post_id)) {
            return new WP_Error('forbidden', 'Access denied');
        }
        
        return get_post_meta($post_id, '_sensitive_data', true);
    }
    
    // Encrypt sensitive data
    public static function encrypt_data($data) {
        if (!defined('SECURE_AUTH_KEY')) {
            return $data;
        }
        
        $key = substr(hash('sha256', SECURE_AUTH_KEY), 0, 32);
        $iv = openssl_random_pseudo_bytes(16);
        
        $encrypted = openssl_encrypt(
            serialize($data),
            'AES-256-CBC',
            $key,
            0,
            $iv
        );
        
        return base64_encode($iv . $encrypted);
    }
    
    public static function decrypt_data($encrypted) {
        if (!defined('SECURE_AUTH_KEY')) {
            return $encrypted;
        }
        
        $key = substr(hash('sha256', SECURE_AUTH_KEY), 0, 32);
        $data = base64_decode($encrypted);
        $iv = substr($data, 0, 16);
        $encrypted = substr($data, 16);
        
        $decrypted = openssl_decrypt(
            $encrypted,
            'AES-256-CBC',
            $key,
            0,
            $iv
        );
        
        return unserialize($decrypted);
    }
    
    // Prepared statements for custom queries
    public static function get_user_data($user_id, $fields = ['*']) {
        global $wpdb;
        
        $fields = array_map(function($field) {
            return preg_match('/^[a-zA-Z_][a-zA-Z0-9_]*$/', $field) 
                ? $field 
                : '*';
        }, $fields);
        
        $fields_str = implode(', ', $fields);
        
        return $wpdb->get_row($wpdb->prepare("
            SELECT $fields_str
            FROM {$wpdb->users}
            WHERE ID = %d
        ", $user_id));
    }
}
                        </code></pre>
                    </section>
                    
                    <!-- Performance Tools -->
                    <section>
                        <h2>Performance Analysis Tools</h2>
                        
                        <h3>Database Query Analysis</h3>
                        <pre><code class="language-php">
// Enable query logging
define('SAVEQUERIES', true);

// Analyze queries
add_action('shutdown', function() {
    if (!defined('SAVEQUERIES') || !SAVEQUERIES) {
        return;
    }
    
    global $wpdb;
    
    echo "&lt;pre style='background: #fff; color: #000; padding: 20px;'&gt;";
    echo "Total queries: " . count($wpdb->queries) . "\n";
    
    $total_time = 0;
    $slow_queries = [];
    
    foreach ($wpdb->queries as $query) {
        $time = $query[1];
        $total_time += $time;
        
        if ($time > 0.05) { // 50ms threshold
            $slow_queries[] = [
                'query' => $query[0],
                'time' => $time,
                'stack' => $query[2]
            ];
        }
    }
    
    echo "Total query time: " . round($total_time, 4) . " seconds\n";
    echo "Slow queries: " . count($slow_queries) . "\n\n";
    
    foreach ($slow_queries as $sq) {
        echo "Time: " . round($sq['time'], 4) . "s\n";
        echo "Query: " . $sq['query'] . "\n";
        echo "Stack: " . $sq['stack'] . "\n\n";
    }
    
    echo "&lt;/pre&gt;";
});

// Database table analysis
function analyze_database_tables() {
    global $wpdb;
    
    $tables = $wpdb->get_results("
        SELECT 
            table_name,
            table_rows,
            data_length,
            index_length,
            round(((data_length + index_length) / 1024 / 1024), 2) as size_mb
        FROM information_schema.TABLES
        WHERE table_schema = '" . DB_NAME . "'
        ORDER BY (data_length + index_length) DESC
    ");
    
    echo "&lt;table&gt;";
    echo "&lt;tr&gt;&lt;th&gt;Table&lt;/th&gt;&lt;th&gt;Rows&lt;/th&gt;&lt;th&gt;Size (MB)&lt;/th&gt;&lt;/tr&gt;";
    
    foreach ($tables as $table) {
        echo "&lt;tr&gt;";
        echo "&lt;td&gt;{$table->table_name}&lt;/td&gt;";
        echo "&lt;td&gt;{$table->table_rows}&lt;/td&gt;";
        echo "&lt;td&gt;{$table->size_mb}&lt;/td&gt;";
        echo "&lt;/tr&gt;";
    }
    
    echo "&lt;/table&gt;";
}
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>Choose the right storage method for your data type</li>
                                <li>Optimize queries to minimize database hits</li>
                                <li>Implement caching at multiple levels</li>
                                <li>Use custom tables for complex data structures</li>
                                <li>Always sanitize and validate data</li>
                                <li>Monitor and profile database performance</li>
                                <li>Consider scalability from the start</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Performance Checklist</h3>
                            <ul>
                                <li>✓ Minimize autoloaded options</li>
                                <li>✓ Use appropriate indexes on custom tables</li>
                                <li>✓ Cache expensive queries</li>
                                <li>✓ Batch database operations when possible</li>
                                <li>✓ Clean up old/unused data regularly</li>
                                <li>✓ Use object cache for frequently accessed data</li>
                                <li>✓ Profile queries in development</li>
                                <li>✓ Implement proper error handling</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://developer.wordpress.org/apis/handbook/database/" target="_blank">WordPress Database API Handbook</a></li>
                            <li><a href="https://developer.wordpress.org/apis/handbook/transients/" target="_blank">Transients API Documentation</a></li>
                            <li><a href="https://www.percona.com/blog/wordpress-database-optimization/" target="_blank">WordPress Database Optimization Guide</a></li>
                            <li><a href="https://kinsta.com/blog/wordpress-cache/" target="_blank">WordPress Caching Guide</a></li>
                            <li><a href="https://github.com/10up/ElasticPress" target="_blank">ElasticPress - Advanced Search</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/cmb2_metaboxes.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            CMB2 for Metaboxes
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/homework_complex_acf.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            Homework: Complex ACF
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>