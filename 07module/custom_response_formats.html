<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>Custom Response Formats - PHP WordPress Course</title>
    <meta name="description" content="Learn to create custom response formats for WordPress REST API. Implement CSV, XML, PDF exports and custom data structures.">
    <meta name="keywords" content="WordPress, REST API, response formats, CSV, XML, PDF, data export">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Custom Response Formats">
    <meta property="og:description" content="Create custom REST API response formats">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Response Formats</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">Custom Response Formats</h1>
                    <p class="lesson-subtitle">Deliver API data in multiple formats beyond JSON</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Create CSV export endpoints</li>
                        <li>Generate XML responses</li>
                        <li>Build PDF generation endpoints</li>
                        <li>Implement format negotiation</li>
                        <li>Create custom data transformers</li>
                        <li>Handle binary data responses</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Format Negotiation -->
                    <section>
                        <h2>Format Negotiation System</h2>
                        
                        <h3>Content Type Detection and Response</h3>
                        <pre><code class="language-php">
/**
 * Format negotiation and response handler
 */
class Format_Negotiation_Handler {
    
    private $supported_formats = [
        'json' => 'application/json',
        'xml' => 'application/xml',
        'csv' => 'text/csv',
        'pdf' => 'application/pdf',
        'html' => 'text/html',
        'yaml' => 'application/x-yaml',
    ];
    
    public function __construct() {
        add_filter('rest_pre_serve_request', [$this, 'handle_format_request'], 10, 4);
        add_action('rest_api_init', [$this, 'register_format_endpoints']);
    }
    
    /**
     * Handle format requests
     */
    public function handle_format_request($served, $result, $request, $server) {
        // Check for format parameter or Accept header
        $format = $this->determine_response_format($request);
        
        if ($format !== 'json') {
            $served = true;
            $this->send_formatted_response($result, $format, $request);
        }
        
        return $served;
    }
    
    /**
     * Determine response format
     */
    private function determine_response_format($request) {
        // Check URL parameter
        if ($format = $request->get_param('format')) {
            return $format;
        }
        
        // Check file extension in URL
        $route = $request->get_route();
        if (preg_match('/\.(\w+)$/', $route, $matches)) {
            return $matches[1];
        }
        
        // Check Accept header
        $accept = $_SERVER['HTTP_ACCEPT'] ?? '';
        foreach ($this->supported_formats as $format => $mime) {
            if (strpos($accept, $mime) !== false) {
                return $format;
            }
        }
        
        return 'json'; // Default
    }
    
    /**
     * Send formatted response
     */
    private function send_formatted_response($data, $format, $request) {
        // Convert WP_REST_Response to array
        if ($data instanceof WP_REST_Response) {
            $data = $data->get_data();
        }
        
        // Handle WP_Error
        if (is_wp_error($data)) {
            $data = [
                'error' => true,
                'code' => $data->get_error_code(),
                'message' => $data->get_error_message(),
            ];
        }
        
        switch ($format) {
            case 'xml':
                $this->send_xml_response($data);
                break;
                
            case 'csv':
                $this->send_csv_response($data);
                break;
                
            case 'pdf':
                $this->send_pdf_response($data, $request);
                break;
                
            case 'html':
                $this->send_html_response($data);
                break;
                
            case 'yaml':
                $this->send_yaml_response($data);
                break;
                
            default:
                $this->send_json_response($data);
        }
    }
    
    /**
     * Send JSON response (default)
     */
    private function send_json_response($data) {
        header('Content-Type: application/json; charset=utf-8');
        echo wp_json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
    }
    
    /**
     * Send XML response
     */
    private function send_xml_response($data) {
        header('Content-Type: application/xml; charset=utf-8');
        
        $xml = new SimpleXMLElement('<?xml version="1.0" encoding="UTF-8"?><response></response>');
        $this->array_to_xml($data, $xml);
        
        echo $xml->asXML();
    }
    
    /**
     * Convert array to XML
     */
    private function array_to_xml($data, &$xml) {
        foreach ($data as $key => $value) {
            if (is_numeric($key)) {
                $key = 'item';
            }
            
            if (is_array($value)) {
                $subnode = $xml->addChild($key);
                $this->array_to_xml($value, $subnode);
            } else {
                $xml->addChild($key, htmlspecialchars($value));
            }
        }
    }
    
    /**
     * Send CSV response
     */
    private function send_csv_response($data) {
        header('Content-Type: text/csv; charset=utf-8');
        header('Content-Disposition: attachment; filename="export.csv"');
        
        $output = fopen('php://output', 'w');
        
        // Add BOM for Excel UTF-8 recognition
        fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF));
        
        // Flatten nested data
        $flat_data = $this->flatten_for_csv($data);
        
        // Write headers
        if (!empty($flat_data)) {
            fputcsv($output, array_keys(reset($flat_data)));
            
            // Write data
            foreach ($flat_data as $row) {
                fputcsv($output, $row);
            }
        }
        
        fclose($output);
    }
    
    /**
     * Flatten data for CSV export
     */
    private function flatten_for_csv($data) {
        if (!is_array($data)) {
            return [[$data]];
        }
        
        // Check if it's a single item or collection
        if (isset($data[0])) {
            // Collection
            $flattened = [];
            foreach ($data as $item) {
                $flattened[] = $this->flatten_item($item);
            }
            return $flattened;
        } else {
            // Single item
            return [$this->flatten_item($data)];
        }
    }
    
    /**
     * Flatten single item
     */
    private function flatten_item($item, $prefix = '') {
        $result = [];
        
        foreach ($item as $key => $value) {
            $new_key = $prefix ? $prefix . '_' . $key : $key;
            
            if (is_array($value) && !isset($value[0])) {
                // Nested object
                $result = array_merge($result, $this->flatten_item($value, $new_key));
            } elseif (is_array($value)) {
                // Array values
                $result[$new_key] = implode(', ', array_map('strval', $value));
            } else {
                $result[$new_key] = $value;
            }
        }
        
        return $result;
    }
    
    /**
     * Send YAML response
     */
    private function send_yaml_response($data) {
        header('Content-Type: application/x-yaml; charset=utf-8');
        
        // Simple YAML converter (for production, use a library like Symfony YAML)
        echo $this->array_to_yaml($data);
    }
    
    /**
     * Convert array to YAML
     */
    private function array_to_yaml($data, $indent = 0) {
        $yaml = '';
        $prefix = str_repeat('  ', $indent);
        
        foreach ($data as $key => $value) {
            if (is_array($value)) {
                $yaml .= $prefix . $key . ":\n";
                $yaml .= $this->array_to_yaml($value, $indent + 1);
            } else {
                $yaml .= $prefix . $key . ': ' . $value . "\n";
            }
        }
        
        return $yaml;
    }
}

new Format_Negotiation_Handler();
                        </code></pre>
                    </section>
                    
                    <!-- PDF Generation -->
                    <section>
                        <h2>PDF Generation Endpoint</h2>
                        
                        <h3>Creating PDF Responses</h3>
                        <pre><code class="language-php">
/**
 * PDF generation for REST API responses
 */
class PDF_Response_Generator {
    
    public function __construct() {
        add_action('rest_api_init', [$this, 'register_pdf_endpoints']);
    }
    
    /**
     * Register PDF export endpoints
     */
    public function register_pdf_endpoints() {
        // PDF export for posts
        register_rest_route('export/v1', '/posts/pdf', [
            'methods' => 'GET',
            'callback' => [$this, 'export_posts_pdf'],
            'permission_callback' => '__return_true',
            'args' => [
                'ids' => [
                    'type' => 'array',
                    'items' => ['type' => 'integer'],
                ],
                'per_page' => [
                    'type' => 'integer',
                    'default' => 10,
                ],
            ],
        ]);
        
        // Single post PDF
        register_rest_route('export/v1', '/post/(?P<id>\d+)/pdf', [
            'methods' => 'GET',
            'callback' => [$this, 'export_single_post_pdf'],
            'permission_callback' => '__return_true',
        ]);
        
        // Report generation
        register_rest_route('export/v1', '/report/pdf', [
            'methods' => 'POST',
            'callback' => [$this, 'generate_report_pdf'],
            'permission_callback' => 'is_user_logged_in',
        ]);
    }
    
    /**
     * Export posts to PDF
     */
    public function export_posts_pdf($request) {
        require_once(WP_CONTENT_DIR . '/tcpdf/tcpdf.php');
        
        // Get posts
        $args = [
            'posts_per_page' => $request->get_param('per_page'),
            'post_status' => 'publish',
        ];
        
        if ($ids = $request->get_param('ids')) {
            $args['post__in'] = $ids;
        }
        
        $posts = get_posts($args);
        
        // Create PDF
        $pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        
        // Set document information
        $pdf->SetCreator('WordPress REST API');
        $pdf->SetAuthor(get_bloginfo('name'));
        $pdf->SetTitle('Posts Export');
        $pdf->SetSubject('WordPress Posts');
        
        // Set default header data
        $pdf->SetHeaderData('', 0, get_bloginfo('name'), 'Posts Export - ' . date('Y-m-d'));
        
        // Set header and footer fonts
        $pdf->setHeaderFont(['helvetica', '', 10]);
        $pdf->setFooterFont(['helvetica', '', 8]);
        
        // Set margins
        $pdf->SetMargins(15, 27, 15);
        $pdf->SetHeaderMargin(5);
        $pdf->SetFooterMargin(10);
        
        // Set auto page breaks
        $pdf->SetAutoPageBreak(true, 25);
        
        // Add posts to PDF
        foreach ($posts as $post) {
            $pdf->AddPage();
            
            // Title
            $pdf->SetFont('helvetica', 'B', 16);
            $pdf->Cell(0, 10, $post->post_title, 0, 1);
            
            // Meta information
            $pdf->SetFont('helvetica', 'I', 10);
            $pdf->Cell(0, 5, 'By ' . get_the_author_meta('display_name', $post->post_author), 0, 1);
            $pdf->Cell(0, 5, 'Published: ' . get_the_date('', $post), 0, 1);
            $pdf->Ln(5);
            
            // Content
            $pdf->SetFont('helvetica', '', 11);
            $content = strip_tags($post->post_content);
            $pdf->WriteHTML($this->prepare_content_for_pdf($post->post_content), true, false, true, false, '');
            
            // Categories and tags
            $pdf->Ln(10);
            $pdf->SetFont('helvetica', 'B', 10);
            
            $categories = wp_get_post_categories($post->ID, ['fields' => 'names']);
            if (!empty($categories)) {
                $pdf->Cell(0, 5, 'Categories: ' . implode(', ', $categories), 0, 1);
            }
            
            $tags = wp_get_post_tags($post->ID, ['fields' => 'names']);
            if (!empty($tags)) {
                $pdf->Cell(0, 5, 'Tags: ' . implode(', ', $tags), 0, 1);
            }
        }
        
        // Output PDF
        $pdf->Output('posts_export.pdf', 'D');
        exit;
    }
    
    /**
     * Export single post to PDF
     */
    public function export_single_post_pdf($request) {
        $post_id = $request->get_param('id');
        $post = get_post($post_id);
        
        if (!$post) {
            return new WP_Error('post_not_found', 'Post not found', ['status' => 404]);
        }
        
        require_once(WP_CONTENT_DIR . '/tcpdf/tcpdf.php');
        
        // Create custom PDF class
        class Custom_PDF extends TCPDF {
            public function Header() {
                $this->SetFont('helvetica', 'B', 10);
                $this->Cell(0, 10, get_bloginfo('name'), 0, false, 'C', 0, '', 0, false, 'M', 'M');
            }
            
            public function Footer() {
                $this->SetY(-15);
                $this->SetFont('helvetica', 'I', 8);
                $this->Cell(0, 10, 'Page ' . $this->getAliasNumPage() . '/' . $this->getAliasNbPages(), 0, false, 'C', 0, '', 0, false, 'T', 'M');
            }
        }
        
        $pdf = new Custom_PDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        
        // Set document information
        $pdf->SetCreator('WordPress');
        $pdf->SetAuthor(get_the_author_meta('display_name', $post->post_author));
        $pdf->SetTitle($post->post_title);
        
        // Add a page
        $pdf->AddPage();
        
        // Title
        $pdf->SetFont('helvetica', 'B', 20);
        $pdf->Cell(0, 15, $post->post_title, 0, 1, 'C');
        
        // Featured image if exists
        if (has_post_thumbnail($post_id)) {
            $image_url = get_the_post_thumbnail_url($post_id, 'large');
            $pdf->Image($image_url, '', '', 0, 60, '', '', 'C');
            $pdf->Ln(65);
        }
        
        // Content with HTML support
        $pdf->SetFont('helvetica', '', 11);
        $content = apply_filters('the_content', $post->post_content);
        $pdf->writeHTML($content, true, false, true, false, '');
        
        // Comments section
        $comments = get_comments(['post_id' => $post_id, 'status' => 'approve']);
        if (!empty($comments)) {
            $pdf->AddPage();
            $pdf->SetFont('helvetica', 'B', 14);
            $pdf->Cell(0, 10, 'Comments', 0, 1);
            
            foreach ($comments as $comment) {
                $pdf->SetFont('helvetica', 'B', 10);
                $pdf->Cell(0, 5, $comment->comment_author . ' - ' . $comment->comment_date, 0, 1);
                $pdf->SetFont('helvetica', '', 9);
                $pdf->MultiCell(0, 5, $comment->comment_content, 0, 'L');
                $pdf->Ln(3);
            }
        }
        
        // Output
        $filename = sanitize_file_name($post->post_title) . '.pdf';
        $pdf->Output($filename, 'D');
        exit;
    }
    
    /**
     * Prepare content for PDF
     */
    private function prepare_content_for_pdf($content) {
        // Convert WordPress blocks to HTML
        $content = do_blocks($content);
        
        // Apply content filters
        $content = apply_filters('the_content', $content);
        
        // Clean up HTML for PDF
        $content = preg_replace('/<script\b[^>]*>(.*?)<\/script>/is', '', $content);
        $content = preg_replace('/<style\b[^>]*>(.*?)<\/style>/is', '', $content);
        
        // Convert relative URLs to absolute
        $content = str_replace('src="/', 'src="' . get_site_url() . '/', $content);
        $content = str_replace('href="/', 'href="' . get_site_url() . '/', $content);
        
        return $content;
    }
}

new PDF_Response_Generator();
                        </code></pre>
                    </section>
                    
                    <!-- Excel/Spreadsheet Export -->
                    <section>
                        <h2>Excel/Spreadsheet Export</h2>
                        
                        <h3>Generate Excel Files</h3>
                        <pre><code class="language-php">
/**
 * Excel export functionality
 */
class Excel_Export_Handler {
    
    public function __construct() {
        add_action('rest_api_init', [$this, 'register_excel_endpoints']);
    }
    
    /**
     * Register Excel export endpoints
     */
    public function register_excel_endpoints() {
        register_rest_route('export/v1', '/excel', [
            'methods' => 'POST',
            'callback' => [$this, 'generate_excel'],
            'permission_callback' => 'is_user_logged_in',
            'args' => [
                'data_type' => [
                    'required' => true,
                    'type' => 'string',
                    'enum' => ['posts', 'users', 'orders', 'custom'],
                ],
                'filters' => [
                    'type' => 'object',
                ],
                'columns' => [
                    'type' => 'array',
                    'items' => ['type' => 'string'],
                ],
            ],
        ]);
    }
    
    /**
     * Generate Excel file
     */
    public function generate_excel($request) {
        require_once(WP_CONTENT_DIR . '/PHPExcel/PHPExcel.php');
        
        $data_type = $request->get_param('data_type');
        $filters = $request->get_param('filters') ?: [];
        $columns = $request->get_param('columns') ?: [];
        
        // Create new PHPExcel object
        $objPHPExcel = new PHPExcel();
        
        // Set document properties
        $objPHPExcel->getProperties()
            ->setCreator(get_bloginfo('name'))
            ->setLastModifiedBy(wp_get_current_user()->display_name)
            ->setTitle('Data Export')
            ->setSubject($data_type . ' Export')
            ->setDescription('Exported from WordPress REST API');
        
        // Get data based on type
        $data = $this->get_export_data($data_type, $filters);
        
        // Add data to spreadsheet
        $sheet = $objPHPExcel->setActiveSheetIndex(0);
        $sheet->setTitle(ucfirst($data_type));
        
        // Add headers
        $headers = $this->get_headers($data_type, $columns);
        $col = 0;
        foreach ($headers as $header) {
            $sheet->setCellValueByColumnAndRow($col, 1, $header);
            $sheet->getStyleByColumnAndRow($col, 1)->getFont()->setBold(true);
            $col++;
        }
        
        // Style header row
        $sheet->getStyle('A1:' . $sheet->getHighestColumn() . '1')
            ->getFill()
            ->setFillType(PHPExcel_Style_Fill::FILL_SOLID)
            ->getStartColor()
            ->setRGB('4472C4');
        
        $sheet->getStyle('A1:' . $sheet->getHighestColumn() . '1')
            ->getFont()
            ->getColor()
            ->setRGB('FFFFFF');
        
        // Add data rows
        $row = 2;
        foreach ($data as $item) {
            $col = 0;
            foreach ($headers as $key => $header) {
                $value = $this->get_cell_value($item, $key);
                $sheet->setCellValueByColumnAndRow($col, $row, $value);
                
                // Auto-detect data type
                if (is_numeric($value)) {
                    $sheet->getStyleByColumnAndRow($col, $row)
                        ->getNumberFormat()
                        ->setFormatCode(PHPExcel_Style_NumberFormat::FORMAT_NUMBER);
                } elseif (strtotime($value)) {
                    $sheet->getStyleByColumnAndRow($col, $row)
                        ->getNumberFormat()
                        ->setFormatCode(PHPExcel_Style_NumberFormat::FORMAT_DATE_DATETIME);
                }
                
                $col++;
            }
            $row++;
        }
        
        // Auto-size columns
        foreach (range(0, $col - 1) as $col) {
            $sheet->getColumnDimensionByColumn($col)->setAutoSize(true);
        }
        
        // Add filters
        $sheet->setAutoFilter('A1:' . $sheet->getHighestColumn() . '1');
        
        // Create chart if numeric data exists
        if ($this->has_numeric_data($data)) {
            $this->add_chart($objPHPExcel, $data, $headers);
        }
        
        // Add summary sheet
        $this->add_summary_sheet($objPHPExcel, $data, $data_type);
        
        // Save Excel file
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment;filename="export_' . date('Y-m-d_H-i-s') . '.xlsx"');
        header('Cache-Control: max-age=0');
        
        $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');
        $objWriter->save('php://output');
        exit;
    }
    
    /**
     * Get export data
     */
    private function get_export_data($type, $filters) {
        switch ($type) {
            case 'posts':
                return $this->get_posts_data($filters);
                
            case 'users':
                return $this->get_users_data($filters);
                
            case 'orders':
                return $this->get_orders_data($filters);
                
            case 'custom':
                return apply_filters('excel_export_custom_data', [], $filters);
                
            default:
                return [];
        }
    }
    
    /**
     * Get posts data for export
     */
    private function get_posts_data($filters) {
        $args = [
            'posts_per_page' => -1,
            'post_status' => $filters['status'] ?? 'publish',
            'post_type' => $filters['post_type'] ?? 'post',
        ];
        
        if (isset($filters['date_from'])) {
            $args['date_query'] = [
                ['after' => $filters['date_from']],
            ];
        }
        
        $posts = get_posts($args);
        $data = [];
        
        foreach ($posts as $post) {
            $data[] = [
                'ID' => $post->ID,
                'Title' => $post->post_title,
                'Author' => get_the_author_meta('display_name', $post->post_author),
                'Date' => $post->post_date,
                'Status' => $post->post_status,
                'Categories' => implode(', ', wp_get_post_categories($post->ID, ['fields' => 'names'])),
                'Tags' => implode(', ', wp_get_post_tags($post->ID, ['fields' => 'names'])),
                'Comments' => $post->comment_count,
                'Views' => get_post_meta($post->ID, '_post_views', true) ?: 0,
            ];
        }
        
        return $data;
    }
    
    /**
     * Add summary sheet
     */
    private function add_summary_sheet($objPHPExcel, $data, $type) {
        $sheet = $objPHPExcel->createSheet();
        $sheet->setTitle('Summary');
        
        $sheet->setCellValue('A1', 'Export Summary');
        $sheet->getStyle('A1')->getFont()->setBold(true)->setSize(16);
        
        $sheet->setCellValue('A3', 'Export Type:');
        $sheet->setCellValue('B3', ucfirst($type));
        
        $sheet->setCellValue('A4', 'Total Records:');
        $sheet->setCellValue('B4', count($data));
        
        $sheet->setCellValue('A5', 'Export Date:');
        $sheet->setCellValue('B5', date('Y-m-d H:i:s'));
        
        $sheet->setCellValue('A6', 'Exported By:');
        $sheet->setCellValue('B6', wp_get_current_user()->display_name);
        
        // Add statistics
        if (!empty($data)) {
            $sheet->setCellValue('A8', 'Statistics');
            $sheet->getStyle('A8')->getFont()->setBold(true);
            
            $row = 9;
            foreach (array_keys(reset($data)) as $key) {
                if (is_numeric(reset($data)[$key])) {
                    $values = array_column($data, $key);
                    $sheet->setCellValue('A' . $row, $key . ' (Average):');
                    $sheet->setCellValue('B' . $row, array_sum($values) / count($values));
                    $row++;
                }
            }
        }
    }
}

new Excel_Export_Handler();
                        </code></pre>
                    </section>
                    
                    <!-- Custom Format Transformers -->
                    <section>
                        <h2>Custom Format Transformers</h2>
                        
                        <h3>Transform Data for Different Formats</h3>
                        <pre><code class="language-php">
/**
 * Custom data transformers for different formats
 */
class Data_Format_Transformer {
    
    /**
     * Transform data for GraphQL-like response
     */
    public function transform_graphql_format($data, $fields = []) {
        $response = [
            'data' => null,
            'errors' => [],
        ];
        
        if (is_wp_error($data)) {
            $response['errors'][] = [
                'message' => $data->get_error_message(),
                'code' => $data->get_error_code(),
            ];
        } else {
            $response['data'] = $this->filter_fields($data, $fields);
        }
        
        return $response;
    }
    
    /**
     * Transform data for HAL format
     */
    public function transform_hal_format($data, $request) {
        $hal = [];
        
        if (is_array($data) && isset($data[0])) {
            // Collection
            $hal['_embedded'] = [
                'items' => array_map(function($item) use ($request) {
                    return $this->add_hal_links($item, $request);
                }, $data),
            ];
            
            $hal['_links'] = [
                'self' => ['href' => $request->get_route()],
                'first' => ['href' => add_query_arg('page', 1, $request->get_route())],
            ];
        } else {
            // Single resource
            $hal = $this->add_hal_links($data, $request);
        }
        
        return $hal;
    }
    
    /**
     * Add HAL links to resource
     */
    private function add_hal_links($resource, $request) {
        if (!is_array($resource)) {
            return $resource;
        }
        
        $resource['_links'] = [
            'self' => [
                'href' => $request->get_route() . '/' . ($resource['id'] ?? ''),
            ],
            'collection' => [
                'href' => $request->get_route(),
            ],
        ];
        
        // Add related links
        if (isset($resource['author'])) {
            $resource['_links']['author'] = [
                'href' => '/wp/v2/users/' . $resource['author'],
            ];
        }
        
        return $resource;
    }
    
    /**
     * Transform data for JSON-LD format
     */
    public function transform_jsonld_format($data, $type = 'Article') {
        $context = 'https://schema.org';
        
        if (is_array($data) && isset($data[0])) {
            // Collection
            return [
                '@context' => $context,
                '@type' => 'ItemList',
                'numberOfItems' => count($data),
                'itemListElement' => array_map(function($item, $index) use ($type) {
                    return [
                        '@type' => 'ListItem',
                        'position' => $index + 1,
                        'item' => $this->create_jsonld_item($item, $type),
                    ];
                }, $data, array_keys($data)),
            ];
        } else {
            // Single item
            return $this->create_jsonld_item($data, $type);
        }
    }
    
    /**
     * Create JSON-LD item
     */
    private function create_jsonld_item($item, $type) {
        $jsonld = [
            '@context' => 'https://schema.org',
            '@type' => $type,
        ];
        
        // Map WordPress fields to Schema.org properties
        $mappings = [
            'title' => 'headline',
            'content' => 'articleBody',
            'excerpt' => 'description',
            'date' => 'datePublished',
            'modified' => 'dateModified',
            'author' => 'author',
        ];
        
        foreach ($mappings as $wp_field => $schema_field) {
            if (isset($item[$wp_field])) {
                $jsonld[$schema_field] = $item[$wp_field];
            }
        }
        
        // Add additional Schema.org properties
        if (isset($item['id'])) {
            $jsonld['@id'] = get_permalink($item['id']);
            $jsonld['url'] = get_permalink($item['id']);
        }
        
        if (isset($item['featured_media'])) {
            $jsonld['image'] = wp_get_attachment_url($item['featured_media']);
        }
        
        return $jsonld;
    }
    
    /**
     * Transform data for RSS/Atom feed
     */
    public function transform_feed_format($data, $format = 'rss2') {
        header('Content-Type: application/rss+xml; charset=UTF-8');
        
        if ($format === 'atom') {
            echo $this->generate_atom_feed($data);
        } else {
            echo $this->generate_rss_feed($data);
        }
        
        exit;
    }
    
    /**
     * Generate RSS feed
     */
    private function generate_rss_feed($data) {
        $xml = '<?xml version="1.0" encoding="UTF-8"?>';
        $xml .= '<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">';
        $xml .= '<channel>';
        $xml .= '<title>' . get_bloginfo('name') . '</title>';
        $xml .= '<link>' . get_bloginfo('url') . '</link>';
        $xml .= '<description>' . get_bloginfo('description') . '</description>';
        $xml .= '<language>' . get_bloginfo('language') . '</language>';
        $xml .= '<lastBuildDate>' . date('r') . '</lastBuildDate>';
        
        foreach ($data as $item) {
            $xml .= '<item>';
            $xml .= '<title>' . htmlspecialchars($item['title'] ?? '') . '</title>';
            $xml .= '<link>' . get_permalink($item['id'] ?? 0) . '</link>';
            $xml .= '<description>' . htmlspecialchars($item['excerpt'] ?? '') . '</description>';
            $xml .= '<content:encoded><![CDATA[' . ($item['content'] ?? '') . ']]></content:encoded>';
            $xml .= '<pubDate>' . date('r', strtotime($item['date'] ?? 'now')) . '</pubDate>';
            $xml .= '<guid>' . get_permalink($item['id'] ?? 0) . '</guid>';
            $xml .= '</item>';
        }
        
        $xml .= '</channel>';
        $xml .= '</rss>';
        
        return $xml;
    }
}

// Usage in endpoint
add_action('rest_api_init', function() {
    register_rest_route('custom/v1', '/posts', [
        'methods' => 'GET',
        'callback' => function($request) {
            $posts = get_posts(['posts_per_page' => 10]);
            
            $transformer = new Data_Format_Transformer();
            $format = $request->get_param('format') ?: 'json';
            
            switch ($format) {
                case 'graphql':
                    return $transformer->transform_graphql_format($posts);
                    
                case 'hal':
                    return $transformer->transform_hal_format($posts, $request);
                    
                case 'jsonld':
                    return $transformer->transform_jsonld_format($posts);
                    
                case 'rss':
                    return $transformer->transform_feed_format($posts, 'rss2');
                    
                default:
                    return $posts;
            }
        },
        'permission_callback' => '__return_true',
    ]);
});
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>REST APIs can serve multiple response formats</li>
                                <li>Content negotiation allows dynamic format selection</li>
                                <li>PDF generation enables document exports</li>
                                <li>Excel exports provide data analysis capabilities</li>
                                <li>Custom transformers adapt data for specific needs</li>
                                <li>Format flexibility improves API usability</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Response Format Best Practices</h3>
                            <ul>
                                <li>Support content negotiation via headers</li>
                                <li>Use appropriate MIME types</li>
                                <li>Handle errors consistently across formats</li>
                                <li>Optimize large data exports</li>
                                <li>Cache generated files when possible</li>
                                <li>Document available formats</li>
                                <li>Consider performance implications</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://www.tcpdf.org/" target="_blank">TCPDF Documentation</a></li>
                            <li><a href="https://phpspreadsheet.readthedocs.io/" target="_blank">PHPSpreadsheet Documentation</a></li>
                            <li><a href="https://jsonld.com/" target="_blank">JSON-LD Documentation</a></li>
                            <li><a href="https://stateless.group/hal_specification.html" target="_blank">HAL Specification</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/field_registration_visibility.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            Field Registration
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/rest_api_javascript.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            REST API with JavaScript
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>