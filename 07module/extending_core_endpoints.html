<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>Extending Core REST API Endpoints - PHP WordPress Course</title>
    <meta name="description" content="Learn to extend WordPress core REST API endpoints. Add custom fields, modify responses, and enhance existing endpoints.">
    <meta name="keywords" content="WordPress, REST API, extending endpoints, custom fields, API modification">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Extending Core REST API Endpoints">
    <meta property="og:description" content="Enhance WordPress core endpoints with custom functionality">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Extending Core Endpoints</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">Extending Core REST API Endpoints</h1>
                    <p class="lesson-subtitle">Enhance existing WordPress endpoints without modifying core</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Add custom fields to core endpoints</li>
                        <li>Modify response data dynamically</li>
                        <li>Add custom parameters to existing endpoints</li>
                        <li>Filter and modify core endpoint behavior</li>
                        <li>Extend post, user, and taxonomy endpoints</li>
                        <li>Implement conditional field visibility</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Adding Custom Fields -->
                    <section>
                        <h2>Adding Custom Fields to Core Endpoints</h2>
                        
                        <h3>Register REST Fields</h3>
                        <pre><code class="language-php">
/**
 * Extending core endpoints with custom fields
 */
class Core_Endpoints_Extension {
    
    public function __construct() {
        add_action('rest_api_init', [$this, 'register_custom_fields']);
    }
    
    /**
     * Register custom fields for core endpoints
     */
    public function register_custom_fields() {
        // Add custom field to posts endpoint
        register_rest_field('post', 'custom_meta', [
            'get_callback' => [$this, 'get_post_meta_field'],
            'update_callback' => [$this, 'update_post_meta_field'],
            'schema' => [
                'description' => 'Custom meta field for posts',
                'type' => 'object',
                'context' => ['view', 'edit'],
                'properties' => [
                    'views' => [
                        'type' => 'integer',
                        'description' => 'Number of post views',
                    ],
                    'likes' => [
                        'type' => 'integer',
                        'description' => 'Number of likes',
                    ],
                    'featured' => [
                        'type' => 'boolean',
                        'description' => 'Is this a featured post',
                    ],
                ],
            ],
        ]);
        
        // Add calculated field to posts
        register_rest_field('post', 'reading_time', [
            'get_callback' => [$this, 'calculate_reading_time'],
            'schema' => [
                'description' => 'Estimated reading time in minutes',
                'type' => 'integer',
                'context' => ['view', 'embed'],
            ],
        ]);
        
        // Add author details to posts
        register_rest_field('post', 'author_details', [
            'get_callback' => [$this, 'get_author_details'],
            'schema' => [
                'description' => 'Detailed author information',
                'type' => 'object',
                'context' => ['view', 'embed'],
                'properties' => [
                    'name' => ['type' => 'string'],
                    'avatar' => ['type' => 'string', 'format' => 'uri'],
                    'bio' => ['type' => 'string'],
                    'social' => ['type' => 'object'],
                ],
            ],
        ]);
        
        // Add custom fields to pages
        register_rest_field('page', 'page_settings', [
            'get_callback' => [$this, 'get_page_settings'],
            'update_callback' => [$this, 'update_page_settings'],
            'schema' => [
                'description' => 'Page-specific settings',
                'type' => 'object',
                'context' => ['view', 'edit'],
                'properties' => [
                    'layout' => [
                        'type' => 'string',
                        'enum' => ['default', 'full-width', 'sidebar-left', 'sidebar-right'],
                    ],
                    'hero_image' => ['type' => 'integer'],
                    'custom_css' => ['type' => 'string'],
                    'custom_js' => ['type' => 'string'],
                ],
            ],
        ]);
        
        // Add fields to users endpoint
        register_rest_field('user', 'profile', [
            'get_callback' => [$this, 'get_user_profile'],
            'update_callback' => [$this, 'update_user_profile'],
            'schema' => [
                'description' => 'Extended user profile',
                'type' => 'object',
                'context' => ['view', 'edit'],
                'properties' => [
                    'phone' => ['type' => 'string'],
                    'company' => ['type' => 'string'],
                    'position' => ['type' => 'string'],
                    'social_links' => [
                        'type' => 'object',
                        'properties' => [
                            'twitter' => ['type' => 'string', 'format' => 'uri'],
                            'linkedin' => ['type' => 'string', 'format' => 'uri'],
                            'github' => ['type' => 'string', 'format' => 'uri'],
                        ],
                    ],
                ],
            ],
        ]);
        
        // Add fields to categories
        register_rest_field('category', 'meta', [
            'get_callback' => [$this, 'get_category_meta'],
            'update_callback' => [$this, 'update_category_meta'],
            'schema' => [
                'description' => 'Category metadata',
                'type' => 'object',
                'context' => ['view', 'edit'],
                'properties' => [
                    'color' => ['type' => 'string'],
                    'icon' => ['type' => 'string'],
                    'featured_image' => ['type' => 'integer'],
                ],
            ],
        ]);
        
        // Add fields to comments
        register_rest_field('comment', 'ratings', [
            'get_callback' => [$this, 'get_comment_ratings'],
            'update_callback' => [$this, 'update_comment_ratings'],
            'schema' => [
                'description' => 'Comment ratings',
                'type' => 'object',
                'context' => ['view', 'edit'],
                'properties' => [
                    'helpful' => ['type' => 'integer'],
                    'not_helpful' => ['type' => 'integer'],
                    'user_vote' => ['type' => 'string', 'enum' => ['helpful', 'not_helpful', null]],
                ],
            ],
        ]);
    }
    
    /**
     * Callback functions for custom fields
     */
    public function get_post_meta_field($post, $field_name, $request) {
        return [
            'views' => (int) get_post_meta($post['id'], '_post_views', true),
            'likes' => (int) get_post_meta($post['id'], '_post_likes', true),
            'featured' => get_post_meta($post['id'], '_is_featured', true) === 'yes',
        ];
    }
    
    public function update_post_meta_field($value, $post, $field_name) {
        if (isset($value['views'])) {
            update_post_meta($post->ID, '_post_views', (int) $value['views']);
        }
        
        if (isset($value['likes'])) {
            update_post_meta($post->ID, '_post_likes', (int) $value['likes']);
        }
        
        if (isset($value['featured'])) {
            update_post_meta($post->ID, '_is_featured', $value['featured'] ? 'yes' : 'no');
        }
        
        return true;
    }
    
    public function calculate_reading_time($post) {
        $content = get_post_field('post_content', $post['id']);
        $word_count = str_word_count(strip_tags($content));
        $reading_speed = 200; // Average words per minute
        
        return ceil($word_count / $reading_speed);
    }
    
    public function get_author_details($post) {
        $author_id = $post['author'];
        $author = get_user_by('id', $author_id);
        
        if (!$author) {
            return null;
        }
        
        return [
            'name' => $author->display_name,
            'avatar' => get_avatar_url($author_id),
            'bio' => get_the_author_meta('description', $author_id),
            'social' => [
                'twitter' => get_user_meta($author_id, 'twitter', true),
                'website' => $author->user_url,
            ],
        ];
    }
    
    public function get_page_settings($page) {
        return [
            'layout' => get_post_meta($page['id'], '_page_layout', true) ?: 'default',
            'hero_image' => (int) get_post_meta($page['id'], '_hero_image_id', true),
            'custom_css' => get_post_meta($page['id'], '_custom_css', true),
            'custom_js' => get_post_meta($page['id'], '_custom_js', true),
        ];
    }
    
    public function update_page_settings($value, $page) {
        $allowed_layouts = ['default', 'full-width', 'sidebar-left', 'sidebar-right'];
        
        if (isset($value['layout']) && in_array($value['layout'], $allowed_layouts)) {
            update_post_meta($page->ID, '_page_layout', $value['layout']);
        }
        
        if (isset($value['hero_image'])) {
            update_post_meta($page->ID, '_hero_image_id', (int) $value['hero_image']);
        }
        
        if (isset($value['custom_css'])) {
            update_post_meta($page->ID, '_custom_css', sanitize_text_field($value['custom_css']));
        }
        
        if (isset($value['custom_js'])) {
            update_post_meta($page->ID, '_custom_js', sanitize_text_field($value['custom_js']));
        }
        
        return true;
    }
    
    public function get_user_profile($user) {
        return [
            'phone' => get_user_meta($user['id'], 'phone', true),
            'company' => get_user_meta($user['id'], 'company', true),
            'position' => get_user_meta($user['id'], 'position', true),
            'social_links' => [
                'twitter' => get_user_meta($user['id'], 'twitter', true),
                'linkedin' => get_user_meta($user['id'], 'linkedin', true),
                'github' => get_user_meta($user['id'], 'github', true),
            ],
        ];
    }
    
    public function update_user_profile($value, $user) {
        if (isset($value['phone'])) {
            update_user_meta($user->ID, 'phone', sanitize_text_field($value['phone']));
        }
        
        if (isset($value['company'])) {
            update_user_meta($user->ID, 'company', sanitize_text_field($value['company']));
        }
        
        if (isset($value['position'])) {
            update_user_meta($user->ID, 'position', sanitize_text_field($value['position']));
        }
        
        if (isset($value['social_links'])) {
            foreach ($value['social_links'] as $platform => $url) {
                update_user_meta($user->ID, $platform, esc_url_raw($url));
            }
        }
        
        return true;
    }
}

new Core_Endpoints_Extension();
                        </code></pre>
                    </section>
                    
                    <!-- Modifying Response Data -->
                    <section>
                        <h2>Modifying Response Data</h2>
                        
                        <h3>Filter Response Data</h3>
                        <pre><code class="language-php">
/**
 * Modify core endpoint responses
 */
class Response_Modifier {
    
    public function __construct() {
        // Filter post responses
        add_filter('rest_prepare_post', [$this, 'modify_post_response'], 10, 3);
        
        // Filter user responses
        add_filter('rest_prepare_user', [$this, 'modify_user_response'], 10, 3);
        
        // Filter comment responses
        add_filter('rest_prepare_comment', [$this, 'modify_comment_response'], 10, 3);
        
        // Filter taxonomy responses
        add_filter('rest_prepare_category', [$this, 'modify_category_response'], 10, 3);
        add_filter('rest_prepare_post_tag', [$this, 'modify_tag_response'], 10, 3);
        
        // Filter attachment responses
        add_filter('rest_prepare_attachment', [$this, 'modify_attachment_response'], 10, 3);
    }
    
    /**
     * Modify post response
     */
    public function modify_post_response($response, $post, $request) {
        $data = $response->get_data();
        
        // Add custom data
        $data['custom_data'] = [
            'word_count' => str_word_count(strip_tags($post->post_content)),
            'has_featured_image' => has_post_thumbnail($post->ID),
            'comment_status_text' => $post->comment_status === 'open' ? 'Comments are open' : 'Comments are closed',
            'is_sticky' => is_sticky($post->ID),
        ];
        
        // Add related posts
        if ($request->get_param('include_related')) {
            $data['related_posts'] = $this->get_related_posts($post->ID);
        }
        
        // Add post format
        $data['format'] = get_post_format($post->ID) ?: 'standard';
        
        // Add custom taxonomies
        $taxonomies = get_object_taxonomies($post->post_type);
        foreach ($taxonomies as $taxonomy) {
            if (!in_array($taxonomy, ['category', 'post_tag'])) {
                $terms = wp_get_post_terms($post->ID, $taxonomy, ['fields' => 'all']);
                $data['taxonomies'][$taxonomy] = array_map(function($term) {
                    return [
                        'id' => $term->term_id,
                        'name' => $term->name,
                        'slug' => $term->slug,
                    ];
                }, $terms);
            }
        }
        
        // Conditionally remove data
        if (!current_user_can('edit_post', $post->ID)) {
            unset($data['guid']);
            unset($data['modified_gmt']);
        }
        
        // Modify existing fields
        if (isset($data['title'])) {
            $data['title']['word_count'] = str_word_count($data['title']['rendered']);
        }
        
        // Add breadcrumbs for hierarchical posts
        if ($post->post_parent) {
            $data['breadcrumbs'] = $this->get_post_breadcrumbs($post->ID);
        }
        
        $response->set_data($data);
        
        // Add custom headers
        $response->header('X-Post-Views', get_post_meta($post->ID, '_post_views', true) ?: 0);
        $response->header('X-Last-Modified', $post->post_modified);
        
        return $response;
    }
    
    /**
     * Modify user response
     */
    public function modify_user_response($response, $user, $request) {
        $data = $response->get_data();
        
        // Add user statistics
        $data['stats'] = [
            'post_count' => count_user_posts($user->ID),
            'comment_count' => get_comments([
                'user_id' => $user->ID,
                'count' => true,
            ]),
            'registration_days' => floor((time() - strtotime($user->user_registered)) / DAY_IN_SECONDS),
        ];
        
        // Add user roles with capabilities
        $data['roles_details'] = [];
        foreach ($user->roles as $role) {
            $role_obj = get_role($role);
            $data['roles_details'][] = [
                'name' => $role,
                'capabilities' => array_keys(array_filter($role_obj->capabilities)),
            ];
        }
        
        // Add recent activity
        if ($request->get_param('include_activity')) {
            $data['recent_posts'] = get_posts([
                'author' => $user->ID,
                'posts_per_page' => 5,
                'fields' => 'ids',
            ]);
            
            $data['recent_comments'] = get_comments([
                'user_id' => $user->ID,
                'number' => 5,
                'fields' => 'ids',
            ]);
        }
        
        // Hide sensitive data for non-admins
        if (!current_user_can('list_users')) {
            unset($data['email']);
            unset($data['registered_date']);
            unset($data['capabilities']);
        }
        
        $response->set_data($data);
        
        return $response;
    }
    
    /**
     * Modify comment response
     */
    public function modify_comment_response($response, $comment, $request) {
        $data = $response->get_data();
        
        // Add nested replies
        if ($request->get_param('include_replies')) {
            $data['replies'] = $this->get_comment_replies($comment->comment_ID);
        }
        
        // Add author avatar
        $data['author_avatar'] = get_avatar_url($comment->comment_author_email);
        
        // Add moderation status
        $data['moderation'] = [
            'is_approved' => $comment->comment_approved == '1',
            'is_spam' => $comment->comment_approved == 'spam',
            'is_trash' => $comment->comment_approved == 'trash',
        ];
        
        // Add parent comment excerpt if reply
        if ($comment->comment_parent) {
            $parent = get_comment($comment->comment_parent);
            if ($parent) {
                $data['parent_excerpt'] = wp_trim_words($parent->comment_content, 20);
            }
        }
        
        $response->set_data($data);
        
        return $response;
    }
    
    /**
     * Modify category response
     */
    public function modify_category_response($response, $term, $request) {
        $data = $response->get_data();
        
        // Add post count by post type
        $data['post_counts'] = [];
        $post_types = get_post_types(['public' => true]);
        
        foreach ($post_types as $post_type) {
            $count = get_posts([
                'post_type' => $post_type,
                'tax_query' => [
                    [
                        'taxonomy' => 'category',
                        'field' => 'term_id',
                        'terms' => $term->term_id,
                    ],
                ],
                'posts_per_page' => -1,
                'fields' => 'ids',
            ]);
            
            $data['post_counts'][$post_type] = count($count);
        }
        
        // Add children categories
        $data['children'] = get_term_children($term->term_id, 'category');
        
        // Add category image if exists
        $image_id = get_term_meta($term->term_id, 'category_image', true);
        if ($image_id) {
            $data['image'] = [
                'id' => $image_id,
                'url' => wp_get_attachment_url($image_id),
            ];
        }
        
        $response->set_data($data);
        
        return $response;
    }
    
    /**
     * Helper methods
     */
    private function get_related_posts($post_id, $limit = 3) {
        $categories = wp_get_post_categories($post_id, ['fields' => 'ids']);
        
        if (empty($categories)) {
            return [];
        }
        
        $related = get_posts([
            'category__in' => $categories,
            'posts_per_page' => $limit,
            'post__not_in' => [$post_id],
            'orderby' => 'rand',
        ]);
        
        return array_map(function($post) {
            return [
                'id' => $post->ID,
                'title' => $post->post_title,
                'url' => get_permalink($post->ID),
            ];
        }, $related);
    }
    
    private function get_post_breadcrumbs($post_id) {
        $breadcrumbs = [];
        $current_id = $post_id;
        
        while ($current_id) {
            $post = get_post($current_id);
            array_unshift($breadcrumbs, [
                'id' => $post->ID,
                'title' => $post->post_title,
                'url' => get_permalink($post->ID),
            ]);
            $current_id = $post->post_parent;
        }
        
        return $breadcrumbs;
    }
    
    private function get_comment_replies($comment_id) {
        $replies = get_comments([
            'parent' => $comment_id,
            'status' => 'approve',
        ]);
        
        return array_map(function($reply) {
            return [
                'id' => $reply->comment_ID,
                'author' => $reply->comment_author,
                'content' => $reply->comment_content,
                'date' => $reply->comment_date,
            ];
        }, $replies);
    }
}

new Response_Modifier();
                        </code></pre>
                    </section>
                    
                    <!-- Adding Custom Parameters -->
                    <section>
                        <h2>Adding Custom Parameters</h2>
                        
                        <h3>Extend Query Parameters</h3>
                        <pre><code class="language-php">
/**
 * Add custom parameters to core endpoints
 */
class Custom_Parameters {
    
    public function __construct() {
        add_filter('rest_post_collection_params', [$this, 'add_post_params'], 10, 2);
        add_filter('rest_post_query', [$this, 'filter_post_query'], 10, 2);
        
        add_filter('rest_user_collection_params', [$this, 'add_user_params'], 10, 2);
        add_filter('rest_user_query', [$this, 'filter_user_query'], 10, 2);
        
        add_filter('rest_comment_collection_params', [$this, 'add_comment_params'], 10, 2);
        add_filter('rest_comment_query', [$this, 'filter_comment_query'], 10, 2);
    }
    
    /**
     * Add custom parameters to posts endpoint
     */
    public function add_post_params($params, $post_type) {
        // Add meta query parameters
        $params['meta_key'] = [
            'description' => 'Meta key for meta query',
            'type' => 'string',
            'sanitize_callback' => 'sanitize_text_field',
        ];
        
        $params['meta_value'] = [
            'description' => 'Meta value for meta query',
            'type' => 'string',
            'sanitize_callback' => 'sanitize_text_field',
        ];
        
        $params['meta_compare'] = [
            'description' => 'Comparison operator for meta query',
            'type' => 'string',
            'enum' => ['=', '!=', '>', '>=', '<', '<=', 'LIKE', 'NOT LIKE', 'IN', 'NOT IN', 'BETWEEN', 'NOT BETWEEN', 'EXISTS', 'NOT EXISTS'],
            'default' => '=',
        ];
        
        // Add custom filters
        $params['featured'] = [
            'description' => 'Filter by featured status',
            'type' => 'boolean',
        ];
        
        $params['has_thumbnail'] = [
            'description' => 'Filter posts with featured images',
            'type' => 'boolean',
        ];
        
        $params['word_count_min'] = [
            'description' => 'Minimum word count',
            'type' => 'integer',
            'minimum' => 0,
        ];
        
        $params['word_count_max'] = [
            'description' => 'Maximum word count',
            'type' => 'integer',
            'minimum' => 0,
        ];
        
        // Add date range parameters
        $params['date_from'] = [
            'description' => 'Posts published after this date',
            'type' => 'string',
            'format' => 'date',
        ];
        
        $params['date_to'] = [
            'description' => 'Posts published before this date',
            'type' => 'string',
            'format' => 'date',
        ];
        
        // Add related fields parameter
        $params['include_related'] = [
            'description' => 'Include related posts in response',
            'type' => 'boolean',
            'default' => false,
        ];
        
        // Add custom orderby options
        $params['orderby']['enum'][] = 'popularity';
        $params['orderby']['enum'][] = 'word_count';
        $params['orderby']['enum'][] = 'comment_count';
        
        return $params;
    }
    
    /**
     * Filter post query based on custom parameters
     */
    public function filter_post_query($args, $request) {
        // Handle meta query
        if ($request->get_param('meta_key') && $request->get_param('meta_value')) {
            $args['meta_query'] = [
                [
                    'key' => $request->get_param('meta_key'),
                    'value' => $request->get_param('meta_value'),
                    'compare' => $request->get_param('meta_compare') ?: '=',
                ],
            ];
        }
        
        // Filter featured posts
        if ($request->get_param('featured') !== null) {
            $args['meta_query'][] = [
                'key' => '_is_featured',
                'value' => $request->get_param('featured') ? 'yes' : 'no',
            ];
        }
        
        // Filter posts with thumbnails
        if ($request->get_param('has_thumbnail')) {
            $args['meta_query'][] = [
                'key' => '_thumbnail_id',
                'compare' => 'EXISTS',
            ];
        }
        
        // Date range filter
        if ($request->get_param('date_from') || $request->get_param('date_to')) {
            $date_query = [];
            
            if ($request->get_param('date_from')) {
                $date_query['after'] = $request->get_param('date_from');
            }
            
            if ($request->get_param('date_to')) {
                $date_query['before'] = $request->get_param('date_to');
            }
            
            $args['date_query'] = [$date_query];
        }
        
        // Custom orderby
        $orderby = $request->get_param('orderby');
        
        if ($orderby === 'popularity') {
            $args['meta_key'] = '_post_views';
            $args['orderby'] = 'meta_value_num';
        } elseif ($orderby === 'word_count') {
            $args['meta_key'] = '_word_count';
            $args['orderby'] = 'meta_value_num';
        } elseif ($orderby === 'comment_count') {
            $args['orderby'] = 'comment_count';
        }
        
        // Word count filter (requires preprocessing)
        if ($request->get_param('word_count_min') || $request->get_param('word_count_max')) {
            add_filter('posts_where', function($where) use ($request) {
                global $wpdb;
                
                if ($min = $request->get_param('word_count_min')) {
                    $where .= $wpdb->prepare(
                        " AND CHAR_LENGTH({$wpdb->posts}.post_content) - CHAR_LENGTH(REPLACE({$wpdb->posts}.post_content, ' ', '')) + 1 >= %d",
                        $min
                    );
                }
                
                if ($max = $request->get_param('word_count_max')) {
                    $where .= $wpdb->prepare(
                        " AND CHAR_LENGTH({$wpdb->posts}.post_content) - CHAR_LENGTH(REPLACE({$wpdb->posts}.post_content, ' ', '')) + 1 <= %d",
                        $max
                    );
                }
                
                return $where;
            });
        }
        
        return $args;
    }
    
    /**
     * Add custom parameters to users endpoint
     */
    public function add_user_params($params) {
        $params['role_in'] = [
            'description' => 'Filter users by multiple roles',
            'type' => 'array',
            'items' => [
                'type' => 'string',
            ],
        ];
        
        $params['has_posts'] = [
            'description' => 'Filter users who have published posts',
            'type' => 'boolean',
        ];
        
        $params['registration_after'] = [
            'description' => 'Users registered after this date',
            'type' => 'string',
            'format' => 'date',
        ];
        
        $params['registration_before'] = [
            'description' => 'Users registered before this date',
            'type' => 'string',
            'format' => 'date',
        ];
        
        $params['include_activity'] = [
            'description' => 'Include user activity in response',
            'type' => 'boolean',
            'default' => false,
        ];
        
        return $params;
    }
    
    /**
     * Filter user query based on custom parameters
     */
    public function filter_user_query($prepared_args, $request) {
        // Filter by multiple roles
        if ($roles = $request->get_param('role_in')) {
            $prepared_args['role__in'] = $roles;
        }
        
        // Filter users with posts
        if ($request->get_param('has_posts')) {
            $prepared_args['has_published_posts'] = true;
        }
        
        // Registration date filters
        if ($after = $request->get_param('registration_after')) {
            $prepared_args['date_query'][] = [
                'after' => $after,
                'column' => 'user_registered',
            ];
        }
        
        if ($before = $request->get_param('registration_before')) {
            $prepared_args['date_query'][] = [
                'before' => $before,
                'column' => 'user_registered',
            ];
        }
        
        return $prepared_args;
    }
}

new Custom_Parameters();
                        </code></pre>
                    </section>
                    
                    <!-- Conditional Field Visibility -->
                    <section>
                        <h2>Conditional Field Visibility</h2>
                        
                        <h3>Context-Based Field Display</h3>
                        <pre><code class="language-php">
/**
 * Implement conditional field visibility
 */
class Conditional_Fields {
    
    public function __construct() {
        add_action('rest_api_init', [$this, 'register_conditional_fields']);
    }
    
    /**
     * Register fields with conditional visibility
     */
    public function register_conditional_fields() {
        // Private data only for authenticated users
        register_rest_field('post', 'private_data', [
            'get_callback' => function($post, $field_name, $request) {
                // Only show for authenticated users
                if (!is_user_logged_in()) {
                    return null;
                }
                
                return [
                    'internal_notes' => get_post_meta($post['id'], '_internal_notes', true),
                    'edit_count' => get_post_meta($post['id'], '_edit_count', true),
                    'last_editor' => get_post_meta($post['id'], '_last_editor_id', true),
                ];
            },
            'schema' => [
                'description' => 'Private post data',
                'type' => ['object', 'null'],
                'context' => ['view', 'edit'],
                'properties' => [
                    'internal_notes' => ['type' => 'string'],
                    'edit_count' => ['type' => 'integer'],
                    'last_editor' => ['type' => 'integer'],
                ],
            ],
        ]);
        
        // Admin-only fields
        register_rest_field('post', 'admin_data', [
            'get_callback' => function($post, $field_name, $request) {
                // Only show for administrators
                if (!current_user_can('manage_options')) {
                    return null;
                }
                
                return [
                    'revenue' => get_post_meta($post['id'], '_revenue', true),
                    'cost' => get_post_meta($post['id'], '_cost', true),
                    'profit' => get_post_meta($post['id'], '_profit', true),
                    'analytics' => [
                        'impressions' => get_post_meta($post['id'], '_impressions', true),
                        'conversions' => get_post_meta($post['id'], '_conversions', true),
                    ],
                ];
            },
            'schema' => [
                'description' => 'Administrative data',
                'type' => ['object', 'null'],
                'context' => ['edit'],
            ],
        ]);
        
        // Context-dependent fields
        register_rest_field('post', 'context_data', [
            'get_callback' => function($post, $field_name, $request) {
                $context = $request->get_param('context');
                $data = [];
                
                // Always include basic data
                $data['basic'] = [
                    'views' => get_post_meta($post['id'], '_views', true),
                ];
                
                // Add more data in view context
                if ($context === 'view' || $context === 'embed') {
                    $data['extended'] = [
                        'related_count' => $this->get_related_count($post['id']),
                        'comment_sentiment' => $this->analyze_comment_sentiment($post['id']),
                    ];
                }
                
                // Add edit data in edit context
                if ($context === 'edit' && current_user_can('edit_post', $post['id'])) {
                    $data['edit'] = [
                        'lock_status' => wp_check_post_lock($post['id']),
                        'autosave' => wp_get_post_autosave($post['id']),
                        'revisions_count' => wp_get_post_revisions($post['id'], ['fields' => 'ids']),
                    ];
                }
                
                return $data;
            },
            'schema' => [
                'description' => 'Context-dependent data',
                'type' => 'object',
                'context' => ['view', 'edit', 'embed'],
            ],
        ]);
        
        // Role-based user fields
        register_rest_field('user', 'role_specific_data', [
            'get_callback' => function($user, $field_name, $request) {
                $current_user = wp_get_current_user();
                $user_obj = get_user_by('id', $user['id']);
                
                if (!$user_obj) {
                    return null;
                }
                
                $data = [];
                
                // Public data
                $data['public'] = [
                    'display_name' => $user_obj->display_name,
                    'avatar' => get_avatar_url($user['id']),
                ];
                
                // Data visible to the user themselves
                if ($current_user->ID === $user['id']) {
                    $data['private'] = [
                        'email' => $user_obj->user_email,
                        'api_key' => get_user_meta($user['id'], 'api_key', true),
                        'preferences' => get_user_meta($user['id'], 'preferences', true),
                    ];
                }
                
                // Data visible to admins
                if (current_user_can('list_users')) {
                    $data['admin'] = [
                        'last_login' => get_user_meta($user['id'], 'last_login', true),
                        'login_count' => get_user_meta($user['id'], 'login_count', true),
                        'failed_attempts' => get_user_meta($user['id'], 'failed_login_attempts', true),
                    ];
                }
                
                // Data visible to editors
                if (current_user_can('edit_others_posts')) {
                    $data['editor'] = [
                        'posts_in_review' => count(get_posts([
                            'author' => $user['id'],
                            'post_status' => 'pending',
                            'posts_per_page' => -1,
                            'fields' => 'ids',
                        ])),
                    ];
                }
                
                return $data;
            },
            'schema' => [
                'description' => 'Role-specific user data',
                'type' => ['object', 'null'],
                'context' => ['view', 'edit'],
            ],
        ]);
    }
    
    /**
     * Helper methods
     */
    private function get_related_count($post_id) {
        $categories = wp_get_post_categories($post_id, ['fields' => 'ids']);
        
        if (empty($categories)) {
            return 0;
        }
        
        return count(get_posts([
            'category__in' => $categories,
            'post__not_in' => [$post_id],
            'posts_per_page' => -1,
            'fields' => 'ids',
        ]));
    }
    
    private function analyze_comment_sentiment($post_id) {
        $comments = get_comments([
            'post_id' => $post_id,
            'status' => 'approve',
        ]);
        
        $positive = 0;
        $negative = 0;
        $neutral = 0;
        
        // Simple sentiment analysis based on keywords
        $positive_words = ['great', 'excellent', 'love', 'awesome', 'fantastic', 'good'];
        $negative_words = ['bad', 'terrible', 'hate', 'awful', 'poor', 'worst'];
        
        foreach ($comments as $comment) {
            $content = strtolower($comment->comment_content);
            $has_positive = false;
            $has_negative = false;
            
            foreach ($positive_words as $word) {
                if (strpos($content, $word) !== false) {
                    $has_positive = true;
                    break;
                }
            }
            
            foreach ($negative_words as $word) {
                if (strpos($content, $word) !== false) {
                    $has_negative = true;
                    break;
                }
            }
            
            if ($has_positive && !$has_negative) {
                $positive++;
            } elseif ($has_negative && !$has_positive) {
                $negative++;
            } else {
                $neutral++;
            }
        }
        
        return [
            'positive' => $positive,
            'negative' => $negative,
            'neutral' => $neutral,
            'total' => count($comments),
        ];
    }
}

new Conditional_Fields();
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>Core endpoints can be extended without modifying WordPress core</li>
                                <li>Custom fields add functionality to existing endpoints</li>
                                <li>Response filters allow dynamic data modification</li>
                                <li>Custom parameters enhance query capabilities</li>
                                <li>Conditional visibility provides security and optimization</li>
                                <li>Context awareness improves API efficiency</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Extension Best Practices</h3>
                            <ul>
                                <li>Always check permissions before exposing data</li>
                                <li>Use appropriate contexts for field visibility</li>
                                <li>Sanitize and validate custom parameters</li>
                                <li>Cache expensive calculations</li>
                                <li>Document custom fields in schema</li>
                                <li>Consider backwards compatibility</li>
                                <li>Test with different user roles</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://developer.wordpress.org/rest-api/extending-the-rest-api/modifying-responses/" target="_blank">Modifying Responses</a></li>
                            <li><a href="https://developer.wordpress.org/rest-api/extending-the-rest-api/adding-custom-endpoints/#register-rest-field" target="_blank">Register REST Field</a></li>
                            <li><a href="https://developer.wordpress.org/rest-api/extending-the-rest-api/adding-rest-api-support-for-custom-content-types/" target="_blank">REST API Support for Custom Content</a></li>
                            <li><a href="https://developer.wordpress.org/rest-api/using-the-rest-api/global-parameters/" target="_blank">Global Parameters</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/custom_endpoints_controllers.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            Custom Endpoints
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/field_registration_visibility.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            Field Registration
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>