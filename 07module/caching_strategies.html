<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>WordPress Caching Strategies - PHP WordPress Course</title>
    <meta name="description" content="Master advanced caching strategies for WordPress including object caching, page caching, CDN integration, and cache optimization.">
    <meta name="keywords" content="WordPress, caching, Redis, Memcached, CDN, performance">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="WordPress Caching Strategies">
    <meta property="og:description" content="Implement comprehensive caching solutions for WordPress">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Caching Strategies</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">WordPress Caching Strategies</h1>
                    <p class="lesson-subtitle">Implement comprehensive caching solutions for optimal performance</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Implement object caching with Redis/Memcached</li>
                        <li>Configure page caching solutions</li>
                        <li>Set up CDN integration</li>
                        <li>Optimize browser caching</li>
                        <li>Implement fragment caching</li>
                        <li>Create custom caching strategies</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Object Caching with Redis -->
                    <section>
                        <h2>Object Caching with Redis</h2>
                        
                        <h3>Redis Object Cache Implementation</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * Redis Object Cache Drop-in
 * Save as wp-content/object-cache.php
 */

class WP_Redis_Object_Cache {
    
    private $redis;
    private $connected = false;
    private $cache = [];
    private $non_persistent_groups = [];
    private $global_groups = [];
    private $blog_prefix;
    private $multisite = false;
    
    public function __construct() {
        $this->multisite = is_multisite();
        $this->blog_prefix = $this->multisite ? get_current_blog_id() . ':' : '';
        
        // Non-persistent groups (not saved to Redis)
        $this->non_persistent_groups = [
            'comment',
            'counts',
            'plugins'
        ];
        
        // Global groups (shared across sites in multisite)
        $this->global_groups = [
            'users',
            'userlogins',
            'usermeta',
            'user_meta',
            'site-transient',
            'site-options',
            'site-lookup',
            'blog-lookup',
            'blog-details',
            'rss',
            'global-posts',
            'blog-id-cache'
        ];
        
        $this->connect();
    }
    
    /**
     * Connect to Redis
     */
    private function connect() {
        try {
            $this->redis = new Redis();
            
            // Get connection parameters from wp-config.php
            $host = defined('WP_REDIS_HOST') ? WP_REDIS_HOST : '127.0.0.1';
            $port = defined('WP_REDIS_PORT') ? WP_REDIS_PORT : 6379;
            $auth = defined('WP_REDIS_PASSWORD') ? WP_REDIS_PASSWORD : null;
            $database = defined('WP_REDIS_DATABASE') ? WP_REDIS_DATABASE : 0;
            
            // Connect to Redis
            $this->connected = $this->redis->connect($host, $port, 2.5);
            
            if ($this->connected) {
                // Authenticate if password is set
                if ($auth) {
                    $this->redis->auth($auth);
                }
                
                // Select database
                $this->redis->select($database);
                
                // Set serializer
                if (defined('Redis::SERIALIZER_PHP')) {
                    $this->redis->setOption(Redis::OPT_SERIALIZER, Redis::SERIALIZER_PHP);
                }
                
                // Set key prefix
                if (defined('WP_REDIS_PREFIX')) {
                    $this->redis->setOption(Redis::OPT_PREFIX, WP_REDIS_PREFIX);
                }
            }
        } catch (Exception $e) {
            $this->connected = false;
            error_log('Redis connection failed: ' . $e->getMessage());
        }
    }
    
    /**
     * Get cache key
     */
    private function get_key($key, $group = 'default') {
        if (empty($group)) {
            $group = 'default';
        }
        
        // Add blog prefix for non-global groups
        if (!in_array($group, $this->global_groups)) {
            $key = $this->blog_prefix . $key;
        }
        
        return $group . ':' . $key;
    }
    
    /**
     * Get value from cache
     */
    public function get($key, $group = 'default', $force = false, &$found = null) {
        $found = false;
        
        // Check non-persistent cache first
        if (in_array($group, $this->non_persistent_groups)) {
            $cache_key = $this->get_key($key, $group);
            if (isset($this->cache[$cache_key])) {
                $found = true;
                return $this->cache[$cache_key];
            }
            return false;
        }
        
        // Return false if not connected
        if (!$this->connected) {
            return false;
        }
        
        $cache_key = $this->get_key($key, $group);
        
        // Check local cache
        if (!$force && isset($this->cache[$cache_key])) {
            $found = true;
            return $this->cache[$cache_key];
        }
        
        // Get from Redis
        try {
            $value = $this->redis->get($cache_key);
            
            if ($value !== false) {
                $found = true;
                $this->cache[$cache_key] = $value;
                return $value;
            }
        } catch (Exception $e) {
            error_log('Redis get error: ' . $e->getMessage());
        }
        
        return false;
    }
    
    /**
     * Set value in cache
     */
    public function set($key, $value, $group = 'default', $expire = 0) {
        $cache_key = $this->get_key($key, $group);
        
        // Store in local cache
        $this->cache[$cache_key] = $value;
        
        // Non-persistent groups only stored in memory
        if (in_array($group, $this->non_persistent_groups)) {
            return true;
        }
        
        // Return false if not connected
        if (!$this->connected) {
            return false;
        }
        
        try {
            if ($expire > 0) {
                return $this->redis->setex($cache_key, $expire, $value);
            } else {
                return $this->redis->set($cache_key, $value);
            }
        } catch (Exception $e) {
            error_log('Redis set error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Delete from cache
     */
    public function delete($key, $group = 'default') {
        $cache_key = $this->get_key($key, $group);
        
        // Remove from local cache
        unset($this->cache[$cache_key]);
        
        // Non-persistent groups
        if (in_array($group, $this->non_persistent_groups)) {
            return true;
        }
        
        // Return false if not connected
        if (!$this->connected) {
            return false;
        }
        
        try {
            return $this->redis->del($cache_key) > 0;
        } catch (Exception $e) {
            error_log('Redis delete error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Flush cache
     */
    public function flush() {
        $this->cache = [];
        
        if (!$this->connected) {
            return false;
        }
        
        try {
            return $this->redis->flushDB();
        } catch (Exception $e) {
            error_log('Redis flush error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Add to cache (only if doesn't exist)
     */
    public function add($key, $value, $group = 'default', $expire = 0) {
        if ($this->get($key, $group) !== false) {
            return false;
        }
        
        return $this->set($key, $value, $group, $expire);
    }
    
    /**
     * Replace in cache (only if exists)
     */
    public function replace($key, $value, $group = 'default', $expire = 0) {
        if ($this->get($key, $group) === false) {
            return false;
        }
        
        return $this->set($key, $value, $group, $expire);
    }
    
    /**
     * Increment numeric cache value
     */
    public function incr($key, $offset = 1, $group = 'default') {
        if (!$this->connected) {
            return false;
        }
        
        $cache_key = $this->get_key($key, $group);
        
        try {
            $value = $this->redis->incrBy($cache_key, $offset);
            $this->cache[$cache_key] = $value;
            return $value;
        } catch (Exception $e) {
            error_log('Redis incr error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Decrement numeric cache value
     */
    public function decr($key, $offset = 1, $group = 'default') {
        return $this->incr($key, -$offset, $group);
    }
    
    /**
     * Get cache statistics
     */
    public function stats() {
        if (!$this->connected) {
            return [];
        }
        
        try {
            $info = $this->redis->info();
            
            return [
                'hits' => $info['keyspace_hits'] ?? 0,
                'misses' => $info['keyspace_misses'] ?? 0,
                'uptime' => $info['uptime_in_seconds'] ?? 0,
                'memory_used' => $info['used_memory_human'] ?? '0',
                'connected_clients' => $info['connected_clients'] ?? 0,
                'evicted_keys' => $info['evicted_keys'] ?? 0,
                'total_keys' => $this->redis->dbSize()
            ];
        } catch (Exception $e) {
            error_log('Redis stats error: ' . $e->getMessage());
            return [];
        }
    }
    
    /**
     * Add global groups
     */
    public function add_global_groups($groups) {
        $groups = (array) $groups;
        $this->global_groups = array_merge($this->global_groups, $groups);
        $this->global_groups = array_unique($this->global_groups);
    }
    
    /**
     * Add non-persistent groups
     */
    public function add_non_persistent_groups($groups) {
        $groups = (array) $groups;
        $this->non_persistent_groups = array_merge($this->non_persistent_groups, $groups);
        $this->non_persistent_groups = array_unique($this->non_persistent_groups);
    }
    
    /**
     * Switch blog (for multisite)
     */
    public function switch_to_blog($blog_id) {
        $this->blog_prefix = $blog_id . ':';
    }
}

// Initialize object cache
global $wp_object_cache;
$wp_object_cache = new WP_Redis_Object_Cache();

// WordPress cache functions
function wp_cache_get($key, $group = '', $force = false, &$found = null) {
    global $wp_object_cache;
    return $wp_object_cache->get($key, $group, $force, $found);
}

function wp_cache_set($key, $data, $group = '', $expire = 0) {
    global $wp_object_cache;
    return $wp_object_cache->set($key, $data, $group, $expire);
}

function wp_cache_delete($key, $group = '') {
    global $wp_object_cache;
    return $wp_object_cache->delete($key, $group);
}

function wp_cache_add($key, $data, $group = '', $expire = 0) {
    global $wp_object_cache;
    return $wp_object_cache->add($key, $data, $group, $expire);
}

function wp_cache_replace($key, $data, $group = '', $expire = 0) {
    global $wp_object_cache;
    return $wp_object_cache->replace($key, $data, $group, $expire);
}

function wp_cache_incr($key, $offset = 1, $group = '') {
    global $wp_object_cache;
    return $wp_object_cache->incr($key, $offset, $group);
}

function wp_cache_decr($key, $offset = 1, $group = '') {
    global $wp_object_cache;
    return $wp_object_cache->decr($key, $offset, $group);
}

function wp_cache_flush() {
    global $wp_object_cache;
    return $wp_object_cache->flush();
}

function wp_cache_add_global_groups($groups) {
    global $wp_object_cache;
    $wp_object_cache->add_global_groups($groups);
}

function wp_cache_add_non_persistent_groups($groups) {
    global $wp_object_cache;
    $wp_object_cache->add_non_persistent_groups($groups);
}

function wp_cache_switch_to_blog($blog_id) {
    global $wp_object_cache;
    $wp_object_cache->switch_to_blog($blog_id);
}

function wp_cache_get_stats() {
    global $wp_object_cache;
    return $wp_object_cache->stats();
}
                        </code></pre>
                    </section>
                    
                    <!-- Advanced Page Caching -->
                    <section>
                        <h2>Advanced Page Caching</h2>
                        
                        <h3>Full Page Cache with Advanced Features</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * Advanced Page Cache System
 */
class Advanced_Page_Cache {
    
    private $cache_dir;
    private $cache_enabled = true;
    private $cache_time = 3600;
    private $gzip_enabled = true;
    private $mobile_cache = true;
    
    public function __construct() {
        $this->cache_dir = WP_CONTENT_DIR . '/cache/pages/';
        
        // Create cache directory
        if (!file_exists($this->cache_dir)) {
            wp_mkdir_p($this->cache_dir);
        }
        
        // Early cache serving
        add_action('plugins_loaded', [$this, 'serve_cache'], 1);
        
        // Cache generation
        add_action('template_redirect', [$this, 'start_cache'], -999999);
        
        // Cache purging
        add_action('save_post', [$this, 'purge_post_cache']);
        add_action('comment_post', [$this, 'purge_comment_cache']);
        add_action('switch_theme', [$this, 'purge_all_cache']);
        
        // Preload cache
        add_action('wp', [$this, 'schedule_cache_preload']);
        add_action('cache_preload_event', [$this, 'preload_cache']);
        
        // Admin bar
        add_action('admin_bar_menu', [$this, 'admin_bar_menu'], 100);
        
        // AJAX handlers
        add_action('wp_ajax_purge_page_cache', [$this, 'ajax_purge_cache']);
    }
    
    /**
     * Serve cached page
     */
    public function serve_cache() {
        // Skip for logged in users
        if (is_user_logged_in()) {
            return;
        }
        
        // Skip for POST requests
        if ($_SERVER['REQUEST_METHOD'] !== 'GET') {
            return;
        }
        
        // Skip if cache disabled
        if (!$this->cache_enabled) {
            return;
        }
        
        $cache_file = $this->get_cache_file();
        
        if (file_exists($cache_file) && $this->is_cache_valid($cache_file)) {
            // Set cache headers
            header('X-Cache: HIT');
            header('X-Cache-File: ' . basename($cache_file));
            
            // Check if gzipped version exists
            if ($this->gzip_enabled && file_exists($cache_file . '.gz')) {
                if ($this->client_accepts_gzip()) {
                    header('Content-Encoding: gzip');
                    readfile($cache_file . '.gz');
                } else {
                    readfile($cache_file);
                }
            } else {
                readfile($cache_file);
            }
            
            exit;
        }
    }
    
    /**
     * Start output buffering for cache
     */
    public function start_cache() {
        // Skip for logged in users
        if (is_user_logged_in()) {
            return;
        }
        
        // Skip for specific pages
        if (is_404() || is_search() || is_preview()) {
            return;
        }
        
        // Skip if doing AJAX
        if (defined('DOING_AJAX') && DOING_AJAX) {
            return;
        }
        
        ob_start([$this, 'save_cache']);
    }
    
    /**
     * Save page to cache
     */
    public function save_cache($content) {
        // Don't cache empty content
        if (empty($content)) {
            return $content;
        }
        
        // Don't cache if there were errors
        if (http_response_code() !== 200) {
            return $content;
        }
        
        $cache_file = $this->get_cache_file();
        
        // Create cache directory if needed
        $cache_dir = dirname($cache_file);
        if (!file_exists($cache_dir)) {
            wp_mkdir_p($cache_dir);
        }
        
        // Optimize content
        $content = $this->optimize_html($content);
        
        // Add cache info
        $cache_info = "\n<!-- Cached: " . date('Y-m-d H:i:s') . " -->";
        $cache_info .= "\n<!-- Cache File: " . basename($cache_file) . " -->";
        $content_with_info = $content . $cache_info;
        
        // Save regular version
        file_put_contents($cache_file, $content_with_info, LOCK_EX);
        
        // Save gzipped version
        if ($this->gzip_enabled) {
            $gzipped = gzencode($content_with_info, 9);
            file_put_contents($cache_file . '.gz', $gzipped, LOCK_EX);
        }
        
        // Set cache headers for this response
        header('X-Cache: MISS');
        header('X-Cache-File: ' . basename($cache_file));
        
        return $content;
    }
    
    /**
     * Get cache file path
     */
    private function get_cache_file() {
        $url_parts = parse_url($_SERVER['REQUEST_URI']);
        $path = isset($url_parts['path']) ? $url_parts['path'] : '/';
        $query = isset($url_parts['query']) ? $url_parts['query'] : '';
        
        // Remove trailing slash
        $path = rtrim($path, '/');
        if (empty($path)) {
            $path = 'index';
        }
        
        // Handle query strings
        if (!empty($query)) {
            // Only cache specific query parameters
            parse_str($query, $params);
            $allowed_params = ['page', 'paged'];
            $filtered_params = array_intersect_key($params, array_flip($allowed_params));
            
            if (!empty($filtered_params)) {
                $path .= '-' . md5(http_build_query($filtered_params));
            }
        }
        
        // Add mobile suffix
        if ($this->mobile_cache && wp_is_mobile()) {
            $path .= '-mobile';
        }
        
        // Clean path for filesystem
        $path = str_replace('/', '-', $path);
        $path = preg_replace('/[^a-zA-Z0-9\-_]/', '', $path);
        
        return $this->cache_dir . $path . '.html';
    }
    
    /**
     * Check if cache is valid
     */
    private function is_cache_valid($cache_file) {
        $file_time = filemtime($cache_file);
        
        // Check age
        if ((time() - $file_time) > $this->cache_time) {
            return false;
        }
        
        // Check if content has been updated
        $last_modified = $this->get_last_modified_time();
        if ($last_modified > $file_time) {
            return false;
        }
        
        return true;
    }
    
    /**
     * Get last modified time
     */
    private function get_last_modified_time() {
        global $wpdb;
        
        // Get most recent post modification
        $last_post = $wpdb->get_var("
            SELECT MAX(post_modified_gmt) 
            FROM {$wpdb->posts} 
            WHERE post_status = 'publish'
        ");
        
        // Get most recent comment
        $last_comment = $wpdb->get_var("
            SELECT MAX(comment_date_gmt) 
            FROM {$wpdb->comments} 
            WHERE comment_approved = '1'
        ");
        
        return max(
            strtotime($last_post),
            strtotime($last_comment),
            get_option('_site_transient_update_core')
        );
    }
    
    /**
     * Optimize HTML
     */
    private function optimize_html($html) {
        // Remove HTML comments (except IE conditionals)
        $html = preg_replace('/<!--(?!\[if)(?!wp:).*?-->/s', '', $html);
        
        // Remove unnecessary whitespace
        $html = preg_replace('/\s+/', ' ', $html);
        $html = preg_replace('/>\s+</', '><', $html);
        
        // Optimize inline CSS
        $html = preg_replace_callback('/<style[^>]*>(.*?)<\/style>/is', function($matches) {
            $css = $matches[1];
            // Remove CSS comments
            $css = preg_replace('/\/\*.*?\*\//s', '', $css);
            // Remove whitespace
            $css = preg_replace('/\s+/', ' ', $css);
            $css = str_replace(': ', ':', $css);
            $css = str_replace('; ', ';', $css);
            $css = str_replace(' {', '{', $css);
            $css = str_replace('{ ', '{', $css);
            $css = str_replace(' }', '}', $css);
            $css = str_replace('} ', '}', $css);
            
            return '<style>' . $css . '</style>';
        }, $html);
        
        // Optimize inline JavaScript
        $html = preg_replace_callback('/<script[^>]*>(.*?)<\/script>/is', function($matches) {
            // Skip if external script
            if (strpos($matches[0], 'src=') !== false) {
                return $matches[0];
            }
            
            $js = $matches[1];
            // Basic JS minification (be careful with this)
            $js = preg_replace('/\/\/.*$/m', '', $js); // Remove single-line comments
            $js = preg_replace('/\s+/', ' ', $js); // Remove excess whitespace
            
            return '<script>' . $js . '</script>';
        }, $html);
        
        return trim($html);
    }
    
    /**
     * Check if client accepts gzip
     */
    private function client_accepts_gzip() {
        return isset($_SERVER['HTTP_ACCEPT_ENCODING']) && 
               strpos($_SERVER['HTTP_ACCEPT_ENCODING'], 'gzip') !== false;
    }
    
    /**
     * Purge post cache
     */
    public function purge_post_cache($post_id) {
        $post = get_post($post_id);
        
        if ($post->post_status !== 'publish') {
            return;
        }
        
        // Purge post page
        $this->purge_url(get_permalink($post_id));
        
        // Purge home page
        $this->purge_url(home_url('/'));
        
        // Purge archives
        $this->purge_archives($post);
    }
    
    /**
     * Purge URL cache
     */
    private function purge_url($url) {
        $url_parts = parse_url($url);
        $path = isset($url_parts['path']) ? $url_parts['path'] : '/';
        
        $path = rtrim($path, '/');
        if (empty($path)) {
            $path = 'index';
        }
        
        $path = str_replace('/', '-', $path);
        $path = preg_replace('/[^a-zA-Z0-9\-_]/', '', $path);
        
        // Delete desktop version
        $cache_file = $this->cache_dir . $path . '.html';
        if (file_exists($cache_file)) {
            unlink($cache_file);
        }
        if (file_exists($cache_file . '.gz')) {
            unlink($cache_file . '.gz');
        }
        
        // Delete mobile version
        $mobile_file = $this->cache_dir . $path . '-mobile.html';
        if (file_exists($mobile_file)) {
            unlink($mobile_file);
        }
        if (file_exists($mobile_file . '.gz')) {
            unlink($mobile_file . '.gz');
        }
    }
    
    /**
     * Purge all cache
     */
    public function purge_all_cache() {
        $files = glob($this->cache_dir . '*.{html,gz}', GLOB_BRACE);
        
        foreach ($files as $file) {
            unlink($file);
        }
        
        // Trigger action for other caches
        do_action('purge_all_caches');
    }
    
    /**
     * Schedule cache preload
     */
    public function schedule_cache_preload() {
        if (!wp_next_scheduled('cache_preload_event')) {
            wp_schedule_event(time(), 'daily', 'cache_preload_event');
        }
    }
    
    /**
     * Preload cache
     */
    public function preload_cache() {
        // Get important URLs to preload
        $urls = [
            home_url('/'),
            get_permalink(get_option('page_on_front')),
            get_permalink(get_option('page_for_posts'))
        ];
        
        // Add recent posts
        $recent_posts = get_posts([
            'numberposts' => 10,
            'post_status' => 'publish'
        ]);
        
        foreach ($recent_posts as $post) {
            $urls[] = get_permalink($post);
        }
        
        // Add important pages
        $important_pages = get_pages([
            'number' => 10,
            'sort_column' => 'menu_order'
        ]);
        
        foreach ($important_pages as $page) {
            $urls[] = get_permalink($page);
        }
        
        // Warm cache for each URL
        foreach (array_unique($urls) as $url) {
            wp_remote_get($url, [
                'timeout' => 30,
                'blocking' => false,
                'sslverify' => false
            ]);
        }
    }
}

// Initialize page cache
new Advanced_Page_Cache();
                        </code></pre>
                    </section>
                    
                    <!-- CDN Integration -->
                    <section>
                        <h2>CDN Integration</h2>
                        
                        <h3>CDN URL Rewriting and Management</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * CDN Integration System
 */
class CDN_Integration {
    
    private $cdn_domain;
    private $site_domain;
    private $directories = ['wp-content', 'wp-includes'];
    private $extensions = ['css', 'js', 'jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'woff', 'woff2', 'ttf', 'eot'];
    private $exclude_urls = [];
    
    public function __construct() {
        $this->cdn_domain = get_option('cdn_domain', '');
        $this->site_domain = parse_url(home_url(), PHP_URL_HOST);
        
        if (empty($this->cdn_domain)) {
            return;
        }
        
        // URL rewriting
        add_filter('script_loader_src', [$this, 'rewrite_url']);
        add_filter('style_loader_src', [$this, 'rewrite_url']);
        add_filter('wp_get_attachment_url', [$this, 'rewrite_url']);
        add_filter('the_content', [$this, 'rewrite_content_urls']);
        add_filter('widget_text', [$this, 'rewrite_content_urls']);
        
        // Srcset rewriting for responsive images
        add_filter('wp_calculate_image_srcset', [$this, 'rewrite_srcset'], 10, 5);
        
        // Preconnect to CDN
        add_action('wp_head', [$this, 'add_preconnect'], 1);
        
        // Push to CDN on upload
        add_action('add_attachment', [$this, 'push_to_cdn']);
        add_action('edit_attachment', [$this, 'push_to_cdn']);
        
        // Purge CDN cache
        add_action('save_post', [$this, 'purge_cdn_cache']);
        
        // Admin settings
        add_action('admin_menu', [$this, 'add_admin_menu']);
    }
    
    /**
     * Rewrite URL to CDN
     */
    public function rewrite_url($url) {
        // Skip if no CDN domain
        if (empty($this->cdn_domain)) {
            return $url;
        }
        
        // Skip external URLs
        if (strpos($url, $this->site_domain) === false) {
            return $url;
        }
        
        // Skip excluded URLs
        foreach ($this->exclude_urls as $exclude) {
            if (strpos($url, $exclude) !== false) {
                return $url;
            }
        }
        
        // Check if URL should be rewritten
        if (!$this->should_rewrite($url)) {
            return $url;
        }
        
        // Rewrite to CDN
        $cdn_url = str_replace(
            '//' . $this->site_domain,
            '//' . $this->cdn_domain,
            $url
        );
        
        return $cdn_url;
    }
    
    /**
     * Check if URL should be rewritten
     */
    private function should_rewrite($url) {
        // Check directories
        $valid_dir = false;
        foreach ($this->directories as $dir) {
            if (strpos($url, '/' . $dir . '/') !== false) {
                $valid_dir = true;
                break;
            }
        }
        
        if (!$valid_dir) {
            return false;
        }
        
        // Check extensions
        $extension = pathinfo(parse_url($url, PHP_URL_PATH), PATHINFO_EXTENSION);
        if (!in_array(strtolower($extension), $this->extensions)) {
            return false;
        }
        
        return true;
    }
    
    /**
     * Rewrite URLs in content
     */
    public function rewrite_content_urls($content) {
        if (empty($this->cdn_domain)) {
            return $content;
        }
        
        // Find all URLs in content
        $pattern = '/(https?:\/\/' . preg_quote($this->site_domain, '/') . '[^"\'\s]*)/i';
        
        $content = preg_replace_callback($pattern, function($matches) {
            return $this->rewrite_url($matches[0]);
        }, $content);
        
        return $content;
    }
    
    /**
     * Rewrite srcset URLs
     */
    public function rewrite_srcset($sources, $size_array, $image_src, $image_meta, $attachment_id) {
        foreach ($sources as &$source) {
            $source['url'] = $this->rewrite_url($source['url']);
        }
        
        return $sources;
    }
    
    /**
     * Add preconnect headers
     */
    public function add_preconnect() {
        if (empty($this->cdn_domain)) {
            return;
        }
        
        echo '<link rel="dns-prefetch" href="//' . esc_attr($this->cdn_domain) . '">' . "\n";
        echo '<link rel="preconnect" href="//' . esc_attr($this->cdn_domain) . '">' . "\n";
        echo '<link rel="preconnect" href="//' . esc_attr($this->cdn_domain) . '" crossorigin>' . "\n";
    }
    
    /**
     * Push file to CDN
     */
    public function push_to_cdn($attachment_id) {
        $file = get_attached_file($attachment_id);
        
        if (!file_exists($file)) {
            return;
        }
        
        // Get CDN API credentials
        $api_key = get_option('cdn_api_key');
        $api_secret = get_option('cdn_api_secret');
        
        if (empty($api_key) || empty($api_secret)) {
            return;
        }
        
        // Push to CDN (example for generic CDN API)
        $cdn_path = str_replace(ABSPATH, '', $file);
        
        $response = wp_remote_post('https://api.cdn.com/upload', [
            'headers' => [
                'Authorization' => 'Bearer ' . $api_key,
                'X-API-Secret' => $api_secret
            ],
            'body' => [
                'file' => new CURLFile($file),
                'path' => $cdn_path
            ]
        ]);
        
        if (is_wp_error($response)) {
            error_log('CDN upload failed: ' . $response->get_error_message());
        }
    }
    
    /**
     * Purge CDN cache
     */
    public function purge_cdn_cache($post_id = null) {
        $api_key = get_option('cdn_api_key');
        
        if (empty($api_key)) {
            return;
        }
        
        $purge_urls = [];
        
        if ($post_id) {
            // Purge specific post
            $purge_urls[] = get_permalink($post_id);
            
            // Purge post thumbnail
            if (has_post_thumbnail($post_id)) {
                $purge_urls[] = get_the_post_thumbnail_url($post_id);
            }
        } else {
            // Purge all
            $purge_urls[] = home_url('/*');
        }
        
        // Send purge request to CDN
        foreach ($purge_urls as $url) {
            $cdn_url = $this->rewrite_url($url);
            
            wp_remote_request('https://api.cdn.com/purge', [
                'method' => 'PURGE',
                'headers' => [
                    'Authorization' => 'Bearer ' . $api_key,
                    'X-Purge-URL' => $cdn_url
                ]
            ]);
        }
    }
}

// Initialize CDN integration
new CDN_Integration();
                        </code></pre>
                    </section>
                    
                    <!-- Browser Caching -->
                    <section>
                        <h2>Browser Caching Configuration</h2>
                        
                        <h3>.htaccess Browser Caching Rules</h3>
                        <pre><code class="language-apache">
# Browser Caching Configuration
&lt;IfModule mod_expires.c>
    ExpiresActive On
    
    # Default expiration
    ExpiresDefault "access plus 1 month"
    
    # HTML - Don't cache
    ExpiresByType text/html "access plus 0 seconds"
    
    # Data interchange
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType application/xml "access plus 0 seconds"
    ExpiresByType text/xml "access plus 0 seconds"
    
    # Manifest files
    ExpiresByType application/x-web-app-manifest+json "access plus 0 seconds"
    ExpiresByType text/cache-manifest "access plus 0 seconds"
    
    # Media files
    ExpiresByType audio/ogg "access plus 1 year"
    ExpiresByType image/bmp "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType video/mp4 "access plus 1 year"
    ExpiresByType video/ogg "access plus 1 year"
    ExpiresByType video/webm "access plus 1 year"
    
    # Web fonts
    ExpiresByType font/eot "access plus 1 year"
    ExpiresByType font/opentype "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    ExpiresByType application/x-font-ttf "access plus 1 year"
    ExpiresByType application/x-font-woff "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    
    # Misc
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType image/vnd.microsoft.icon "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
&lt;/IfModule>

# Cache Control Headers
&lt;IfModule mod_headers.c>
    # Security headers
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    
    # Cache-Control for static files
    &lt;FilesMatch "\.(css|js|jpg|jpeg|png|gif|webp|svg|ico|woff|woff2|ttf|eot|otf)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    &lt;/FilesMatch>
    
    # Don't cache HTML
    &lt;FilesMatch "\.(html|htm|php)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    &lt;/FilesMatch>
    
    # ETags
    Header unset ETag
    FileETag None
    
    # Remove PHP version
    Header unset X-Powered-By
    
    # Vary: Accept-Encoding for all resources
    Header append Vary "Accept-Encoding"
&lt;/IfModule>

# Gzip Compression
&lt;IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    
    # Remove browser bugs
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
    Header append Vary User-Agent
&lt;/IfModule>
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>Object caching with Redis dramatically improves database performance</li>
                                <li>Page caching serves static HTML for anonymous visitors</li>
                                <li>CDN integration offloads static asset delivery</li>
                                <li>Browser caching reduces server requests</li>
                                <li>Cache invalidation strategy is crucial</li>
                                <li>Multiple cache layers work together</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Caching Best Practices</h3>
                            <ul>
                                <li>Implement multiple cache layers</li>
                                <li>Use appropriate cache durations</li>
                                <li>Implement smart cache invalidation</li>
                                <li>Monitor cache hit rates</li>
                                <li>Test cache warming strategies</li>
                                <li>Handle cache stampedes</li>
                                <li>Document cache dependencies</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://redis.io/documentation" target="_blank">Redis Documentation</a></li>
                            <li><a href="https://www.cloudflare.com/learning/cdn/what-is-a-cdn/" target="_blank">CDN Overview</a></li>
                            <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching" target="_blank">HTTP Caching</a></li>
                            <li><a href="https://web.dev/http-cache/" target="_blank">HTTP Cache Best Practices</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/performance_optimization.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            Performance Optimization
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/security_best_practices.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            Security Best Practices
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>