<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>Custom REST API Endpoints and Controllers - PHP WordPress Course</title>
    <meta name="description" content="Learn to create custom REST API endpoints and controllers in WordPress. Build complex API routes with proper validation and permissions.">
    <meta name="keywords" content="WordPress, REST API, custom endpoints, controllers, API development">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="Custom REST API Endpoints and Controllers">
    <meta property="og:description" content="Build custom REST API endpoints with controllers">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Custom Endpoints</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">Custom REST API Endpoints and Controllers</h1>
                    <p class="lesson-subtitle">Build powerful custom API endpoints with proper architecture</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Create custom REST API endpoints</li>
                        <li>Build controller classes for organization</li>
                        <li>Implement proper validation and sanitization</li>
                        <li>Handle different HTTP methods</li>
                        <li>Create nested and dynamic routes</li>
                        <li>Build batch processing endpoints</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Basic Custom Endpoints -->
                    <section>
                        <h2>Creating Custom Endpoints</h2>
                        
                        <h3>Basic Endpoint Registration</h3>
                        <pre><code class="language-php">
/**
 * Register custom REST API endpoints
 */
class Custom_API_Endpoints {
    
    private $namespace = 'myapi/v1';
    
    public function __construct() {
        add_action('rest_api_init', [$this, 'register_routes']);
    }
    
    /**
     * Register all custom routes
     */
    public function register_routes() {
        // Simple GET endpoint
        register_rest_route($this->namespace, '/status', [
            'methods' => WP_REST_Server::READABLE, // GET
            'callback' => [$this, 'get_status'],
            'permission_callback' => '__return_true', // Public endpoint
        ]);
        
        // POST endpoint with validation
        register_rest_route($this->namespace, '/contact', [
            'methods' => WP_REST_Server::CREATABLE, // POST
            'callback' => [$this, 'submit_contact'],
            'permission_callback' => '__return_true',
            'args' => [
                'name' => [
                    'required' => true,
                    'type' => 'string',
                    'description' => 'Contact name',
                    'sanitize_callback' => 'sanitize_text_field',
                    'validate_callback' => [$this, 'validate_name'],
                ],
                'email' => [
                    'required' => true,
                    'type' => 'string',
                    'format' => 'email',
                    'description' => 'Contact email',
                    'sanitize_callback' => 'sanitize_email',
                    'validate_callback' => 'is_email',
                ],
                'message' => [
                    'required' => true,
                    'type' => 'string',
                    'description' => 'Contact message',
                    'sanitize_callback' => 'sanitize_textarea_field',
                    'validate_callback' => [$this, 'validate_message'],
                ],
            ],
        ]);
        
        // Multiple methods on same endpoint
        register_rest_route($this->namespace, '/settings', [
            [
                'methods' => WP_REST_Server::READABLE,
                'callback' => [$this, 'get_settings'],
                'permission_callback' => [$this, 'check_permissions'],
            ],
            [
                'methods' => WP_REST_Server::EDITABLE, // POST, PUT, PATCH
                'callback' => [$this, 'update_settings'],
                'permission_callback' => [$this, 'check_admin_permissions'],
                'args' => $this->get_settings_args(),
            ],
        ]);
        
        // Dynamic route with regex pattern
        register_rest_route($this->namespace, '/user/(?P<id>\d+)', [
            'methods' => WP_REST_Server::READABLE,
            'callback' => [$this, 'get_user_data'],
            'permission_callback' => [$this, 'check_user_permissions'],
            'args' => [
                'id' => [
                    'validate_callback' => function($param) {
                        return is_numeric($param);
                    },
                ],
            ],
        ]);
        
        // Nested resource endpoint
        register_rest_route($this->namespace, '/posts/(?P<post_id>\d+)/comments', [
            'methods' => WP_REST_Server::READABLE,
            'callback' => [$this, 'get_post_comments'],
            'permission_callback' => '__return_true',
            'args' => [
                'post_id' => [
                    'validate_callback' => [$this, 'validate_post_exists'],
                ],
                'page' => [
                    'default' => 1,
                    'sanitize_callback' => 'absint',
                ],
                'per_page' => [
                    'default' => 10,
                    'sanitize_callback' => 'absint',
                ],
            ],
        ]);
    }
    
    /**
     * Endpoint callbacks
     */
    public function get_status(WP_REST_Request $request) {
        return new WP_REST_Response([
            'status' => 'online',
            'version' => '1.0.0',
            'timestamp' => current_time('c'),
        ], 200);
    }
    
    public function submit_contact(WP_REST_Request $request) {
        $name = $request->get_param('name');
        $email = $request->get_param('email');
        $message = $request->get_param('message');
        
        // Process contact form
        $result = $this->process_contact_form($name, $email, $message);
        
        if ($result) {
            return new WP_REST_Response([
                'success' => true,
                'message' => 'Contact form submitted successfully',
                'id' => $result,
            ], 201);
        }
        
        return new WP_Error(
            'submission_failed',
            'Failed to submit contact form',
            ['status' => 500]
        );
    }
    
    public function get_settings(WP_REST_Request $request) {
        $settings = get_option('myapi_settings', []);
        
        return new WP_REST_Response($settings, 200);
    }
    
    public function update_settings(WP_REST_Request $request) {
        $settings = $request->get_params();
        
        // Remove non-setting parameters
        unset($settings['_method']);
        unset($settings['_wpnonce']);
        
        update_option('myapi_settings', $settings);
        
        return new WP_REST_Response([
            'success' => true,
            'settings' => $settings,
        ], 200);
    }
    
    public function get_user_data(WP_REST_Request $request) {
        $user_id = $request->get_param('id');
        $user = get_user_by('id', $user_id);
        
        if (!$user) {
            return new WP_Error(
                'user_not_found',
                'User not found',
                ['status' => 404]
            );
        }
        
        return new WP_REST_Response([
            'id' => $user->ID,
            'name' => $user->display_name,
            'email' => $user->user_email,
            'registered' => $user->user_registered,
        ], 200);
    }
    
    public function get_post_comments(WP_REST_Request $request) {
        $post_id = $request->get_param('post_id');
        $page = $request->get_param('page');
        $per_page = $request->get_param('per_page');
        
        $comments = get_comments([
            'post_id' => $post_id,
            'status' => 'approve',
            'number' => $per_page,
            'offset' => ($page - 1) * $per_page,
        ]);
        
        $response = new WP_REST_Response($comments, 200);
        
        // Add pagination headers
        $total = get_comments([
            'post_id' => $post_id,
            'status' => 'approve',
            'count' => true,
        ]);
        
        $response->header('X-WP-Total', $total);
        $response->header('X-WP-TotalPages', ceil($total / $per_page));
        
        return $response;
    }
    
    /**
     * Validation callbacks
     */
    public function validate_name($param, $request, $key) {
        if (strlen($param) < 2) {
            return new WP_Error(
                'invalid_name',
                'Name must be at least 2 characters long'
            );
        }
        return true;
    }
    
    public function validate_message($param, $request, $key) {
        if (strlen($param) < 10) {
            return new WP_Error(
                'invalid_message',
                'Message must be at least 10 characters long'
            );
        }
        return true;
    }
    
    public function validate_post_exists($param, $request, $key) {
        $post = get_post($param);
        return $post && $post->post_status === 'publish';
    }
    
    /**
     * Permission callbacks
     */
    public function check_permissions() {
        return is_user_logged_in();
    }
    
    public function check_admin_permissions() {
        return current_user_can('manage_options');
    }
    
    public function check_user_permissions($request) {
        $user_id = $request->get_param('id');
        
        // Users can view their own data
        if (get_current_user_id() == $user_id) {
            return true;
        }
        
        // Admins can view any user
        return current_user_can('list_users');
    }
    
    /**
     * Helper methods
     */
    private function get_settings_args() {
        return [
            'site_title' => [
                'type' => 'string',
                'sanitize_callback' => 'sanitize_text_field',
            ],
            'enable_feature' => [
                'type' => 'boolean',
                'default' => false,
            ],
            'items_per_page' => [
                'type' => 'integer',
                'minimum' => 1,
                'maximum' => 100,
                'default' => 10,
            ],
        ];
    }
    
    private function process_contact_form($name, $email, $message) {
        // Save to database or send email
        global $wpdb;
        
        $result = $wpdb->insert(
            $wpdb->prefix . 'contact_submissions',
            [
                'name' => $name,
                'email' => $email,
                'message' => $message,
                'submitted_at' => current_time('mysql'),
            ]
        );
        
        if ($result) {
            // Send email notification
            wp_mail(
                get_option('admin_email'),
                'New Contact Form Submission',
                sprintf(
                    "Name: %s\nEmail: %s\nMessage: %s",
                    $name,
                    $email,
                    $message
                )
            );
            
            return $wpdb->insert_id;
        }
        
        return false;
    }
}

new Custom_API_Endpoints();
                        </code></pre>
                    </section>
                    
                    <!-- Controller Pattern -->
                    <section>
                        <h2>Controller Pattern Implementation</h2>
                        
                        <h3>Base Controller Class</h3>
                        <pre><code class="language-php">
/**
 * Base REST Controller
 */
abstract class WP_REST_Controller_Base extends WP_REST_Controller {
    
    /**
     * Endpoint namespace
     */
    protected $namespace = 'myapi/v1';
    
    /**
     * Route base
     */
    protected $rest_base;
    
    /**
     * Constructor
     */
    public function __construct() {
        $this->rest_base = $this->get_rest_base();
    }
    
    /**
     * Get the route base
     */
    abstract protected function get_rest_base();
    
    /**
     * Register routes
     */
    abstract public function register_routes();
    
    /**
     * Check if user has permission
     */
    public function check_permissions($request) {
        return current_user_can($this->get_required_capability());
    }
    
    /**
     * Get required capability
     */
    protected function get_required_capability() {
        return 'read';
    }
    
    /**
     * Prepare item for response
     */
    public function prepare_item_for_response($item, $request) {
        $data = $this->prepare_item($item);
        $context = !empty($request['context']) ? $request['context'] : 'view';
        $data = $this->filter_response_by_context($data, $context);
        
        $response = rest_ensure_response($data);
        $response->add_links($this->prepare_links($item));
        
        return $response;
    }
    
    /**
     * Prepare item data
     */
    abstract protected function prepare_item($item);
    
    /**
     * Prepare links for the response
     */
    protected function prepare_links($item) {
        return [
            'self' => [
                'href' => rest_url(sprintf('%s/%s/%d', $this->namespace, $this->rest_base, $item->ID)),
            ],
            'collection' => [
                'href' => rest_url(sprintf('%s/%s', $this->namespace, $this->rest_base)),
            ],
        ];
    }
    
    /**
     * Get collection parameters
     */
    public function get_collection_params() {
        return [
            'page' => [
                'description' => 'Current page of the collection.',
                'type' => 'integer',
                'default' => 1,
                'sanitize_callback' => 'absint',
                'validate_callback' => 'rest_validate_request_arg',
                'minimum' => 1,
            ],
            'per_page' => [
                'description' => 'Maximum number of items to be returned in result set.',
                'type' => 'integer',
                'default' => 10,
                'minimum' => 1,
                'maximum' => 100,
                'sanitize_callback' => 'absint',
                'validate_callback' => 'rest_validate_request_arg',
            ],
            'search' => [
                'description' => 'Limit results to those matching a string.',
                'type' => 'string',
                'sanitize_callback' => 'sanitize_text_field',
                'validate_callback' => 'rest_validate_request_arg',
            ],
            'orderby' => [
                'description' => 'Sort collection by object attribute.',
                'type' => 'string',
                'default' => 'date',
                'enum' => ['date', 'id', 'title', 'menu_order'],
                'validate_callback' => 'rest_validate_request_arg',
            ],
            'order' => [
                'description' => 'Order sort attribute ascending or descending.',
                'type' => 'string',
                'default' => 'desc',
                'enum' => ['asc', 'desc'],
                'validate_callback' => 'rest_validate_request_arg',
            ],
        ];
    }
}
                        </code></pre>
                        
                        <h3>Product Controller Example</h3>
                        <pre><code class="language-php">
/**
 * Products REST Controller
 */
class Products_REST_Controller extends WP_REST_Controller_Base {
    
    /**
     * Post type
     */
    protected $post_type = 'product';
    
    /**
     * Get route base
     */
    protected function get_rest_base() {
        return 'products';
    }
    
    /**
     * Register the routes
     */
    public function register_routes() {
        // Collection endpoints
        register_rest_route($this->namespace, '/' . $this->rest_base, [
            [
                'methods' => WP_REST_Server::READABLE,
                'callback' => [$this, 'get_items'],
                'permission_callback' => '__return_true',
                'args' => $this->get_collection_params(),
            ],
            [
                'methods' => WP_REST_Server::CREATABLE,
                'callback' => [$this, 'create_item'],
                'permission_callback' => [$this, 'create_item_permissions_check'],
                'args' => $this->get_endpoint_args_for_item_schema(WP_REST_Server::CREATABLE),
            ],
            'schema' => [$this, 'get_public_item_schema'],
        ]);
        
        // Single item endpoints
        register_rest_route($this->namespace, '/' . $this->rest_base . '/(?P<id>[\d]+)', [
            [
                'methods' => WP_REST_Server::READABLE,
                'callback' => [$this, 'get_item'],
                'permission_callback' => '__return_true',
                'args' => [
                    'context' => [
                        'default' => 'view',
                    ],
                ],
            ],
            [
                'methods' => WP_REST_Server::EDITABLE,
                'callback' => [$this, 'update_item'],
                'permission_callback' => [$this, 'update_item_permissions_check'],
                'args' => $this->get_endpoint_args_for_item_schema(WP_REST_Server::EDITABLE),
            ],
            [
                'methods' => WP_REST_Server::DELETABLE,
                'callback' => [$this, 'delete_item'],
                'permission_callback' => [$this, 'delete_item_permissions_check'],
                'args' => [
                    'force' => [
                        'default' => false,
                        'description' => 'Whether to bypass trash and force deletion.',
                        'type' => 'boolean',
                    ],
                ],
            ],
            'schema' => [$this, 'get_public_item_schema'],
        ]);
        
        // Custom action endpoints
        register_rest_route($this->namespace, '/' . $this->rest_base . '/(?P<id>[\d]+)/duplicate', [
            'methods' => WP_REST_Server::CREATABLE,
            'callback' => [$this, 'duplicate_item'],
            'permission_callback' => [$this, 'create_item_permissions_check'],
        ]);
        
        // Batch endpoint
        register_rest_route($this->namespace, '/' . $this->rest_base . '/batch', [
            'methods' => WP_REST_Server::EDITABLE,
            'callback' => [$this, 'batch_items'],
            'permission_callback' => [$this, 'batch_items_permissions_check'],
            'args' => [
                'create' => [
                    'type' => 'array',
                    'items' => [
                        'type' => 'object',
                    ],
                ],
                'update' => [
                    'type' => 'array',
                    'items' => [
                        'type' => 'object',
                    ],
                ],
                'delete' => [
                    'type' => 'array',
                    'items' => [
                        'type' => 'integer',
                    ],
                ],
            ],
        ]);
    }
    
    /**
     * Get a collection of items
     */
    public function get_items($request) {
        $args = [
            'post_type' => $this->post_type,
            'posts_per_page' => $request['per_page'],
            'paged' => $request['page'],
            'orderby' => $request['orderby'],
            'order' => $request['order'],
        ];
        
        if (!empty($request['search'])) {
            $args['s'] = $request['search'];
        }
        
        // Add custom filters
        if (!empty($request['category'])) {
            $args['tax_query'] = [
                [
                    'taxonomy' => 'product_category',
                    'field' => 'term_id',
                    'terms' => $request['category'],
                ],
            ];
        }
        
        if (!empty($request['min_price']) || !empty($request['max_price'])) {
            $args['meta_query'] = [];
            
            if (!empty($request['min_price'])) {
                $args['meta_query'][] = [
                    'key' => '_price',
                    'value' => $request['min_price'],
                    'compare' => '>=',
                    'type' => 'NUMERIC',
                ];
            }
            
            if (!empty($request['max_price'])) {
                $args['meta_query'][] = [
                    'key' => '_price',
                    'value' => $request['max_price'],
                    'compare' => '<=',
                    'type' => 'NUMERIC',
                ];
            }
        }
        
        $query = new WP_Query($args);
        
        $products = [];
        foreach ($query->posts as $post) {
            $data = $this->prepare_item_for_response($post, $request);
            $products[] = $this->prepare_response_for_collection($data);
        }
        
        $response = rest_ensure_response($products);
        
        // Add pagination headers
        $total_posts = $query->found_posts;
        $max_pages = $query->max_num_pages;
        
        $response->header('X-WP-Total', $total_posts);
        $response->header('X-WP-TotalPages', $max_pages);
        
        return $response;
    }
    
    /**
     * Get one item from the collection
     */
    public function get_item($request) {
        $post = get_post($request['id']);
        
        if (!$post || $post->post_type !== $this->post_type) {
            return new WP_Error(
                'rest_product_invalid_id',
                __('Invalid product ID.'),
                ['status' => 404]
            );
        }
        
        $data = $this->prepare_item_for_response($post, $request);
        
        return rest_ensure_response($data);
    }
    
    /**
     * Create one item from the collection
     */
    public function create_item($request) {
        $prepared_post = $this->prepare_item_for_database($request);
        
        if (is_wp_error($prepared_post)) {
            return $prepared_post;
        }
        
        $prepared_post['post_type'] = $this->post_type;
        $prepared_post['post_status'] = 'publish';
        
        $post_id = wp_insert_post($prepared_post, true);
        
        if (is_wp_error($post_id)) {
            return $post_id;
        }
        
        // Update meta fields
        $this->update_post_meta($post_id, $request);
        
        $post = get_post($post_id);
        $response = $this->prepare_item_for_response($post, $request);
        $response = rest_ensure_response($response);
        
        $response->set_status(201);
        $response->header('Location', rest_url(sprintf('%s/%s/%d', $this->namespace, $this->rest_base, $post_id)));
        
        return $response;
    }
    
    /**
     * Update one item from the collection
     */
    public function update_item($request) {
        $post = get_post($request['id']);
        
        if (!$post || $post->post_type !== $this->post_type) {
            return new WP_Error(
                'rest_product_invalid_id',
                __('Invalid product ID.'),
                ['status' => 404]
            );
        }
        
        $prepared_post = $this->prepare_item_for_database($request);
        
        if (is_wp_error($prepared_post)) {
            return $prepared_post;
        }
        
        $prepared_post['ID'] = $post->ID;
        
        $post_id = wp_update_post($prepared_post, true);
        
        if (is_wp_error($post_id)) {
            return $post_id;
        }
        
        // Update meta fields
        $this->update_post_meta($post_id, $request);
        
        $post = get_post($post_id);
        $response = $this->prepare_item_for_response($post, $request);
        
        return rest_ensure_response($response);
    }
    
    /**
     * Delete one item from the collection
     */
    public function delete_item($request) {
        $post = get_post($request['id']);
        
        if (!$post || $post->post_type !== $this->post_type) {
            return new WP_Error(
                'rest_product_invalid_id',
                __('Invalid product ID.'),
                ['status' => 404]
            );
        }
        
        $force = (bool) $request['force'];
        
        if ($force) {
            $result = wp_delete_post($post->ID, true);
        } else {
            $result = wp_trash_post($post->ID);
        }
        
        if (!$result) {
            return new WP_Error(
                'rest_cannot_delete',
                __('The product cannot be deleted.'),
                ['status' => 500]
            );
        }
        
        $response = new WP_REST_Response();
        $response->set_data([
            'deleted' => true,
            'previous' => $this->prepare_item_for_response($post, $request)->get_data(),
        ]);
        
        return $response;
    }
    
    /**
     * Duplicate a product
     */
    public function duplicate_item($request) {
        $original = get_post($request['id']);
        
        if (!$original || $original->post_type !== $this->post_type) {
            return new WP_Error(
                'rest_product_invalid_id',
                __('Invalid product ID.'),
                ['status' => 404]
            );
        }
        
        // Create duplicate
        $new_post = [
            'post_title' => $original->post_title . ' (Copy)',
            'post_content' => $original->post_content,
            'post_excerpt' => $original->post_excerpt,
            'post_type' => $this->post_type,
            'post_status' => 'draft',
        ];
        
        $new_id = wp_insert_post($new_post);
        
        if (is_wp_error($new_id)) {
            return $new_id;
        }
        
        // Copy meta data
        $meta_data = get_post_meta($original->ID);
        foreach ($meta_data as $key => $values) {
            foreach ($values as $value) {
                add_post_meta($new_id, $key, maybe_unserialize($value));
            }
        }
        
        // Copy taxonomies
        $taxonomies = get_object_taxonomies($this->post_type);
        foreach ($taxonomies as $taxonomy) {
            $terms = wp_get_object_terms($original->ID, $taxonomy, ['fields' => 'ids']);
            wp_set_object_terms($new_id, $terms, $taxonomy);
        }
        
        $new_post = get_post($new_id);
        $response = $this->prepare_item_for_response($new_post, $request);
        $response = rest_ensure_response($response);
        
        $response->set_status(201);
        $response->header('Location', rest_url(sprintf('%s/%s/%d', $this->namespace, $this->rest_base, $new_id)));
        
        return $response;
    }
    
    /**
     * Batch processing
     */
    public function batch_items($request) {
        $response = [
            'create' => [],
            'update' => [],
            'delete' => [],
        ];
        
        // Process creates
        if (!empty($request['create'])) {
            foreach ($request['create'] as $item) {
                $item_request = new WP_REST_Request('POST');
                $item_request->set_body_params($item);
                $result = $this->create_item($item_request);
                
                if (is_wp_error($result)) {
                    $response['create'][] = [
                        'error' => [
                            'code' => $result->get_error_code(),
                            'message' => $result->get_error_message(),
                        ],
                    ];
                } else {
                    $response['create'][] = $result->get_data();
                }
            }
        }
        
        // Process updates
        if (!empty($request['update'])) {
            foreach ($request['update'] as $item) {
                if (empty($item['id'])) {
                    $response['update'][] = [
                        'error' => [
                            'code' => 'missing_id',
                            'message' => 'ID is required for update',
                        ],
                    ];
                    continue;
                }
                
                $item_request = new WP_REST_Request('PUT');
                $item_request->set_param('id', $item['id']);
                unset($item['id']);
                $item_request->set_body_params($item);
                
                $result = $this->update_item($item_request);
                
                if (is_wp_error($result)) {
                    $response['update'][] = [
                        'id' => $item_request->get_param('id'),
                        'error' => [
                            'code' => $result->get_error_code(),
                            'message' => $result->get_error_message(),
                        ],
                    ];
                } else {
                    $response['update'][] = $result->get_data();
                }
            }
        }
        
        // Process deletes
        if (!empty($request['delete'])) {
            foreach ($request['delete'] as $id) {
                $item_request = new WP_REST_Request('DELETE');
                $item_request->set_param('id', $id);
                $item_request->set_param('force', true);
                
                $result = $this->delete_item($item_request);
                
                if (is_wp_error($result)) {
                    $response['delete'][] = [
                        'id' => $id,
                        'error' => [
                            'code' => $result->get_error_code(),
                            'message' => $result->get_error_message(),
                        ],
                    ];
                } else {
                    $response['delete'][] = $result->get_data();
                }
            }
        }
        
        return rest_ensure_response($response);
    }
    
    /**
     * Prepare item for response
     */
    protected function prepare_item($item) {
        $data = [
            'id' => $item->ID,
            'title' => $item->post_title,
            'slug' => $item->post_name,
            'content' => $item->post_content,
            'excerpt' => $item->post_excerpt,
            'date' => mysql_to_rfc3339($item->post_date),
            'modified' => mysql_to_rfc3339($item->post_modified),
            'status' => $item->post_status,
            'featured_image' => get_post_thumbnail_id($item->ID),
            'price' => get_post_meta($item->ID, '_price', true),
            'sku' => get_post_meta($item->ID, '_sku', true),
            'stock' => get_post_meta($item->ID, '_stock', true),
            'categories' => wp_get_post_terms($item->ID, 'product_category', ['fields' => 'ids']),
        ];
        
        return $data;
    }
    
    /**
     * Prepare item for database
     */
    protected function prepare_item_for_database($request) {
        $prepared_post = [];
        
        if (isset($request['title'])) {
            $prepared_post['post_title'] = $request['title'];
        }
        
        if (isset($request['content'])) {
            $prepared_post['post_content'] = $request['content'];
        }
        
        if (isset($request['excerpt'])) {
            $prepared_post['post_excerpt'] = $request['excerpt'];
        }
        
        if (isset($request['status'])) {
            $prepared_post['post_status'] = $request['status'];
        }
        
        return $prepared_post;
    }
    
    /**
     * Update post meta
     */
    protected function update_post_meta($post_id, $request) {
        if (isset($request['price'])) {
            update_post_meta($post_id, '_price', $request['price']);
        }
        
        if (isset($request['sku'])) {
            update_post_meta($post_id, '_sku', $request['sku']);
        }
        
        if (isset($request['stock'])) {
            update_post_meta($post_id, '_stock', $request['stock']);
        }
        
        if (isset($request['categories'])) {
            wp_set_object_terms($post_id, $request['categories'], 'product_category');
        }
    }
    
    /**
     * Get item schema
     */
    public function get_item_schema() {
        if ($this->schema) {
            return $this->add_additional_fields_schema($this->schema);
        }
        
        $schema = [
            '$schema' => 'http://json-schema.org/draft-04/schema#',
            'title' => 'product',
            'type' => 'object',
            'properties' => [
                'id' => [
                    'description' => 'Unique identifier for the product.',
                    'type' => 'integer',
                    'context' => ['view', 'edit', 'embed'],
                    'readonly' => true,
                ],
                'title' => [
                    'description' => 'The title of the product.',
                    'type' => 'string',
                    'context' => ['view', 'edit', 'embed'],
                    'required' => true,
                ],
                'content' => [
                    'description' => 'The content of the product.',
                    'type' => 'string',
                    'context' => ['view', 'edit'],
                ],
                'excerpt' => [
                    'description' => 'The excerpt of the product.',
                    'type' => 'string',
                    'context' => ['view', 'edit', 'embed'],
                ],
                'price' => [
                    'description' => 'The price of the product.',
                    'type' => 'number',
                    'context' => ['view', 'edit'],
                ],
                'sku' => [
                    'description' => 'The SKU of the product.',
                    'type' => 'string',
                    'context' => ['view', 'edit'],
                ],
                'stock' => [
                    'description' => 'The stock quantity.',
                    'type' => 'integer',
                    'context' => ['view', 'edit'],
                ],
                'categories' => [
                    'description' => 'Product categories.',
                    'type' => 'array',
                    'items' => [
                        'type' => 'integer',
                    ],
                    'context' => ['view', 'edit'],
                ],
            ],
        ];
        
        $this->schema = $schema;
        
        return $this->add_additional_fields_schema($this->schema);
    }
    
    /**
     * Permission check for creating items
     */
    public function create_item_permissions_check($request) {
        return current_user_can('edit_posts');
    }
    
    /**
     * Permission check for updating items
     */
    public function update_item_permissions_check($request) {
        $post = get_post($request['id']);
        
        if (!$post) {
            return false;
        }
        
        return current_user_can('edit_post', $post->ID);
    }
    
    /**
     * Permission check for deleting items
     */
    public function delete_item_permissions_check($request) {
        $post = get_post($request['id']);
        
        if (!$post) {
            return false;
        }
        
        return current_user_can('delete_post', $post->ID);
    }
    
    /**
     * Permission check for batch operations
     */
    public function batch_items_permissions_check($request) {
        return current_user_can('edit_posts');
    }
}

// Register controller
add_action('rest_api_init', function() {
    $controller = new Products_REST_Controller();
    $controller->register_routes();
});
                        </code></pre>
                    </section>
                    
                    <!-- Advanced Endpoints -->
                    <section>
                        <h2>Advanced Endpoint Patterns</h2>
                        
                        <h3>File Upload Endpoint</h3>
                        <pre><code class="language-php">
/**
 * File upload endpoint
 */
class File_Upload_Endpoint {
    
    public function __construct() {
        add_action('rest_api_init', [$this, 'register_upload_route']);
    }
    
    public function register_upload_route() {
        register_rest_route('myapi/v1', '/upload', [
            'methods' => 'POST',
            'callback' => [$this, 'handle_upload'],
            'permission_callback' => 'is_user_logged_in',
        ]);
    }
    
    public function handle_upload(WP_REST_Request $request) {
        $files = $request->get_file_params();
        
        if (empty($files)) {
            return new WP_Error(
                'no_file',
                'No file was uploaded',
                ['status' => 400]
            );
        }
        
        require_once(ABSPATH . 'wp-admin/includes/file.php');
        require_once(ABSPATH . 'wp-admin/includes/media.php');
        require_once(ABSPATH . 'wp-admin/includes/image.php');
        
        $uploaded_files = [];
        
        foreach ($files as $file) {
            // Check file type
            $allowed_types = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
            
            if (!in_array($file['type'], $allowed_types)) {
                continue;
            }
            
            // Check file size (5MB max)
            if ($file['size'] > 5 * 1024 * 1024) {
                continue;
            }
            
            $upload = wp_handle_upload($file, [
                'test_form' => false,
            ]);
            
            if (isset($upload['error'])) {
                continue;
            }
            
            // Create attachment
            $attachment_id = wp_insert_attachment([
                'post_mime_type' => $upload['type'],
                'post_title' => sanitize_file_name($file['name']),
                'post_content' => '',
                'post_status' => 'inherit',
            ], $upload['file']);
            
            // Generate metadata
            $attach_data = wp_generate_attachment_metadata($attachment_id, $upload['file']);
            wp_update_attachment_metadata($attachment_id, $attach_data);
            
            $uploaded_files[] = [
                'id' => $attachment_id,
                'url' => $upload['url'],
                'type' => $upload['type'],
                'name' => basename($upload['file']),
            ];
        }
        
        return new WP_REST_Response([
            'success' => true,
            'files' => $uploaded_files,
        ], 200);
    }
}

new File_Upload_Endpoint();
                        </code></pre>
                        
                        <h3>Search and Filter Endpoint</h3>
                        <pre><code class="language-php">
/**
 * Advanced search endpoint
 */
class Advanced_Search_Endpoint {
    
    public function __construct() {
        add_action('rest_api_init', [$this, 'register_search_route']);
    }
    
    public function register_search_route() {
        register_rest_route('myapi/v1', '/search', [
            'methods' => 'GET',
            'callback' => [$this, 'search'],
            'permission_callback' => '__return_true',
            'args' => [
                'q' => [
                    'required' => true,
                    'type' => 'string',
                    'sanitize_callback' => 'sanitize_text_field',
                ],
                'post_type' => [
                    'type' => 'array',
                    'items' => [
                        'type' => 'string',
                    ],
                    'default' => ['post', 'page'],
                ],
                'taxonomies' => [
                    'type' => 'object',
                ],
                'meta' => [
                    'type' => 'object',
                ],
                'date_from' => [
                    'type' => 'string',
                    'format' => 'date',
                ],
                'date_to' => [
                    'type' => 'string',
                    'format' => 'date',
                ],
                'per_page' => [
                    'type' => 'integer',
                    'default' => 10,
                    'minimum' => 1,
                    'maximum' => 100,
                ],
                'page' => [
                    'type' => 'integer',
                    'default' => 1,
                    'minimum' => 1,
                ],
            ],
        ]);
    }
    
    public function search(WP_REST_Request $request) {
        global $wpdb;
        
        $query = $request->get_param('q');
        $post_types = $request->get_param('post_type');
        $taxonomies = $request->get_param('taxonomies');
        $meta = $request->get_param('meta');
        $date_from = $request->get_param('date_from');
        $date_to = $request->get_param('date_to');
        $per_page = $request->get_param('per_page');
        $page = $request->get_param('page');
        
        // Build query arguments
        $args = [
            's' => $query,
            'post_type' => $post_types,
            'posts_per_page' => $per_page,
            'paged' => $page,
            'post_status' => 'publish',
        ];
        
        // Add taxonomy queries
        if (!empty($taxonomies)) {
            $tax_query = [];
            
            foreach ($taxonomies as $taxonomy => $terms) {
                $tax_query[] = [
                    'taxonomy' => $taxonomy,
                    'field' => 'term_id',
                    'terms' => $terms,
                ];
            }
            
            if (count($tax_query) > 1) {
                $tax_query['relation'] = 'AND';
            }
            
            $args['tax_query'] = $tax_query;
        }
        
        // Add meta queries
        if (!empty($meta)) {
            $meta_query = [];
            
            foreach ($meta as $key => $value) {
                $meta_query[] = [
                    'key' => $key,
                    'value' => $value,
                    'compare' => is_array($value) ? 'IN' : '=',
                ];
            }
            
            if (count($meta_query) > 1) {
                $meta_query['relation'] = 'AND';
            }
            
            $args['meta_query'] = $meta_query;
        }
        
        // Add date range
        if ($date_from || $date_to) {
            $date_query = [];
            
            if ($date_from) {
                $date_query['after'] = $date_from;
            }
            
            if ($date_to) {
                $date_query['before'] = $date_to;
            }
            
            $args['date_query'] = [$date_query];
        }
        
        // Perform search
        $query = new WP_Query($args);
        
        $results = [];
        
        foreach ($query->posts as $post) {
            $results[] = [
                'id' => $post->ID,
                'title' => $post->post_title,
                'excerpt' => wp_trim_words($post->post_excerpt ?: $post->post_content, 20),
                'url' => get_permalink($post->ID),
                'type' => $post->post_type,
                'date' => $post->post_date,
                'relevance' => $this->calculate_relevance($post, $query),
            ];
        }
        
        // Sort by relevance
        usort($results, function($a, $b) {
            return $b['relevance'] <=> $a['relevance'];
        });
        
        $response = new WP_REST_Response([
            'results' => $results,
            'total' => $query->found_posts,
            'pages' => $query->max_num_pages,
        ], 200);
        
        return $response;
    }
    
    private function calculate_relevance($post, $search_query) {
        $relevance = 0;
        $search_terms = explode(' ', strtolower($search_query));
        
        foreach ($search_terms as $term) {
            // Title matches (highest relevance)
            if (stripos($post->post_title, $term) !== false) {
                $relevance += 10;
            }
            
            // Content matches
            if (stripos($post->post_content, $term) !== false) {
                $relevance += 5;
            }
            
            // Excerpt matches
            if (stripos($post->post_excerpt, $term) !== false) {
                $relevance += 3;
            }
        }
        
        return $relevance;
    }
}

new Advanced_Search_Endpoint();
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>Custom endpoints extend WordPress REST API functionality</li>
                                <li>Controller pattern provides organized, reusable code</li>
                                <li>Proper validation and sanitization are essential</li>
                                <li>Permission callbacks ensure security</li>
                                <li>Batch operations improve efficiency</li>
                                <li>Schema definitions provide API documentation</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Endpoint Best Practices</h3>
                            <ul>
                                <li>Use semantic HTTP methods correctly</li>
                                <li>Implement comprehensive validation</li>
                                <li>Return appropriate HTTP status codes</li>
                                <li>Include pagination for collections</li>
                                <li>Document endpoints with schemas</li>
                                <li>Handle errors gracefully</li>
                                <li>Version your API namespace</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://developer.wordpress.org/rest-api/extending-the-rest-api/adding-custom-endpoints/" target="_blank">Adding Custom Endpoints</a></li>
                            <li><a href="https://developer.wordpress.org/rest-api/extending-the-rest-api/controller-classes/" target="_blank">Controller Classes</a></li>
                            <li><a href="https://developer.wordpress.org/rest-api/extending-the-rest-api/schema/" target="_blank">REST API Schema</a></li>
                            <li><a href="https://restfulapi.net/" target="_blank">RESTful API Design</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/rest_api_authentication.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            API Authentication
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/extending_core_endpoints.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            Extending Core Endpoints
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>