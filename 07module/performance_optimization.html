<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>WordPress Performance Optimization - PHP WordPress Course</title>
    <meta name="description" content="Master WordPress performance optimization techniques including caching, database optimization, and speed improvements.">
    <meta name="keywords" content="WordPress, performance, optimization, caching, speed, database">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="WordPress Performance Optimization">
    <meta property="og:description" content="Learn to optimize WordPress for maximum performance">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">Performance Optimization</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">WordPress Performance Optimization</h1>
                    <p class="lesson-subtitle">Maximize speed and efficiency of your WordPress sites</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Implement advanced caching strategies</li>
                        <li>Optimize database queries and structure</li>
                        <li>Configure server-level optimizations</li>
                        <li>Implement lazy loading and code splitting</li>
                        <li>Use performance monitoring tools</li>
                        <li>Apply WordPress-specific optimizations</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Performance Analysis -->
                    <section>
                        <h2>Performance Analysis and Monitoring</h2>
                        
                        <h3>Performance Monitoring Class</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * WordPress Performance Monitor
 */
class WP_Performance_Monitor {
    
    private static $instance = null;
    private $start_time;
    private $queries = [];
    private $timers = [];
    private $memory_peaks = [];
    
    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    private function __construct() {
        $this->start_time = microtime(true);
        
        // Hook into WordPress
        add_action('init', [$this, 'init_monitoring']);
        add_action('shutdown', [$this, 'log_performance']);
        add_filter('query', [$this, 'log_query']);
        
        // Admin bar integration
        add_action('admin_bar_menu', [$this, 'add_admin_bar_menu'], 999);
        add_action('wp_footer', [$this, 'display_frontend_stats'], 999);
        add_action('admin_footer', [$this, 'display_admin_stats'], 999);
    }
    
    /**
     * Initialize monitoring
     */
    public function init_monitoring() {
        // Start monitoring
        $this->start_timer('page_generation');
        
        // Monitor memory
        $this->memory_peaks['init'] = memory_get_peak_usage(true);
        
        // Database query monitoring
        if (defined('SAVEQUERIES') && SAVEQUERIES) {
            add_action('shutdown', [$this, 'analyze_queries'], 9);
        }
        
        // Asset loading monitoring
        add_action('wp_enqueue_scripts', [$this, 'monitor_assets'], 999);
        add_action('admin_enqueue_scripts', [$this, 'monitor_assets'], 999);
        
        // Hook monitoring
        add_action('all', [$this, 'monitor_hooks']);
    }
    
    /**
     * Start a timer
     */
    public function start_timer($name) {
        $this->timers[$name] = [
            'start' => microtime(true),
            'end' => null,
            'duration' => null
        ];
    }
    
    /**
     * Stop a timer
     */
    public function stop_timer($name) {
        if (isset($this->timers[$name])) {
            $this->timers[$name]['end'] = microtime(true);
            $this->timers[$name]['duration'] = 
                $this->timers[$name]['end'] - $this->timers[$name]['start'];
        }
    }
    
    /**
     * Log database query
     */
    public function log_query($query) {
        $this->queries[] = [
            'query' => $query,
            'time' => microtime(true),
            'backtrace' => debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS, 5)
        ];
        return $query;
    }
    
    /**
     * Analyze database queries
     */
    public function analyze_queries() {
        global $wpdb;
        
        if (!isset($wpdb->queries)) {
            return;
        }
        
        $total_time = 0;
        $slow_queries = [];
        $duplicate_queries = [];
        $query_types = [
            'SELECT' => 0,
            'INSERT' => 0,
            'UPDATE' => 0,
            'DELETE' => 0
        ];
        
        $query_hashes = [];
        
        foreach ($wpdb->queries as $query_data) {
            list($query, $elapsed, $caller) = $query_data;
            
            $total_time += $elapsed;
            
            // Identify slow queries (>0.05s)
            if ($elapsed > 0.05) {
                $slow_queries[] = [
                    'query' => $query,
                    'time' => $elapsed,
                    'caller' => $caller
                ];
            }
            
            // Track query types
            $query_type = strtoupper(substr(trim($query), 0, 6));
            if (isset($query_types[$query_type])) {
                $query_types[$query_type]++;
            }
            
            // Find duplicates
            $query_hash = md5($query);
            if (!isset($query_hashes[$query_hash])) {
                $query_hashes[$query_hash] = 0;
            }
            $query_hashes[$query_hash]++;
        }
        
        // Identify duplicate queries
        foreach ($query_hashes as $hash => $count) {
            if ($count > 1) {
                foreach ($wpdb->queries as $query_data) {
                    if (md5($query_data[0]) === $hash) {
                        $duplicate_queries[] = [
                            'query' => $query_data[0],
                            'count' => $count,
                            'caller' => $query_data[2]
                        ];
                        break;
                    }
                }
            }
        }
        
        // Store analysis
        $this->query_analysis = [
            'total_queries' => count($wpdb->queries),
            'total_time' => $total_time,
            'slow_queries' => $slow_queries,
            'duplicate_queries' => $duplicate_queries,
            'query_types' => $query_types
        ];
    }
    
    /**
     * Monitor asset loading
     */
    public function monitor_assets() {
        global $wp_scripts, $wp_styles;
        
        $this->assets = [
            'scripts' => [
                'registered' => count($wp_scripts->registered),
                'enqueued' => count($wp_scripts->queue),
                'size' => $this->calculate_assets_size($wp_scripts->queue, 'js')
            ],
            'styles' => [
                'registered' => count($wp_styles->registered),
                'enqueued' => count($wp_styles->queue),
                'size' => $this->calculate_assets_size($wp_styles->queue, 'css')
            ]
        ];
    }
    
    /**
     * Calculate total size of assets
     */
    private function calculate_assets_size($handles, $type) {
        global $wp_scripts, $wp_styles;
        
        $total_size = 0;
        $registry = $type === 'js' ? $wp_scripts : $wp_styles;
        
        foreach ($handles as $handle) {
            if (isset($registry->registered[$handle])) {
                $src = $registry->registered[$handle]->src;
                
                // Convert URL to file path
                if (strpos($src, home_url()) === 0) {
                    $file_path = str_replace(home_url(), ABSPATH, $src);
                    if (file_exists($file_path)) {
                        $total_size += filesize($file_path);
                    }
                }
            }
        }
        
        return $total_size;
    }
    
    /**
     * Monitor hooks
     */
    public function monitor_hooks($hook_name) {
        static $hook_count = [];
        
        if (!isset($hook_count[$hook_name])) {
            $hook_count[$hook_name] = 0;
        }
        $hook_count[$hook_name]++;
        
        $this->hook_stats = $hook_count;
    }
    
    /**
     * Add admin bar menu
     */
    public function add_admin_bar_menu($wp_admin_bar) {
        if (!current_user_can('manage_options')) {
            return;
        }
        
        $this->stop_timer('page_generation');
        
        $time = $this->timers['page_generation']['duration'];
        $memory = size_format(memory_get_peak_usage(true));
        $queries = isset($this->query_analysis) ? 
            $this->query_analysis['total_queries'] : 0;
        
        // Main node
        $wp_admin_bar->add_node([
            'id' => 'performance-monitor',
            'title' => sprintf(
                'âš¡ %.2fs | %s | %d queries',
                $time,
                $memory,
                $queries
            ),
            'href' => '#',
            'meta' => ['class' => 'performance-monitor-menu']
        ]);
        
        // Sub nodes
        $wp_admin_bar->add_node([
            'parent' => 'performance-monitor',
            'id' => 'pm-time',
            'title' => sprintf('â±ï¸ Page Generation: %.4fs', $time)
        ]);
        
        $wp_admin_bar->add_node([
            'parent' => 'performance-monitor',
            'id' => 'pm-memory',
            'title' => sprintf('ðŸ’¾ Memory Peak: %s', $memory)
        ]);
        
        if (isset($this->query_analysis)) {
            $wp_admin_bar->add_node([
                'parent' => 'performance-monitor',
                'id' => 'pm-queries',
                'title' => sprintf(
                    'ðŸ—„ï¸ Queries: %d (%.4fs)',
                    $this->query_analysis['total_queries'],
                    $this->query_analysis['total_time']
                )
            ]);
            
            if (!empty($this->query_analysis['slow_queries'])) {
                $wp_admin_bar->add_node([
                    'parent' => 'performance-monitor',
                    'id' => 'pm-slow-queries',
                    'title' => sprintf(
                        'ðŸŒ Slow Queries: %d',
                        count($this->query_analysis['slow_queries'])
                    )
                ]);
            }
        }
        
        if (isset($this->assets)) {
            $wp_admin_bar->add_node([
                'parent' => 'performance-monitor',
                'id' => 'pm-assets',
                'title' => sprintf(
                    'ðŸ“¦ Assets: %d JS (%s) | %d CSS (%s)',
                    $this->assets['scripts']['enqueued'],
                    size_format($this->assets['scripts']['size']),
                    $this->assets['styles']['enqueued'],
                    size_format($this->assets['styles']['size'])
                )
            ]);
        }
    }
    
    /**
     * Display detailed stats
     */
    public function display_frontend_stats() {
        if (!current_user_can('manage_options') || !isset($_GET['show_performance'])) {
            return;
        }
        
        ?>
        <div id="performance-monitor-details" style="
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #23282d;
            color: #fff;
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
            z-index: 99999;
            font-family: monospace;
        ">
            <h3>Performance Details</h3>
            
            <?php if (isset($this->query_analysis)): ?>
                <h4>Database Queries</h4>
                <p>Total: <?php echo $this->query_analysis['total_queries']; ?> 
                   (<?php echo number_format($this->query_analysis['total_time'], 4); ?>s)</p>
                
                <?php if (!empty($this->query_analysis['slow_queries'])): ?>
                    <h5>Slow Queries:</h5>
                    <ul>
                        <?php foreach ($this->query_analysis['slow_queries'] as $query): ?>
                            <li>
                                <?php echo esc_html(substr($query['query'], 0, 100)); ?>...
                                (<?php echo number_format($query['time'], 4); ?>s)
                                <br><small><?php echo esc_html($query['caller']); ?></small>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>
                
                <?php if (!empty($this->query_analysis['duplicate_queries'])): ?>
                    <h5>Duplicate Queries:</h5>
                    <ul>
                        <?php foreach ($this->query_analysis['duplicate_queries'] as $query): ?>
                            <li>
                                <?php echo esc_html(substr($query['query'], 0, 100)); ?>...
                                (Ã—<?php echo $query['count']; ?>)
                            </li>
                        <?php endforeach; ?>
                    </ul>
                <?php endif; ?>
            <?php endif; ?>
            
            <button onclick="document.getElementById('performance-monitor-details').style.display='none'"
                    style="position: absolute; top: 10px; right: 10px;">Ã—</button>
        </div>
        <?php
    }
    
    /**
     * Log performance data
     */
    public function log_performance() {
        if (!defined('WP_DEBUG') || !WP_DEBUG) {
            return;
        }
        
        $log_data = [
            'timestamp' => current_time('mysql'),
            'url' => $_SERVER['REQUEST_URI'],
            'generation_time' => $this->timers['page_generation']['duration'] ?? 0,
            'memory_peak' => memory_get_peak_usage(true),
            'queries' => $this->query_analysis['total_queries'] ?? 0,
            'query_time' => $this->query_analysis['total_time'] ?? 0
        ];
        
        // Log to file
        $log_file = WP_CONTENT_DIR . '/performance.log';
        error_log(json_encode($log_data) . "\n", 3, $log_file);
    }
}

// Initialize performance monitor
if (defined('WP_DEBUG') && WP_DEBUG) {
    WP_Performance_Monitor::get_instance();
}
                        </code></pre>
                    </section>
                    
                    <!-- Caching Strategies -->
                    <section>
                        <h2>Advanced Caching Implementation</h2>
                        
                        <h3>Multi-Layer Caching System</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * Advanced WordPress Caching System
 */
class Advanced_Cache_Manager {
    
    private $cache_group = 'advanced_cache';
    private $cache_time = 3600; // 1 hour default
    
    public function __construct() {
        // Page caching
        add_action('init', [$this, 'init_page_cache']);
        add_action('template_redirect', [$this, 'serve_cached_page'], 1);
        add_action('shutdown', [$this, 'save_page_cache']);
        
        // Fragment caching
        add_action('init', [$this, 'register_fragment_cache']);
        
        // Query caching
        add_filter('posts_pre_query', [$this, 'check_query_cache'], 10, 2);
        add_filter('posts_results', [$this, 'save_query_cache'], 10, 2);
        
        // Object caching optimization
        add_action('init', [$this, 'optimize_object_cache']);
        
        // Cache purging
        add_action('save_post', [$this, 'purge_post_cache']);
        add_action('comment_post', [$this, 'purge_comment_cache'], 10, 2);
        add_action('transition_post_status', [$this, 'purge_on_status_change'], 10, 3);
        
        // Admin interface
        add_action('admin_menu', [$this, 'add_admin_menu']);
        add_action('admin_bar_menu', [$this, 'add_admin_bar_menu'], 100);
        
        // REST API endpoints
        add_action('rest_api_init', [$this, 'register_rest_routes']);
    }
    
    /**
     * Initialize page caching
     */
    public function init_page_cache() {
        // Skip cache for logged-in users
        if (is_user_logged_in()) {
            return;
        }
        
        // Skip cache for specific pages
        if ($this->should_skip_cache()) {
            return;
        }
        
        // Start output buffering for page cache
        ob_start([$this, 'process_page_output']);
    }
    
    /**
     * Check if cache should be skipped
     */
    private function should_skip_cache() {
        // Skip for POST requests
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            return true;
        }
        
        // Skip for query strings (except allowed ones)
        if (!empty($_GET)) {
            $allowed_params = apply_filters('cache_allowed_query_params', ['utm_source', 'utm_medium']);
            $get_keys = array_keys($_GET);
            if (array_diff($get_keys, $allowed_params)) {
                return true;
            }
        }
        
        // Skip for specific URLs
        $skip_urls = [
            '/cart/',
            '/checkout/',
            '/my-account/',
            '/wp-admin/',
            '/wp-login.php'
        ];
        
        $current_url = $_SERVER['REQUEST_URI'];
        foreach ($skip_urls as $skip_url) {
            if (strpos($current_url, $skip_url) !== false) {
                return true;
            }
        }
        
        // Skip if no-cache cookie is set
        if (isset($_COOKIE['wordpress_no_cache'])) {
            return true;
        }
        
        return false;
    }
    
    /**
     * Serve cached page if available
     */
    public function serve_cached_page() {
        if (is_user_logged_in() || $this->should_skip_cache()) {
            return;
        }
        
        $cache_key = $this->get_page_cache_key();
        $cached_page = get_transient($cache_key);
        
        if ($cached_page !== false) {
            // Add cache headers
            header('X-Cache: HIT');
            header('X-Cache-Time: ' . $cached_page['time']);
            
            // Output cached content
            echo $cached_page['content'];
            
            // Add cache info comment
            echo "\n<!-- Served from cache at " . current_time('mysql') . " -->";
            
            exit;
        }
    }
    
    /**
     * Process page output for caching
     */
    public function process_page_output($content) {
        // Don't cache errors
        if (is_404() || is_error()) {
            return $content;
        }
        
        // Minify HTML
        $content = $this->minify_html($content);
        
        // Add cache timestamp
        $content .= "\n<!-- Cached at " . current_time('mysql') . " -->";
        
        return $content;
    }
    
    /**
     * Save page to cache
     */
    public function save_page_cache() {
        if (is_user_logged_in() || $this->should_skip_cache()) {
            return;
        }
        
        // Don't cache if there were errors
        if (is_404() || is_error()) {
            return;
        }
        
        $content = ob_get_contents();
        if (!empty($content)) {
            $cache_key = $this->get_page_cache_key();
            $cache_data = [
                'content' => $content,
                'time' => current_time('mysql')
            ];
            
            set_transient($cache_key, $cache_data, $this->cache_time);
        }
    }
    
    /**
     * Get page cache key
     */
    private function get_page_cache_key() {
        $url = $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
        $device = wp_is_mobile() ? 'mobile' : 'desktop';
        
        return 'page_cache_' . md5($url . $device);
    }
    
    /**
     * Fragment caching implementation
     */
    public function fragment_cache($key, $callback, $args = [], $expire = null) {
        $cache_key = 'fragment_' . md5($key . serialize($args));
        $cached = get_transient($cache_key);
        
        if ($cached === false) {
            ob_start();
            call_user_func_array($callback, $args);
            $cached = ob_get_clean();
            
            $expire = $expire ?: $this->cache_time;
            set_transient($cache_key, $cached, $expire);
        }
        
        return $cached;
    }
    
    /**
     * Query caching
     */
    public function check_query_cache($posts, $query) {
        // Skip if caching is disabled for this query
        if ($query->get('cache_results') === false) {
            return $posts;
        }
        
        $cache_key = $this->get_query_cache_key($query);
        $cached = wp_cache_get($cache_key, $this->cache_group);
        
        if ($cached !== false) {
            // Add cache hit header
            $query->set('cache_hit', true);
            return $cached;
        }
        
        return $posts;
    }
    
    /**
     * Save query results to cache
     */
    public function save_query_cache($posts, $query) {
        // Don't cache if already hit cache
        if ($query->get('cache_hit')) {
            return $posts;
        }
        
        // Don't cache if caching is disabled
        if ($query->get('cache_results') === false) {
            return $posts;
        }
        
        $cache_key = $this->get_query_cache_key($query);
        wp_cache_set($cache_key, $posts, $this->cache_group, $this->cache_time);
        
        return $posts;
    }
    
    /**
     * Get query cache key
     */
    private function get_query_cache_key($query) {
        $vars = $query->query_vars;
        
        // Remove non-deterministic values
        unset($vars['cache_results']);
        unset($vars['cache_hit']);
        unset($vars['fields']);
        
        return 'query_' . md5(serialize($vars));
    }
    
    /**
     * Optimize object cache
     */
    public function optimize_object_cache() {
        // Preload commonly used options
        $preload_options = [
            'siteurl',
            'home',
            'blogname',
            'blogdescription',
            'users_can_register',
            'default_role',
            'timezone_string',
            'date_format',
            'time_format',
            'start_of_week'
        ];
        
        wp_cache_get_multiple($preload_options, 'options');
        
        // Preload active plugins
        wp_cache_get('active_plugins', 'options');
        
        // Preload current theme
        wp_cache_get('stylesheet', 'options');
        wp_cache_get('template', 'options');
    }
    
    /**
     * Minify HTML
     */
    private function minify_html($html) {
        // Remove HTML comments (keep IE conditionals)
        $html = preg_replace('/<!--(?!\[if).*?-->/s', '', $html);
        
        // Remove whitespace between tags
        $html = preg_replace('/>\s+</', '><', $html);
        
        // Remove leading/trailing whitespace
        $html = trim($html);
        
        return $html;
    }
    
    /**
     * Purge post cache
     */
    public function purge_post_cache($post_id) {
        // Clear page cache for post
        $permalink = get_permalink($post_id);
        $this->purge_url_cache($permalink);
        
        // Clear archive pages
        $this->purge_archive_cache($post_id);
        
        // Clear home page
        $this->purge_url_cache(home_url('/'));
        
        // Clear related query caches
        wp_cache_flush_group($this->cache_group);
    }
    
    /**
     * Purge URL cache
     */
    private function purge_url_cache($url) {
        $parsed = parse_url($url);
        $cache_key = 'page_cache_' . md5($parsed['host'] . $parsed['path']);
        
        delete_transient($cache_key . '_desktop');
        delete_transient($cache_key . '_mobile');
    }
    
    /**
     * Purge archive cache
     */
    private function purge_archive_cache($post_id) {
        $post = get_post($post_id);
        
        // Clear category archives
        $categories = wp_get_post_categories($post_id);
        foreach ($categories as $cat_id) {
            $url = get_category_link($cat_id);
            $this->purge_url_cache($url);
        }
        
        // Clear tag archives
        $tags = wp_get_post_tags($post_id);
        foreach ($tags as $tag) {
            $url = get_tag_link($tag->term_id);
            $this->purge_url_cache($url);
        }
        
        // Clear date archives
        $year = get_the_date('Y', $post_id);
        $month = get_the_date('m', $post_id);
        
        $this->purge_url_cache(get_year_link($year));
        $this->purge_url_cache(get_month_link($year, $month));
        
        // Clear author archive
        $author_id = $post->post_author;
        $this->purge_url_cache(get_author_posts_url($author_id));
    }
}

// Initialize cache manager
new Advanced_Cache_Manager();

/**
 * Helper function for fragment caching
 */
function fragment_cache($key, $callback, $args = [], $expire = null) {
    $cache = new Advanced_Cache_Manager();
    return $cache->fragment_cache($key, $callback, $args, $expire);
}
                        </code></pre>
                    </section>
                    
                    <!-- Database Optimization -->
                    <section>
                        <h2>Database Optimization</h2>
                        
                        <h3>Database Optimizer Class</h3>
                        <pre><code class="language-php">
&lt;?php
/**
 * WordPress Database Optimizer
 */
class WP_Database_Optimizer {
    
    private $optimization_queries = [];
    
    public function __construct() {
        add_action('init', [$this, 'schedule_optimization']);
        add_action('wp_db_optimization', [$this, 'run_optimization']);
        add_action('admin_menu', [$this, 'add_admin_menu']);
        
        // Custom query optimizations
        add_filter('posts_request', [$this, 'optimize_query'], 10, 2);
        add_filter('posts_clauses', [$this, 'optimize_clauses'], 10, 2);
        
        // Index management
        add_action('init', [$this, 'check_indexes']);
    }
    
    /**
     * Schedule regular optimization
     */
    public function schedule_optimization() {
        if (!wp_next_scheduled('wp_db_optimization')) {
            wp_schedule_event(time(), 'weekly', 'wp_db_optimization');
        }
    }
    
    /**
     * Run database optimization
     */
    public function run_optimization() {
        global $wpdb;
        
        // Optimize tables
        $tables = $wpdb->get_col("SHOW TABLES");
        foreach ($tables as $table) {
            $wpdb->query("OPTIMIZE TABLE `$table`");
        }
        
        // Clean up transients
        $this->cleanup_transients();
        
        // Clean up post revisions
        $this->cleanup_revisions();
        
        // Clean up auto-drafts
        $this->cleanup_autodrafts();
        
        // Clean up spam comments
        $this->cleanup_spam_comments();
        
        // Clean up orphaned meta
        $this->cleanup_orphaned_meta();
        
        // Update statistics
        $wpdb->query("ANALYZE TABLE " . implode(', ', $tables));
        
        // Log optimization
        $this->log_optimization();
    }
    
    /**
     * Clean up expired transients
     */
    private function cleanup_transients() {
        global $wpdb;
        
        // Delete expired transients
        $wpdb->query(
            "DELETE FROM {$wpdb->options} 
             WHERE option_name LIKE '_transient_timeout_%' 
             AND option_value < UNIX_TIMESTAMP()"
        );
        
        // Delete orphaned transient values
        $wpdb->query(
            "DELETE FROM {$wpdb->options} 
             WHERE option_name LIKE '_transient_%' 
             AND option_name NOT IN (
                SELECT CONCAT('_transient_', SUBSTRING(option_name, 19)) 
                FROM (SELECT option_name FROM {$wpdb->options} WHERE option_name LIKE '_transient_timeout_%') AS t
             )"
        );
    }
    
    /**
     * Clean up post revisions
     */
    private function cleanup_revisions($keep = 5) {
        global $wpdb;
        
        // Keep only last N revisions per post
        $query = "
            DELETE FROM {$wpdb->posts} 
            WHERE post_type = 'revision' 
            AND ID NOT IN (
                SELECT * FROM (
                    SELECT ID FROM {$wpdb->posts} r1 
                    WHERE r1.post_type = 'revision' 
                    AND (
                        SELECT COUNT(*) FROM {$wpdb->posts} r2 
                        WHERE r2.post_parent = r1.post_parent 
                        AND r2.post_type = 'revision' 
                        AND r2.ID >= r1.ID
                    ) <= %d
                ) AS t
            )
        ";
        
        $wpdb->query($wpdb->prepare($query, $keep));
    }
    
    /**
     * Check and create missing indexes
     */
    public function check_indexes() {
        global $wpdb;
        
        $indexes = [
            // Postmeta indexes
            [
                'table' => $wpdb->postmeta,
                'name' => 'meta_key_value',
                'columns' => 'meta_key(191), meta_value(100)'
            ],
            // Comments indexes
            [
                'table' => $wpdb->comments,
                'name' => 'comment_approved_date',
                'columns' => 'comment_approved, comment_date_gmt'
            ],
            // Options indexes
            [
                'table' => $wpdb->options,
                'name' => 'autoload',
                'columns' => 'autoload'
            ]
        ];
        
        foreach ($indexes as $index) {
            $this->create_index_if_not_exists(
                $index['table'],
                $index['name'],
                $index['columns']
            );
        }
    }
    
    /**
     * Create index if it doesn't exist
     */
    private function create_index_if_not_exists($table, $index_name, $columns) {
        global $wpdb;
        
        $index_exists = $wpdb->get_var(
            $wpdb->prepare(
                "SHOW INDEX FROM $table WHERE Key_name = %s",
                $index_name
            )
        );
        
        if (!$index_exists) {
            $wpdb->query("CREATE INDEX $index_name ON $table ($columns)");
        }
    }
    
    /**
     * Optimize query
     */
    public function optimize_query($request, $query) {
        // Add SQL_CALC_FOUND_ROWS only when necessary
        if (!$query->is_single() && !$query->is_page()) {
            if (strpos($request, 'SQL_CALC_FOUND_ROWS') !== false && 
                $query->get('no_found_rows')) {
                $request = str_replace('SQL_CALC_FOUND_ROWS', '', $request);
            }
        }
        
        // Use STRAIGHT_JOIN for complex queries
        if (substr_count($request, 'JOIN') > 2) {
            $request = str_replace('SELECT', 'SELECT STRAIGHT_JOIN', $request);
        }
        
        return $request;
    }
    
    /**
     * Database statistics
     */
    public function get_database_stats() {
        global $wpdb;
        
        $stats = [];
        
        // Table sizes
        $tables = $wpdb->get_results("
            SELECT 
                table_name AS 'Table',
                round(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
            FROM information_schema.TABLES
            WHERE table_schema = '" . DB_NAME . "'
            ORDER BY (data_length + index_length) DESC
        ");
        
        $stats['tables'] = $tables;
        
        // Total database size
        $total_size = $wpdb->get_var("
            SELECT sum(round(((data_length + index_length) / 1024 / 1024), 2))
            FROM information_schema.TABLES
            WHERE table_schema = '" . DB_NAME . "'
        ");
        
        $stats['total_size'] = $total_size;
        
        // Count records
        $stats['posts'] = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->posts}");
        $stats['comments'] = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->comments}");
        $stats['users'] = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->users}");
        $stats['terms'] = $wpdb->get_var("SELECT COUNT(*) FROM {$wpdb->terms}");
        
        // Transients
        $stats['transients'] = $wpdb->get_var(
            "SELECT COUNT(*) FROM {$wpdb->options} WHERE option_name LIKE '%_transient_%'"
        );
        
        // Autoloaded data
        $stats['autoload_size'] = $wpdb->get_var(
            "SELECT SUM(LENGTH(option_value)) FROM {$wpdb->options} WHERE autoload = 'yes'"
        );
        
        return $stats;
    }
}

// Initialize optimizer
new WP_Database_Optimizer();
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>Performance monitoring is essential for optimization</li>
                                <li>Multi-layer caching significantly improves speed</li>
                                <li>Database optimization reduces query times</li>
                                <li>Regular maintenance keeps sites running fast</li>
                                <li>Measure before and after optimization</li>
                                <li>Consider server-level optimizations</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Performance Best Practices</h3>
                            <ul>
                                <li>Implement caching at multiple levels</li>
                                <li>Optimize database queries and indexes</li>
                                <li>Minimize HTTP requests</li>
                                <li>Use CDN for static assets</li>
                                <li>Lazy load images and videos</li>
                                <li>Minify CSS and JavaScript</li>
                                <li>Regular performance audits</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://developer.wordpress.org/plugins/performance/" target="_blank">WordPress Performance Guide</a></li>
                            <li><a href="https://web.dev/measure/" target="_blank">Google PageSpeed Insights</a></li>
                            <li><a href="https://gtmetrix.com/" target="_blank">GTmetrix</a></li>
                            <li><a href="https://tools.pingdom.com/" target="_blank">Pingdom Tools</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/homework_gutenberg.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            Gutenberg Homework
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/caching_strategies.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            Caching Strategies
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>