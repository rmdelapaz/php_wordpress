<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>REST API Authentication Methods - PHP WordPress Course</title>
    <meta name="description" content="Master WordPress REST API authentication. Learn cookie authentication, application passwords, OAuth, JWT, and custom authentication methods.">
    <meta name="keywords" content="WordPress, REST API, authentication, OAuth, JWT, security">
    <meta name="author" content="PHP WordPress Course">
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="REST API Authentication Methods">
    <meta property="og:description" content="Secure your WordPress REST API with proper authentication">
    <meta property="og:type" content="article">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    
    <!-- Prism.js for syntax highlighting -->
    <link href="/assets/css/prism.css" rel="stylesheet">
</head>
<body>
    <!-- Skip to main content -->
    <a href="#main-content" class="sr-only">Skip to main content</a>
    
    <div class="page-wrapper">
        <!-- Header -->
        <header class="site-header" role="banner">
            <div class="header-container">
                <div class="site-branding">
                    <a href="/" class="site-logo">
                        <h1 class="site-title">PHP WordPress Development</h1>
                    </a>
                </div>
                
                <nav class="main-navigation" role="navigation" aria-label="Main navigation">
                    <button class="mobile-menu-btn" aria-label="Toggle navigation" aria-expanded="false">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="nav-menu">
                        <ul class="nav-list">
                            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                            <li class="nav-item dropdown">
                                <button class="nav-link dropdown-toggle active" aria-haspopup="true">Modules</button>
                                <div class="dropdown-menu">
                                    <a href="/module1.html" class="dropdown-item">Module 1: Web Fundamentals</a>
                                    <a href="/module2.html" class="dropdown-item">Module 2: PHP Fundamentals</a>
                                    <a href="/module3.html" class="dropdown-item">Module 3: MySQL Database</a>
                                    <a href="/module4.html" class="dropdown-item">Module 4: WordPress & Docker</a>
                                    <a href="/module5.html" class="dropdown-item">Module 5: Theme Development</a>
                                    <a href="/module6.html" class="dropdown-item">Module 6: Plugin Development</a>
                                    <a href="/module7.html" class="dropdown-item active">Module 7: Advanced WordPress</a>
                                    <a href="/module8.html" class="dropdown-item">Module 8: Deployment</a>
                                    <a href="/module9.html" class="dropdown-item">Module 9: Final Project</a>
                                </div>
                            </li>
                            <li class="nav-item"><a href="/resources.html" class="nav-link">Resources</a></li>
                            <li class="nav-item"><a href="/about.html" class="nav-link">About</a></li>
                        </ul>
                    </div>
                </nav>
                
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                        <input type="search" class="search-input" placeholder="Search lessons..." aria-label="Search">
                    </div>
                    <div class="search-results"></div>
                </div>
            </div>
        </header>
        
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-header">
                <h2 class="progress-title">Course Progress</h2>
                <span class="progress-text">Loading...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Breadcrumb -->
        <nav class="breadcrumb container" aria-label="Breadcrumb">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/">Home</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <a href="/module7.html">Module 7</a>
                    <span class="breadcrumb-separator">/</span>
                </li>
                <li class="breadcrumb-item">
                    <span aria-current="page">API Authentication</span>
                </li>
            </ol>
        </nav>
        
        <!-- Main Content -->
        <main id="main-content" class="main-content" role="main">
            <div class="container">
                <!-- Lesson Header -->
                <div class="lesson-header">
                    <h1 class="lesson-title">REST API Authentication Methods</h1>
                    <p class="lesson-subtitle">Implement secure authentication for your WordPress REST API</p>
                </div>
                
                <!-- Learning Objectives -->
                <div class="lesson-objectives">
                    <h2>Learning Objectives</h2>
                    <p>By the end of this lesson, you will be able to:</p>
                    <ul>
                        <li>Implement cookie authentication for logged-in users</li>
                        <li>Set up application passwords</li>
                        <li>Create JWT authentication system</li>
                        <li>Implement OAuth 2.0 authentication</li>
                        <li>Build custom authentication methods</li>
                        <li>Secure API endpoints properly</li>
                    </ul>
                </div>
                
                <!-- Lesson Body -->
                <div class="lesson-body">
                    <!-- Cookie Authentication -->
                    <section>
                        <h2>Cookie Authentication</h2>
                        
                        <h3>WordPress Native Authentication</h3>
                        <pre><code class="language-php">
/**
 * Cookie Authentication (Built-in)
 * Works automatically for logged-in users with nonce verification
 */
class Cookie_Authentication {
    
    public function __construct() {
        // Cookie auth works out of the box for logged-in users
        // But requires nonce for security
        add_action('wp_enqueue_scripts', [$this, 'localize_nonce']);
        add_filter('rest_authentication_errors', [$this, 'check_authentication']);
    }
    
    /**
     * Provide nonce to JavaScript
     */
    public function localize_nonce() {
        wp_localize_script('my-api-script', 'wpApiSettings', [
            'root' => esc_url_raw(rest_url()),
            'nonce' => wp_create_nonce('wp_rest'),
        ]);
    }
    
    /**
     * Verify cookie authentication
     */
    public function check_authentication($error) {
        // If error already set, return it
        if (!empty($error)) {
            return $error;
        }
        
        // Check if user is logged in via cookie
        if (is_user_logged_in()) {
            // Verify nonce for non-GET requests
            if ($_SERVER['REQUEST_METHOD'] !== 'GET') {
                $nonce = $_SERVER['HTTP_X_WP_NONCE'] ?? '';
                
                if (!wp_verify_nonce($nonce, 'wp_rest')) {
                    return new WP_Error(
                        'rest_cookie_invalid_nonce',
                        'Cookie nonce is invalid',
                        ['status' => 403]
                    );
                }
            }
            
            return true;
        }
        
        return $error;
    }
}

// JavaScript implementation for cookie auth
?>
<script>
// Using cookie authentication with fetch
async function apiRequestWithCookie(endpoint, options = {}) {
    const response = await fetch(wpApiSettings.root + endpoint, {
        ...options,
        credentials: 'include', // Include cookies
        headers: {
            ...options.headers,
            'X-WP-Nonce': wpApiSettings.nonce,
            'Content-Type': 'application/json',
        },
    });
    
    if (!response.ok) {
        throw new Error(`API request failed: ${response.statusText}`);
    }
    
    return response.json();
}

// Example usage
apiRequestWithCookie('wp/v2/posts', {
    method: 'POST',
    body: JSON.stringify({
        title: 'New Post',
        content: 'Post content',
        status: 'draft',
    }),
}).then(post => {
    console.log('Post created:', post);
});

// Using jQuery (if available)
jQuery.ajax({
    url: wpApiSettings.root + 'wp/v2/posts',
    method: 'POST',
    beforeSend: function(xhr) {
        xhr.setRequestHeader('X-WP-Nonce', wpApiSettings.nonce);
    },
    data: {
        title: 'New Post',
        content: 'Post content',
    },
}).done(function(response) {
    console.log('Post created:', response);
});
</script>
                        </code></pre>
                    </section>
                    
                    <!-- Application Passwords -->
                    <section>
                        <h2>Application Passwords</h2>
                        
                        <h3>WordPress 5.6+ Built-in Feature</h3>
                        <pre><code class="language-php">
/**
 * Application Passwords Authentication
 * Available in WordPress 5.6+
 */
class Application_Passwords_Handler {
    
    public function __construct() {
        // Enable application passwords
        add_filter('wp_is_application_passwords_available', '__return_true');
        
        // Customize application passwords
        add_action('rest_api_init', [$this, 'setup_app_passwords']);
        add_filter('application_password_is_api_request', [$this, 'is_api_request']);
        add_filter('application_password_did_authenticate', [$this, 'log_authentication'], 10, 2);
    }
    
    /**
     * Setup application passwords
     */
    public function setup_app_passwords() {
        // Application passwords work automatically with Basic Auth
        // Username: WordPress username
        // Password: Application password (not regular password)
    }
    
    /**
     * Check if request should use app passwords
     */
    public function is_api_request($is_api_request) {
        // Check custom conditions
        if (strpos($_SERVER['REQUEST_URI'], '/wp-json/') !== false) {
            return true;
        }
        
        return $is_api_request;
    }
    
    /**
     * Log successful authentication
     */
    public function log_authentication($user, $app_password) {
        if ($user) {
            // Log the authentication
            error_log(sprintf(
                'User %s authenticated via app password: %s',
                $user->user_login,
                $app_password['name']
            ));
            
            // Update last used time
            $this->update_app_password_last_used($user->ID, $app_password['uuid']);
        }
    }
    
    /**
     * Create application password programmatically
     */
    public function create_app_password($user_id, $name) {
        if (!function_exists('wp_generate_password')) {
            require_once ABSPATH . 'wp-includes/pluggable.php';
        }
        
        $password = wp_generate_password(24, false);
        $hashed = wp_hash_password($password);
        
        $app_passwords = get_user_meta($user_id, '_application_passwords', true);
        if (!$app_passwords) {
            $app_passwords = [];
        }
        
        $app_passwords[] = [
            'uuid' => wp_generate_uuid4(),
            'app_id' => '',
            'name' => $name,
            'password' => $hashed,
            'created' => time(),
            'last_used' => null,
            'last_ip' => null,
        ];
        
        update_user_meta($user_id, '_application_passwords', $app_passwords);
        
        return $password; // Return unhashed password to show user once
    }
    
    /**
     * Revoke application password
     */
    public function revoke_app_password($user_id, $uuid) {
        $app_passwords = get_user_meta($user_id, '_application_passwords', true);
        
        if ($app_passwords) {
            $app_passwords = array_filter($app_passwords, function($item) use ($uuid) {
                return $item['uuid'] !== $uuid;
            });
            
            update_user_meta($user_id, '_application_passwords', array_values($app_passwords));
            return true;
        }
        
        return false;
    }
    
    /**
     * Update last used time
     */
    private function update_app_password_last_used($user_id, $uuid) {
        $app_passwords = get_user_meta($user_id, '_application_passwords', true);
        
        if ($app_passwords) {
            foreach ($app_passwords as &$app_password) {
                if ($app_password['uuid'] === $uuid) {
                    $app_password['last_used'] = time();
                    $app_password['last_ip'] = $_SERVER['REMOTE_ADDR'] ?? '';
                    break;
                }
            }
            
            update_user_meta($user_id, '_application_passwords', $app_passwords);
        }
    }
}

// Client-side usage with application passwords
?>
<script>
// Using application passwords with Basic Auth
async function apiRequestWithAppPassword(endpoint, username, appPassword, options = {}) {
    const credentials = btoa(`${username}:${appPassword}`);
    
    const response = await fetch(`https://example.com/wp-json/${endpoint}`, {
        ...options,
        headers: {
            ...options.headers,
            'Authorization': `Basic ${credentials}`,
            'Content-Type': 'application/json',
        },
    });
    
    if (!response.ok) {
        throw new Error(`API request failed: ${response.statusText}`);
    }
    
    return response.json();
}

// Example usage
apiRequestWithAppPassword(
    'wp/v2/posts',
    'username',
    'xxxx xxxx xxxx xxxx xxxx xxxx', // Application password
    {
        method: 'GET',
    }
).then(posts => {
    console.log('Posts:', posts);
});
</script>
                        </code></pre>
                    </section>
                    
                    <!-- JWT Authentication -->
                    <section>
                        <h2>JWT Authentication</h2>
                        
                        <h3>JSON Web Token Implementation</h3>
                        <pre><code class="language-php">
/**
 * JWT Authentication System
 * Requires custom implementation
 */
class JWT_Authentication {
    
    private $jwt_secret;
    private $jwt_algo = 'HS256';
    
    public function __construct() {
        $this->jwt_secret = defined('JWT_AUTH_SECRET_KEY') ? JWT_AUTH_SECRET_KEY : wp_salt();
        
        add_action('rest_api_init', [$this, 'register_routes']);
        add_filter('rest_authentication_errors', [$this, 'jwt_auth_handler']);
        add_filter('rest_pre_dispatch', [$this, 'rest_pre_dispatch'], 10, 2);
    }
    
    /**
     * Register authentication routes
     */
    public function register_routes() {
        // Token endpoint
        register_rest_route('jwt-auth/v1', '/token', [
            'methods' => 'POST',
            'callback' => [$this, 'generate_token'],
            'permission_callback' => '__return_true',
            'args' => [
                'username' => [
                    'required' => true,
                    'type' => 'string',
                ],
                'password' => [
                    'required' => true,
                    'type' => 'string',
                ],
            ],
        ]);
        
        // Validate token endpoint
        register_rest_route('jwt-auth/v1', '/token/validate', [
            'methods' => 'POST',
            'callback' => [$this, 'validate_token'],
            'permission_callback' => '__return_true',
        ]);
        
        // Refresh token endpoint
        register_rest_route('jwt-auth/v1', '/token/refresh', [
            'methods' => 'POST',
            'callback' => [$this, 'refresh_token'],
            'permission_callback' => '__return_true',
        ]);
    }
    
    /**
     * Generate JWT token
     */
    public function generate_token(WP_REST_Request $request) {
        $username = $request->get_param('username');
        $password = $request->get_param('password');
        
        // Authenticate user
        $user = wp_authenticate($username, $password);
        
        if (is_wp_error($user)) {
            return new WP_Error(
                'jwt_auth_failed',
                'Invalid credentials',
                ['status' => 401]
            );
        }
        
        // Generate token
        $token = $this->create_token($user);
        
        // Generate refresh token
        $refresh_token = $this->create_refresh_token($user);
        
        return new WP_REST_Response([
            'token' => $token,
            'refresh_token' => $refresh_token,
            'user_email' => $user->user_email,
            'user_nicename' => $user->user_nicename,
            'user_display_name' => $user->display_name,
            'expires_in' => 3600, // 1 hour
        ], 200);
    }
    
    /**
     * Create JWT token
     */
    private function create_token($user) {
        $issued_at = time();
        $not_before = $issued_at;
        $expire = $issued_at + (60 * 60); // 1 hour
        
        $payload = [
            'iss' => get_bloginfo('url'),
            'iat' => $issued_at,
            'nbf' => $not_before,
            'exp' => $expire,
            'data' => [
                'user' => [
                    'id' => $user->ID,
                    'email' => $user->user_email,
                    'login' => $user->user_login,
                ],
            ],
        ];
        
        return $this->encode_token($payload);
    }
    
    /**
     * Create refresh token
     */
    private function create_refresh_token($user) {
        $issued_at = time();
        $expire = $issued_at + (60 * 60 * 24 * 30); // 30 days
        
        $payload = [
            'iss' => get_bloginfo('url'),
            'iat' => $issued_at,
            'exp' => $expire,
            'data' => [
                'user' => [
                    'id' => $user->ID,
                ],
                'type' => 'refresh',
            ],
        ];
        
        $token = $this->encode_token($payload);
        
        // Store refresh token in database
        update_user_meta($user->ID, 'jwt_refresh_token', wp_hash($token));
        update_user_meta($user->ID, 'jwt_refresh_token_exp', $expire);
        
        return $token;
    }
    
    /**
     * Encode JWT token
     */
    private function encode_token($payload) {
        $header = json_encode(['typ' => 'JWT', 'alg' => $this->jwt_algo]);
        $payload = json_encode($payload);
        
        $base64Header = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($header));
        $base64Payload = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($payload));
        
        $signature = hash_hmac('sha256', $base64Header . '.' . $base64Payload, $this->jwt_secret, true);
        $base64Signature = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($signature));
        
        return $base64Header . '.' . $base64Payload . '.' . $base64Signature;
    }
    
    /**
     * Decode and verify JWT token
     */
    private function decode_token($token) {
        $parts = explode('.', $token);
        
        if (count($parts) !== 3) {
            return false;
        }
        
        $header = json_decode(base64_decode($parts[0]), true);
        $payload = json_decode(base64_decode($parts[1]), true);
        
        // Verify signature
        $signature = hash_hmac('sha256', $parts[0] . '.' . $parts[1], $this->jwt_secret, true);
        $base64Signature = str_replace(['+', '/', '='], ['-', '_', ''], base64_encode($signature));
        
        if ($base64Signature !== $parts[2]) {
            return false;
        }
        
        // Check expiration
        if (isset($payload['exp']) && $payload['exp'] < time()) {
            return false;
        }
        
        return $payload;
    }
    
    /**
     * Validate token endpoint
     */
    public function validate_token(WP_REST_Request $request) {
        $auth = $this->get_auth_header();
        
        if (!$auth) {
            return new WP_Error(
                'jwt_auth_no_token',
                'Token not provided',
                ['status' => 401]
            );
        }
        
        $token = str_replace('Bearer ', '', $auth);
        $payload = $this->decode_token($token);
        
        if (!$payload) {
            return new WP_Error(
                'jwt_auth_invalid_token',
                'Token is invalid',
                ['status' => 401]
            );
        }
        
        return new WP_REST_Response([
            'code' => 'jwt_auth_valid_token',
            'data' => [
                'status' => 200,
            ],
        ], 200);
    }
    
    /**
     * Refresh token endpoint
     */
    public function refresh_token(WP_REST_Request $request) {
        $refresh_token = $request->get_param('refresh_token');
        
        if (!$refresh_token) {
            return new WP_Error(
                'jwt_auth_no_token',
                'Refresh token not provided',
                ['status' => 401]
            );
        }
        
        $payload = $this->decode_token($refresh_token);
        
        if (!$payload || !isset($payload['data']['type']) || $payload['data']['type'] !== 'refresh') {
            return new WP_Error(
                'jwt_auth_invalid_token',
                'Invalid refresh token',
                ['status' => 401]
            );
        }
        
        $user_id = $payload['data']['user']['id'];
        $stored_token = get_user_meta($user_id, 'jwt_refresh_token', true);
        
        if (wp_hash($refresh_token) !== $stored_token) {
            return new WP_Error(
                'jwt_auth_invalid_token',
                'Refresh token mismatch',
                ['status' => 401]
            );
        }
        
        $user = get_user_by('id', $user_id);
        
        if (!$user) {
            return new WP_Error(
                'jwt_auth_user_not_found',
                'User not found',
                ['status' => 404]
            );
        }
        
        // Generate new tokens
        $new_token = $this->create_token($user);
        $new_refresh_token = $this->create_refresh_token($user);
        
        return new WP_REST_Response([
            'token' => $new_token,
            'refresh_token' => $new_refresh_token,
            'expires_in' => 3600,
        ], 200);
    }
    
    /**
     * JWT authentication handler
     */
    public function jwt_auth_handler($error) {
        if (!empty($error)) {
            return $error;
        }
        
        $auth = $this->get_auth_header();
        
        if (!$auth) {
            return $error;
        }
        
        $token = str_replace('Bearer ', '', $auth);
        $payload = $this->decode_token($token);
        
        if ($payload && isset($payload['data']['user']['id'])) {
            wp_set_current_user($payload['data']['user']['id']);
            return true;
        }
        
        return new WP_Error(
            'jwt_auth_invalid_token',
            'Invalid authentication token',
            ['status' => 401]
        );
    }
    
    /**
     * Get authorization header
     */
    private function get_auth_header() {
        $auth = isset($_SERVER['HTTP_AUTHORIZATION']) ? $_SERVER['HTTP_AUTHORIZATION'] : false;
        
        if (!$auth) {
            $auth = isset($_SERVER['REDIRECT_HTTP_AUTHORIZATION']) ? $_SERVER['REDIRECT_HTTP_AUTHORIZATION'] : false;
        }
        
        return $auth;
    }
    
    /**
     * Pre-dispatch to allow JWT auth for all routes
     */
    public function rest_pre_dispatch($result, $server) {
        if (is_user_logged_in()) {
            return $result;
        }
        
        $auth = $this->get_auth_header();
        
        if ($auth) {
            $token = str_replace('Bearer ', '', $auth);
            $payload = $this->decode_token($token);
            
            if ($payload && isset($payload['data']['user']['id'])) {
                wp_set_current_user($payload['data']['user']['id']);
            }
        }
        
        return $result;
    }
}

// Initialize JWT authentication
new JWT_Authentication();

// Client-side JWT usage
?>
<script>
class JWTClient {
    constructor(apiUrl) {
        this.apiUrl = apiUrl;
        this.token = localStorage.getItem('jwt_token');
        this.refreshToken = localStorage.getItem('jwt_refresh_token');
    }
    
    async login(username, password) {
        const response = await fetch(`${this.apiUrl}/jwt-auth/v1/token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, password }),
        });
        
        if (!response.ok) {
            throw new Error('Login failed');
        }
        
        const data = await response.json();
        this.token = data.token;
        this.refreshToken = data.refresh_token;
        
        localStorage.setItem('jwt_token', this.token);
        localStorage.setItem('jwt_refresh_token', this.refreshToken);
        
        return data;
    }
    
    async request(endpoint, options = {}) {
        if (!this.token) {
            throw new Error('Not authenticated');
        }
        
        const response = await fetch(`${this.apiUrl}${endpoint}`, {
            ...options,
            headers: {
                ...options.headers,
                'Authorization': `Bearer ${this.token}`,
                'Content-Type': 'application/json',
            },
        });
        
        if (response.status === 401) {
            // Token expired, try to refresh
            await this.refreshTokens();
            
            // Retry request with new token
            return this.request(endpoint, options);
        }
        
        if (!response.ok) {
            throw new Error(`Request failed: ${response.statusText}`);
        }
        
        return response.json();
    }
    
    async refreshTokens() {
        const response = await fetch(`${this.apiUrl}/jwt-auth/v1/token/refresh`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ refresh_token: this.refreshToken }),
        });
        
        if (!response.ok) {
            // Refresh failed, need to login again
            this.logout();
            throw new Error('Session expired, please login again');
        }
        
        const data = await response.json();
        this.token = data.token;
        this.refreshToken = data.refresh_token;
        
        localStorage.setItem('jwt_token', this.token);
        localStorage.setItem('jwt_refresh_token', this.refreshToken);
    }
    
    logout() {
        this.token = null;
        this.refreshToken = null;
        localStorage.removeItem('jwt_token');
        localStorage.removeItem('jwt_refresh_token');
    }
}

// Usage
const client = new JWTClient('https://example.com/wp-json');

// Login
client.login('username', 'password').then(data => {
    console.log('Logged in:', data);
});

// Make authenticated request
client.request('/wp/v2/posts').then(posts => {
    console.log('Posts:', posts);
});
</script>
                        </code></pre>
                    </section>
                    
                    <!-- OAuth 2.0 -->
                    <section>
                        <h2>OAuth 2.0 Authentication</h2>
                        
                        <h3>OAuth 2.0 Implementation</h3>
                        <pre><code class="language-php">
/**
 * OAuth 2.0 Authentication
 * Requires OAuth server setup
 */
class OAuth2_Authentication {
    
    private $client_id;
    private $client_secret;
    private $redirect_uri;
    
    public function __construct() {
        add_action('rest_api_init', [$this, 'register_oauth_endpoints']);
        add_filter('rest_authentication_errors', [$this, 'oauth_authentication']);
        add_action('init', [$this, 'register_oauth_tables']);
    }
    
    /**
     * Register OAuth endpoints
     */
    public function register_oauth_endpoints() {
        // Authorization endpoint
        register_rest_route('oauth/v2', '/authorize', [
            'methods' => 'GET',
            'callback' => [$this, 'authorize_endpoint'],
            'permission_callback' => 'is_user_logged_in',
            'args' => [
                'response_type' => [
                    'required' => true,
                    'enum' => ['code', 'token'],
                ],
                'client_id' => [
                    'required' => true,
                    'type' => 'string',
                ],
                'redirect_uri' => [
                    'required' => true,
                    'type' => 'string',
                    'format' => 'uri',
                ],
                'scope' => [
                    'type' => 'string',
                    'default' => 'basic',
                ],
                'state' => [
                    'type' => 'string',
                ],
            ],
        ]);
        
        // Token endpoint
        register_rest_route('oauth/v2', '/token', [
            'methods' => 'POST',
            'callback' => [$this, 'token_endpoint'],
            'permission_callback' => '__return_true',
            'args' => [
                'grant_type' => [
                    'required' => true,
                    'enum' => ['authorization_code', 'refresh_token', 'client_credentials', 'password'],
                ],
                'code' => [
                    'type' => 'string',
                ],
                'refresh_token' => [
                    'type' => 'string',
                ],
                'client_id' => [
                    'required' => true,
                    'type' => 'string',
                ],
                'client_secret' => [
                    'required' => true,
                    'type' => 'string',
                ],
            ],
        ]);
        
        // Revoke token endpoint
        register_rest_route('oauth/v2', '/revoke', [
            'methods' => 'POST',
            'callback' => [$this, 'revoke_endpoint'],
            'permission_callback' => '__return_true',
        ]);
    }
    
    /**
     * Authorization endpoint
     */
    public function authorize_endpoint(WP_REST_Request $request) {
        $response_type = $request->get_param('response_type');
        $client_id = $request->get_param('client_id');
        $redirect_uri = $request->get_param('redirect_uri');
        $scope = $request->get_param('scope');
        $state = $request->get_param('state');
        
        // Validate client
        if (!$this->validate_client($client_id, $redirect_uri)) {
            return new WP_Error(
                'invalid_client',
                'Invalid client or redirect URI',
                ['status' => 400]
            );
        }
        
        // Get user consent (in real implementation, show consent screen)
        $user_id = get_current_user_id();
        
        if ($response_type === 'code') {
            // Generate authorization code
            $code = $this->generate_auth_code($client_id, $user_id, $redirect_uri, $scope);
            
            // Redirect with code
            $redirect_url = add_query_arg([
                'code' => $code,
                'state' => $state,
            ], $redirect_uri);
            
            wp_redirect($redirect_url);
            exit;
            
        } elseif ($response_type === 'token') {
            // Implicit flow - generate access token directly
            $token = $this->generate_access_token($client_id, $user_id, $scope);
            
            // Redirect with token
            $redirect_url = $redirect_uri . '#' . http_build_query([
                'access_token' => $token['access_token'],
                'token_type' => 'Bearer',
                'expires_in' => $token['expires_in'],
                'state' => $state,
            ]);
            
            wp_redirect($redirect_url);
            exit;
        }
    }
    
    /**
     * Token endpoint
     */
    public function token_endpoint(WP_REST_Request $request) {
        $grant_type = $request->get_param('grant_type');
        
        switch ($grant_type) {
            case 'authorization_code':
                return $this->handle_authorization_code_grant($request);
                
            case 'refresh_token':
                return $this->handle_refresh_token_grant($request);
                
            case 'client_credentials':
                return $this->handle_client_credentials_grant($request);
                
            case 'password':
                return $this->handle_password_grant($request);
                
            default:
                return new WP_Error(
                    'unsupported_grant_type',
                    'Grant type not supported',
                    ['status' => 400]
                );
        }
    }
    
    /**
     * Handle authorization code grant
     */
    private function handle_authorization_code_grant($request) {
        $code = $request->get_param('code');
        $client_id = $request->get_param('client_id');
        $client_secret = $request->get_param('client_secret');
        $redirect_uri = $request->get_param('redirect_uri');
        
        // Validate client credentials
        if (!$this->validate_client_credentials($client_id, $client_secret)) {
            return new WP_Error(
                'invalid_client',
                'Invalid client credentials',
                ['status' => 401]
            );
        }
        
        // Validate authorization code
        $auth_code = $this->get_auth_code($code);
        
        if (!$auth_code || $auth_code['client_id'] !== $client_id) {
            return new WP_Error(
                'invalid_grant',
                'Invalid authorization code',
                ['status' => 400]
            );
        }
        
        // Check code expiration
        if (time() > $auth_code['expires']) {
            return new WP_Error(
                'invalid_grant',
                'Authorization code expired',
                ['status' => 400]
            );
        }
        
        // Generate tokens
        $tokens = $this->generate_tokens($client_id, $auth_code['user_id'], $auth_code['scope']);
        
        // Delete used authorization code
        $this->delete_auth_code($code);
        
        return new WP_REST_Response($tokens, 200);
    }
    
    /**
     * Generate authorization code
     */
    private function generate_auth_code($client_id, $user_id, $redirect_uri, $scope) {
        global $wpdb;
        
        $code = wp_generate_password(32, false);
        $expires = time() + 600; // 10 minutes
        
        $wpdb->insert(
            $wpdb->prefix . 'oauth_authorization_codes',
            [
                'code' => $code,
                'client_id' => $client_id,
                'user_id' => $user_id,
                'redirect_uri' => $redirect_uri,
                'scope' => $scope,
                'expires' => $expires,
                'created_at' => current_time('mysql'),
            ]
        );
        
        return $code;
    }
    
    /**
     * Generate access token
     */
    private function generate_access_token($client_id, $user_id, $scope) {
        global $wpdb;
        
        $access_token = wp_generate_password(40, false);
        $refresh_token = wp_generate_password(40, false);
        $expires_in = 3600; // 1 hour
        
        $wpdb->insert(
            $wpdb->prefix . 'oauth_access_tokens',
            [
                'access_token' => wp_hash($access_token),
                'client_id' => $client_id,
                'user_id' => $user_id,
                'scope' => $scope,
                'expires' => time() + $expires_in,
                'created_at' => current_time('mysql'),
            ]
        );
        
        $wpdb->insert(
            $wpdb->prefix . 'oauth_refresh_tokens',
            [
                'refresh_token' => wp_hash($refresh_token),
                'client_id' => $client_id,
                'user_id' => $user_id,
                'scope' => $scope,
                'expires' => time() + (86400 * 30), // 30 days
                'created_at' => current_time('mysql'),
            ]
        );
        
        return [
            'access_token' => $access_token,
            'refresh_token' => $refresh_token,
            'token_type' => 'Bearer',
            'expires_in' => $expires_in,
            'scope' => $scope,
        ];
    }
    
    /**
     * OAuth authentication handler
     */
    public function oauth_authentication($error) {
        if (!empty($error)) {
            return $error;
        }
        
        $auth_header = $this->get_authorization_header();
        
        if (!$auth_header || strpos($auth_header, 'Bearer ') !== 0) {
            return $error;
        }
        
        $token = str_replace('Bearer ', '', $auth_header);
        
        // Validate access token
        global $wpdb;
        $token_data = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM {$wpdb->prefix}oauth_access_tokens 
            WHERE access_token = %s AND expires > %d",
            wp_hash($token),
            time()
        ));
        
        if ($token_data) {
            wp_set_current_user($token_data->user_id);
            return true;
        }
        
        return new WP_Error(
            'invalid_token',
            'Invalid or expired access token',
            ['status' => 401]
        );
    }
    
    /**
     * Get authorization header
     */
    private function get_authorization_header() {
        if (isset($_SERVER['HTTP_AUTHORIZATION'])) {
            return $_SERVER['HTTP_AUTHORIZATION'];
        }
        
        if (isset($_SERVER['REDIRECT_HTTP_AUTHORIZATION'])) {
            return $_SERVER['REDIRECT_HTTP_AUTHORIZATION'];
        }
        
        return false;
    }
    
    /**
     * Create OAuth tables
     */
    public function register_oauth_tables() {
        global $wpdb;
        
        $charset_collate = $wpdb->get_charset_collate();
        
        // Authorization codes table
        $sql = "CREATE TABLE IF NOT EXISTS {$wpdb->prefix}oauth_authorization_codes (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            code varchar(255) NOT NULL,
            client_id varchar(255) NOT NULL,
            user_id bigint(20) UNSIGNED NOT NULL,
            redirect_uri text NOT NULL,
            scope text,
            expires bigint(20) NOT NULL,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            UNIQUE KEY code (code)
        ) $charset_collate;";
        
        require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
        dbDelta($sql);
        
        // Access tokens table
        $sql = "CREATE TABLE IF NOT EXISTS {$wpdb->prefix}oauth_access_tokens (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            access_token varchar(255) NOT NULL,
            client_id varchar(255) NOT NULL,
            user_id bigint(20) UNSIGNED NOT NULL,
            scope text,
            expires bigint(20) NOT NULL,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY access_token (access_token)
        ) $charset_collate;";
        
        dbDelta($sql);
        
        // Refresh tokens table
        $sql = "CREATE TABLE IF NOT EXISTS {$wpdb->prefix}oauth_refresh_tokens (
            id bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT,
            refresh_token varchar(255) NOT NULL,
            client_id varchar(255) NOT NULL,
            user_id bigint(20) UNSIGNED NOT NULL,
            scope text,
            expires bigint(20) NOT NULL,
            created_at datetime DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (id),
            KEY refresh_token (refresh_token)
        ) $charset_collate;";
        
        dbDelta($sql);
    }
}

// Initialize OAuth authentication
new OAuth2_Authentication();
                        </code></pre>
                    </section>
                    
                    <!-- Custom Authentication -->
                    <section>
                        <h2>Custom Authentication Methods</h2>
                        
                        <h3>API Key Authentication</h3>
                        <pre><code class="language-php">
/**
 * Custom API Key Authentication
 */
class API_Key_Authentication {
    
    public function __construct() {
        add_filter('rest_authentication_errors', [$this, 'api_key_auth']);
        add_action('rest_api_init', [$this, 'register_api_key_endpoints']);
        add_action('show_user_profile', [$this, 'show_api_key_field']);
        add_action('edit_user_profile', [$this, 'show_api_key_field']);
        add_action('personal_options_update', [$this, 'save_api_key_field']);
        add_action('edit_user_profile_update', [$this, 'save_api_key_field']);
    }
    
    /**
     * API key authentication handler
     */
    public function api_key_auth($error) {
        if (!empty($error)) {
            return $error;
        }
        
        // Check for API key in header
        $api_key = $this->get_api_key_from_request();
        
        if (!$api_key) {
            return $error;
        }
        
        // Validate API key
        $user = $this->validate_api_key($api_key);
        
        if ($user) {
            wp_set_current_user($user->ID);
            
            // Log API key usage
            $this->log_api_key_usage($user->ID, $api_key);
            
            return true;
        }
        
        return new WP_Error(
            'invalid_api_key',
            'Invalid API key',
            ['status' => 401]
        );
    }
    
    /**
     * Get API key from request
     */
    private function get_api_key_from_request() {
        // Check header
        if (isset($_SERVER['HTTP_X_API_KEY'])) {
            return $_SERVER['HTTP_X_API_KEY'];
        }
        
        // Check query parameter
        if (isset($_GET['api_key'])) {
            return $_GET['api_key'];
        }
        
        // Check POST data
        if (isset($_POST['api_key'])) {
            return $_POST['api_key'];
        }
        
        return false;
    }
    
    /**
     * Validate API key
     */
    private function validate_api_key($api_key) {
        global $wpdb;
        
        // Get user with this API key
        $users = get_users([
            'meta_key' => 'api_key_hash',
            'meta_value' => wp_hash($api_key),
            'number' => 1,
        ]);
        
        if (empty($users)) {
            return false;
        }
        
        $user = $users[0];
        
        // Check if API key is active
        $is_active = get_user_meta($user->ID, 'api_key_active', true);
        if ($is_active !== 'yes') {
            return false;
        }
        
        // Check rate limits
        if (!$this->check_rate_limit($user->ID)) {
            return false;
        }
        
        return $user;
    }
    
    /**
     * Generate API key for user
     */
    public function generate_api_key($user_id) {
        $api_key = wp_generate_password(32, false);
        
        update_user_meta($user_id, 'api_key_hash', wp_hash($api_key));
        update_user_meta($user_id, 'api_key_active', 'yes');
        update_user_meta($user_id, 'api_key_created', time());
        
        return $api_key;
    }
    
    /**
     * Show API key field in user profile
     */
    public function show_api_key_field($user) {
        $has_api_key = get_user_meta($user->ID, 'api_key_hash', true);
        $is_active = get_user_meta($user->ID, 'api_key_active', true);
        ?>
        <h3>REST API Key</h3>
        <table class="form-table">
            <tr>
                <th><label>API Key</label></th>
                <td>
                    <?php if ($has_api_key): ?>
                        <p>API Key is <?php echo $is_active === 'yes' ? 'active' : 'inactive'; ?></p>
                        <button type="button" class="button" id="regenerate-api-key">
                            Regenerate API Key
                        </button>
                        <button type="button" class="button" id="toggle-api-key">
                            <?php echo $is_active === 'yes' ? 'Deactivate' : 'Activate'; ?> API Key
                        </button>
                    <?php else: ?>
                        <button type="button" class="button" id="generate-api-key">
                            Generate API Key
                        </button>
                    <?php endif; ?>
                    <div id="api-key-display"></div>
                </td>
            </tr>
        </table>
        <script>
        jQuery(document).ready(function($) {
            $('#generate-api-key, #regenerate-api-key').on('click', function() {
                $.post(ajaxurl, {
                    action: 'generate_user_api_key',
                    user_id: <?php echo $user->ID; ?>,
                    nonce: '<?php echo wp_create_nonce('generate_api_key'); ?>'
                }, function(response) {
                    if (response.success) {
                        $('#api-key-display').html(
                            '<p><strong>Your API Key:</strong> <code>' + response.data.api_key + '</code></p>' +
                            '<p><em>Save this key! It will not be shown again.</em></p>'
                        );
                    }
                });
            });
        });
        </script>
        <?php
    }
    
    /**
     * Check rate limiting
     */
    private function check_rate_limit($user_id) {
        $key = 'api_rate_limit_' . $user_id;
        $limit = apply_filters('api_key_rate_limit', 1000); // 1000 requests per hour
        
        $count = get_transient($key) ?: 0;
        
        if ($count >= $limit) {
            return false;
        }
        
        set_transient($key, $count + 1, HOUR_IN_SECONDS);
        
        return true;
    }
    
    /**
     * Log API key usage
     */
    private function log_api_key_usage($user_id, $api_key) {
        global $wpdb;
        
        $wpdb->insert(
            $wpdb->prefix . 'api_key_logs',
            [
                'user_id' => $user_id,
                'api_key_hash' => wp_hash($api_key),
                'endpoint' => $_SERVER['REQUEST_URI'],
                'method' => $_SERVER['REQUEST_METHOD'],
                'ip_address' => $_SERVER['REMOTE_ADDR'],
                'user_agent' => $_SERVER['HTTP_USER_AGENT'],
                'timestamp' => current_time('mysql'),
            ]
        );
    }
}

// Initialize API key authentication
new API_Key_Authentication();
                        </code></pre>
                    </section>
                    
                    <!-- Summary -->
                    <section>
                        <h2>Summary</h2>
                        
                        <div class="summary-box">
                            <h3>Key Takeaways</h3>
                            <ul>
                                <li>Cookie authentication works for logged-in users with nonces</li>
                                <li>Application passwords provide secure Basic Auth</li>
                                <li>JWT offers stateless authentication with tokens</li>
                                <li>OAuth 2.0 enables third-party authorization</li>
                                <li>Custom authentication can be tailored to specific needs</li>
                                <li>Always use HTTPS for API authentication</li>
                            </ul>
                        </div>
                        
                        <div class="best-practices">
                            <h3>Authentication Best Practices</h3>
                            <ul>
                                <li>Use HTTPS for all authenticated requests</li>
                                <li>Implement rate limiting to prevent abuse</li>
                                <li>Store sensitive data hashed, never in plain text</li>
                                <li>Use appropriate token expiration times</li>
                                <li>Implement token refresh mechanisms</li>
                                <li>Log authentication attempts for security</li>
                                <li>Provide clear error messages for debugging</li>
                            </ul>
                        </div>
                    </section>
                    
                    <!-- Additional Resources -->
                    <section class="resources">
                        <h2>Additional Resources</h2>
                        <ul>
                            <li><a href="https://developer.wordpress.org/rest-api/using-the-rest-api/authentication/" target="_blank">WordPress REST API Authentication</a></li>
                            <li><a href="https://jwt.io/" target="_blank">JWT.io - JSON Web Tokens</a></li>
                            <li><a href="https://oauth.net/2/" target="_blank">OAuth 2.0 Documentation</a></li>
                            <li><a href="https://make.wordpress.org/core/2020/11/05/application-passwords-integration-guide/" target="_blank">Application Passwords Guide</a></li>
                        </ul>
                    </section>
                </div>
                
                <!-- Lesson Navigation -->
                <div class="lesson-navigation">
                    <a href="/07module/rest_api_architecture.html" class="lesson-nav-button prev">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"/>
                        </svg>
                        <span>
                            <small>Previous</small><br>
                            API Architecture
                        </span>
                    </a>
                    
                    <button class="complete-lesson-btn">
                        Mark as Complete
                    </button>
                    
                    <a href="/07module/custom_endpoints_controllers.html" class="lesson-nav-button next">
                        <span>
                            <small>Next</small><br>
                            Custom Endpoints
                        </span>
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="site-footer" role="contentinfo">
            <div class="footer-container">
                <div class="footer-content">
                    <div class="footer-section footer-about">
                        <h3>PHP WordPress Development</h3>
                        <p>Complete Web Development Course - From HTML to WordPress</p>
                    </div>
                    
                    <div class="footer-section">
                        <h4>Quick Links</h4>
                        <ul class="footer-links">
                            <li><a href="/">Home</a></li>
                            <li><a href="/module7.html">Module 7</a></li>
                            <li><a href="/resources.html">Resources</a></li>
                            <li><a href="/about.html">About</a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <p>&copy; 2025 PHP WordPress Development Course. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- JavaScript -->
    <script src="/assets/js/prism.js"></script>
    <script src="/assets/js/main.js"></script>
    <script src="/assets/js/lesson.js"></script>
</body>
</html>